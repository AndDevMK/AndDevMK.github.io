<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>解读Flutter源码之Animation - AndDevMK&#39;s android blog site</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="AndDevMK" /><meta name="description" content="注：本文代码基于Flutter SDK 3.13.5 一、前言 如果你开发的App失去了交互动画，那么这将是一件很难想象的事情，此时它的体验必然一言难尽，用户会为它贴上“傻快”、“生硬”、“粗糙”等标签，从而你将不得不丢失一部分用户。 因此，精心设计的动画会使UI更生动，它有助于提升App更精巧的外观和" /><meta name="keywords" content="Android, Java, Kotlin, C&#43;&#43;, C, Flutter, Dart, NDK" />


<meta name="baidu-site-verification" content="codeva-wQ7uOo4V09" />
<meta name="google-site-verification" content="yHzWB9BxTR74LiaUhuL5ncr89fnDYXiplTaPY565zqo" />


<meta name="generator" content="Hugo 0.111.3 with theme even" />


<link rel="canonical" href="https://anddevmk.github.io/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Banimation/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.c11aaf02bef1025d6b0813ba5e1a8a8551aee15fa8f2bcea906d41b20bdf5c69.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/codecopy.css">


<meta property="og:title" content="解读Flutter源码之Animation" />
<meta property="og:description" content="注：本文代码基于Flutter SDK 3.13.5 一、前言 如果你开发的App失去了交互动画，那么这将是一件很难想象的事情，此时它的体验必然一言难尽，用户会为它贴上“傻快”、“生硬”、“粗糙”等标签，从而你将不得不丢失一部分用户。 因此，精心设计的动画会使UI更生动，它有助于提升App更精巧的外观和" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://anddevmk.github.io/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Banimation/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-11-04T11:28:31+08:00" />
<meta property="article:modified_time" content="2023-11-04T11:28:31+08:00" />
<meta itemprop="name" content="解读Flutter源码之Animation">
<meta itemprop="description" content="注：本文代码基于Flutter SDK 3.13.5 一、前言 如果你开发的App失去了交互动画，那么这将是一件很难想象的事情，此时它的体验必然一言难尽，用户会为它贴上“傻快”、“生硬”、“粗糙”等标签，从而你将不得不丢失一部分用户。 因此，精心设计的动画会使UI更生动，它有助于提升App更精巧的外观和"><meta itemprop="datePublished" content="2023-11-04T11:28:31+08:00" />
<meta itemprop="dateModified" content="2023-11-04T11:28:31+08:00" />
<meta itemprop="wordCount" content="15778">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="解读Flutter源码之Animation"/>
<meta name="twitter:description" content="注：本文代码基于Flutter SDK 3.13.5 一、前言 如果你开发的App失去了交互动画，那么这将是一件很难想象的事情，此时它的体验必然一言难尽，用户会为它贴上“傻快”、“生硬”、“粗糙”等标签，从而你将不得不丢失一部分用户。 因此，精心设计的动画会使UI更生动，它有助于提升App更精巧的外观和"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">AndDevMK</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>

    
    <li class="mobile-menu-item-search">
      <div id="mobile_open_search" class="mobile_open_search">
        搜索
      </div>
    </li>

    
    <li class="mobile-menu-item-dark-mode">
      <div id="mobile_dark_mode_toggle" class="mobile_light_mode">
       
      </div>
    </li>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">AndDevMK</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
    
    <div id="open_search" class="open_search">
      搜索
    </div>

    
    <div id="dark_mode_toggle" class="light_mode">

    </div>
  
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">解读Flutter源码之Animation</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-11-04 </span>
        <div class="post-category">
            <a href="/categories/flutter/"> Flutter </a>
            </div>
          <span class="more-meta"> 约 15778 字 </span>
          <span class="more-meta"> 预计阅读 32 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#一前言">一、前言</a></li>
    <li><a href="#二动画概览">二、动画概览</a>
      <ul>
        <li><a href="#21动画的实现方式">2.1、动画的实现方式</a></li>
        <li><a href="#22动画的类型">2.2、动画的类型</a></li>
        <li><a href="#23预置动画">2.3、预置动画</a></li>
        <li><a href="#24常见的动画模式">2.4、常见的动画模式</a></li>
      </ul>
    </li>
    <li><a href="#三动画基础">三、动画基础</a>
      <ul>
        <li><a href="#31animation">3.1、<em>Animation</em></a>
          <ul>
            <li><a href="#311动画通知">3.1.1、动画通知</a></li>
          </ul>
        </li>
        <li><a href="#32curve">3.2、<em>Curve</em></a></li>
        <li><a href="#33animationcontroller">3.3、<em>AnimationController</em></a></li>
        <li><a href="#34tween">3.4、<em>Tween</em></a>
          <ul>
            <li><a href="#341tweenanimate">3.4.1、<em>Tween.animate</em></a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#四动画示例">四、动画示例</a></li>
    <li><a href="#五分析动画源码">五、分析动画源码</a>
      <ul>
        <li><a href="#51_animationcontrollerforward">5.1、<em>_animationController.forward()</em></a></li>
        <li><a href="#52animationcontroller的构造方法">5.2、<em>AnimationController</em>的构造方法</a></li>
        <li><a href="#53_animationvalue">5.3、<em>_animation.value</em></a></li>
      </ul>
    </li>
    <li><a href="#六动画总结">六、动画总结</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <blockquote>
<p><em>注：本文代码基于Flutter SDK 3.13.5</em></p>
</blockquote>
<h1 id="一前言">一、前言</h1>
<p>如果你开发的<em>App</em>失去了交互动画，那么这将是一件很难想象的事情，此时它的体验必然一言难尽，用户会为它贴上“傻快”、“生硬”、“粗糙”等标签，从而你将不得不丢失一部分用户。</p>
<p>因此，精心设计的动画会使<em>UI</em>更生动，它有助于提升<em>App</em>更精巧的外观和感觉，从而改善用户体验。</p>
<p>在<em>Flutter</em>的<em>Material Widgets</em>中，这些<em>Widgets</em>均自带其设计规范中定义的标准动画效果，能让各种动画效果的实现变得容易，当然了，你也可以定制这些效果。</p>
<h1 id="二动画概览">二、动画概览</h1>
<p>在<em>Flutter</em>中，创建动画可以有多种不同实现方式。那么，究竟哪种才是最适合你的呢？可以参考下面的决策树，它将帮助你挑选实现<em>Flutter</em>动画的正确方式。</p>
<img title="" src="/img/flutter/解读Flutter源码之Animation/animation-decision-tree.png" alt="" width="535">
<h2 id="21动画的实现方式">2.1、动画的实现方式</h2>
<p>按照<em><strong>动画的实现方式</strong></em>来分类，可以分为隐式动画与显式动画。</p>
<ul>
<li>隐式动画</li>
</ul>
<p>所有隐式动画均扩展了<em>ImplicitlyAnimatedWidget</em>类。你可以使用内置的隐式动画，例如<em>AnimatedContainer</em>、<em>AnimatedAlign</em>等，这些是最简单的动画。如果内置的隐式动画不能够满足你的需求，你也可以使用<em>TweenAnimationBuilder</em>创建一个自定义的隐式动画。</p>
<ul>
<li>显式动画</li>
</ul>
<p>所谓显式动画，就是需要手动控制，而不是让框架控制。你可以使用内置的其中一个显式动画类来实现，例如<em>ScaleTransition</em>、<em>RotationTransition</em>等。如果内置的显式动画不能够满足你的需求，你也可以使用<em>AnimatedBuilder</em>或<em>AnimatedWidget</em>创建一个自定义的显式动画。</p>
<p>当然了，不管隐式动画还是显式动画，它们也只是对底层<em>Animation</em>的一个封装，只是封装后的使用自由度不太相同罢了。</p>
<h2 id="22动画的类型">2.2、动画的类型</h2>
<p>按照<em><strong>动画的类型</strong></em>来分类，可以分为补间动画与基于物理动画。</p>
<ul>
<li>补间动画</li>
</ul>
<p>补间动画是“介于两者之间”的缩写。在补间动画中，定义了起点和终点以及时间轴，再定义过渡时间和速度的曲线，然后框架会计算如何从起点过渡到终点。</p>
<ul>
<li>基于物理动画</li>
</ul>
<p>在基于物理基础的动画中，动作是模拟真实世界的行为来进行建模的。举个例子，当您抛球时，球落地的时间和位置取决于抛出的速度和距离地面的高度。类似地，附在弹簧上的球和附在绳子上的球掉落（和反弹）方式是不一样的。</p>
<h2 id="23预置动画">2.3、预置动画</h2>
<p>预置动画指的是<em>pub.dev</em>上的<a href="https://pub-web.flutter-io.cn/packages/animations"><em>animations</em></a>库中所包含的动画，它是由<em>Flutter</em>官方提供的。这个库包含了以下内置常用模式： <em>Container</em>变换、共享轴变化、渐变穿透和渐变变换。</p>
<h2 id="24常见的动画模式">2.4、常见的动画模式</h2>
<p>常见的动画模式包括列表或网格动画、共享元素转换、交织动画等。</p>
<ul>
<li>列表或网格动画</li>
</ul>
<p>这种模式用于在列表或网格中添加或删除元素。</p>
<ul>
<li>共享元素转换</li>
</ul>
<p>在这个模式中，用户从页面中选择一个元素，通常是图像，然后<em>UI</em>会在新页面中为指定元素添加动画，并生成更多细节。在<em>Flutter</em>中，您可以通过<em>Hero</em>组件轻松实现路径（页面）间的共享元素转换动画。</p>
<p>例如，下面这两种风格的<em>Hero</em>动画：</p>
<p>1、当改变位置和大小时，<em>Hero</em>从一页飞至另一页。</p>
<p>2、<em>Hero</em>的边界改变形状由圆变方，同时从一页飞至另一页。</p>
<p>为什么要将这种可飞行的共享组件称为<em>Hero</em>（英雄），有一种说法是说美国文化中的超人是可以飞的，那是美国人心中的大英雄，还有漫威中的超级英雄基本上都是会飞的，所以<em>Flutter</em>开发人员就对这种“会飞的<em>Widget</em>”就起了一个富有浪漫主义的名字<em>Hero</em>。当然这种说法并非官方解释，但却很有意思。</p>
<ul>
<li>交织动画</li>
</ul>
<p>将复杂的动画分解成较小的动作，其中一些动作被延迟，分解后的这些小动画可以是连续的，也可以部分或完全重叠。例如：有一个柱状图，需要在高度增长的同时改变颜色，等到增长到最大高度后，我们需要在X轴上平移一段距离。</p>
<p>使用交织动画需要注意以下几点：</p>
<p>1、要创建交织动画，需要使用多个动画对象（<em>Animation</em>）</p>
<p>2、一个<em>AnimationController</em>控制所有的动画对象</p>
<p>3、给每一个动画对象指定时间间隔（<em>Interval</em>）</p>
<p><em>OK</em>，动画总览讲解完毕，最后再给出一张动画总览的思维导图。</p>
<img title="" src="/img/flutter/解读Flutter源码之Animation/Flutter动画总览.png" alt="" width="535">
<h1 id="三动画基础">三、动画基础</h1>
<p>在任何系统的<em>UI</em>框架中，动画的实现原理都是相同的，即在一段时间内，快速地多次改变<em>UI</em>外观；由于人眼会产生视觉暂留，所以最终看到的就是一个“连续”的动画，这和电影的原理是一样的。</p>
<p><em>Flutter</em>中对动画进行了抽象，主要涉及<em>Animation</em>、<em>Curve</em>、<em>Controller</em>、<em>Tween</em>这四个角色，它们一起配合来完成一个完整动画，下面来一一介绍它们。</p>
<h2 id="31animation">3.1、<em>Animation</em></h2>
<p>1、在<em>Flutter</em>中，动画对象<em>Animation</em>无法获取屏幕上显示的内容，它与渲染或 <em>build()</em> 方法无关。</p>
<p>2、<em>Animation</em>是一个已知当前值<em>value</em>和状态<em>status</em>（已完成或已解除）的抽象类，其中一个比较常见的<em>Animation</em>类型是 <code>Animation&lt;double&gt;</code>。</p>
<p>3、动画还可以插入除<em>double</em>以外的类型，比如<code>Animation&lt;Color&gt;</code>或者<code>Animation&lt;Size&gt;</code>。</p>
<p>4、一个<em>Animation</em>对象在一段时间内，持续生成介于两个值之间的插入值。这个<em>Animation</em>对象输出的可能是直线，曲线，阶梯函数，或者任何自定义的映射，这由<em>Curve</em>来决定。</p>
<p>5、根据<em>Animation</em>对象的不同控制方式，它可以反向运行，或者中途切换方向。</p>
<p>6、在动画的每一帧中，我们可以通过<em>Animation</em>对象的<em>value</em>属性获取动画的当前值。</p>
<h3 id="311动画通知">3.1.1、动画通知</h3>
<p>一个<em>Animation</em>对象可以有不止一个<em>Listener</em>和<em>StatusListener</em>，用<em>addListener()</em> 和<em>addStatusListener()</em> 来定义。</p>
<ul>
<li>
<p>当动画值改变时调用<em>Listener</em>。<em>Listener</em>最常用的操作是调用 <em>setState()</em> 进行重建。</p>
</li>
<li>
<p>当一个动画开始，结束，前进或后退时，会调用<em>StatusListener</em>，用<em>AnimationStatus</em>来定义。</p>
</li>
</ul>
<h2 id="32curve">3.2、<em>Curve</em></h2>
<p><em>CurvedAnimation</em>定义动画进程为非线性曲线。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">CurvedAnimation</span> <span class="n">curve</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="n">CurvedAnimation</span><span class="p">(</span><span class="nl">parent:</span> <span class="n">controller</span><span class="p">,</span> <span class="nl">curve:</span> <span class="n">Curves</span><span class="p">.</span><span class="n">easeIn</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>CurvedAnimation</em>和<em>AnimationController</em>（下面介绍）都是<code>Animation&lt;double&gt;</code>类型。<em>CurvedAnimation</em>可以通过包装<em>AnimationController</em>和<em>Curve</em>生成一个新的动画对象，我们正是通过这种方式来将动画和动画执行的曲线关联起来的。</p>
<p><em>Curves</em>类中定义了很多常用曲线。</p>
<table>
<thead>
<tr>
<th><em>Curves</em>曲线</th>
<th>动画过程</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>linear</em></td>
<td>线性动画曲线</td>
</tr>
<tr>
<td><em>decelerate</em></td>
<td>变化率开始快速然后减速的曲线</td>
</tr>
<tr>
<td><em>ease</em></td>
<td>快速加速、缓慢结束的立方动画曲线</td>
</tr>
<tr>
<td><em>easeIn</em></td>
<td>缓慢开始并快速结束的立方动画曲线</td>
</tr>
<tr>
<td><em>easeOut</em></td>
<td>快速开始并缓慢结束的立方动画曲线</td>
</tr>
<tr>
<td><em>easeInOut</em></td>
<td>一条立方动画曲线，缓慢开始，加速，然后缓慢结束</td>
</tr>
<tr>
<td><em>bounceIn</em></td>
<td>幅度不断增长的振荡曲线</td>
</tr>
<tr>
<td><em>bounceOut</em></td>
<td>一条先增大后减小幅度的振荡曲线</td>
</tr>
<tr>
<td><em>bounceInOut</em></td>
<td>一条先增大后减小幅度的振荡曲线</td>
</tr>
<tr>
<td>&hellip;</td>
<td>&hellip;</td>
</tr>
</tbody>
</table>
<p>如果内置的<em>Curves</em>曲线不能满足你的要求，你也可以自定义<em>Curves</em>曲线。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="k">import</span> <span class="s1">&#39;dart:math&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ShakeCurve</span> <span class="kd">extends</span> <span class="n">Curve</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">double</span> <span class="n">transform</span><span class="p">(</span><span class="kt">double</span> <span class="n">t</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">sin</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="m">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="33animationcontroller">3.3、<em>AnimationController</em></h2>
<p><em>AnimationController</em>是个特殊的<em>Animation</em>对象，每当硬件准备新帧时，它都会生成一个新值。默认情况下，<em>AnimationController</em>在给定期间内会线性生成从 0.0 到 1.0 的数字。例如，这段代码创建了一个动画对象，但是没有启动运行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">AnimationController</span> <span class="n">controller</span> <span class="o">=</span> <span class="n">AnimationController</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nl">duration:</span> <span class="kd">const</span> <span class="n">Duration</span><span class="p">(</span><span class="nl">milliseconds:</span> <span class="m">2000</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nl">vsync:</span> <span class="k">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>AnimationController</em>生成数字的区间可以通过<em>lowerBound</em>和<em>upperBound</em>来指定，如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">AnimationController</span> <span class="n">controller</span> <span class="o">=</span> <span class="n">AnimationController</span><span class="p">(</span> 
</span></span><span class="line"><span class="cl"> <span class="nl">duration:</span> <span class="kd">const</span> <span class="n">Duration</span><span class="p">(</span><span class="nl">milliseconds:</span> <span class="m">2000</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl"> <span class="nl">lowerBound:</span> <span class="m">10.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nl">upperBound:</span> <span class="m">20.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="nl">vsync:</span> <span class="k">this</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>AnimationController</em>源自于<code>Animation&lt;double&gt;</code>，所以可以用在任何需要<em>Animation</em>对象的地方。但是<em>AnimationController</em>还有其它方法控制动画，例如：<em>forward()</em> 方法可以启动正向动画，<em>reverse()</em> 可以启动反向动画。</p>
<p>在动画开始执行后开始生成动画帧，屏幕每刷新一次就是一个动画帧，在动画的每一帧，会随着根据动画的曲线来生成当前的动画值（<em>Animation.value</em>），然后根据当前的动画值去构建<em>UI</em>，当所有动画帧依次触发时，动画值会依次改变，所以构建的<em>UI</em>也会依次变化，所以最终我们可以看到一个完成的动画。</p>
<p>创建<em>AnimationController</em>的同时，也赋予了一个<em>vsync</em>参数。<em>vsync</em>的存在防止后台动画消耗不必要的资源。您可以通过添加<em>SingleTickerProviderStateMixin</em>到类定义，将有状态的对象用作<em>vsync</em>。</p>
<blockquote>
<p>注意：在一些情况下，一个位置可能会超过<em>AnimationController</em>的 0.0-1.0 的范围。例如，<em>fling()</em> 函数可以根据我们手指滑动（甩出）的速度(<em>velocity</em>)、力量(<em>force</em>)等来模拟一个手指甩出动画，因此它的动画值可以在[0.0，1.0]范围之外。即使<em>AnimationController</em>在范围内，<em>CurvedAnimation</em>也可能会出现超出 0.0-1.0 范围的情况。根据所选曲线的不同，<em>CurvedAnimation</em>的输出范围可能会超过输入。举个例子，弹性曲线（比如<em>Curves.elasticIn</em>）会明显超出或低于默认范围。</p>
</blockquote>
<h2 id="34tween">3.4、<em>Tween</em></h2>
<p>在默认情况下，<em>AnimationController</em>对象的范围是 0.0-0.1。如果需要不同的范围或者不同的数据类型，可以使用<em>Tween</em>配置动画来插入不同的范围或数据类型。例如下面的示例中，<em>Tween</em>的范围是 -200 到 0.0。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">Tween</span> <span class="n">doubleTween</span> <span class="o">=</span> <span class="n">Tween</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="nl">begin:</span> <span class="o">-</span><span class="m">200.0</span><span class="p">,</span> <span class="nl">end:</span> <span class="m">0.0</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>Tween</em>是无状态的对象，只有<em>begin</em>和<em>end</em>。<em>Tween</em>的这种单一用途用来定义从输入范围到输出范围的映射。输入范围一般为 0.0-1.0，但这并不是必须的。</p>
<p><em>Tween</em>源自<code>Animatable&lt;T&gt;</code>，而不是<code>Animation&lt;T&gt;</code>。像动画这样的可动画元素不必重复输出。例如，<em>ColorTween</em>指定了两种颜色之间的过程。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">Tween</span> <span class="n">colorTween</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="n">ColorTween</span><span class="p">(</span><span class="nl">begin:</span> <span class="n">Colors</span><span class="p">.</span><span class="n">transparent</span><span class="p">,</span> <span class="nl">end:</span> <span class="n">Colors</span><span class="p">.</span><span class="n">black54</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>Tween</em>对象不存储任何状态。而是提供<code>evaluate(Animation&lt;double&gt; animation)</code>方法，将映射函数应用于动画当前值。<em>Animation</em>对象的当前值可以在<code>.value</code>方法中找到。<em>evaluate</em>方法还执行一些内部处理内容，比如确保当动画值在 0.0 和1.0 时分别返回起始点和终点。</p>
<h3 id="341tweenanimate">3.4.1、<em>Tween.animate</em></h3>
<p>要使用<em>Tween</em>对象，请在<em>Tween</em>调用<em>animate()</em>，传入控制器对象。例如，下面的代码在 500 ms 的进程中生成 0-255 范围内的整数值。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">AnimationController</span> <span class="n">controller</span> <span class="o">=</span> <span class="n">AnimationController</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">duration:</span> <span class="kd">const</span> <span class="n">Duration</span><span class="p">(</span><span class="nl">milliseconds:</span> <span class="m">500</span><span class="p">),</span> <span class="nl">vsync:</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Animation</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">IntTween</span><span class="p">(</span><span class="nl">begin:</span> <span class="m">0</span><span class="p">,</span> <span class="nl">end:</span> <span class="m">255</span><span class="p">).</span><span class="n">animate</span><span class="p">(</span><span class="n">controller</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意：<em>animate()</em> 方法会返回一个<em>Animation</em>，而不是<em>Animatable</em>。</p>
</blockquote>
<p>下面的示例展示了一个控制器，一个曲线，和一个<em>Tween</em>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">AnimationController</span> <span class="n">controller</span> <span class="o">=</span> <span class="n">AnimationController</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">duration:</span> <span class="kd">const</span> <span class="n">Duration</span><span class="p">(</span><span class="nl">milliseconds:</span> <span class="m">500</span><span class="p">),</span> <span class="nl">vsync:</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">Animation</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">curve</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="n">CurvedAnimation</span><span class="p">(</span><span class="nl">parent:</span> <span class="n">controller</span><span class="p">,</span> <span class="nl">curve:</span> <span class="n">Curves</span><span class="p">.</span><span class="n">easeOut</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Animation</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">IntTween</span><span class="p">(</span><span class="nl">begin:</span> <span class="m">0</span><span class="p">,</span> <span class="nl">end:</span> <span class="m">255</span><span class="p">).</span><span class="n">animate</span><span class="p">(</span><span class="n">curve</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="四动画示例">四、动画示例</h1>
<p>现有一需求，点击<em>scale</em>按钮，可以将一个<em>Icon</em>变大或缩小，并且中途还可以调转动画的方向。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">runApp</span><span class="p">(</span><span class="kd">const</span> <span class="n">MyApp</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyApp</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">MyApp</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">MaterialApp</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">title:</span> <span class="s1">&#39;Flutter Demo&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">theme:</span> <span class="n">ThemeData</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">colorScheme:</span> <span class="n">ColorScheme</span><span class="p">.</span><span class="n">fromSeed</span><span class="p">(</span><span class="nl">seedColor:</span> <span class="n">Colors</span><span class="p">.</span><span class="n">deepPurple</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">useMaterial3:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">home:</span> <span class="kd">const</span> <span class="n">MyPage</span><span class="p">(</span><span class="nl">title:</span> <span class="s1">&#39;动画演示&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyPage</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">MyPage</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="kd">required</span> <span class="k">this</span><span class="p">.</span><span class="n">title</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">String</span> <span class="n">title</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">State</span><span class="o">&lt;</span><span class="n">MyPage</span><span class="o">&gt;</span> <span class="n">createState</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="n">_MyPageState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">_MyPageState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">MyPage</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">appBar:</span> <span class="n">AppBar</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">backgroundColor:</span> <span class="n">Theme</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">inversePrimary</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">title:</span> <span class="n">Text</span><span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">title</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">body:</span> <span class="kd">const</span> <span class="n">MyWidget</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyWidget</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">MyWidget</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">State</span><span class="o">&lt;</span><span class="n">MyWidget</span><span class="o">&gt;</span> <span class="n">createState</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="n">_MyWidgetState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">_MyWidgetState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">MyWidget</span><span class="o">&gt;</span> <span class="kd">with</span> <span class="n">SingleTickerProviderStateMixin</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">late</span> <span class="n">AnimationController</span> <span class="n">_animationController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">late</span> <span class="n">Animation</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">_animation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">initState</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">initState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_animationController</span> <span class="o">=</span> <span class="n">AnimationController</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">vsync:</span> <span class="k">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">duration:</span> <span class="kd">const</span> <span class="n">Duration</span><span class="p">(</span><span class="nl">seconds:</span> <span class="m">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">reverseDuration:</span> <span class="kd">const</span> <span class="n">Duration</span><span class="p">(</span><span class="nl">seconds:</span> <span class="m">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_animation</span> <span class="o">=</span> <span class="n">CurvedAnimation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">parent:</span> <span class="n">_animationController</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">curve:</span> <span class="n">Curves</span><span class="p">.</span><span class="n">easeIn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">reverseCurve:</span> <span class="n">Curves</span><span class="p">.</span><span class="n">bounceIn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_animation</span> <span class="o">=</span> <span class="n">Tween</span><span class="p">(</span><span class="nl">begin:</span> <span class="m">200.0</span><span class="p">,</span> <span class="nl">end:</span> <span class="m">300.0</span><span class="p">).</span><span class="n">animate</span><span class="p">(</span><span class="n">_animation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">..</span><span class="n">addListener</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">_scale</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_animation</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">AnimationStatus</span><span class="p">.</span><span class="n">completed</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">_animation</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">AnimationStatus</span><span class="p">.</span><span class="n">forward</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_animationController</span><span class="p">.</span><span class="n">reverse</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_animation</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">AnimationStatus</span><span class="p">.</span><span class="n">dismissed</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">_animation</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">AnimationStatus</span><span class="p">.</span><span class="n">reverse</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_animationController</span><span class="p">.</span><span class="n">forward</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">dispose</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_animationController</span><span class="p">.</span><span class="n">dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;build&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Center</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">Column</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">mainAxisSize:</span> <span class="n">MainAxisSize</span><span class="p">.</span><span class="n">min</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">children:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="n">Icon</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">Icons</span><span class="p">.</span><span class="n">account_circle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nl">size:</span> <span class="n">_animation</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="n">OutlinedButton</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nl">onPressed:</span> <span class="n">_scale</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nl">child:</span> <span class="kd">const</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>程序运行起来后，<em>UI</em>效果为：</p>
<img title="" src="/img/flutter/解读Flutter源码之Animation/scale.gif" alt="" width="235">
<h1 id="五分析动画源码">五、分析动画源码</h1>
<h2 id="51_animationcontrollerforward">5.1、<em>_animationController.forward()</em></h2>
<p>从动画的启动方法入手，也就是<em>AnimationController</em>的<em>forward</em>方法，看下它的源码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">TickerFuture</span> <span class="n">forward</span><span class="p">({</span> <span class="kt">double</span><span class="o">?</span> <span class="n">from</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 指定动画方向为正向
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_direction</span> <span class="o">=</span> <span class="n">_AnimationDirection</span><span class="p">.</span><span class="n">forward</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 因为没有传入from，所以这里为null，此处不会执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">from</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">_animateToInternal</span><span class="p">(</span><span class="n">upperBound</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>AnimationController</em>的<em>forward</em>方法中，执行了 <em>_animateToInternal</em> 方法，这里传入了<em>upperBound</em>，它是该动画被视为完成的值。</p>
<p><em>upperBound</em>是在<em>AnimationController</em>的构造方法中传入，只是本示例中没有传入，所以取的是默认值为 1.0。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AnimationController</span> <span class="kd">extends</span> <span class="n">Animation</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">with</span> <span class="n">AnimationEagerListenerMixin</span><span class="p">,</span> <span class="n">AnimationLocalListenersMixin</span><span class="p">,</span> <span class="n">AnimationLocalStatusListenersMixin</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">AnimationController</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span><span class="o">?</span> <span class="n">value</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">duration</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">reverseDuration</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">debugLabel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">lowerBound</span> <span class="o">=</span> <span class="m">0.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 默认值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="n">upperBound</span> <span class="o">=</span> <span class="m">1.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">animationBehavior</span> <span class="o">=</span> <span class="n">AnimationBehavior</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kd">required</span> <span class="n">TickerProvider</span> <span class="n">vsync</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span> <span class="o">:</span> <span class="k">assert</span><span class="p">(</span><span class="n">upperBound</span> <span class="o">&gt;=</span> <span class="n">lowerBound</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">       <span class="n">_direction</span> <span class="o">=</span> <span class="n">_AnimationDirection</span><span class="p">.</span><span class="n">forward</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_ticker</span> <span class="o">=</span> <span class="n">vsync</span><span class="p">.</span><span class="n">createTicker</span><span class="p">(</span><span class="n">_tick</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_internalSetValue</span><span class="p">(</span><span class="n">value</span> <span class="o">??</span> <span class="n">lowerBound</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>继续跟踪<em>AnimationController</em>的 <em>_animateToInternal</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">TickerFuture</span> <span class="n">_animateToInternal</span><span class="p">(</span><span class="kt">double</span> <span class="n">target</span><span class="p">,</span> <span class="p">{</span> <span class="n">Duration</span><span class="o">?</span> <span class="n">duration</span><span class="p">,</span> <span class="n">Curve</span> <span class="n">curve</span> <span class="o">=</span> <span class="n">Curves</span><span class="p">.</span><span class="n">linear</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">double</span> <span class="n">scale</span> <span class="o">=</span> <span class="m">1.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">/// SemanticsBinding.instance.disableAnimations用来判断该平台是否要求禁用或简化动画。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// 可通过设置debugSemanticsDisableAnimations可以覆盖此设置以进行测试或调试
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// 例如：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// ```dart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// import &#39;package:flutter/rendering.dart&#39;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// void main() {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">///   // debugSemanticsDisableAnimations = true;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">///   runApp(const MyApp());
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// ```
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// 本示例中很明显没有禁用动画，所以此处不执行，scale的值仍然为1.0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">SemanticsBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">disableAnimations</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">animationBehavior</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">AnimationBehavior</span><span class="p">.</span><span class="nl">normal:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 由于该框架无法处理零持续时间动画，因此我们以正常持续时间的 5% 运行它，以将大多数动画限制为单帧。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 理想情况下，框架将能够处理零持续时间动画，但是，如果不延迟至少一帧，永久重复动画的常见模式可能会导致无限循环。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Since the framework cannot handle zero duration animations, we run it at 5% of the normal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// duration to limit most animations to a single frame.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Ideally, the framework would be able to handle zero duration animations, however, the common
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// pattern of an eternally repeating animation might cause an endless loop if it weren&#39;t delayed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// for at least one frame.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">scale</span> <span class="o">=</span> <span class="m">0.05</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">AnimationBehavior</span><span class="p">.</span><span class="nl">preserve:</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// simulationDuration是模拟持续时间，但是由于duration参数没有传入，所以simulationDuration为null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Duration</span><span class="o">?</span> <span class="n">simulationDuration</span> <span class="o">=</span> <span class="n">duration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 因为simulationDuration为null，所以此处执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">simulationDuration</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">duration</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">_direction</span> <span class="o">==</span> <span class="n">_AnimationDirection</span><span class="p">.</span><span class="n">forward</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">duration</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">_direction</span> <span class="o">==</span> <span class="n">_AnimationDirection</span><span class="p">.</span><span class="n">reverse</span> <span class="o">&amp;&amp;</span> <span class="n">reverseDuration</span> <span class="o">==</span> <span class="kc">null</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 获取动画的范围，因为在AnimationController构造方法中，upperBound与lowerBound参数均没传入，所以都是取默认值，upperBound为1.0，lowerBound为0.0，那么此处range为1.0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="kt">double</span> <span class="n">range</span> <span class="o">=</span> <span class="n">upperBound</span> <span class="o">-</span> <span class="n">lowerBound</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// range.isFinite是判断range这个数字是否是有限的。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 唯一的非有限数是 NaN 值、正无穷大和负无穷大。所有整数都是有限的。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 所有数字都满足isInfinite、isFinite和isNaN之一
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 因为range为1.0，所以range.isFinite是true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 因为target为传入的upperBound，所以它的值为1.0，_value默认值为0.0，所以remainingFraction的最终计算结果为1.0，也就是动画的执行进度剩余百分比
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="kt">double</span> <span class="n">remainingFraction</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">isFinite</span> <span class="o">?</span> <span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">_value</span><span class="p">).</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">range</span> <span class="o">:</span> <span class="m">1.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果动画方向为反向并且反向动画时间reverseDuration（此处reverseDuration也就是AnimationController构造方法传入的reverseDuration）不为null，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 那么directionDuration为反向动画时间，否则为正向动画时间duration（此处duration也就是AnimationController构造方法传入的duration）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 在前面的forward方法中，_direction已经被赋值为_AnimationDirection.forward，所以这里directionDuration为this.duration，也就是1s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="n">Duration</span> <span class="n">directionDuration</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="n">_direction</span> <span class="o">==</span> <span class="n">_AnimationDirection</span><span class="p">.</span><span class="n">reverse</span> <span class="o">&amp;&amp;</span> <span class="n">reverseDuration</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">?</span> <span class="n">reverseDuration</span><span class="o">!</span>
</span></span><span class="line"><span class="cl">      <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="n">duration</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 那么最终计算后的simulationDuration模拟持续时间为1s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">simulationDuration</span> <span class="o">=</span> <span class="n">directionDuration</span> <span class="o">*</span> <span class="n">remainingFraction</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Already at target, don&#39;t animate.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">simulationDuration</span> <span class="o">=</span> <span class="n">Duration</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 停止运行该动画。这不会触发任何通知。动画停止在当前状态。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">stop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 因为simulationDuration为1s，所以这里不执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">simulationDuration</span> <span class="o">==</span> <span class="n">Duration</span><span class="p">.</span><span class="n">zero</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_value</span> <span class="o">=</span> <span class="n">clampDouble</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">lowerBound</span><span class="p">,</span> <span class="n">upperBound</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">notifyListeners</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">_direction</span> <span class="o">==</span> <span class="n">_AnimationDirection</span><span class="p">.</span><span class="n">forward</span><span class="p">)</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">      <span class="n">AnimationStatus</span><span class="p">.</span><span class="n">completed</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">AnimationStatus</span><span class="p">.</span><span class="n">dismissed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_checkStatusChanged</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">TickerFuture</span><span class="p">.</span><span class="n">complete</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">simulationDuration</span> <span class="o">&gt;</span> <span class="n">Duration</span><span class="p">.</span><span class="n">zero</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">isAnimating</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行_startSimulation方法，并且创建_InterpolationSimulation实例并作为参数传入该方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">_startSimulation</span><span class="p">(</span><span class="n">_InterpolationSimulation</span><span class="p">(</span><span class="n">_value</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">simulationDuration</span><span class="p">,</span> <span class="n">curve</span><span class="p">,</span> <span class="n">scale</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>AnimationController</em>的 <em>_animateToInternal</em> 方法中，执行了 <em>_startSimulation</em> 方法，并且创建 <em>_InterpolationSimulation</em> 实例并作为参数传入该方法。</p>
<p>继续跟踪<em>AnimationController</em>的 <em>_startSimulation</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">TickerFuture</span> <span class="n">_startSimulation</span><span class="p">(</span><span class="n">Simulation</span> <span class="n">simulation</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">isAnimating</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 将前面创建的_InterpolationSimulation实例赋值给成员变量_simulation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_simulation</span> <span class="o">=</span> <span class="n">simulation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 初始化动画上一帧的时间，动画还没开始，所以为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_lastElapsedDuration</span> <span class="o">=</span> <span class="n">Duration</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 计算_value，也就是外部使用的_animation.value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// clampDouble主要对simulation.x(0.0)这个结果做了大小限制（lowerBound &lt;= 结果 &lt;= upperBound）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 此处执行的是_InterpolationSimulation的x方法，_value的最终计算结果为0.0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_value</span> <span class="o">=</span> <span class="n">clampDouble</span><span class="p">(</span><span class="n">simulation</span><span class="p">.</span><span class="n">x</span><span class="p">(</span><span class="m">0.0</span><span class="p">),</span> <span class="n">lowerBound</span><span class="p">,</span> <span class="n">upperBound</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 启动Ticker，每个动画帧均会调用一次回调，这个等下再分析
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">TickerFuture</span> <span class="n">result</span> <span class="o">=</span> <span class="n">_ticker</span><span class="o">!</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 因为_direction为_AnimationDirection.forward，所以此时_status状态为AnimationStatus.forward
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">_direction</span> <span class="o">==</span> <span class="n">_AnimationDirection</span><span class="p">.</span><span class="n">forward</span><span class="p">)</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">      <span class="n">AnimationStatus</span><span class="p">.</span><span class="n">forward</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">AnimationStatus</span><span class="p">.</span><span class="n">reverse</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 调用所有状态监听器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_checkStatusChanged</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 最后将TickerFuture返回，但是本示例中没用到，这里就不讲解了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>关于<em>simulation.x(0.0)</em>，这里分析下，它执行了 <em>_InterpolationSimulation</em> 的x方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// _InterpolationSimulation的作用就是将Engine层返回的每一帧时间转换为[0.0, 1.0]范围的数值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">class</span> <span class="nc">_InterpolationSimulation</span> <span class="kd">extends</span> <span class="n">Simulation</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _begin传入的是_value，它的值为0.0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _end传入的是target，它的值为1.0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// duration传入的是simulationDuration，它的值为1s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _curve传入的是curve，它的值为Curves.linear
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// scale传入的是scale，它的值为1.0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_InterpolationSimulation</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">_begin</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">_end</span><span class="p">,</span> <span class="n">Duration</span> <span class="n">duration</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">_curve</span><span class="p">,</span> <span class="kt">double</span> <span class="n">scale</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="k">assert</span><span class="p">(</span><span class="n">duration</span><span class="p">.</span><span class="n">inMicroseconds</span> <span class="o">&gt;</span> <span class="m">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// duration.inMicroseconds表示获取微秒数，所以1s的微秒数为1000000，microsecondsPerSecond表示每秒的微秒数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 结合传入的参数值，那么_durationInSeconds最终的计算结果为1s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">_durationInSeconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">duration</span><span class="p">.</span><span class="n">inMicroseconds</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span> <span class="o">/</span> <span class="n">Duration</span><span class="p">.</span><span class="n">microsecondsPerSecond</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">double</span> <span class="n">_durationInSeconds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">double</span> <span class="n">_begin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">double</span> <span class="n">_end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Curve</span> <span class="n">_curve</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">double</span> <span class="n">x</span><span class="p">(</span><span class="kt">double</span> <span class="n">timeInSeconds</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 外部调用simulation.x(0.0)时传入0.0，所以此处timeInSeconds为0.0，所以t最终的计算结果为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="kt">double</span> <span class="n">t</span> <span class="o">=</span> <span class="n">clampDouble</span><span class="p">(</span><span class="n">timeInSeconds</span> <span class="o">/</span> <span class="n">_durationInSeconds</span><span class="p">,</span> <span class="m">0.0</span><span class="p">,</span> <span class="m">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 因为t为0，所以执行这里，返回_begin，它的值为0.0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="m">0.0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">_begin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="m">1.0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">_end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">_begin</span> <span class="o">+</span> <span class="p">(</span><span class="n">_end</span> <span class="o">-</span> <span class="n">_begin</span><span class="p">)</span> <span class="o">*</span> <span class="n">_curve</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>关于 <em>_checkStatusChanged</em> 方法，这里分析下。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">AnimationStatus</span> <span class="n">_lastReportedStatus</span> <span class="o">=</span> <span class="n">AnimationStatus</span><span class="p">.</span><span class="n">dismissed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_checkStatusChanged</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 因为在_startSimulation方法中，_status已经被赋值为AnimationStatus.forward，所以这里将成员变量_status赋值给status，那么此时newStatus的值为AnimationStatus.forward
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">AnimationStatus</span> <span class="n">newStatus</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// _lastReportedStatus的默认值为AnimationStatus.dismissed，所以if判断不相等，此处执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">_lastReportedStatus</span> <span class="o">!=</span> <span class="n">newStatus</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_lastReportedStatus</span> <span class="o">=</span> <span class="n">newStatus</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 将newStatus通知给所有已注册的状态监听器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">notifyStatusListeners</span><span class="p">(</span><span class="n">newStatus</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为<em>AnimationController</em>混入了<em>AnimationLocalStatusListenersMixin</em>，所以这里的<em>notifyStatusListeners</em>方法执行的是<em>AnimationLocalStatusListenersMixin</em>的<em>notifyStatusListeners</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">notifyStatusListeners</span><span class="p">(</span><span class="n">AnimationStatus</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">AnimationStatusListener</span><span class="o">&gt;</span> <span class="n">localListeners</span> <span class="o">=</span> <span class="n">_statusListeners</span><span class="p">.</span><span class="n">toList</span><span class="p">(</span><span class="nl">growable:</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">AnimationStatusListener</span> <span class="n">listener</span> <span class="k">in</span> <span class="n">localListeners</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 遍历所有AnimationStatusListener，将status回调出去
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">_statusListeners</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">listener</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">listener</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">InformationCollector</span><span class="o">?</span> <span class="n">collector</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">collector</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="n">DiagnosticsNode</span><span class="o">&gt;</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="n">DiagnosticsProperty</span><span class="o">&lt;</span><span class="n">AnimationLocalStatusListenersMixin</span><span class="o">&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;The </span><span class="si">$</span><span class="n">runtimeType</span><span class="s1"> notifying status listeners was&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nl">style:</span> <span class="n">DiagnosticsTreeStyle</span><span class="p">.</span><span class="n">errorProperty</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}());</span>
</span></span><span class="line"><span class="cl">      <span class="n">FlutterError</span><span class="p">.</span><span class="n">reportError</span><span class="p">(</span><span class="n">FlutterErrorDetails</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">exception:</span> <span class="n">exception</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">stack:</span> <span class="n">stack</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="k">library</span><span class="o">:</span> <span class="s1">&#39;animation library&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">context:</span> <span class="n">ErrorDescription</span><span class="p">(</span><span class="s1">&#39;while notifying status listeners for </span><span class="si">$</span><span class="n">runtimeType</span><span class="s1">&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">informationCollector:</span> <span class="n">collector</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>先回到 <em>_startSimulation</em> 方法上来，其实整个 <em>_startSimulation</em> 方法的重点是<code>_ticker!.start()</code>，因为它启动了动画，那么 <em>_ticker</em> 是什么？又在哪创建的？</p>
<h2 id="52animationcontroller的构造方法">5.2、<em>AnimationController</em>的构造方法</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">AnimationController</span> <span class="kd">extends</span> <span class="n">Animation</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">with</span> <span class="n">AnimationEagerListenerMixin</span><span class="p">,</span> <span class="n">AnimationLocalListenersMixin</span><span class="p">,</span> <span class="n">AnimationLocalStatusListenersMixin</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">AnimationController</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span><span class="o">?</span> <span class="n">value</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">duration</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">reverseDuration</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">debugLabel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">lowerBound</span> <span class="o">=</span> <span class="m">0.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">upperBound</span> <span class="o">=</span> <span class="m">1.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">animationBehavior</span> <span class="o">=</span> <span class="n">AnimationBehavior</span><span class="p">.</span><span class="n">normal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kd">required</span> <span class="n">TickerProvider</span> <span class="n">vsync</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span> <span class="o">:</span> <span class="k">assert</span><span class="p">(</span><span class="n">upperBound</span> <span class="o">&gt;=</span> <span class="n">lowerBound</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">       <span class="n">_direction</span> <span class="o">=</span> <span class="n">_AnimationDirection</span><span class="p">.</span><span class="n">forward</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 此处执行了TickerProvider的createTicker方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_ticker</span> <span class="o">=</span> <span class="n">vsync</span><span class="p">.</span><span class="n">createTicker</span><span class="p">(</span><span class="n">_tick</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_internalSetValue</span><span class="p">(</span><span class="n">value</span> <span class="o">??</span> <span class="n">lowerBound</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>AnimationController</em>的构造方法中，执行了<em>vsync.createTicker(_tick)<em>这行代码，也就是执行了</em>TickerProvider</em>的<em>createTicker</em>方法，而<em>createTicker</em>方法需要传入的参数是一个<em>TickerCallback</em>，这里传入的实参为<em>AnimationController</em>的 <em>_tick</em> 方法。</p>
<p>在本示例中，<em>vsync</em>参数传入的是<em>this</em>，即混入的<em>SingleTickerProviderStateMixin</em>，它是专门用来提供和管理单个<em>Ticker</em>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">_MyWidgetState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">MyWidget</span><span class="o">&gt;</span> <span class="kd">with</span> <span class="n">SingleTickerProviderStateMixin</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">late</span> <span class="n">AnimationController</span> <span class="n">_animationController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">late</span> <span class="n">Animation</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">_animation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">initState</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">initState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_animationController</span> <span class="o">=</span> <span class="n">AnimationController</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 传入this，即混入的SingleTickerProviderStateMixin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nl">vsync:</span> <span class="k">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">duration:</span> <span class="kd">const</span> <span class="n">Duration</span><span class="p">(</span><span class="nl">seconds:</span> <span class="m">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">reverseDuration:</span> <span class="kd">const</span> <span class="n">Duration</span><span class="p">(</span><span class="nl">seconds:</span> <span class="m">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>因此，<em>vsync.createTicker</em>实际上执行了<em>SingleTickerProviderStateMixin</em>的<em>createTicker</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">mixin</span> <span class="n">SingleTickerProviderStateMixin</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span><span class="o">&gt;</span> <span class="n">on</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">TickerProvider</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">Ticker</span><span class="o">?</span> <span class="n">_ticker</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"> <span class="n">Ticker</span> <span class="n">createTicker</span><span class="p">(</span><span class="n">TickerCallback</span> <span class="n">onTick</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="p">(</span><span class="n">_ticker</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="k">throw</span> <span class="n">FlutterError</span><span class="p">.</span><span class="n">fromParts</span><span class="p">(</span><span class="o">&lt;</span><span class="n">DiagnosticsNode</span><span class="o">&gt;</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">       <span class="n">ErrorSummary</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">$</span><span class="n">runtimeType</span><span class="s1"> is a SingleTickerProviderStateMixin but multiple tickers were created.&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">       <span class="n">ErrorDescription</span><span class="p">(</span><span class="s1">&#39;A SingleTickerProviderStateMixin can only be used as a TickerProvider once.&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">       <span class="n">ErrorHint</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">         <span class="s1">&#39;If a State is used for multiple AnimationController objects, or if it is passed to other &#39;</span>
</span></span><span class="line"><span class="cl">         <span class="s1">&#39;objects and those objects might use it more than one time in total, then instead of &#39;</span>
</span></span><span class="line"><span class="cl">         <span class="s1">&#39;mixing in a SingleTickerProviderStateMixin, use a regular TickerProviderStateMixin.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="p">),</span>
</span></span><span class="line"><span class="cl">     <span class="p">]);</span>
</span></span><span class="line"><span class="cl">   <span class="p">}());</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// 这里创建了Ticker实例并赋值给成员变量_ticker
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// 此处Ticker构造方法传入的参数onTick，它的实例是AnimationController的_tick方法。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">_ticker</span> <span class="o">=</span> <span class="n">Ticker</span><span class="p">(</span><span class="n">onTick</span><span class="p">,</span> <span class="nl">debugLabel:</span> <span class="n">kDebugMode</span> <span class="o">?</span> <span class="s1">&#39;created by </span><span class="si">${</span><span class="n">describeIdentity</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="n">_updateTickerModeNotifier</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">   <span class="n">_updateTicker</span><span class="p">();</span> <span class="c1">// Sets _ticker.mute correctly.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// 把Ticker实例返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">return</span> <span class="n">_ticker</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>当 <em>_startSimulation</em> 方法执行了 <em>_ticker!.start()</em> 时，就会执行上面创建的 <em>_ticker</em> 的<em>start</em>方法，跟踪下<em>Ticker</em>的<em>start</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">TickerFuture</span> <span class="n">start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="n">isActive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">throw</span> <span class="n">FlutterError</span><span class="p">.</span><span class="n">fromParts</span><span class="p">(</span><span class="o">&lt;</span><span class="n">DiagnosticsNode</span><span class="o">&gt;</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">       <span class="n">ErrorSummary</span><span class="p">(</span><span class="s1">&#39;A ticker was started twice.&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">       <span class="n">ErrorDescription</span><span class="p">(</span><span class="s1">&#39;A ticker that is already active cannot be started again without first stopping it.&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">       <span class="n">describeForError</span><span class="p">(</span><span class="s1">&#39;The affected ticker was&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">     <span class="p">]);</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}());</span>
</span></span><span class="line"><span class="cl"> <span class="k">assert</span><span class="p">(</span><span class="n">_startTime</span> <span class="o">==</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// 此处创建了一个TickerFuture对象，表示正在进行的Ticker序列的对象。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="c1">// Ticker.start方法返回一个TickerFuture。如果使用Ticker.stop停止Ticker ，并将canceled参数设置为 false（默认值），则TickerFuture将成功完成。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="c1">// 如果Ticker在未停止的情况下被处置，或者如果在canceled设置为 true 的情况下停止，则此 Future 将永远不会完成
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">_future</span> <span class="o">=</span> <span class="n">TickerFuture</span><span class="p">.</span><span class="n">_</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// shouldScheduleTick表示是否应该安排一个tick
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="c1">// 不应安排tick的原因包括：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="c1">// 1、已经为下一帧安排了一个tick
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="c1">// 2、ticker未激活（尚未调用start）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="c1">// 3、ticker没有在ticking，例如因为它被muted （请参阅isTicking ）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="c1">// 通过断点调试来看，此处shouldScheduleTick为true，所以执行了scheduleTick方法。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="k">if</span> <span class="p">(</span><span class="n">shouldScheduleTick</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">scheduleTick</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// schedulerPhase表示调度程序当前运行的阶段，通过断点调试来看，SchedulerBinding.instance.schedulerPhase.index的值为0，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="c1">// 也就是schedulerPhase所处状态为idle，所以SchedulerBinding.instance.schedulerPhase.index &gt; SchedulerPhase.idle.index不满足，不会执行这里代码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="k">if</span> <span class="p">(</span><span class="n">SchedulerBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">schedulerPhase</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">SchedulerPhase</span><span class="p">.</span><span class="n">idle</span><span class="p">.</span><span class="n">index</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">     <span class="n">SchedulerBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">schedulerPhase</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">SchedulerPhase</span><span class="p">.</span><span class="n">postFrameCallbacks</span><span class="p">.</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">_startTime</span> <span class="o">=</span> <span class="n">SchedulerBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">currentFrameTimeStamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// 返回一个TickerFuture对象，此处的返回就是forward方法的返回值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="k">return</span> <span class="n">_future</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>Ticker</em>的<em>start</em>方法中，执行了<em>scheduleTick</em>方法，跟踪看看。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// scheduleTick方法的作用是为下一帧安排一个tick
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">scheduleTick</span><span class="p">({</span> <span class="kt">bool</span> <span class="n">rescheduling</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">scheduled</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">shouldScheduleTick</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行了SchedulerBinding的scheduleFrameCallback方法，该方法需要传入一个FrameCallback实例，该实例就是Ticker的_tick方法。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_animationId</span> <span class="o">=</span> <span class="n">SchedulerBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">scheduleFrameCallback</span><span class="p">(</span><span class="n">_tick</span><span class="p">,</span> <span class="nl">rescheduling:</span> <span class="n">rescheduling</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>先看下<em>SchedulerBinding</em>的<em>scheduleFrameCallback</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">scheduleFrameCallback</span><span class="p">(</span><span class="n">FrameCallback</span> <span class="n">callback</span><span class="p">,</span> <span class="p">{</span> <span class="kt">bool</span> <span class="n">rescheduling</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行了scheduleFrame方法。调用dart:ui.PlatformDispatcher.scheduleFrame来安排新帧
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 调用此函数后，引擎将（最终）调用handleBeginFrame 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">scheduleFrame</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 下一帧回调实例的Id，此处+1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_nextFrameCallbackId</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 将callback包装成_FrameCallbackEntry对象，存入瞬态回调Map集合_transientCallbacks中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_transientCallbacks</span><span class="p">[</span><span class="n">_nextFrameCallbackId</span><span class="p">]</span> <span class="o">=</span> <span class="n">_FrameCallbackEntry</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="nl">rescheduling:</span> <span class="n">rescheduling</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">_nextFrameCallbackId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>SchedulerBinding</em>的<em>scheduleFrame</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">scheduleFrame</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_hasScheduledFrame</span> <span class="o">||</span> <span class="o">!</span><span class="n">framesEnabled</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">debugPrintScheduleFrameStacks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">debugPrintStack</span><span class="p">(</span><span class="nl">label:</span> <span class="s1">&#39;scheduleFrame() called. Current phase is </span><span class="si">$</span><span class="n">schedulerPhase</span><span class="s1">.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}());</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行ensureFrameCallbacksRegistered方法，确保PlatformDispatcher.onBeginFrame和PlatformDispatcher.onDrawFrame的回调已注册
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ensureFrameCallbacksRegistered</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行platformDispatcher的scheduleFrame，请求在下一个适当的机会调用onBeginFrame和onDrawFrame回调
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">platformDispatcher</span><span class="p">.</span><span class="n">scheduleFrame</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">_hasScheduledFrame</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>ensureFrameCallbacksRegistered</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ensureFrameCallbacksRegistered</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 为platformDispatcher的onBeginFrame注册回调，这里具体实现是_handleBeginFrame方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">platformDispatcher</span><span class="p">.</span><span class="n">onBeginFrame</span> <span class="o">??=</span> <span class="n">_handleBeginFrame</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 为platformDispatcher的onDrawFrame注册回调，这里具体实现是_handleDrawFrame方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">platformDispatcher</span><span class="p">.</span><span class="n">onDrawFrame</span> <span class="o">??=</span> <span class="n">_handleDrawFrame</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>再看下<em>platformDispatcher.scheduleFrame()</em>，这里是<em>external</em>修饰，说明调用了<em>Engine</em>层的方法了，它在不同平台有不同实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// 请求在下一个适当的机会调用onBeginFrame和onDrawFrame回调。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">scheduleFrame</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="n">_scheduleFrame</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">Native</span><span class="o">&lt;</span><span class="n">Void</span> <span class="n">Function</span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="nl">symbol:</span> <span class="s1">&#39;PlatformConfigurationNativeApi::ScheduleFrame&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">external</span> <span class="kd">static</span> <span class="kt">void</span> <span class="n">_scheduleFrame</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里就不深入底层实现了，不过可以猜测，在<em>Android</em>中应该是调用了<em>Choreographer</em>注册了<em>Vysnc</em>信号监听，然后再回调给<em>Flutter</em>，具体留给你们去验证了。</p>
<p>等到<em>Engine</em>层处理完成，将会回调给<em>Framework</em>层的 <em>_beginFrame</em> 方法，在 <em>_beginFrame</em> 方法中执行了<em>PlatformDispatcher</em>的 <em>_beginFrame</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">pragma</span><span class="p">(</span><span class="s1">&#39;vm:entry-point&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_beginFrame</span><span class="p">(</span><span class="kt">int</span> <span class="n">microseconds</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frameNumber</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">PlatformDispatcher</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">_beginFrame</span><span class="p">(</span><span class="n">microseconds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">PlatformDispatcher</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">_updateFrameData</span><span class="p">(</span><span class="n">frameNumber</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>PlatformDispatcher</em>的 <em>_beginFrame</em> 方法中，执行了 <em>_invoke1</em> 方法，第一个参数传入的是<em>onBeginFrame</em>回调，这个就是之前讲过的<em>SchedulerBinding</em>的<em>ensureFrameCallbacksRegistered</em>方法中注册的回调。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_beginFrame</span><span class="p">(</span><span class="kt">int</span> <span class="n">microseconds</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_invoke1</span><span class="o">&lt;</span><span class="n">Duration</span><span class="o">&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 此处传入onBeginFrame
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">onBeginFrame</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_onBeginFrameZone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">Duration</span><span class="p">(</span><span class="nl">microseconds:</span> <span class="n">microseconds</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>来看下 <em>_invoke1</em> 方法，执行了<em>callback()</em>，也就是调用了<em>onBeginFrame</em>的回调引用，那么就会触发<em>SchedulerBinding</em>的 <em>_handleBeginFrame</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_invoke1</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">(</span><span class="kt">void</span> <span class="n">Function</span><span class="p">(</span><span class="n">A</span> <span class="n">a</span><span class="p">)</span><span class="o">?</span> <span class="n">callback</span><span class="p">,</span> <span class="n">Zone</span> <span class="n">zone</span><span class="p">,</span> <span class="n">A</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">callback</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">identical</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">Zone</span><span class="p">.</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 此处调用外部方法引用，传入参数是arg，也就是一个Duration，这个时间是每一帧的时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">callback</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">zone</span><span class="p">.</span><span class="n">runUnaryGuarded</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>继续看<em>SchedulerBinding</em>的 <em>_handleBeginFrame</em> 方法，执行了<em>handleBeginFrame</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">handleBeginFrame</span><span class="p">(</span><span class="n">Duration</span><span class="o">?</span> <span class="n">rawTimeStamp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_frameTimelineTask</span><span class="o">?</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;Frame&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_firstRawTimeStampInEpoch</span> <span class="o">??=</span> <span class="n">rawTimeStamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_currentFrameTimeStamp</span> <span class="o">=</span> <span class="n">_adjustForEpoch</span><span class="p">(</span><span class="n">rawTimeStamp</span> <span class="o">??</span> <span class="n">_lastRawTimeStamp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">rawTimeStamp</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_lastRawTimeStamp</span> <span class="o">=</span> <span class="n">rawTimeStamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_debugFrameNumber</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">debugPrintBeginFrameBanner</span> <span class="o">||</span> <span class="n">debugPrintEndFrameBanner</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="n">StringBuffer</span> <span class="n">frameTimeStampDescription</span> <span class="o">=</span> <span class="n">StringBuffer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">rawTimeStamp</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_debugDescribeTimeStamp</span><span class="p">(</span><span class="n">_currentFrameTimeStamp</span><span class="o">!</span><span class="p">,</span> <span class="n">frameTimeStampDescription</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">frameTimeStampDescription</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;(warm-up frame)&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">_debugBanner</span> <span class="o">=</span> <span class="s1">&#39;▄▄▄▄▄▄▄▄ Frame </span><span class="si">${</span><span class="n">_debugFrameNumber</span><span class="p">.</span><span class="n">toString</span><span class="p">().</span><span class="n">padRight</span><span class="p">(</span><span class="m">7</span><span class="p">)</span><span class="si">}</span><span class="s1">   </span><span class="si">${</span><span class="n">frameTimeStampDescription</span><span class="p">.</span><span class="n">toString</span><span class="p">().</span><span class="n">padLeft</span><span class="p">(</span><span class="m">18</span><span class="p">)</span><span class="si">}</span><span class="s1"> ▄▄▄▄▄▄▄▄&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">debugPrintBeginFrameBanner</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">debugPrint</span><span class="p">(</span><span class="n">_debugBanner</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">schedulerPhase</span> <span class="o">==</span> <span class="n">SchedulerPhase</span><span class="p">.</span><span class="n">idle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_hasScheduledFrame</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TRANSIENT FRAME CALLBACKS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_frameTimelineTask</span><span class="o">?</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="s1">&#39;Animate&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_schedulerPhase</span> <span class="o">=</span> <span class="n">SchedulerPhase</span><span class="p">.</span><span class="n">transientCallbacks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">_FrameCallbackEntry</span><span class="o">&gt;</span> <span class="n">callbacks</span> <span class="o">=</span> <span class="n">_transientCallbacks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_transientCallbacks</span> <span class="o">=</span> <span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">_FrameCallbackEntry</span><span class="o">&gt;</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 此处遍历执行_transientCallbacks，也就是传入的Ticker的_tick方法实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">callbacks</span><span class="p">.</span><span class="n">forEach</span><span class="p">((</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">_FrameCallbackEntry</span> <span class="n">callbackEntry</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_removedIds</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_invokeFrameCallback</span><span class="p">(</span><span class="n">callbackEntry</span><span class="p">.</span><span class="n">callback</span><span class="p">,</span> <span class="n">_currentFrameTimeStamp</span><span class="o">!</span><span class="p">,</span> <span class="n">callbackEntry</span><span class="p">.</span><span class="n">debugStack</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">_removedIds</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_schedulerPhase</span> <span class="o">=</span> <span class="n">SchedulerPhase</span><span class="p">.</span><span class="n">midFrameMicrotasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>Ticker</em>的 <em>_tick</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_tick</span><span class="p">(</span><span class="n">Duration</span> <span class="n">timeStamp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">isTicking</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">scheduled</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_animationId</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">_startTime</span> <span class="o">??=</span> <span class="n">timeStamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行了SingleTickerProviderStateMixin的createTicker方法中传入的onTick参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 也就是执行了AnimationController构造方法中的vsync.createTicker(_tick)传入的_tick方法实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_onTick</span><span class="p">(</span><span class="n">timeStamp</span> <span class="o">-</span> <span class="n">_startTime</span><span class="o">!</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// The onTick callback may have scheduled another tick already, for
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// example by calling stop then start again.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">shouldScheduleTick</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">scheduleTick</span><span class="p">(</span><span class="nl">rescheduling:</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>AnimationController</em>的 <em>_tick</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// elapsed是Engine层返回的每一帧时间Duration，每一帧的时间都不一样
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">_tick</span><span class="p">(</span><span class="n">Duration</span> <span class="n">elapsed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_lastElapsedDuration</span> <span class="o">=</span> <span class="n">elapsed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 将拿到的每一帧的时间单位改为秒
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="kt">double</span> <span class="n">elapsedInSeconds</span> <span class="o">=</span> <span class="n">elapsed</span><span class="p">.</span><span class="n">inMicroseconds</span><span class="p">.</span><span class="n">toDouble</span><span class="p">()</span> <span class="o">/</span> <span class="n">Duration</span><span class="p">.</span><span class="n">microsecondsPerSecond</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">elapsedInSeconds</span> <span class="o">&gt;=</span> <span class="m">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行clampDouble方法获取_value，此时的_value依然是_simulation控制，也就是_InterpolationSimulation实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_value</span> <span class="o">=</span> <span class="n">clampDouble</span><span class="p">(</span><span class="n">_simulation</span><span class="o">!</span><span class="p">.</span><span class="n">x</span><span class="p">(</span><span class="n">elapsedInSeconds</span><span class="p">),</span> <span class="n">lowerBound</span><span class="p">,</span> <span class="n">upperBound</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 等到elapsedInSeconds时间达到我们设定的动画时间Duration，也就是本示例中的1s，表示动画执行完成
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">_simulation</span><span class="o">!</span><span class="p">.</span><span class="n">isDone</span><span class="p">(</span><span class="n">elapsedInSeconds</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 如果_direction是_AnimationDirection.forward，更改_status为AnimationStatus.completed，否则改为AnimationStatus.dismissed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">_direction</span> <span class="o">==</span> <span class="n">_AnimationDirection</span><span class="p">.</span><span class="n">forward</span><span class="p">)</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">      <span class="n">AnimationStatus</span><span class="p">.</span><span class="n">completed</span> <span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">AnimationStatus</span><span class="p">.</span><span class="n">dismissed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 停止当前动画，移除当前瞬态帧回调，那么_tick方法就不会被再回调执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">stop</span><span class="p">(</span><span class="nl">canceled:</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行notifyListeners方法，通知所有listeners回调
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">notifyListeners</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行_checkStatusChanged，通知所有status listeners回调
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_checkStatusChanged</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>至此，<em>forward</em>方法完成了第一帧动画的初始操作，可以说它启动了动画。等到在<em>addListener</em>方法中执行<em>setState</em>方法时，就会触发下一轮 <em>_tick</em> 方法的执行以及<em>build</em>方法的执行，这样一帧一帧执行直到动画完成。</p>
<p>关于<em>setState</em>方法的分析参考<a href="https://anddevmk.github.io/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Bsetstate/"><em>解读Flutter源码之setState</em></a>一文。</p>
<h2 id="53_animationvalue">5.3、<em>_animation.value</em></h2>
<p>通过 <em>_animation.value</em> 最初拿到的是<em>AnimationController</em>的 <em>_value</em>，也就是上面 <em>_tick</em> 方法中计算出来的 <em>_value</em>，为什么这么说呢？看下面分析就知道了。</p>
<p>在本示例中，<em>CurvedAnimation</em>的构造方法将 <em>_animationController</em> 作为参数传了进去。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">_animation</span> <span class="o">=</span> <span class="n">CurvedAnimation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 传入_animationController
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">parent:</span> <span class="n">_animationController</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">curve:</span> <span class="n">Curves</span><span class="p">.</span><span class="n">easeIn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">reverseCurve:</span> <span class="n">Curves</span><span class="p">.</span><span class="n">bounceIn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以发现<em>CurvedAnimation</em>混入了<em>AnimationWithParentMixin</em>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">CurvedAnimation</span> <span class="kd">extends</span> <span class="n">Animation</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="kd">with</span> <span class="n">AnimationWithParentMixin</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">CurvedAnimation</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="kd">required</span> <span class="k">this</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kd">required</span> <span class="k">this</span><span class="p">.</span><span class="n">curve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">reverseCurve</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 根据_animationController的初始状态，更新Curved曲线的方向
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_updateCurveDirection</span><span class="p">(</span><span class="n">parent</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 给_animationController注册状态监听，用来更新后续Curved曲线的方向
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">parent</span><span class="p">.</span><span class="n">addStatusListener</span><span class="p">(</span><span class="n">_updateCurveDirection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Animation</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">parent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>AnimationWithParentMixin</em>，可以发现此时的<em>listeners</em>管理以及<em>status</em>依然是转发给<em>parent</em>处理，也就是还是由<em>AnimationController</em>来管理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">mixin</span> <span class="n">AnimationWithParentMixin</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Animation</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">get</span> <span class="n">parent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">addListener</span><span class="p">(</span><span class="n">VoidCallback</span> <span class="n">listener</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">parent</span><span class="p">.</span><span class="n">addListener</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">removeListener</span><span class="p">(</span><span class="n">VoidCallback</span> <span class="n">listener</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">parent</span><span class="p">.</span><span class="n">removeListener</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">addStatusListener</span><span class="p">(</span><span class="n">AnimationStatusListener</span> <span class="n">listener</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">parent</span><span class="p">.</span><span class="n">addStatusListener</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">removeStatusListener</span><span class="p">(</span><span class="n">AnimationStatusListener</span> <span class="n">listener</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">parent</span><span class="p">.</span><span class="n">removeStatusListener</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">AnimationStatus</span> <span class="kd">get</span> <span class="n">status</span> <span class="o">=&gt;</span> <span class="n">parent</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>但是，<em>CurvedAnimation</em>重写了<em>AnimationController</em>成员变量<em>value</em>，可以看到在<em>value</em>中拿到<em>parent.value</em>后，执行了 <em>activeCurve.transform(t)</em> 进行转换。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">double</span> <span class="kd">get</span> <span class="n">value</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 获取Curves曲线的方向
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Curve</span><span class="o">?</span> <span class="n">activeCurve</span> <span class="o">=</span> <span class="n">_useForwardCurve</span> <span class="o">?</span> <span class="n">curve</span> <span class="o">:</span> <span class="n">reverseCurve</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 获取AnimationController的value值，这个值之前由simulation计算得来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="kt">double</span> <span class="n">t</span> <span class="o">=</span> <span class="n">parent</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">activeCurve</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 控制动画范围
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="m">0.0</span> <span class="o">||</span> <span class="n">t</span> <span class="o">==</span> <span class="m">1.0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="kt">double</span> <span class="n">transformedValue</span> <span class="o">=</span> <span class="n">activeCurve</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="kt">double</span> <span class="n">roundedTransformedValue</span> <span class="o">=</span> <span class="n">transformedValue</span><span class="p">.</span><span class="n">round</span><span class="p">().</span><span class="n">toDouble</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">roundedTransformedValue</span> <span class="o">!=</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">FlutterError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="s1">&#39;Invalid curve endpoint at </span><span class="si">$</span><span class="n">t</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">          <span class="s1">&#39;Curves must map 0.0 to near zero and 1.0 to near one but &#39;</span>
</span></span><span class="line"><span class="cl">          <span class="s1">&#39;</span><span class="si">${</span><span class="n">activeCurve</span><span class="p">.</span><span class="n">runtimeType</span><span class="si">}</span><span class="s1"> mapped </span><span class="si">$</span><span class="n">t</span><span class="s1"> to </span><span class="si">$</span><span class="n">transformedValue</span><span class="s1">, which &#39;</span>
</span></span><span class="line"><span class="cl">          <span class="s1">&#39;is near </span><span class="si">$</span><span class="n">roundedTransformedValue</span><span class="s1">.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行Curve转换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">activeCurve</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里执行了<em>Curve</em>的父类<em>ParametricCurve</em>的<em>transform</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Curve</span> <span class="kd">extends</span> <span class="n">ParametricCurve</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">Curve</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">double</span> <span class="n">transform</span><span class="p">(</span><span class="kt">double</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 控制动画范围
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="m">0.0</span> <span class="o">||</span> <span class="n">t</span> <span class="o">==</span> <span class="m">1.0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行父类ParametricCurve的transform方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="k">super</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>ParametricCurve</em>的<em>transform</em>方法中，执行了<em>transformInternal</em>方法，该方法由子类实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ParametricCurve</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">ParametricCurve</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">T</span> <span class="n">transform</span><span class="p">(</span><span class="kt">double</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="m">0.0</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="m">1.0</span><span class="p">,</span> <span class="s1">&#39;parametric value </span><span class="si">$</span><span class="n">t</span><span class="s1"> is outside of [0, 1] range.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行transformInternal方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">transformInternal</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl">  <span class="n">T</span> <span class="n">transformInternal</span><span class="p">(</span><span class="kt">double</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="n">UnimplementedError</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在本示例中，对于动画的方向是正向的，<em>CurvedAnimation</em>构造方法中传入的子类是<em>Curves.easeIn</em>；对于动画的方向是反向的，<em>CurvedAnimation</em>构造方法中传入的子类是<em>Curves.bounceIn</em>。因为本示例只讲解<em>forward</em>方法，所以这里只以<em>Curves.easeIn</em>为例讲解，看下源码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kd">const</span> <span class="n">Cubic</span> <span class="n">easeIn</span> <span class="o">=</span> <span class="n">Cubic</span><span class="p">(</span><span class="m">0.42</span><span class="p">,</span> <span class="m">0.0</span><span class="p">,</span> <span class="m">1.0</span><span class="p">,</span> <span class="m">1.0</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>Cubic</em>实现的<em>transformInternal</em>方法。它是返回点t处的曲线值。但是给定的参数值t将介于 0.0 和 1.0 之间（包含 0.0 和 1.0），那和我们实际<em>Widget</em>的参数映射还是不一致，比如本示例中<em>Icon</em>的<em>size</em>参数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">double</span> <span class="n">transformInternal</span><span class="p">(</span><span class="kt">double</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">double</span> <span class="n">start</span> <span class="o">=</span> <span class="m">0.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">double</span> <span class="n">end</span> <span class="o">=</span> <span class="m">1.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">double</span> <span class="n">midpoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">end</span><span class="p">)</span> <span class="o">/</span> <span class="m">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">double</span> <span class="n">estimate</span> <span class="o">=</span> <span class="n">_evaluateCubic</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">midpoint</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">t</span> <span class="o">-</span> <span class="n">estimate</span><span class="p">).</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">_cubicErrorBound</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">_evaluateCubic</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">midpoint</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">estimate</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">start</span> <span class="o">=</span> <span class="n">midpoint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">end</span> <span class="o">=</span> <span class="n">midpoint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>想要和我们实际<em>Widget</em>的参数映射一致，就需要讲到<em>Tween</em>了，看下本示例中的实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">_animation</span> <span class="o">=</span> <span class="n">Tween</span><span class="p">(</span><span class="nl">begin:</span> <span class="m">200.0</span><span class="p">,</span> <span class="nl">end:</span> <span class="m">300.0</span><span class="p">).</span><span class="n">animate</span><span class="p">(</span><span class="n">_animation</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>Tween</em>的<em>animate</em>方法，方法参数传入了上一步创建的<em>CurvedAnimation</em>，返回的是 <em>_AnimatedEvaluation</em> 实例。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">Animation</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">animate</span><span class="p">(</span><span class="n">Animation</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">_AnimatedEvaluation</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下 <em>_AnimatedEvaluation</em>实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">_AnimatedEvaluation</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">Animation</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">with</span> <span class="n">AnimationWithParentMixin</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_AnimatedEvaluation</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">_evaluatable</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Animation</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">parent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Animatable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">_evaluatable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">T</span> <span class="kd">get</span> <span class="n">value</span> <span class="o">=&gt;</span> <span class="n">_evaluatable</span><span class="p">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到 <em>_AnimatedEvaluation</em> 继承自<em>Animation</em>，和<em>CurvedAnimation</em>一样混入了<em>AnimationWithParentMixin</em>，此时的<em>listeners</em>管理以及<em>status</em>是转发给<em>parent</em>处理，也就是<em>CurvedAnimation</em>。</p>
<p>而且 <em>_AnimatedEvaluation</em> 重写了<em>AnimationController</em>成员变量<em>value</em>，当执行 <em>_animation.value</em>时就会调用该<em>value</em>。可以看到在<em>value</em>中执行了 <em>_evaluatable.evaluate(parent)</em> 进行转换。</p>
<p><em>_evaluatable</em> 就是 <em>_AnimatedEvaluation</em> 构造方法传入进来的<em>this</em>，指的是<em>Tween</em>实例，又因为<em>Tween</em>继承自<em>Animatable</em>，看下<em>Animatable</em>的<em>evaluate</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Animatable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">T</span> <span class="n">transform</span><span class="p">(</span><span class="kt">double</span> <span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">T</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">Animation</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">animation</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">transform</span><span class="p">(</span><span class="n">animation</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到啊，在<em>Animatable</em>的<em>evaluate</em>方法中，执行了<em>transform</em>方法，传入的是<em>animation.value</em>，实际上就拿到了<em>CurvedAnimation</em>的<em>value</em>，这个方法由子类实现，现在看下<em>Tween</em>的<em>transform</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="n">T</span> <span class="n">transform</span><span class="p">(</span><span class="kt">double</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="m">0.0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">begin</span> <span class="o">as</span> <span class="n">T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="m">1.0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">end</span> <span class="o">as</span> <span class="n">T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">lerp</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>Tween</em>的<em>transform</em>方法中，执行了<em>lerp</em>方法进行<em>Widget</em>参数映射到[0.0, 1.0]范围。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl"><span class="n">T</span> <span class="n">lerp</span><span class="p">(</span><span class="kt">double</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">begin</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">end</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Assertions that attempt to catch common cases of tweening types
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// that do not conform to the Tween requirements.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">dynamic</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ignore: avoid_dynamic_calls
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">begin</span> <span class="o">as</span> <span class="kt">dynamic</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">end</span> <span class="o">as</span> <span class="kt">dynamic</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">begin</span> <span class="o">as</span> <span class="kt">dynamic</span><span class="p">))</span> <span class="o">*</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">result</span> <span class="o">as</span> <span class="n">T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">on</span> <span class="n">NoSuchMethodError</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">throw</span> <span class="n">FlutterError</span><span class="p">.</span><span class="n">fromParts</span><span class="p">(</span><span class="o">&lt;</span><span class="n">DiagnosticsNode</span><span class="o">&gt;</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">ErrorSummary</span><span class="p">(</span><span class="s1">&#39;Cannot lerp between &#34;</span><span class="si">$</span><span class="n">begin</span><span class="s1">&#34; and &#34;</span><span class="si">$</span><span class="n">end</span><span class="s1">&#34;.&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">ErrorDescription</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="s1">&#39;The type </span><span class="si">${</span><span class="n">begin</span><span class="p">.</span><span class="n">runtimeType</span><span class="si">}</span><span class="s1"> might not fully implement `+`, `-`, and/or `*`. &#39;</span>
</span></span><span class="line"><span class="cl">          <span class="s1">&#39;See &#34;Types with special considerations&#34; at https://api.flutter.dev/flutter/animation/Tween-class.html &#39;</span>
</span></span><span class="line"><span class="cl">          <span class="s1">&#39;for more information.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="k">is</span> <span class="n">Color</span> <span class="o">||</span> <span class="n">end</span> <span class="k">is</span> <span class="n">Color</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="n">ErrorHint</span><span class="p">(</span><span class="s1">&#39;To lerp colors, consider ColorTween instead.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="k">is</span> <span class="n">Rect</span> <span class="o">||</span> <span class="n">end</span> <span class="k">is</span> <span class="n">Rect</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="n">ErrorHint</span><span class="p">(</span><span class="s1">&#39;To lerp rects, consider RectTween instead.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">          <span class="n">ErrorHint</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;There may be a dedicated &#34;</span><span class="si">${</span><span class="n">begin</span><span class="p">.</span><span class="n">runtimeType</span><span class="si">}</span><span class="s1">Tween&#34; for this type, &#39;</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;or you may need to create one.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">on</span> <span class="n">TypeError</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">throw</span> <span class="n">FlutterError</span><span class="p">.</span><span class="n">fromParts</span><span class="p">(</span><span class="o">&lt;</span><span class="n">DiagnosticsNode</span><span class="o">&gt;</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">ErrorSummary</span><span class="p">(</span><span class="s1">&#39;Cannot lerp between &#34;</span><span class="si">$</span><span class="n">begin</span><span class="s1">&#34; and &#34;</span><span class="si">$</span><span class="n">end</span><span class="s1">&#34;.&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">ErrorDescription</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="s1">&#39;The type </span><span class="si">${</span><span class="n">begin</span><span class="p">.</span><span class="n">runtimeType</span><span class="si">}</span><span class="s1"> returned a </span><span class="si">${</span><span class="n">result</span><span class="p">.</span><span class="n">runtimeType</span><span class="si">}</span><span class="s1"> after &#39;</span>
</span></span><span class="line"><span class="cl">          <span class="s1">&#39;multiplication with a double value. &#39;</span>
</span></span><span class="line"><span class="cl">          <span class="s1">&#39;See &#34;Types with special considerations&#34; at https://api.flutter.dev/flutter/animation/Tween-class.html &#39;</span>
</span></span><span class="line"><span class="cl">          <span class="s1">&#39;for more information.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="k">is</span> <span class="kt">int</span> <span class="o">||</span> <span class="n">end</span> <span class="k">is</span> <span class="kt">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="n">ErrorHint</span><span class="p">(</span><span class="s1">&#39;To lerp int values, consider IntTween or StepTween instead.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">          <span class="n">ErrorHint</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;There may be a dedicated &#34;</span><span class="si">${</span><span class="n">begin</span><span class="p">.</span><span class="n">runtimeType</span><span class="si">}</span><span class="s1">Tween&#34; for this type, &#39;</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;or you may need to create one.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}());</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ignore: avoid_dynamic_calls
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="p">(</span><span class="n">begin</span> <span class="o">as</span> <span class="kt">dynamic</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">end</span> <span class="o">as</span> <span class="kt">dynamic</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">begin</span> <span class="o">as</span> <span class="kt">dynamic</span><span class="p">))</span> <span class="o">*</span> <span class="n">t</span> <span class="o">as</span> <span class="n">T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>关于<em>lerp</em>方法，这里插一嘴，因为<em>Tween</em>的子类很多，所以<em>lerp</em>方法可以由<em>Tween</em>的子类去实现，例如<em>Tween</em>的子类<em>SizeTween</em>，看下<em>SizeTween</em>的<em>lerp</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">SizeTween</span> <span class="kd">extends</span> <span class="n">Tween</span><span class="o">&lt;</span><span class="n">Size</span><span class="o">?&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">SizeTween</span><span class="p">({</span> <span class="k">super</span><span class="p">.</span><span class="n">begin</span><span class="p">,</span> <span class="k">super</span><span class="p">.</span><span class="n">end</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Size</span><span class="o">?</span> <span class="n">lerp</span><span class="p">(</span><span class="kt">double</span> <span class="n">t</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">Size</span><span class="p">.</span><span class="n">lerp</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以发现<em>SizeTween</em>的<em>lerp</em>方法，它是调用了<em>Size</em>的<em>lerp</em>方法。除了<em>Size</em>之外，还有很多类也重写了<em>lerp</em>方法，比如<em>Color</em>，<em>BorderRadius</em>，<em>Border</em>等等，它们分别对应的是<em>ColorTween</em>，<em>BorderRadiusTween</em>，<em>BorderTween</em>。</p>
<p>总结一下本示例中 <em>_animation.value</em> 的执行过程：</p>
<blockquote>
<p><em>当外部调用_animation.value时，就会执行Tween中的value，在Tween的value中就会执行CurvedAnimation中的value，在CurvedAnimation的value中就会执行AnimationController的value。</em></p>
</blockquote>
<p>所以说 <em>_animation.value</em> 的执行是一个向上转发，向下执行的过程。</p>
<h1 id="六动画总结">六、动画总结</h1>
<p>当执行<em>forward</em>方法时，就会启动动画，此时只是执行了动画的第一帧，然后就会触发<em>addListener</em>的回调，在<em>addListener</em>的回调中，执行了<em>setState</em>方法。</p>
<p>接着又会触发<em>addListener</em>的回调与<em>build</em>方法的执行，这样就形成了递归执行的过程，在这个过程中，通过引用 <em>_animation.value</em> 可以拿到每一帧的值，这个值是经过了<em>simulation</em>模拟计算将每一帧时间转换为[0.0，1.0]范围，在[0.0，1.0]范围内也经过了<em>Curve</em>曲线速度的转换，最后再通过<em>Tween</em>映射为具体的<em>Widget</em>的参数范围。</p>
<p>每次<em>build</em>方法执行时，<em>_animation.value</em> 的值会重新计算，从而改变<em>Widget</em>参数完成整个动画过程。</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">AndDevMK</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2023-11-04
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/wechat-qr-code.JPG">
        <span>微信打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/alipay-qr-code.JPG">
        <span>支付宝打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Bnotificationlistener/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">解读Flutter源码之NotificationListener</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Binheritedwidget/">
            <span class="next-text nav-default">解读Flutter源码之InheritedWidget</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="AndDevMK/blog-utterances"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    
    <div id="search_mask" class="search_mask">
    <div class="search_modal">
        <div id="close_search" class="close_search">关闭</div>
        <div class="search_divider"></div>
        <input id="input_search_key" class="input_search_key" placeholder="请输入你要搜索的内容" tabindex="0">
        <ul id="search_list">
        </ul>
    </div>
</div>

<script src="/js/fuse.js"></script> 
<script src="/js/fastsearch.js"></script>

    <footer id="footer" class="footer">
      

<div class="copyright">
  <span class="power-by">
    由 <a id="hexo-link" class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    
    <span id="run-time" class="run-time"></span> 
    <span class="heart"><i class="iconfont icon-heart"></i></span>
    &copy; 
    2023 - 
    2024&nbsp;
    <span>AndDevMK</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.11a4ba15caf2d921d57eaf6568c4ad21eafd5d2c001cbcb31693586c63f93005.js"></script>

<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?6db179fb88e600cf326b0515a8aa1de3";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>




<script src="/js/codecopy.js"></script>



<link disabled id="dark-mode-theme" rel="stylesheet" href="/css/dark.css"></link>
<script src="/js/dark.js"></script>


<script src="/js/site_runtime.js"></script>




</body>
</html>
