<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>解读Flutter源码之GestureDetector - AndDevMK&#39;s android blog site</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="AndDevMK" /><meta name="description" content="注：本文代码基于Flutter SDK 3.13.5 一、前言 在之前解读Flutter源码之Listener一文中，我们已经知道Listener用来监听原始指针事件，它的事件处理流程分为命中测试-事件分发-事件清理三部分。 而本文所讲的GestureDetector，它的内部实际上是对Listener" /><meta name="keywords" content="Android, Java, Kotlin, C&#43;&#43;, C, Flutter, Dart, NDK" />


<meta name="baidu-site-verification" content="codeva-wQ7uOo4V09" />
<meta name="google-site-verification" content="yHzWB9BxTR74LiaUhuL5ncr89fnDYXiplTaPY565zqo" />


<meta name="generator" content="Hugo 0.111.3 with theme even" />


<link rel="canonical" href="https://anddevmk.github.io/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Bgesturedetector/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.c11aaf02bef1025d6b0813ba5e1a8a8551aee15fa8f2bcea906d41b20bdf5c69.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/codecopy.css">


<meta property="og:title" content="解读Flutter源码之GestureDetector" />
<meta property="og:description" content="注：本文代码基于Flutter SDK 3.13.5 一、前言 在之前解读Flutter源码之Listener一文中，我们已经知道Listener用来监听原始指针事件，它的事件处理流程分为命中测试-事件分发-事件清理三部分。 而本文所讲的GestureDetector，它的内部实际上是对Listener" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://anddevmk.github.io/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Bgesturedetector/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-11-14T09:28:31+08:00" />
<meta property="article:modified_time" content="2023-11-14T09:28:31+08:00" />
<meta itemprop="name" content="解读Flutter源码之GestureDetector">
<meta itemprop="description" content="注：本文代码基于Flutter SDK 3.13.5 一、前言 在之前解读Flutter源码之Listener一文中，我们已经知道Listener用来监听原始指针事件，它的事件处理流程分为命中测试-事件分发-事件清理三部分。 而本文所讲的GestureDetector，它的内部实际上是对Listener"><meta itemprop="datePublished" content="2023-11-14T09:28:31+08:00" />
<meta itemprop="dateModified" content="2023-11-14T09:28:31+08:00" />
<meta itemprop="wordCount" content="19804">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="解读Flutter源码之GestureDetector"/>
<meta name="twitter:description" content="注：本文代码基于Flutter SDK 3.13.5 一、前言 在之前解读Flutter源码之Listener一文中，我们已经知道Listener用来监听原始指针事件，它的事件处理流程分为命中测试-事件分发-事件清理三部分。 而本文所讲的GestureDetector，它的内部实际上是对Listener"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">AndDevMK</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>

    
    <li class="mobile-menu-item-search">
      <div id="mobile_open_search" class="mobile_open_search">
        搜索
      </div>
    </li>

    
    <li class="mobile-menu-item-dark-mode">
      <div id="mobile_dark_mode_toggle" class="mobile_light_mode">
       
      </div>
    </li>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">AndDevMK</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
    
    <div id="open_search" class="open_search">
      搜索
    </div>

    
    <div id="dark_mode_toggle" class="light_mode">

    </div>
  
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">解读Flutter源码之GestureDetector</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-11-14 </span>
        <div class="post-category">
            <a href="/categories/flutter/"> Flutter </a>
            </div>
          <span class="more-meta"> 约 19804 字 </span>
          <span class="more-meta"> 预计阅读 40 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#一前言">一、前言</a></li>
    <li><a href="#二什么是gesturedetector">二、什么是<em>GestureDetector</em>？</a></li>
    <li><a href="#三gesturedetector示例">三、<em>GestureDetector</em>示例</a></li>
    <li><a href="#四源码分析">四、源码分析</a>
      <ul>
        <li><a href="#41gesturedetector的build方法">4.1、<em>GestureDetector</em>的<em>build</em>方法</a></li>
        <li><a href="#42rawgesturedetectorstate的-_handlepointerdown-方法">4.2、<em>RawGestureDetectorState</em>的 <em>_handlePointerDown</em> 方法</a></li>
        <li><a href="#43gesturebinding的handleevent方法">4.3、<em>GestureBinding</em>的<em>handleEvent</em>方法</a>
          <ul>
            <li><a href="#431pointerdownevent事件分发">4.3.1、<em>PointerDownEvent</em>事件分发</a></li>
            <li><a href="#432pointerupevent事件分发">4.3.2、<em>PointerUpEvent</em>事件分发</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#五同一个gesturedetector多种手势之间的冲突">五、同一个<em>GestureDetector</em>多种手势之间的冲突</a></li>
    <li><a href="#六解决手势冲突">六、解决手势冲突</a>
      <ul>
        <li><a href="#61通过listener解决手势冲突">6.1、通过<em>Listener</em>解决手势冲突</a></li>
        <li><a href="#62通过自定义手势识别器recognizer解决手势冲突">6.2、通过自定义手势识别器<em>Recognizer</em>解决手势冲突</a></li>
      </ul>
    </li>
    <li><a href="#七总结">七、总结</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <blockquote>
<p><em>注：本文代码基于Flutter SDK 3.13.5</em></p>
</blockquote>
<h1 id="一前言">一、前言</h1>
<p>在之前<a href="https://anddevmk.github.io/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Blistener/"><em>解读Flutter源码之Listener</em></a>一文中，我们已经知道<em>Listener</em>用来监听原始指针事件，它的事件处理流程分为命中测试-事件分发-事件清理三部分。</p>
<p>而本文所讲的<em>GestureDetector</em>，它的内部实际上是对<em>Listener</em>的进一步封装，用以识别语义化的手势。相较于<em>Listener</em>，<em>GestureDetector</em>还会涉及手势冲突，那么相应地就需要了解如何去解决手势冲突。</p>
<h1 id="二什么是gesturedetector">二、什么是<em>GestureDetector</em>？</h1>
<p>遇事不决，先来看下<em>GestureDetector</em>的注释&amp;部分源码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">/// 检测手势的widget。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// A widget that detects gestures.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 尝试识别与其非空回调相对应的手势。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Attempts to recognize gestures that correspond to its non-null callbacks.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 如果此widget有一个child，它将遵循该child的大小调整行为。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 如果它没有child，它就会成长以适应parent。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// If this widget has a child, it defers to that child for its sizing behavior.
</span></span></span><span class="line"><span class="cl"><span class="c1">/// If it does not have a child, it grows to fit the parent instead.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// {@youtube 560 315 https://www.youtube.com/watch?v=WhVXkCFPmK4}
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 默认情况下，具有不可见子项的 GestureDetector 会忽略触摸；这种行为可以通过[行为]来控制。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// By default a GestureDetector with an invisible child ignores touches;
</span></span></span><span class="line"><span class="cl"><span class="c1">/// this behavior can be controlled with [behavior].
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// GestureDetector 还侦听辅助功能事件并将它们映射到回调。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 要忽略辅助功能事件，请将 [excludeFromSemantics] 设置为 true。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// GestureDetector also listens for accessibility events and maps
</span></span></span><span class="line"><span class="cl"><span class="c1">/// them to the callbacks. To ignore accessibility events, set
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [excludeFromSemantics] to true.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// See &lt;http://flutter.dev/gestures/&gt; for additional information.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Material design应用程序通常会对触摸做出反应，并产生墨水飞溅效果。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [InkWell] 类实现了此效果，并且可以用来代替 [GestureDetector] 来处理点击。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Material design applications typically react to touches with ink splash
</span></span></span><span class="line"><span class="cl"><span class="c1">/// effects. The [InkWell] class implements this effect and can be used in place
</span></span></span><span class="line"><span class="cl"><span class="c1">/// of a [GestureDetector] for handling taps.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// {@tool dartpad}
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 此示例包含一个包裹在 [GestureDetector] 中的黑灯泡。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 通过设置 `_lights` 字段，当点击“打开灯”按钮时，灯泡会变成黄色，而当点击“关闭灯”时，灯泡会再次关闭。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// This example contains a black light bulb wrapped in a [GestureDetector]. It
</span></span></span><span class="line"><span class="cl"><span class="c1">/// turns the light bulb yellow when the &#34;TURN LIGHT ON&#34; button is tapped by
</span></span></span><span class="line"><span class="cl"><span class="c1">/// setting the `_lights` field, and off again when &#34;TURN LIGHT OFF&#34; is tapped.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ** See code in examples/api/lib/widgets/gesture_detector/gesture_detector.0.dart **
</span></span></span><span class="line"><span class="cl"><span class="c1">/// {@end-tool}
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// {@tool dartpad}
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 此示例使用 [Container] 包装 [GestureDetector]，用于检测点击。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// This example uses a [Container] that wraps a [GestureDetector] widget which
</span></span></span><span class="line"><span class="cl"><span class="c1">/// detects a tap.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 由于 [GestureDetector] 没有child，因此它采用其父项的大小，从而使周围 [Container] 的整个区域都可单击。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 点击时，[Container] 通过设置 `_color` 字段变成黄色。再次点击时，它会变回白色。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Since the [GestureDetector] does not have a child, it takes on the size of its
</span></span></span><span class="line"><span class="cl"><span class="c1">/// parent, making the entire area of the surrounding [Container] clickable. When
</span></span></span><span class="line"><span class="cl"><span class="c1">/// tapped, the [Container] turns yellow by setting the `_color` field. When
</span></span></span><span class="line"><span class="cl"><span class="c1">/// tapped again, it goes back to white.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ** See code in examples/api/lib/widgets/gesture_detector/gesture_detector.1.dart **
</span></span></span><span class="line"><span class="cl"><span class="c1">/// {@end-tool}
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ### 故障排除
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ### Troubleshooting
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 为什么我的父 [GestureDetector.onTap] 方法没有被调用？
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Why isn&#39;t my parent [GestureDetector.onTap] method called?
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 给定具有 onTap 回调的父 [GestureDetector] 和也定义 onTap 回调的子 GestureDetector，当点击内部 GestureDetector 时，两个 GestureDetector 都会向手势区域发送 [GestureRecognizer]。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 这是因为指针坐标位于两个手势检测器的范围内。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 在这种情况下，子 GestureDetector 获胜，因为它是第一个进入竞技场的，解决了先到先得的问题。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 子级的 onTap 被调用，而父级的 onTap 则没有，因为手势已被消耗。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Given a parent [GestureDetector] with an onTap callback, and a child
</span></span></span><span class="line"><span class="cl"><span class="c1">/// GestureDetector that also defines an onTap callback, when the inner
</span></span></span><span class="line"><span class="cl"><span class="c1">/// GestureDetector is tapped, both GestureDetectors send a [GestureRecognizer]
</span></span></span><span class="line"><span class="cl"><span class="c1">/// into the gesture arena. This is because the pointer coordinates are within the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// bounds of both GestureDetectors. The child GestureDetector wins in this
</span></span></span><span class="line"><span class="cl"><span class="c1">/// scenario because it was the first to enter the arena, resolving as first come,
</span></span></span><span class="line"><span class="cl"><span class="c1">/// first served. The child onTap is called, and the parent&#39;s is not as the gesture has
</span></span></span><span class="line"><span class="cl"><span class="c1">/// been consumed.
</span></span></span><span class="line"><span class="cl"><span class="c1">/// For more information on gesture disambiguation see:
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [Gesture disambiguation](https://docs.flutter.dev/development/ui/advanced/gestures#gesture-disambiguation).
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 将 [GestureDetector.behavior] 设置为 [HitTestBehavior.opaque] 或 [HitTestBehavior.translucent] 对父子关系没有影响：
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 两个 GestureDetector 都将 GestureRecognizer 发送到手势竞技场，只有一个获胜。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Setting [GestureDetector.behavior] to [HitTestBehavior.opaque]
</span></span></span><span class="line"><span class="cl"><span class="c1">/// or [HitTestBehavior.translucent] has no impact on parent-child relationships:
</span></span></span><span class="line"><span class="cl"><span class="c1">/// both GestureDetectors send a GestureRecognizer into the gesture arena, only one wins.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 一些回调（例如 onTapDown）可以在识别器赢得竞技场之前触发，而其它回调（例如 onTapCancel）即使在失去竞技场时也会触发。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 因此，上例中的父检测器可能会调用它的一些回调，即使它在竞技场中失败。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Some callbacks (e.g. onTapDown) can fire before a recognizer wins the arena,
</span></span></span><span class="line"><span class="cl"><span class="c1">/// and others (e.g. onTapCancel) fire even when it loses the arena. Therefore,
</span></span></span><span class="line"><span class="cl"><span class="c1">/// the parent detector in the example above may call some of its callbacks even
</span></span></span><span class="line"><span class="cl"><span class="c1">/// though it loses in the arena.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// {@tool dartpad}
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 此示例使用包装绿色 [Container] 的 [GestureDetector] 和包装黄色容器的第二个 GestureDetector。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 第二个 GestureDetector 是绿色 Container 的子级。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 两个 GestureDetector 都定义了 onTap 回调。当调用回调时，它会向相应的容器添加红色边框。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// This example uses a [GestureDetector] that wraps a green [Container] and a second
</span></span></span><span class="line"><span class="cl"><span class="c1">/// GestureDetector that wraps a yellow Container. The second GestureDetector is
</span></span></span><span class="line"><span class="cl"><span class="c1">/// a child of the green Container.
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Both GestureDetectors define an onTap callback. When the callback is called it
</span></span></span><span class="line"><span class="cl"><span class="c1">/// adds a red border to the corresponding Container.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 当点击绿色容器时，它的父 GestureDetector 进入手势区域。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 它获胜是因为没有竞争的 GestureDetector 并且绿色容器显示红色边框。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// When the green Container is tapped, it&#39;s parent GestureDetector enters
</span></span></span><span class="line"><span class="cl"><span class="c1">/// the gesture arena. It wins because there is no competing GestureDetector and
</span></span></span><span class="line"><span class="cl"><span class="c1">/// the green Container shows a red border.
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 当点击黄色容器时，它的父 GestureDetector 进入手势区域。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 包裹绿色容器的 GestureDetector 也进入手势区域（指针事件坐标位于两个 GestureDetector 边界内）。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 包裹黄色容器的 GestureDetector 获胜，因为它是第一个进入竞技场的检测器。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// When the yellow Container is tapped, it&#39;s parent GestureDetector enters
</span></span></span><span class="line"><span class="cl"><span class="c1">/// the gesture arena. The GestureDetector that wraps the green Container also
</span></span></span><span class="line"><span class="cl"><span class="c1">/// enters the gesture arena (the pointer events coordinates are inside both
</span></span></span><span class="line"><span class="cl"><span class="c1">/// GestureDetectors bounds). The GestureDetector that wraps the yellow Container
</span></span></span><span class="line"><span class="cl"><span class="c1">/// wins because it was the first detector to enter the arena.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 此示例将 [debugPrintGestureArenaDiagnostics] 设置为 true。该标志打印有关手势区域的有用信息。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// This example sets [debugPrintGestureArenaDiagnostics] to true.
</span></span></span><span class="line"><span class="cl"><span class="c1">/// This flag prints useful information about gesture arenas.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 将 [GestureDetector.behavior] 属性更改为 [HitTestBehavior.translucent] 或 [HitTestBehavior.opaque] 没有影响：两个 GestureDetector 都将 [GestureRecognizer] 发送到手势区域，只有一个获胜。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Changing the [GestureDetector.behavior] property to [HitTestBehavior.translucent]
</span></span></span><span class="line"><span class="cl"><span class="c1">/// or [HitTestBehavior.opaque] has no impact: both GestureDetectors send a [GestureRecognizer]
</span></span></span><span class="line"><span class="cl"><span class="c1">/// into the gesture arena, only one wins.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ** See code in examples/api/lib/widgets/gesture_detector/gesture_detector.2.dart **
</span></span></span><span class="line"><span class="cl"><span class="c1">/// {@end-tool}
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ## 调试
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ## Debugging
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 要查看 [GestureDetector] 的命中测试框有多大以进行调试，请将 [debugPaintPointersEnabled] 设置为 true。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="c1">/// To see how large the hit test box of a [GestureDetector] is for debugging
</span></span></span><span class="line"><span class="cl"><span class="c1">/// purposes, set [debugPaintPointersEnabled] to true.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">class</span> <span class="nc">GestureDetector</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">GestureDetector</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">child</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onTapDown</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onTapUp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onTap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onTapCancel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onSecondaryTap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onSecondaryTapDown</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onSecondaryTapUp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onSecondaryTapCancel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onTertiaryTapDown</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onTertiaryTapUp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onTertiaryTapCancel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onDoubleTapDown</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onDoubleTap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onDoubleTapCancel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onLongPressDown</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onLongPressCancel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onLongPress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onLongPressStart</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onLongPressMoveUpdate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onLongPressUp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onLongPressEnd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onSecondaryLongPressDown</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onSecondaryLongPressCancel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onSecondaryLongPress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onSecondaryLongPressStart</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onSecondaryLongPressMoveUpdate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onSecondaryLongPressUp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onSecondaryLongPressEnd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onTertiaryLongPressDown</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onTertiaryLongPressCancel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onTertiaryLongPress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onTertiaryLongPressStart</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onTertiaryLongPressMoveUpdate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onTertiaryLongPressUp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onTertiaryLongPressEnd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onVerticalDragDown</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onVerticalDragStart</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onVerticalDragUpdate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onVerticalDragEnd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onVerticalDragCancel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onHorizontalDragDown</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onHorizontalDragStart</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onHorizontalDragUpdate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onHorizontalDragEnd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onHorizontalDragCancel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onForcePressStart</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onForcePressPeak</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onForcePressUpdate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onForcePressEnd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onPanDown</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onPanStart</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onPanUpdate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onPanEnd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onPanCancel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onScaleStart</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onScaleUpdate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">onScaleEnd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">behavior</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">excludeFromSemantics</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">dragStartBehavior</span> <span class="o">=</span> <span class="n">DragStartBehavior</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">trackpadScrollCausesScale</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">trackpadScrollToScaleFactor</span> <span class="o">=</span> <span class="n">kDefaultTrackpadScrollToScaleFactor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">supportedDevices</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span> <span class="o">:</span> <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="kd">final</span> <span class="kt">bool</span> <span class="n">haveVerticalDrag</span> <span class="o">=</span> <span class="n">onVerticalDragStart</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">onVerticalDragUpdate</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">onVerticalDragEnd</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="kd">final</span> <span class="kt">bool</span> <span class="n">haveHorizontalDrag</span> <span class="o">=</span> <span class="n">onHorizontalDragStart</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">onHorizontalDragUpdate</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">onHorizontalDragEnd</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="kd">final</span> <span class="kt">bool</span> <span class="n">havePan</span> <span class="o">=</span> <span class="n">onPanStart</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">onPanUpdate</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">onPanEnd</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="kd">final</span> <span class="kt">bool</span> <span class="n">haveScale</span> <span class="o">=</span> <span class="n">onScaleStart</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">onScaleUpdate</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">onScaleEnd</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">havePan</span> <span class="o">||</span> <span class="n">haveScale</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">           <span class="k">if</span> <span class="p">(</span><span class="n">havePan</span> <span class="o">&amp;&amp;</span> <span class="n">haveScale</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="k">throw</span> <span class="n">FlutterError</span><span class="p">.</span><span class="n">fromParts</span><span class="p">(</span><span class="o">&lt;</span><span class="n">DiagnosticsNode</span><span class="o">&gt;</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">               <span class="n">ErrorSummary</span><span class="p">(</span><span class="s1">&#39;Incorrect GestureDetector arguments.&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">               <span class="n">ErrorDescription</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                 <span class="s1">&#39;Having both a pan gesture recognizer and a scale gesture recognizer is redundant; scale is a superset of pan.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="p">),</span>
</span></span><span class="line"><span class="cl">               <span class="n">ErrorHint</span><span class="p">(</span><span class="s1">&#39;Just use the scale gesture recognizer.&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">             <span class="p">]);</span>
</span></span><span class="line"><span class="cl">           <span class="p">}</span>
</span></span><span class="line"><span class="cl">           <span class="kd">final</span> <span class="kt">String</span> <span class="n">recognizer</span> <span class="o">=</span> <span class="n">havePan</span> <span class="o">?</span> <span class="s1">&#39;pan&#39;</span> <span class="o">:</span> <span class="s1">&#39;scale&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">           <span class="k">if</span> <span class="p">(</span><span class="n">haveVerticalDrag</span> <span class="o">&amp;&amp;</span> <span class="n">haveHorizontalDrag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="k">throw</span> <span class="n">FlutterError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;Incorrect GestureDetector arguments.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;Simultaneously having a vertical drag gesture recognizer, a horizontal drag gesture recognizer, and a </span><span class="si">$</span><span class="n">recognizer</span><span class="s1"> gesture recognizer &#39;</span>
</span></span><span class="line"><span class="cl">               <span class="s1">&#39;will result in the </span><span class="si">$</span><span class="n">recognizer</span><span class="s1"> gesture recognizer being ignored, since the other two will catch all drags.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">             <span class="p">);</span>
</span></span><span class="line"><span class="cl">           <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="p">}());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，<em>GestureDetector</em>是一个<em>StatelessWidget</em>，当你传入了非空回调，那么它会尝试识别与其非空回调相对应的手势。在注释中，<em>GestureDetector</em>也为开发者提供了好几个示例，这里就不分析了，感兴趣的可以自行研究。</p>
<p><em>GestureDetector</em>设计了丰富的手势监听回调，这里列出几个较为常见的。</p>
<table>
<thead>
<tr>
<th><em>GestureDetector</em>回调</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>onTap</em></td>
<td>发生了对主按钮的点击。当点击手势获胜时会触发此操作。如果点击手势没有成功，则会调用<em>onTapCancel</em></td>
</tr>
<tr>
<td><em>onTapDown</em></td>
<td>可能导致点击主按钮的指针已接触到屏幕的特定位置。即使尚未选择获胜手势，也会在短暂的超时后调用此方法。如果点击手势获胜，将调用<em>onTapUp</em> ，否则将调用<em>onTapCancel</em></td>
</tr>
<tr>
<td><em>onTapUp</em></td>
<td>将触发主按钮点击的指针已停止在特定位置接触屏幕。如果点击手势获胜，则会在<em>onTap</em>之前立即触发。如果点击手势没有成功，则会调用<em>onTapCancel</em></td>
</tr>
<tr>
<td><em>onTapCancel</em></td>
<td>先前触发<em>onTapDown</em>的指针最终不会导致点击。如果点击手势未获胜，则在<em>onTapDown</em>之后调用，而不是<em>onTapUp</em>和<em>onTap</em></td>
</tr>
<tr>
<td><em>onDoubleTap</em></td>
<td>用户在同一位置快速连续点击主按钮两次</td>
</tr>
<tr>
<td><em>onDoubleTapDown</em></td>
<td>可能导致双击的指针已接触屏幕的特定位置。在第二次点击的向下事件后立即触发。如果用户完成双击并且手势获胜，则在此回调之后将调用<em>onDoubleTap</em>。否则， <em>onDoubleTapCancel</em>将在此回调后调用</td>
</tr>
<tr>
<td><em>onDoubleTapCancel</em></td>
<td>之前触发<em>onDoubleTapDown</em>的指针最终不会导致双击</td>
</tr>
<tr>
<td><em>onLongPress</em></td>
<td>当识别到主按钮的长按手势时调用。当指针长时间与屏幕同一位置保持接触时触发。这相当于（并在之后立即调用） <em>onLongPressStart</em>。两者之间的唯一区别是此回调不包含指针最初接触屏幕的位置的详细信息。</td>
</tr>
<tr>
<td><em>onLongPressDown</em></td>
<td>指针已通过主按钮接触屏幕，这可能是长按的开始。这在指针向下事件后触发。如果用户完成长按，并且该手势获胜，则在此回调后将调用<em>onLongPressStart</em>。否则， <em>onLongPressCancel</em>将在该回调之后被调用</td>
</tr>
<tr>
<td><em>onLongPressUp</em></td>
<td>触发主按钮长按的指针已停止接触屏幕。这相当于（并在之后立即调用） <em>onLongPressEnd</em>。两者之间的唯一区别是，此回调不包含指针停止接触屏幕时的状态详细信息</td>
</tr>
<tr>
<td><em>onLongPressCancel</em></td>
<td>先前触发<em>onLongPressDown</em>的指针最终不会导致长按。如果先前已触发<em>onLongPressDown</em>则一旦手势丢失，就会触发此操作。如果用户完成了长按，并且手势获胜，则调​​用<em>onLongPressStart和onLongPress</em>。</td>
</tr>
<tr>
<td><em>onLongPressStart</em></td>
<td>当识别到主按钮的长按手势时调用。当指针长时间与屏幕同一位置保持接触时触发。这相当于（并在之前调用） <em>onLongPress</em>。两者之间的唯一区别是，此回调包含指针最初接触屏幕的位置的详细信息，而<em>onLongPress</em>则不包含</td>
</tr>
<tr>
<td><em>onLongPressMoveUpdate</em></td>
<td>长按主按钮后，指针已被拖动移动</td>
</tr>
<tr>
<td><em>onLongPressEnd</em></td>
<td>触发主按钮长按的指针已停止接触屏幕。这相当于（并在之前调用） <em>onLongPressUp</em>。两者之间的唯一区别是，此回调包含指针停止接触屏幕时的状态详细信息，而<em>onLongPressUp</em>则不包含</td>
</tr>
<tr>
<td><em>onVerticalDragDown</em></td>
<td>指针已通过主按钮接触屏幕，并且可能开始垂直移动</td>
</tr>
<tr>
<td><em>onVerticalDragStart</em></td>
<td>指针已通过主按钮接触屏幕并开始垂直移动</td>
</tr>
<tr>
<td><em>onVerticalDragUpdate</em></td>
<td>通过主按钮与屏幕接触并垂直移动的指针已沿垂直方向移动</td>
</tr>
<tr>
<td><em>onVerticalDragEnd</em></td>
<td>之前通过主按钮与屏幕接触并垂直移动的指针不再与屏幕接触，并且在停止接触屏幕时以特定速度移动</td>
</tr>
<tr>
<td><em>onVerticalDragCancel</em></td>
<td>之前触发<em>onVerticalDragDown</em>的指针没有完成</td>
</tr>
<tr>
<td><em>onHorizontalDragDown</em></td>
<td>指针已通过主按钮接触屏幕，并且可能开始水平移动</td>
</tr>
<tr>
<td><em>onHorizontalDragStart</em></td>
<td>指针已通过主按钮接触屏幕并开始水平移动</td>
</tr>
<tr>
<td><em>onHorizontalDragUpdate</em></td>
<td>通过主按钮与屏幕接触并水平移动的指针已沿水平方向移动</td>
</tr>
<tr>
<td><em>onHorizontalDragEnd</em></td>
<td>之前通过主按钮与屏幕接触并水平移动的指针不再与屏幕接触，并且在停止接触屏幕时以特定速度移动</td>
</tr>
<tr>
<td><em>onHorizontalDragCancel</em></td>
<td>先前触发<em>onHorizontalDragDown</em>的指针未完成</td>
</tr>
<tr>
<td><em>onPanDown</em></td>
<td>指针已通过主按钮接触屏幕并可能开始移动</td>
</tr>
<tr>
<td><em>onPanStart</em></td>
<td>指针已与主按钮接触到屏幕并开始移动</td>
</tr>
<tr>
<td><em>onPanUpdate</em></td>
<td>通过主按钮与屏幕接触并移动的指针已再次移动</td>
</tr>
<tr>
<td><em>onPanEnd</em></td>
<td>之前通过主按钮与屏幕接触并移动的指针不再与屏幕接触，并且在停止接触屏幕时以特定速度移动</td>
</tr>
<tr>
<td><em>onPanCancel</em></td>
<td>先前触发onPanDown的指针未完成</td>
</tr>
<tr>
<td>&hellip;</td>
<td>&hellip;</td>
</tr>
</tbody>
</table>
<p>有的回调包含了指针最初接触屏幕的位置的详细信息，例如<em>onTapDown</em>&amp;<em>onDoubleTapDown</em>回调，<em>TapDownDetails</em>是<em>GestureTapDownCallback</em>的详细信息。</p>
<table>
<thead>
<tr>
<th><em>TapDownDetails</em>属性</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>globalPosition</em></td>
<td>指针接触屏幕的全局位置</td>
</tr>
<tr>
<td><em>kind</em></td>
<td>发起事件的设备类型</td>
</tr>
<tr>
<td><em>localPosition</em></td>
<td>指针接触屏幕的本地位置</td>
</tr>
</tbody>
</table>
<h1 id="三gesturedetector示例">三、<em>GestureDetector</em>示例</h1>
<p>为了便于分析，在<em>GestureDetector</em>示例中丢弃了<em>runApp</em>方法带来的一个<em>View</em>结构（在实际项目中不能这样做），具体分析看<a href="https://anddevmk.github.io/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Brunapp/"><em>解读Flutter源码之runApp一文</em></a>。</p>
<p>程序运行起来后，通过<em>Flutter Inspector</em>查看<em>Widget</em>层次结构如下所示。</p>
<img title="" src="/img/flutter/解读Flutter源码之GestureDetector/GestureDetector示例层次结构.png" alt="" width="535">
<p>对应的代码为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 输出手势竞技场的相关日志，用于跟踪手势竞争的执行逻辑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">debugPrintGestureArenaDiagnostics</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_runApp</span><span class="p">(</span><span class="kd">const</span> <span class="n">MyApp</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_runApp</span><span class="p">(</span><span class="n">Widget</span> <span class="n">app</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">WidgetsBinding</span> <span class="n">binding</span> <span class="o">=</span> <span class="n">WidgetsFlutterBinding</span><span class="p">.</span><span class="n">ensureInitialized</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">Timer</span><span class="p">.</span><span class="n">run</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">binding</span><span class="p">.</span><span class="n">attachRootWidget</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="n">binding</span><span class="p">.</span><span class="n">scheduleWarmUpFrame</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyApp</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">MyApp</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">GestureDetector</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">GestureDetector</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">child:</span> <span class="kd">const</span> <span class="n">ColoredBox</span><span class="p">(</span><span class="nl">color:</span> <span class="n">Colors</span><span class="p">.</span><span class="n">blueAccent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onTap:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;inner onTap&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onTapDown:</span> <span class="p">(</span><span class="n">TapDownDetails</span> <span class="n">details</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;inner onTapDown&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onTapUp:</span> <span class="p">(</span><span class="n">TapUpDetails</span> <span class="n">details</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;inner onTapUp&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onTapCancel:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;inner onTapCancel&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onTap:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;outer onTap&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onTapDown:</span> <span class="p">(</span><span class="n">TapDownDetails</span> <span class="n">details</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;outer onTapDown&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onTapUp:</span> <span class="p">(</span><span class="n">TapUpDetails</span> <span class="n">details</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;outer onTapUp&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onTapCancel:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;outer onTapCancel&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>当在屏幕上点击时，打印的日志如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">I/flutter (22965): inner onTapDown
</span></span><span class="line"><span class="cl">I/flutter (22965): inner onTapUp
</span></span><span class="line"><span class="cl">I/flutter (22965): inner onTap
</span></span></code></pre></td></tr></table>
</div>
</div><p>从日志可以知道，为什么父<em>GestureDetector</em>的<em>onTapDown</em>等回调方法没有被调用呢？这里先给出大概的答案，后面再结合源码进行详细分析。</p>
<p>给定具有<em>onTapDown</em>回调的父<em>GestureDetector</em>和也定义了<em>onTapDown</em>回调的子 <em>GestureDetector</em>，当点击内部<em>GestureDetector</em>时，两个<em>GestureDetector</em>都会向手势区域发送<em>GestureRecognizer</em>，这是因为指针坐标位于两个手势检测器的范围内。</p>
<p>在这种情况下，子<em>GestureDetector</em>获胜，因为它是第一个进入竞技场的，解决了先到先得的问题。因此，子级的<em>onTapDown</em>被调用，而父级的<em>onTapDown</em>则没有，因为手势已被消耗。</p>
<h1 id="四源码分析">四、源码分析</h1>
<h2 id="41gesturedetector的build方法">4.1、<em>GestureDetector</em>的<em>build</em>方法</h2>
<p>看下<em>GestureDetector</em>的<em>build</em>方法，可以发现它通过<em>GestureRecognizerFactory</em>工厂类定义了<em>GestureRecognizer</em>的创建方法 <em>_constructor</em> 与初始化方法 <em>_initializer</em>，然后把新创建的<em>GestureRecognizerFactoryWithHandlers</em>实例放入<em>gestures</em>这个<em>Map</em>中保存。</p>
<p>当<em>GestureRecognizerFactoryWithHandlers</em>执行初始化方法时，<em>GestureRecognizer</em>就会持有外部传入的回调方法，例如<em>TapGestureRecognizer</em>持有<em>onTapDown</em>回调方法。</p>
<p>最后，<em>build</em>方法返回了<em>RawGestureDetector</em>组件，<em>gestures</em>也作为参数传入了<em>RawGestureDetector</em>组件。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">GestureRecognizerFactory</span><span class="o">&gt;</span> <span class="n">gestures</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">GestureRecognizerFactory</span><span class="o">&gt;</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">DeviceGestureSettings</span><span class="o">?</span> <span class="n">gestureSettings</span> <span class="o">=</span> <span class="n">MediaQuery</span><span class="p">.</span><span class="n">maybeGestureSettingsOf</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">onTapDown</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">onTapUp</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">onTap</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">onTapCancel</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">onSecondaryTap</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">onSecondaryTapDown</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">onSecondaryTapUp</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">onSecondaryTapCancel</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">onTertiaryTapDown</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">onTertiaryTapUp</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="n">onTertiaryTapCancel</span> <span class="o">!=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// GestureRecognizerFactoryWithHandlers是GestureRecognizerFactory子类，所以可以赋值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">gestures</span><span class="p">[</span><span class="n">TapGestureRecognizer</span><span class="p">]</span> <span class="o">=</span> <span class="n">GestureRecognizerFactoryWithHandlers</span><span class="o">&lt;</span><span class="n">TapGestureRecognizer</span><span class="o">&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">TapGestureRecognizer</span><span class="p">(</span><span class="nl">debugOwner:</span> <span class="k">this</span><span class="p">,</span> <span class="nl">supportedDevices:</span> <span class="n">supportedDevices</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="n">TapGestureRecognizer</span> <span class="n">instance</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TapGestureRecognizer持有了外部传入的回调方法实例，例如*onTapDown*方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">instance</span>
</span></span><span class="line"><span class="cl">          <span class="p">..</span><span class="n">onTapDown</span> <span class="o">=</span> <span class="n">onTapDown</span>
</span></span><span class="line"><span class="cl">          <span class="p">..</span><span class="n">onTapUp</span> <span class="o">=</span> <span class="n">onTapUp</span>
</span></span><span class="line"><span class="cl">          <span class="p">..</span><span class="n">onTap</span> <span class="o">=</span> <span class="n">onTap</span>
</span></span><span class="line"><span class="cl">          <span class="p">..</span><span class="n">onTapCancel</span> <span class="o">=</span> <span class="n">onTapCancel</span>
</span></span><span class="line"><span class="cl">          <span class="p">..</span><span class="n">onSecondaryTap</span> <span class="o">=</span> <span class="n">onSecondaryTap</span>
</span></span><span class="line"><span class="cl">          <span class="p">..</span><span class="n">onSecondaryTapDown</span> <span class="o">=</span> <span class="n">onSecondaryTapDown</span>
</span></span><span class="line"><span class="cl">          <span class="p">..</span><span class="n">onSecondaryTapUp</span> <span class="o">=</span> <span class="n">onSecondaryTapUp</span>
</span></span><span class="line"><span class="cl">          <span class="p">..</span><span class="n">onSecondaryTapCancel</span> <span class="o">=</span> <span class="n">onSecondaryTapCancel</span>
</span></span><span class="line"><span class="cl">          <span class="p">..</span><span class="n">onTertiaryTapDown</span> <span class="o">=</span> <span class="n">onTertiaryTapDown</span>
</span></span><span class="line"><span class="cl">          <span class="p">..</span><span class="n">onTertiaryTapUp</span> <span class="o">=</span> <span class="n">onTertiaryTapUp</span>
</span></span><span class="line"><span class="cl">          <span class="p">..</span><span class="n">onTertiaryTapCancel</span> <span class="o">=</span> <span class="n">onTertiaryTapCancel</span>
</span></span><span class="line"><span class="cl">          <span class="p">..</span><span class="n">gestureSettings</span> <span class="o">=</span> <span class="n">gestureSettings</span>
</span></span><span class="line"><span class="cl">          <span class="p">..</span><span class="n">supportedDevices</span> <span class="o">=</span> <span class="n">supportedDevices</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 返回RawGestureDetector组件，gestures作为参数传入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">RawGestureDetector</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">gestures:</span> <span class="n">gestures</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">behavior:</span> <span class="n">behavior</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">excludeFromSemantics:</span> <span class="n">excludeFromSemantics</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">child:</span> <span class="n">child</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>RawGestureDetector</em>是一个<em>StatefulWidget</em>，它创建了<em>RawGestureDetectorState</em>，看下该<em>State</em>的<em>initState</em>方法。</p>
<p>可以发现，在<em>initState</em>方法中执行了 <em>_syncAll</em> 方法，传入了<em>GestureDetector</em>的<em>build</em>方法中创建的<em>gestures</em>集合。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">RawGestureDetectorState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">RawGestureDetector</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 定义手势识别器Map集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Map</span><span class="o">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">GestureRecognizer</span><span class="o">&gt;?</span> <span class="n">_recognizers</span> <span class="o">=</span> <span class="kd">const</span> <span class="o">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">GestureRecognizer</span><span class="o">&gt;</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="n">SemanticsGestureDelegate</span><span class="o">?</span> <span class="n">_semantics</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">initState</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">initState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_semantics</span> <span class="o">=</span> <span class="n">widget</span><span class="p">.</span><span class="n">semantics</span> <span class="o">??</span> <span class="n">_DefaultSemanticsGestureDelegate</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_syncAll</span><span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">gestures</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>RawGestureDetectorState</em>的 <em>_syncAll</em> 方法，它会将<em>gestures</em>转换为手势识别器集合 <em>_recognizers</em>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_syncAll</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">GestureRecognizerFactory</span><span class="o">&gt;</span> <span class="n">gestures</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_recognizers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 将_recognizers赋值给局部变量oldRecognizers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">GestureRecognizer</span><span class="o">&gt;</span> <span class="n">oldRecognizers</span> <span class="o">=</span> <span class="n">_recognizers</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 创建一个新的_recognizers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_recognizers</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">GestureRecognizer</span><span class="o">&gt;</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 遍历gestures的keys，这里的type就是GestureRecognizer了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">Type</span> <span class="n">type</span> <span class="k">in</span> <span class="n">gestures</span><span class="p">.</span><span class="n">keys</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">gestures</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">gestures</span><span class="p">[</span><span class="n">type</span><span class="p">]</span><span class="o">!</span><span class="p">.</span><span class="n">_debugAssertTypeMatches</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">_recognizers</span><span class="o">!</span><span class="p">.</span><span class="n">containsKey</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果oldRecognizers中存在该GestureRecognizer，则直接赋值即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 如果oldRecognizers中不存在该GestureRecognizer，那么调用GestureRecognizerFactoryWithHandlers的constructor方法创建一个新的GestureRecognizer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_recognizers</span><span class="o">!</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldRecognizers</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">??</span> <span class="n">gestures</span><span class="p">[</span><span class="n">type</span><span class="p">]</span><span class="o">!</span><span class="p">.</span><span class="n">constructor</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">_recognizers</span><span class="o">!</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">runtimeType</span> <span class="o">==</span> <span class="n">type</span><span class="p">,</span> <span class="s1">&#39;GestureRecognizerFactory of type </span><span class="si">$</span><span class="n">type</span><span class="s1"> created a GestureRecognizer of type </span><span class="si">${</span><span class="n">_recognizers</span><span class="o">!</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">runtimeType</span><span class="si">}</span><span class="s1">. The GestureRecognizerFactory must be specialized with the type of the class that it returns from its constructor method.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行GestureRecognizerFactoryWithHandlers的initializer方法，此处initializer方法会对外部传入的回调进行赋值操作，例如instance..onTapDown = onTapDown
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">gestures</span><span class="p">[</span><span class="n">type</span><span class="p">]</span><span class="o">!</span><span class="p">.</span><span class="n">initializer</span><span class="p">(</span><span class="n">_recognizers</span><span class="o">!</span><span class="p">[</span><span class="n">type</span><span class="p">]</span><span class="o">!</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 遍历oldRecognizers的keys，如果_recognizers不包含该type，也就是不包含某个GestureRecognizer了，那么执行该GestureRecognizer的dispose方法，从而做一些资源释放的工作。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">Type</span> <span class="n">type</span> <span class="k">in</span> <span class="n">oldRecognizers</span><span class="p">.</span><span class="n">keys</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_recognizers</span><span class="o">!</span><span class="p">.</span><span class="n">containsKey</span><span class="p">(</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">oldRecognizers</span><span class="p">[</span><span class="n">type</span><span class="p">]</span><span class="o">!</span><span class="p">.</span><span class="n">dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下该<em>RawGestureDetectorState</em>的<em>build</em>方法，可以发现<em>GestureDetector</em>的内部其实是对<em>Listener</em>进行了 <em>_GestureSemantics</em> 一层包装。</p>
<p>我们知道，当事件分发时，就会遍历<em>HitTestResult</em>，然后调用每一个节点（<em>RenderObject</em>）的<em>handleEvent</em>方法。在前面的<em>GestureDetector</em>示例中，此时<em>HitTestResult</em>中 <em>_path</em> 的情况如下。</p>
<img title="" src="/img/flutter/解读Flutter源码之GestureDetector/命中测试结果.png" alt="" width="535">
<p>对于<em>GestureDetector</em>示例中的内部<em>GestureDetector</em>，它内部的<em>Listener</em>作为第二个<em>HitTestTarget</em>被执行了<em>handleEvent</em>方法，最终会执行 <em>_handlePointerDown</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">result</span> <span class="o">=</span> <span class="n">Listener</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行_handlePointerDown方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">onPointerDown:</span> <span class="n">_handlePointerDown</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">onPointerPanZoomStart:</span> <span class="n">_handlePointerPanZoomStart</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">behavior:</span> <span class="n">widget</span><span class="p">.</span><span class="n">behavior</span> <span class="o">??</span> <span class="n">_defaultBehavior</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">child:</span> <span class="n">widget</span><span class="p">.</span><span class="n">child</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">widget</span><span class="p">.</span><span class="n">excludeFromSemantics</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">_GestureSemantics</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">behavior:</span> <span class="n">widget</span><span class="p">.</span><span class="n">behavior</span> <span class="o">??</span> <span class="n">_defaultBehavior</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">assignSemantics:</span> <span class="n">_updateSemanticsForRenderObject</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">result</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="42rawgesturedetectorstate的-_handlepointerdown-方法">4.2、<em>RawGestureDetectorState</em>的 <em>_handlePointerDown</em> 方法</h2>
<p>看下<em>RawGestureDetectorState</em>的 <em>_handlePointerDown</em> 方法，可以发现它对 <em>_recognizers</em> 进行了遍历，执行所有<em>GestureRecognizer</em>的<em>addPointer</em>方法，并把<em>PointerDownEvent</em>作为参数传入了<em>addPointer</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_handlePointerDown</span><span class="p">(</span><span class="n">PointerDownEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_recognizers</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">GestureRecognizer</span> <span class="n">recognizer</span> <span class="k">in</span> <span class="n">_recognizers</span><span class="o">!</span><span class="p">.</span><span class="n">values</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">recognizer</span><span class="p">.</span><span class="n">addPointer</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>GestureRecognizer</em>的<em>addPointer</em>方法，执行<em>isPointerAllowed</em>方法进行<em>if</em>语句判断，用来检查该识别器是否允许跟踪指针。</p>
<p>如果<em>if</em>语句判断为真，那么执行<em>addAllowedPointer</em>方法，注册一个已被检查为手势识别器允许的新指针。</p>
<p>否则，执行<em>handleNonAllowedPointer</em>方法，处理此识别器不允许添加的指针，<em>GestureRecognizer</em>子类可以重写此方法并拒绝手势。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">addPointer</span><span class="p">(</span><span class="n">PointerDownEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 保存指针ID和它们来自的设备类型之间的映射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_pointerToKind</span><span class="p">[</span><span class="n">event</span><span class="p">.</span><span class="n">pointer</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">kind</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析一
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">isPointerAllowed</span><span class="p">(</span><span class="n">event</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析二
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">addAllowedPointer</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析三
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">handleNonAllowedPointer</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>分析一：</p>
<p>前面我们看<em>GestureDetector</em>的<em>build</em>方法时就知道，对于<em>onTapDown</em>、<em>onTapUp</em>、<em>onTap</em>与<em>onTapCancel</em>这几个回调，它所创建的手势识别器为<em>TapGestureRecognizer</em>。</p>
<p>而<em>TapGestureRecognizer</em>实现了<em>isPointerAllowed</em>方法，所以看下<em>TapGestureRecognizer</em>的<em>isPointerAllowed</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">isPointerAllowed</span><span class="p">(</span><span class="n">PointerDownEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">buttons</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">kPrimaryButton:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 满足kPrimaryButton条件，但是示例中回调均不为null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">onTapDown</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">          <span class="n">onTap</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">          <span class="n">onTapUp</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">          <span class="n">onTapCancel</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">kSecondaryButton:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">onSecondaryTap</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">          <span class="n">onSecondaryTapDown</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">          <span class="n">onSecondaryTapUp</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">          <span class="n">onSecondaryTapCancel</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">kTertiaryButton:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">onTertiaryTapDown</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">          <span class="n">onTertiaryTapUp</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">          <span class="n">onTertiaryTapCancel</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 因此，执行了父类的isPointerAllowed方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="k">super</span><span class="p">.</span><span class="n">isPointerAllowed</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>TapGestureRecognizer</em>的<em>isPointerAllowed</em>方法也是执行了父类的isPointerAllowed方法，看下<em>GestureRecognizer</em>的<em>isPointerAllowed</em>方法。</p>
<p>因为<em>supportedDevices</em>是通过<em>GestureDetector</em>的构造方法传入，而我们没有传入，所以<em>supportedDevices</em>为<em>null</em>，那么<em>isPointerAllowed</em>方法返回<em>true</em>，因此，会继续执行分析二。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">Set</span><span class="o">&lt;</span><span class="n">PointerDeviceKind</span><span class="o">&gt;?</span> <span class="n">supportedDevices</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">isPointerAllowed</span><span class="p">(</span><span class="n">PointerDownEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="n">supportedDevices</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">          <span class="n">supportedDevices</span><span class="o">!</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">kind</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">      <span class="n">_allowedButtonsFilter</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">buttons</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>分析二：</p>
<p><em>addAllowedPointer</em>方法在<em>GestureRecognizer</em>是空实现，该方法由<em>GestureRecognizer</em>的子类实现，那么去看下<em>TapGestureRecognizer</em>的<em>addAllowedPointer</em>方法实现。</p>
<p>但是发现<em>TapGestureRecognizer</em>并没有重写该方法，那么看下它的父类<em>BaseTapGestureRecognizer</em>的<em>addAllowedPointer</em>方法实现。</p>
<p>可以看到，在<em>BaseTapGestureRecognizer</em>的<em>addAllowedPointer</em>方法中，最后又执行了父类的<em>addAllowedPointer</em>方法，也就是执行了<em>PrimaryPointerGestureRecognizer</em>的<em>addAllowedPointer</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">addAllowedPointer</span><span class="p">(</span><span class="n">PointerDownEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 此时state为GestureRecognizerState.ready，这是在父类PrimaryPointerGestureRecognizer中成员变量_state的初始赋值，表示识别器已准备好开始识别手势
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">GestureRecognizerState</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果之前的手势区域中没有结果，我们将忽略它们并准备接受新的指针。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// If there is no result in the previous gesture arena,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// we ignore them and prepare to accept a new pointer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 此时_down为null，_up为null，所以不会执行_reset方法去重置变量状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_down</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">_up</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">assert</span><span class="p">(</span><span class="n">_down</span><span class="o">!</span><span class="p">.</span><span class="n">pointer</span> <span class="o">==</span> <span class="n">_up</span><span class="o">!</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">_reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">_down</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">_up</span> <span class="o">==</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 必须在此方法中指定“_down”而不是“handlePrimaryPointer”，因为“acceptGesture”可能会在“handlePrimaryPointer”之前调用，后者依赖“_down”来调用“handleTapDown”。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// `_down` must be assigned in this method instead of `handlePrimaryPointer`,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// because `acceptGesture` might be called before `handlePrimaryPointer`,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// which relies on `_down` to call `handleTapDown`.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_down</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_down</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 当指针向下（即由于移动）时此点击手势被拒绝时，当添加另一个允许的指针时，会发生这种情况，在这种情况下，所有指针都将被忽略。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// `_down` 为 null 意味着 _reset() 已被调用，因为它总是在第一个允许的 down 事件中设置，并且除了 Reset() 之外不会被清除，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This happens when this tap gesture has been rejected while the pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// is down (i.e. due to movement), when another allowed pointer is added,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// in which case all pointers are ignored. The `_down` being null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// means that _reset() has been called, since it is always set at the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// first allowed down event and will not be cleared except for reset(),
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">super</span><span class="p">.</span><span class="n">addAllowedPointer</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>PrimaryPointerGestureRecognizer</em>的<em>addAllowedPointer</em>方法，首先执行了父类<em>OneSequenceGestureRecognizer</em>的<em>addAllowedPointer</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">addAllowedPointer</span><span class="p">(</span><span class="n">PointerDownEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行父类的addAllowedPointer方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">super</span><span class="p">.</span><span class="n">addAllowedPointer</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">GestureRecognizerState</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 修改_state位possible，表示到目前为止看到的指针事件序列与识别器尝试识别的手势一致，但该手势尚未被明确接受
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_state</span> <span class="o">=</span> <span class="n">GestureRecognizerState</span><span class="p">.</span><span class="n">possible</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 该识别器正在跟踪的主指针的ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 如果此识别器不再跟踪任何指针，则此字段保存此识别器最近跟踪的主指针的ID。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 这使得识别器能够在调用acceptGesture或rejectGesture时知道它最近跟踪哪个指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_primaryPointer</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 主指针接触屏幕的位置，仅当该识别器正在跟踪至少一个指针时，该值才为非空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_initialPosition</span> <span class="o">=</span> <span class="n">OffsetPair</span><span class="p">(</span><span class="nl">local:</span> <span class="n">event</span><span class="p">.</span><span class="n">localPosition</span><span class="p">,</span> <span class="nl">global:</span> <span class="n">event</span><span class="p">.</span><span class="n">position</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// deadline在BaseTapGestureRecognizer构造方法中调用父类的构造方法时传入了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 对于轻击屏幕，它的值是固定的，为kPressTimeout，等于Duration(milliseconds: 100)，此时它表示如果怀疑该手势是轻击，则轻击手势发送 onTapDown 之前必须经过的时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 对于长按屏幕，它的值不是固定的，可以自定义，不传入时默认值为kLongPressTimeout，等于Duration(milliseconds: 500)，此时它表示长按手势尝试获胜之前的时间。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 当然我们示例中肯定是轻击屏幕，所以这里会执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">deadline</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 如果非空，则识别器将在开始跟踪主指针后经过此时间量后调用didExceedDeadline 。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// 如果主指针在截止deadline之前被接受、拒绝，或者所有指针都已启动或取消，则不会调用didExceedDeadline 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// 我们示例中，如果轻击超时了，就会执行didExceedDeadlineWithEvent方法，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// 在didExceedDeadlineWithEvent方法中，最终会执行handleTapDown方法回调给外部GestureDetector，也就是点击超时时也会触发onTapDown回调。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// didExceedDeadlineWithEvent源码这里不讲解了，可自行查看
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">_timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="n">deadline</span><span class="o">!</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">didExceedDeadlineWithEvent</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>OneSequenceGestureRecognizer</em>的<em>addAllowedPointer</em>方法，执行了<em>startTrackingPointer</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">addAllowedPointer</span><span class="p">(</span><span class="n">PointerDownEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">startTrackingPointer</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">pointer</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">transform</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>此处<em>startTrackingPointer</em>方法由<em>OneSequenceGestureRecognizer</em>的子类<em>BaseTapGestureRecognizer</em>去实现，看下<em>BaseTapGestureRecognizer</em>的<em>startTrackingPointer</em>方法。</p>
<p>可以看到，在<em>BaseTapGestureRecognizer</em>的<em>startTrackingPointer</em>方法中，又执行了父类<em>OneSequenceGestureRecognizer</em>的<em>startTrackingPointer</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">startTrackingPointer</span><span class="p">(</span><span class="kt">int</span> <span class="n">pointer</span><span class="p">,</span> <span class="p">[</span><span class="n">Matrix4</span><span class="o">?</span> <span class="n">transform</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 当 _down 为空时，识别器不应该跟踪任何指针，因为在这种状态下调用 _checkDown 会抛出异常。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// The recognizer should never track any pointers when `_down` is null,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// because calling `_checkDown` in this state will throw exception.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">assert</span><span class="p">(</span><span class="n">_down</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">super</span><span class="p">.</span><span class="n">startTrackingPointer</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="n">transform</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>OneSequenceGestureRecognizer</em>的<em>startTrackingPointer</em>方法，执行了<em>GestureBinding</em>中成员变量<em>pointerRouter</em>的<em>addRoute</em>方法，将路由添加到路由表。</p>
<p>然后执行 <em>_addPointerToArena</em> 方法，将新成员（例如手势识别器）添加到竞技场。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">GestureArenaEntry</span><span class="o">&gt;</span> <span class="n">_entries</span> <span class="o">=</span> <span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">GestureArenaEntry</span><span class="o">&gt;</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">_trackedPointers</span> <span class="o">=</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 导致与给定指针 D相关的事件被路由到此识别器。
</span></span></span><span class="line"><span class="cl"><span class="c1">// 指针事件根据transform进行转换，然后传递给handleEvent。transform参数的值通常从PointerDownEvent.transform获取，以将事件从全局坐标空间转换到事件接收者的坐标空间。如果不需要转换，它可能为空。
</span></span></span><span class="line"><span class="cl"><span class="c1">// 使用stopTrackingPointer删除此函数添加的路由。
</span></span></span><span class="line"><span class="cl"><span class="c1">// 此方法还会将此识别器（或其team ，如果它非空）添加到指定指针的手势区域。
</span></span></span><span class="line"><span class="cl"><span class="c1">// 这是由OneSequenceGestureRecognizer.addAllowedPointer调用的。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">startTrackingPointer</span><span class="p">(</span><span class="kt">int</span> <span class="n">pointer</span><span class="p">,</span> <span class="p">[</span><span class="n">Matrix4</span><span class="o">?</span> <span class="n">transform</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 将路由添加到路由表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">GestureBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">pointerRouter</span><span class="p">.</span><span class="n">addRoute</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="n">handleEvent</span><span class="p">,</span> <span class="n">transform</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 将指针添加到追踪指针Set集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_trackedPointers</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">pointer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// TODO(goderbauer): Enable assert after recognizers properly clean up their defunct `_entries`, see https://github.com/flutter/flutter/issues/117356.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// assert(!_entries.containsKey(pointer));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 将新成员（例如手势识别器）添加到竞技场
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 给定的GestureArenaMember（手势识别器）可以在多个具有不同指针id的区域中拥有多个条目。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 将返回的GestureArenaEntry存入Map集合中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_entries</span><span class="p">[</span><span class="n">pointer</span><span class="p">]</span> <span class="o">=</span> <span class="n">_addPointerToArena</span><span class="p">(</span><span class="n">pointer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>PointerRouter</em>的<em>addRoute</em>方法，可以发现<em>pointer</em>与路由表<em>routes</em>相关联，并且路由表的条目让<em>OneSequenceGestureRecognizer</em>的<em>handleEvent</em>方法与<em>PointerDownEvent</em>中的<em>transform</em>进行了关联。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// _routeMap以pointer作为Key，Map&lt;PointerRoute, Matrix4?&gt;作为Value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PointerRoute</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?&gt;&gt;</span> <span class="n">_routeMap</span> <span class="o">=</span> <span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PointerRoute</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?&gt;&gt;</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">addRoute</span><span class="p">(</span><span class="kt">int</span> <span class="n">pointer</span><span class="p">,</span> <span class="n">PointerRoute</span> <span class="n">route</span><span class="p">,</span> <span class="p">[</span><span class="n">Matrix4</span><span class="o">?</span> <span class="n">transform</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果_routeMap中存在该值为pointer的Key，那么返回它的Value，也就是一个Map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 否则，以该pointer为Key，空的Map为Value，创建一个新的Key-Value对存入_routeMap中，最后返回它的Value，也就是一个空的Map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PointerRoute</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?&gt;</span> <span class="n">routes</span> <span class="o">=</span> <span class="n">_routeMap</span><span class="p">.</span><span class="n">putIfAbsent</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">pointer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">()</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="n">PointerRoute</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?&gt;</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">routes</span><span class="p">.</span><span class="n">containsKey</span><span class="p">(</span><span class="n">route</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 再把PointerDownEvent中的transform存入该routes中，Key为route，也就是handleEvent方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 这里已经将OneSequenceGestureRecognizer的handleEvent方法与PointerDownEvent中的transform进行了关联，不过handleEvent方法由OneSequenceGestureRecognizer的子类实现
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">routes</span><span class="p">[</span><span class="n">route</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>再看下<em>OneSequenceGestureRecognizer</em>的 <em>_addPointerToArena</em> 方法，执行了<em>GestureBinding</em>中成员变量<em>gestureArena</em>的<em>add</em>方法，将新成员（例如手势识别器）添加到竞技场。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">GestureArenaEntry</span> <span class="n">_addPointerToArena</span><span class="p">(</span><span class="kt">int</span> <span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 该识别器所属的团队（如果有）。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 如果team为null，则此识别器直接在GestureArenaManager中竞争，将一系列指针事件识别为手势。如果team不为空，则该识别器在竞技场中与同一团队的其它识别器一起竞争。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 仅当团队未参加竞技场时，才能将识别器分配给该团队。例如，将识别器分配给团队的常见时间是在创建识别器后不久。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">_team</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">_team</span><span class="o">!</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 将新成员（例如手势识别器）添加到竞技场
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">GestureBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">gestureArena</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>GestureArenaManager</em>的<em>add</em>方法，可以发现<em>pointer</em>与手势竞技场 <em>_GestureArena</em> 相关联。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// _arenas以pointer作为Key，_GestureArena作为Value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">_GestureArena</span><span class="o">&gt;</span> <span class="n">_arenas</span> <span class="o">=</span> <span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">_GestureArena</span><span class="o">&gt;</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">/// Adds a new member (e.g., gesture recognizer) to the arena.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">GestureArenaEntry</span> <span class="n">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">pointer</span><span class="p">,</span> <span class="n">GestureArenaMember</span> <span class="n">member</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果_arenas中存在该值为pointer的Key，那么返回它的Value，也就是一个_GestureArena
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 否则，以该pointer为Key，新的_GestureArena为Value，创建一个新的Key-Value对存入_arenas中，最后返回它的Value，也就是一个新的_GestureArena
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">_GestureArena</span> <span class="n">state</span> <span class="o">=</span> <span class="n">_arenas</span><span class="p">.</span><span class="n">putIfAbsent</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">_debugLogDiagnostic</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="s1">&#39;★ Opening new gesture arena.&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">_GestureArena</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 将GestureArenaMember添加到_GestureArena中的成员变量members，它是一个List
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 此处的GestureArenaMember其实是我们的识别器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">state</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">member</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_debugLogDiagnostic</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="s1">&#39;Adding: </span><span class="si">$</span><span class="n">member</span><span class="s1">&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 最后返回GestureArenaEntry对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">GestureArenaEntry</span><span class="p">.</span><span class="n">_</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">pointer</span><span class="p">,</span> <span class="n">member</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>分析三：</p>
<p>回到<em>GestureRecognizer</em>的<em>addPointer</em>方法，看下<em>handleNonAllowedPointer</em>方法，它用来处理此识别器不允许添加的指针，子类可以重写此方法并拒绝手势。</p>
<p>一般情况下，<em>handleNonAllowedPointer</em>方法不会执行。对于<em>TapGestureRecognizer</em>来说，如果一个回调（例如<em>onTapDown</em>）都不传入<em>GestureDetector</em>，或者传入的<em>supportedDevices</em>和系统识别出来的输入设备的类型不一致，那么<em>isPointerAllowed</em>方法就会返回<em>false</em>，所以会执行<em>handleNonAllowedPointer</em>方法。</p>
<p>可以发现，在<em>GestureRecognizer</em>中<em>handleNonAllowedPointer</em>方法是一个空实现，由<em>GestureRecognizer</em>的子类去实现，那么看下<em>PrimaryPointerGestureRecognizer</em>的<em>handleNonAllowedPointer</em>方法，最后执行了父类的<em>handleNonAllowedPointer</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">handleNonAllowedPointer</span><span class="p">(</span><span class="n">PointerDownEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 该指针是通过赢得竞技场而被接受还是由调用acceptGesture的子类定义。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_gestureAccepted</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">handleNonAllowedPointer</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>OneSequenceGestureRecognizer</em>的<em>handleNonAllowedPointer</em>方法，执行了<em>resolve</em>方法，传入的状态是<em>GestureDisposition.rejected</em>。</p>
<p><em>resolve</em>方法也是可以被重写的，它由子类<em>BaseTapGestureRecognizer</em>去实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">handleNonAllowedPointer</span><span class="p">(</span><span class="n">PointerDownEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 使用给定的配置解决此识别器参与每个手势领域的问题
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 这里传入了GestureDisposition.rejected，说明该手势被拒绝作为对用户输入的解释
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">resolve</span><span class="p">(</span><span class="n">GestureDisposition</span><span class="p">.</span><span class="n">rejected</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>BaseTapGestureRecognizer</em>的<em>resolve</em>方法，最后执行了父类的<em>resolve</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">resolve</span><span class="p">(</span><span class="n">GestureDisposition</span> <span class="n">disposition</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_wonArenaForPrimaryPointer</span> <span class="o">&amp;&amp;</span> <span class="n">disposition</span> <span class="o">==</span> <span class="n">GestureDisposition</span><span class="p">.</span><span class="n">rejected</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果手势被取消，就会发生这种情况。例如，当指针超过触摸斜率时，按钮已改变，或者识别器被布置。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This can happen if the gesture has been canceled. For example, when
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the pointer has exceeded the touch slop, the buttons have been changed,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// or if the recognizer is disposed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">assert</span><span class="p">(</span><span class="n">_sentTapDown</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 之前触发过handleTapDown的指针最终不会导致点击
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 如果之前已触发过handleTapDown ，则一旦手势失去区域，就会触发此操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_checkCancel</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;spontaneous&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 重置成员变量的状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">super</span><span class="p">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">disposition</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>OneSequenceGestureRecognizer</em>的<em>resolve</em>方法，这里<em>disposition</em>传入的是<em>GestureDisposition.rejected</em>，执行所有<em>GestureArenaEntry</em>的<em>resolve</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">mustCallSuper</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">resolve</span><span class="p">(</span><span class="n">GestureDisposition</span> <span class="n">disposition</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 当然了，如果之前没调用startTrackingPointer方法的话，_entries就为空，那么localEntries也为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">GestureArenaEntry</span><span class="o">&gt;</span> <span class="n">localEntries</span> <span class="o">=</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">GestureArenaEntry</span><span class="o">&gt;</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">_entries</span><span class="p">.</span><span class="n">values</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_entries</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果localEntries为空，此处不会执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">GestureArenaEntry</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">localEntries</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span><span class="p">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">disposition</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>GestureArenaEntry</em>的<em>resolve</em>方法，可以看到，执行了<em>GestureArenaManager</em>的 <em>_resolve</em> 方法，该方法表示拒绝或接受手势识别器。</p>
<p>前面一路传过来的<em>disposition</em>为<em>GestureDisposition.rejected</em>，说明要拒绝手势识别器。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">GestureArenaManager</span> <span class="n">_arena</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">resolve</span><span class="p">(</span><span class="n">GestureDisposition</span> <span class="n">disposition</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_arena</span><span class="p">.</span><span class="n">_resolve</span><span class="p">(</span><span class="n">_pointer</span><span class="p">,</span> <span class="n">_member</span><span class="p">,</span> <span class="n">disposition</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="43gesturebinding的handleevent方法">4.3、<em>GestureBinding</em>的<em>handleEvent</em>方法</h2>
<p>之前讲过，<em>WidgetsFlutterBinding</em>也命中测试了，由于它是最后被添加到<em>HitTestResult</em>中的，所以在事件分发阶段<em>WidgetsFlutterBinding</em>的<em>handleEvent</em>会在最后被调用，只是<em>WidgetsFlutterBinding</em>没有重写<em>handleEvent</em>方法，这里是调用了混入<em>GestureBinding</em>的<em>handleEvent</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span> <span class="c1">// from HitTestTarget
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">handleEvent</span><span class="p">(</span><span class="n">PointerEvent</span> <span class="n">event</span><span class="p">,</span> <span class="n">HitTestEntry</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析一
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pointerRouter</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="k">is</span> <span class="n">PointerDownEvent</span> <span class="o">||</span> <span class="n">event</span> <span class="k">is</span> <span class="n">PointerPanZoomStartEvent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析二
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">gestureArena</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="k">is</span> <span class="n">PointerUpEvent</span> <span class="o">||</span> <span class="n">event</span> <span class="k">is</span> <span class="n">PointerPanZoomEndEvent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析三
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">gestureArena</span><span class="p">.</span><span class="n">sweep</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="k">is</span> <span class="n">PointerSignalEvent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">pointerSignalResolver</span><span class="p">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="431pointerdownevent事件分发">4.3.1、<em>PointerDownEvent</em>事件分发</h3>
<p>分析一：</p>
<p>在<em>PointerRouter</em>的<em>route</em>方法中，执行了 <em>_dispatchEventToRoutes</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">route</span><span class="p">(</span><span class="n">PointerEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 取出每个pointer对应的路由表，每个路由表都关联了所有手势识别器的handleEvent方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PointerRoute</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?&gt;?</span> <span class="n">routes</span> <span class="o">=</span> <span class="n">_routeMap</span><span class="p">[</span><span class="n">event</span><span class="p">.</span><span class="n">pointer</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 拷贝一份_globalRoutes，这个是全局路由相关的，本示例这里不涉及
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PointerRoute</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?&gt;</span> <span class="n">copiedGlobalRoutes</span> <span class="o">=</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PointerRoute</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?&gt;</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">_globalRoutes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">routes</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行handleEvent方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_dispatchEventToRoutes</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">event</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">routes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">Map</span><span class="o">&lt;</span><span class="n">PointerRoute</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?&gt;</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">routes</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 这个是全局路由相关的，本示例这里不涉及
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_dispatchEventToRoutes</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">_globalRoutes</span><span class="p">,</span> <span class="n">copiedGlobalRoutes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>PointerRouter</em>的 <em>_dispatchEventToRoutes</em> 方法，遍历了路由表，执行 <em>_dispatch</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_dispatchEventToRoutes</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">PointerEvent</span> <span class="n">event</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">Map</span><span class="o">&lt;</span><span class="n">PointerRoute</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?&gt;</span> <span class="n">referenceRoutes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">Map</span><span class="o">&lt;</span><span class="n">PointerRoute</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?&gt;</span> <span class="n">copiedRoutes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">copiedRoutes</span><span class="p">.</span><span class="n">forEach</span><span class="p">((</span><span class="n">PointerRoute</span> <span class="n">route</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?</span> <span class="n">transform</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">referenceRoutes</span><span class="p">.</span><span class="n">containsKey</span><span class="p">(</span><span class="n">route</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_dispatch</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">transform</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>PointerRouter</em>的 <em>_dispatch</em> 方法，可以发现，执行了<em>route</em>方法，此处<em>PointerRoute</em>其实是<em>OneSequenceGestureRecognizer</em>的<em>startTrackingPointer</em>方法中通过调用<em>GestureBinding</em>的成员变量<em>pointerRouter</em>的<em>addRoute</em>方法传入的<em>handleEvent</em>方法。</p>
<p>不过<em>OneSequenceGestureRecognizer</em>的<em>handleEvent</em>方法是一个空实现，它由子类<em>PrimaryPointerGestureRecognizer</em>来实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">pragma</span><span class="p">(</span><span class="s1">&#39;vm:notify-debugger-on-exception&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_dispatch</span><span class="p">(</span><span class="n">PointerEvent</span> <span class="n">event</span><span class="p">,</span> <span class="n">PointerRoute</span> <span class="n">route</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?</span> <span class="n">transform</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">transformed</span><span class="p">(</span><span class="n">transform</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行手势识别器的handleEvent方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">route</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">InformationCollector</span><span class="o">?</span> <span class="n">collector</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">collector</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="n">DiagnosticsNode</span><span class="o">&gt;</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">DiagnosticsProperty</span><span class="o">&lt;</span><span class="n">PointerRouter</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;router&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nl">level:</span> <span class="n">DiagnosticLevel</span><span class="p">.</span><span class="n">debug</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">DiagnosticsProperty</span><span class="o">&lt;</span><span class="n">PointerRoute</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="nl">level:</span> <span class="n">DiagnosticLevel</span><span class="p">.</span><span class="n">debug</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">DiagnosticsProperty</span><span class="o">&lt;</span><span class="n">PointerEvent</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="nl">level:</span> <span class="n">DiagnosticLevel</span><span class="p">.</span><span class="n">debug</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}());</span>
</span></span><span class="line"><span class="cl">    <span class="n">FlutterError</span><span class="p">.</span><span class="n">reportError</span><span class="p">(</span><span class="n">FlutterErrorDetails</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">exception:</span> <span class="n">exception</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">stack:</span> <span class="n">stack</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="k">library</span><span class="o">:</span> <span class="s1">&#39;gesture library&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">context:</span> <span class="n">ErrorDescription</span><span class="p">(</span><span class="s1">&#39;while routing a pointer event&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">informationCollector:</span> <span class="n">collector</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>PrimaryPointerGestureRecognizer</em>的<em>handleEvent</em>方法，可以发现执行了<em>handlePrimaryPointer</em>方法，该方法由子类<em>BaseTapGestureRecognizer</em>去实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">handleEvent</span><span class="p">(</span><span class="n">PointerEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">GestureRecognizerState</span><span class="p">.</span><span class="n">ready</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">GestureRecognizerState</span><span class="p">.</span><span class="n">possible</span> <span class="o">&amp;&amp;</span> <span class="n">event</span><span class="p">.</span><span class="n">pointer</span> <span class="o">==</span> <span class="n">primaryPointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">bool</span> <span class="n">isPreAcceptSlopPastTolerance</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="o">!</span><span class="n">_gestureAccepted</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">preAcceptSlopTolerance</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_getGlobalDistance</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">preAcceptSlopTolerance</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">bool</span> <span class="n">isPostAcceptSlopPastTolerance</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">_gestureAccepted</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">postAcceptSlopTolerance</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_getGlobalDistance</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">postAcceptSlopTolerance</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="k">is</span> <span class="n">PointerMoveEvent</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">isPreAcceptSlopPastTolerance</span> <span class="o">||</span> <span class="n">isPostAcceptSlopPastTolerance</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">resolve</span><span class="p">(</span><span class="n">GestureDisposition</span><span class="p">.</span><span class="n">rejected</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">stopTrackingPointer</span><span class="p">(</span><span class="n">primaryPointer</span><span class="o">!</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 因为先是分发PointerDownEvent，所以执行这里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">handlePrimaryPointer</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">stopTrackingIfPointerNoLongerDown</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>BaseTapGestureRecognizer</em>的<em>handlePrimaryPointer</em>方法，可以看到，该方法内部并没有对<em>PointerDownEvent</em>事件进行处理，所以整个 <em>pointerRouter.route(event)</em> 相当于没执行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">handlePrimaryPointer</span><span class="p">(</span><span class="n">PointerEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="k">is</span> <span class="n">PointerUpEvent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_up</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_checkUp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="k">is</span> <span class="n">PointerCancelEvent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">resolve</span><span class="p">(</span><span class="n">GestureDisposition</span><span class="p">.</span><span class="n">rejected</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_sentTapDown</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_checkCancel</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">_reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">buttons</span> <span class="o">!=</span> <span class="n">_down</span><span class="o">!</span><span class="p">.</span><span class="n">buttons</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 此处buttons相等，不满足条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">resolve</span><span class="p">(</span><span class="n">GestureDisposition</span><span class="p">.</span><span class="n">rejected</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">stopTrackingPointer</span><span class="p">(</span><span class="n">primaryPointer</span><span class="o">!</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>分析二：</p>
<p>如果<em>event</em>是<em>PointerDownEvent</em>，那么就会执行<em>GestureArenaManager</em>的<em>close</em>方法，在该方法中执行了 <em>_tryToResolveArena</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">close</span><span class="p">(</span><span class="kt">int</span> <span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">_GestureArena</span><span class="o">?</span> <span class="n">state</span> <span class="o">=</span> <span class="n">_arenas</span><span class="p">[</span><span class="n">pointer</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span> <span class="c1">// This arena either never existed or has been resolved.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">state</span><span class="p">.</span><span class="n">isOpen</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_debugLogDiagnostic</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="s1">&#39;Closing&#39;</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">_tryToResolveArena</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>GestureArenaManager</em>的 <em>_tryToResolveArena</em> 方法，执行了 <em>_resolveByDefault</em> 方法，在该方法中，此时<em>state.members</em>的数量为2，也就是两个<em>TapGestureRecognizer</em>手势识别器，并且此时还没有获胜者，所以<em>state.eagerWinner</em>为<em>null</em>，整个 <em>_tryToResolveArena</em> 方法相当于没执行。</p>
<p>那么，*gestureArena.close(event.pointer)*也相当于没执行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_tryToResolveArena</span><span class="p">(</span><span class="kt">int</span> <span class="n">pointer</span><span class="p">,</span> <span class="n">_GestureArena</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_arenas</span><span class="p">[</span><span class="n">pointer</span><span class="p">]</span> <span class="o">==</span> <span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">.</span><span class="n">isOpen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">members</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">scheduleMicrotask</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="n">_resolveByDefault</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">members</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_arenas</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pointer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">_debugLogDiagnostic</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="s1">&#39;Arena empty.&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">eagerWinner</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">_debugLogDiagnostic</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="s1">&#39;Eager winner: </span><span class="si">${</span><span class="n">state</span><span class="p">.</span><span class="n">eagerWinner</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">_resolveInFavorOf</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">eagerWinner</span><span class="o">!</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="432pointerupevent事件分发">4.3.2、<em>PointerUpEvent</em>事件分发</h3>
<p>分析一：</p>
<p>在<em>PointerRouter</em>的<em>route</em>方法中，执行了 <em>_dispatchEventToRoutes</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">route</span><span class="p">(</span><span class="n">PointerEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 取出每个pointer对应的路由表，每个路由表都关联了所有手势识别器的handleEvent方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PointerRoute</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?&gt;?</span> <span class="n">routes</span> <span class="o">=</span> <span class="n">_routeMap</span><span class="p">[</span><span class="n">event</span><span class="p">.</span><span class="n">pointer</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 拷贝一份_globalRoutes，这个是全局路由相关的，本示例这里不涉及
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PointerRoute</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?&gt;</span> <span class="n">copiedGlobalRoutes</span> <span class="o">=</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PointerRoute</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?&gt;</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">_globalRoutes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">routes</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行handleEvent方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_dispatchEventToRoutes</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">event</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">routes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">Map</span><span class="o">&lt;</span><span class="n">PointerRoute</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?&gt;</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">routes</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 这个是全局路由相关的，本示例这里不涉及
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_dispatchEventToRoutes</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">_globalRoutes</span><span class="p">,</span> <span class="n">copiedGlobalRoutes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>PointerRouter</em>的 <em>_dispatchEventToRoutes</em> 方法，遍历了路由表，执行 <em>_dispatch</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_dispatchEventToRoutes</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">PointerEvent</span> <span class="n">event</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">Map</span><span class="o">&lt;</span><span class="n">PointerRoute</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?&gt;</span> <span class="n">referenceRoutes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">Map</span><span class="o">&lt;</span><span class="n">PointerRoute</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?&gt;</span> <span class="n">copiedRoutes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">copiedRoutes</span><span class="p">.</span><span class="n">forEach</span><span class="p">((</span><span class="n">PointerRoute</span> <span class="n">route</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?</span> <span class="n">transform</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">referenceRoutes</span><span class="p">.</span><span class="n">containsKey</span><span class="p">(</span><span class="n">route</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_dispatch</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">transform</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>PointerRouter</em>的 <em>_dispatch</em> 方法，可以发现，执行了<em>route</em>方法，此处<em>PointerRoute</em>其实是<em>OneSequenceGestureRecognizer</em>的<em>startTrackingPointer</em>方法中通过调用<em>GestureBinding</em>的成员变量<em>pointerRouter</em>的<em>addRoute</em>方法传入的<em>handleEvent</em>方法。</p>
<p>不过<em>OneSequenceGestureRecognizer</em>的<em>handleEvent</em>方法是一个空实现，它由子类<em>PrimaryPointerGestureRecognizer</em>来实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">pragma</span><span class="p">(</span><span class="s1">&#39;vm:notify-debugger-on-exception&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_dispatch</span><span class="p">(</span><span class="n">PointerEvent</span> <span class="n">event</span><span class="p">,</span> <span class="n">PointerRoute</span> <span class="n">route</span><span class="p">,</span> <span class="n">Matrix4</span><span class="o">?</span> <span class="n">transform</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="n">transformed</span><span class="p">(</span><span class="n">transform</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">route</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">InformationCollector</span><span class="o">?</span> <span class="n">collector</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">collector</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="n">DiagnosticsNode</span><span class="o">&gt;</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">DiagnosticsProperty</span><span class="o">&lt;</span><span class="n">PointerRouter</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;router&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nl">level:</span> <span class="n">DiagnosticLevel</span><span class="p">.</span><span class="n">debug</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">DiagnosticsProperty</span><span class="o">&lt;</span><span class="n">PointerRoute</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="nl">level:</span> <span class="n">DiagnosticLevel</span><span class="p">.</span><span class="n">debug</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">DiagnosticsProperty</span><span class="o">&lt;</span><span class="n">PointerEvent</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="nl">level:</span> <span class="n">DiagnosticLevel</span><span class="p">.</span><span class="n">debug</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}());</span>
</span></span><span class="line"><span class="cl">    <span class="n">FlutterError</span><span class="p">.</span><span class="n">reportError</span><span class="p">(</span><span class="n">FlutterErrorDetails</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">exception:</span> <span class="n">exception</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">stack:</span> <span class="n">stack</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="k">library</span><span class="o">:</span> <span class="s1">&#39;gesture library&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">context:</span> <span class="n">ErrorDescription</span><span class="p">(</span><span class="s1">&#39;while routing a pointer event&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">informationCollector:</span> <span class="n">collector</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>PrimaryPointerGestureRecognizer</em>的<em>handleEvent</em>方法，可以发现执行了<em>handlePrimaryPointer</em>方法，该方法由子类<em>BaseTapGestureRecognizer</em>去实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">handleEvent</span><span class="p">(</span><span class="n">PointerEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">GestureRecognizerState</span><span class="p">.</span><span class="n">ready</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">GestureRecognizerState</span><span class="p">.</span><span class="n">possible</span> <span class="o">&amp;&amp;</span> <span class="n">event</span><span class="p">.</span><span class="n">pointer</span> <span class="o">==</span> <span class="n">primaryPointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">bool</span> <span class="n">isPreAcceptSlopPastTolerance</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="o">!</span><span class="n">_gestureAccepted</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">preAcceptSlopTolerance</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_getGlobalDistance</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">preAcceptSlopTolerance</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">bool</span> <span class="n">isPostAcceptSlopPastTolerance</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">_gestureAccepted</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">postAcceptSlopTolerance</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_getGlobalDistance</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">postAcceptSlopTolerance</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="k">is</span> <span class="n">PointerMoveEvent</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">isPreAcceptSlopPastTolerance</span> <span class="o">||</span> <span class="n">isPostAcceptSlopPastTolerance</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">resolve</span><span class="p">(</span><span class="n">GestureDisposition</span><span class="p">.</span><span class="n">rejected</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">stopTrackingPointer</span><span class="p">(</span><span class="n">primaryPointer</span><span class="o">!</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">handlePrimaryPointer</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">stopTrackingIfPointerNoLongerDown</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>BaseTapGestureRecognizer</em>的<em>handlePrimaryPointer</em>方法，此时<em>event</em>的类型为<em>PointerUpEvent</em>，所以执行 <em>_checkUp</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">handlePrimaryPointer</span><span class="p">(</span><span class="n">PointerEvent</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="k">is</span> <span class="n">PointerUpEvent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_up</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_checkUp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="k">is</span> <span class="n">PointerCancelEvent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">resolve</span><span class="p">(</span><span class="n">GestureDisposition</span><span class="p">.</span><span class="n">rejected</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_sentTapDown</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_checkCancel</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">_reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">buttons</span> <span class="o">!=</span> <span class="n">_down</span><span class="o">!</span><span class="p">.</span><span class="n">buttons</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">resolve</span><span class="p">(</span><span class="n">GestureDisposition</span><span class="p">.</span><span class="n">rejected</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">stopTrackingPointer</span><span class="p">(</span><span class="n">primaryPointer</span><span class="o">!</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>BaseTapGestureRecognizer</em>的 <em>_checkUp</em> 方法，此时是没有获胜者的，所以 <em>_wonArenaForPrimaryPointer</em>为<em>false</em>，那么 <em>_checkUp</em> 方法就会<em>return</em>，不会继续向下执行，所以整个 <em>pointerRouter.route(event)</em> 相当于没执行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_checkUp</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_wonArenaForPrimaryPointer</span> <span class="o">||</span> <span class="n">_up</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_up</span><span class="o">!</span><span class="p">.</span><span class="n">pointer</span> <span class="o">==</span> <span class="n">_down</span><span class="o">!</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">handleTapUp</span><span class="p">(</span><span class="nl">down:</span> <span class="n">_down</span><span class="o">!</span><span class="p">,</span> <span class="nl">up:</span> <span class="n">_up</span><span class="o">!</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>分析三：</p>
<p>如果<em>event</em>是<em>PointerUpEvent</em>，那么就会执行<em>GestureArenaManager</em>的<em>sweep</em>方法，在该方法中，执行了<em>List</em>中第一个手势识别器的<em>acceptGesture</em>方法，让其它手势识别器执行<em>rejectGesture</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// 强制解决竞技场，让第一个成员获胜。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">sweep</span><span class="p">(</span><span class="kt">int</span> <span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">_GestureArena</span><span class="o">?</span> <span class="n">state</span> <span class="o">=</span> <span class="n">_arenas</span><span class="p">[</span><span class="n">pointer</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span> <span class="c1">// This arena either never existed or has been resolved.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">.</span><span class="n">isOpen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">isHeld</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">.</span><span class="n">hasPendingSweep</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">_debugLogDiagnostic</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="s1">&#39;Delaying sweep&#39;</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span> <span class="c1">// This arena is being held for a long-lived member.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_debugLogDiagnostic</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="s1">&#39;Sweeping&#39;</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">_arenas</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pointer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">members</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// First member wins.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">assert</span><span class="p">(</span><span class="n">_debugLogDiagnostic</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="s1">&#39;Winner: </span><span class="si">${</span><span class="n">state</span><span class="p">.</span><span class="n">members</span><span class="p">.</span><span class="n">first</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">.</span><span class="n">members</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">acceptGesture</span><span class="p">(</span><span class="n">pointer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Give all the other members the bad news.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">state</span><span class="p">.</span><span class="n">members</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">state</span><span class="p">.</span><span class="n">members</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rejectGesture</span><span class="p">(</span><span class="n">pointer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>BaseTapGestureRecognizer</em>的<em>acceptGesture</em>方法，可以看到，执行了父类的<em>acceptGesture</em>方法，然后执行了 <em>_checkDown</em>与 <em>_checkUp</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">acceptGesture</span><span class="p">(</span><span class="kt">int</span> <span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">super</span><span class="p">.</span><span class="n">acceptGesture</span><span class="p">(</span><span class="n">pointer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">pointer</span> <span class="o">==</span> <span class="n">primaryPointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_checkDown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_wonArenaForPrimaryPointer</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_checkUp</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>PrimaryPointerGestureRecognizer</em>的<em>acceptGesture</em>方法，可以看到，做了一下清理工作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">acceptGesture</span><span class="p">(</span><span class="kt">int</span> <span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">pointer</span> <span class="o">==</span> <span class="n">primaryPointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_stopTimer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_gestureAccepted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>BaseTapGestureRecognizer</em>的 <em>_checkDown</em> 方法，执行了<em>handleTapDown</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_checkDown</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_sentTapDown</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">handleTapDown</span><span class="p">(</span><span class="nl">down:</span> <span class="n">_down</span><span class="o">!</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_sentTapDown</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>BaseTapGestureRecognizer</em>的<em>handleTapDown</em>方法，该方法由子类<em>TapGestureRecognizer</em>实现。可以看到，调用了<em>invokeCallback</em>方法去调用外部<em>GestureDetector</em>传入的回调。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">handleTapDown</span><span class="p">({</span><span class="kd">required</span> <span class="n">PointerDownEvent</span> <span class="n">down</span><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">TapDownDetails</span> <span class="n">details</span> <span class="o">=</span> <span class="n">TapDownDetails</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">globalPosition:</span> <span class="n">down</span><span class="p">.</span><span class="n">position</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">localPosition:</span> <span class="n">down</span><span class="p">.</span><span class="n">localPosition</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">kind:</span> <span class="n">getKindForPointer</span><span class="p">(</span><span class="n">down</span><span class="p">.</span><span class="n">pointer</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">(</span><span class="n">down</span><span class="p">.</span><span class="n">buttons</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">kPrimaryButton:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">onTapDown</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">invokeCallback</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;onTapDown&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">onTapDown</span><span class="o">!</span><span class="p">(</span><span class="n">details</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">kSecondaryButton:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">onSecondaryTapDown</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">invokeCallback</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;onSecondaryTapDown&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">onSecondaryTapDown</span><span class="o">!</span><span class="p">(</span><span class="n">details</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">kTertiaryButton:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">onTertiaryTapDown</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">invokeCallback</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;onTertiaryTapDown&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">onTertiaryTapDown</span><span class="o">!</span><span class="p">(</span><span class="n">details</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>BaseTapGestureRecognizer</em>的 <em>_checkUp</em> 方法，执行了<em>handleTapUp</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_checkUp</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_wonArenaForPrimaryPointer</span> <span class="o">||</span> <span class="n">_up</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_up</span><span class="o">!</span><span class="p">.</span><span class="n">pointer</span> <span class="o">==</span> <span class="n">_down</span><span class="o">!</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">handleTapUp</span><span class="p">(</span><span class="nl">down:</span> <span class="n">_down</span><span class="o">!</span><span class="p">,</span> <span class="nl">up:</span> <span class="n">_up</span><span class="o">!</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>BaseTapGestureRecognizer</em>的<em>handleTapUp</em>方法，该方法由子类<em>TapGestureRecognizer</em>实现。可以看到，调用了<em>invokeCallback</em>方法去调用外部<em>GestureDetector</em>传入的回调。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">handleTapUp</span><span class="p">({</span> <span class="kd">required</span> <span class="n">PointerDownEvent</span> <span class="n">down</span><span class="p">,</span> <span class="kd">required</span> <span class="n">PointerUpEvent</span> <span class="n">up</span><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">TapUpDetails</span> <span class="n">details</span> <span class="o">=</span> <span class="n">TapUpDetails</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">kind:</span> <span class="n">up</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">globalPosition:</span> <span class="n">up</span><span class="p">.</span><span class="n">position</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">localPosition:</span> <span class="n">up</span><span class="p">.</span><span class="n">localPosition</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">(</span><span class="n">down</span><span class="p">.</span><span class="n">buttons</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">kPrimaryButton:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">onTapUp</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">invokeCallback</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;onTapUp&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">onTapUp</span><span class="o">!</span><span class="p">(</span><span class="n">details</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">onTap</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">invokeCallback</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;onTap&#39;</span><span class="p">,</span> <span class="n">onTap</span><span class="o">!</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">kSecondaryButton:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">onSecondaryTapUp</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">invokeCallback</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;onSecondaryTapUp&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">onSecondaryTapUp</span><span class="o">!</span><span class="p">(</span><span class="n">details</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">onSecondaryTap</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">invokeCallback</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;onSecondaryTap&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">onSecondaryTap</span><span class="o">!</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">kTertiaryButton:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">onTertiaryTapUp</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">invokeCallback</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;onTertiaryTapUp&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">onTertiaryTapUp</span><span class="o">!</span><span class="p">(</span><span class="n">details</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="五同一个gesturedetector多种手势之间的冲突">五、同一个<em>GestureDetector</em>多种手势之间的冲突</h1>
<p>前面所讲的<em>GestureDetector</em>示例属于多个<em>GestureDetector</em>之间的手势竞争，由于手势竞争最终只有一个胜出者，所以，当我们通过一个<em>GestureDetector</em>监听多种手势时，也可能会产生冲突。例如下面这个例子，同时监听轻击事件与双击事件。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyApp</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">MyApp</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">GestureDetector</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="kd">const</span> <span class="n">ColoredBox</span><span class="p">(</span><span class="nl">color:</span> <span class="n">Colors</span><span class="p">.</span><span class="n">blueAccent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onTap:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;onTap&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onTapDown:</span> <span class="p">(</span><span class="n">TapDownDetails</span> <span class="n">details</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;onTapDown&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onTapUp:</span> <span class="p">(</span><span class="n">TapUpDetails</span> <span class="n">details</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;onTapUp&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onTapCancel:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;onTapCancel&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onDoubleTapDown:</span> <span class="p">(</span><span class="n">TapDownDetails</span> <span class="n">details</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;onDoubleTapDown&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>程序运行起来后双击界面，日志打印如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">I/flutter ( 8036): onDoubleTapDown
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以发现没有打印<em>Tap</em>相关的日志，因为双击包含两次间隔时间很短连续轻点击，第一次点击时执行了 <em>_registerFirstTap</em> 方法，开启间隔时间计时（这个值为<em>kDoubleTapTimeout</em>，相较于第一次轻点击会有200ms的延迟），并且通过执行<em>GestureArenaManager</em>的<em>hold</em>方法来防止竞技场被扫荡。通常，在所有其它<em>PointerUpEvent</em>处理完成后，会在竞技场中通过<em>sweep</em>选择获胜者。</p>
<p>相当于不给第一次轻点击获胜的机会，然后在没超过间隔时间内再次轻点击时，就完成了双击，此时双击手势已有完整的语义。接着就会调用 <em>_registerSecondTap</em> 方法宣称获得胜利。</p>
<p>这点通过<em>Flutter</em>内部手势竞技场的日志打印也可以看出来：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">I/flutter ( 8794): Gesture arena 1    ❙ ★ Opening new gesture arena.
</span></span><span class="line"><span class="cl">I/flutter ( 8794): Gesture arena 1    ❙ Adding: TapGestureRecognizer#15e11(debugOwner: GestureDetector, state: ready, button: 1)
</span></span><span class="line"><span class="cl">I/flutter ( 8794): Gesture arena 1    ❙ Adding: DoubleTapGestureRecognizer#c0988(debugOwner: GestureDetector)
</span></span><span class="line"><span class="cl">I/flutter ( 8794): Gesture arena 1    ❙ Closing with 2 members.
</span></span><span class="line"><span class="cl">I/flutter ( 8794): Gesture arena 1    ❙ Holding with 2 members.
</span></span><span class="line"><span class="cl">I/flutter ( 8794): Gesture arena 1    ❙ Delaying sweep with 2 members.
</span></span><span class="line"><span class="cl">I/flutter ( 8794): Gesture arena 2    ❙ ★ Opening new gesture arena.
</span></span><span class="line"><span class="cl">I/flutter ( 8794): Gesture arena 2    ❙ Adding: TapGestureRecognizer#15e11(debugOwner: GestureDetector, state: ready, button: 1)
</span></span><span class="line"><span class="cl">I/flutter ( 8794): onDoubleTapDown
</span></span><span class="line"><span class="cl">I/flutter ( 8794): Gesture arena 2    ❙ Adding: DoubleTapGestureRecognizer#c0988(debugOwner: GestureDetector)
</span></span><span class="line"><span class="cl">I/flutter ( 8794): Gesture arena 2    ❙ Closing with 2 members.
</span></span><span class="line"><span class="cl">I/flutter ( 8794): Gesture arena 1    ❙ Accepting: DoubleTapGestureRecognizer#c0988(debugOwner: GestureDetector)
</span></span><span class="line"><span class="cl">I/flutter ( 8794): Gesture arena 1    ❙ Self-declared winner: DoubleTapGestureRecognizer#c0988(debugOwner: GestureDetector)
</span></span><span class="line"><span class="cl">I/flutter ( 8794): Gesture arena 2    ❙ Accepting: DoubleTapGestureRecognizer#c0988(debugOwner: GestureDetector)
</span></span><span class="line"><span class="cl">I/flutter ( 8794): Gesture arena 2    ❙ Self-declared winner: DoubleTapGestureRecognizer#c0988(debugOwner: GestureDetector)
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="六解决手势冲突">六、解决手势冲突</h1>
<p>手势是对原始指针的语义化的识别，手势冲突只是手势级别的，也就是说只会在组件树中的多个 <em>GestureDetector</em>之间才有冲突的场景，如果压根就没有使用<em>GestureDetector</em>则不存在所谓的冲突，因为每一个节点都能收到事件，只是在<em>GestureDetector</em>中为了识别语义，它会去决定哪些子节点应该忽略事件，哪些节点应该生效。</p>
<p>解决手势冲突的方法有两种：</p>
<p>1、使用<em>Listener</em>。这相当于跳出了手势识别那套规则。</p>
<p>2、通过自定义手势识别器（<em>Recognizer</em>）。</p>
<h2 id="61通过listener解决手势冲突">6.1、通过<em>Listener</em>解决手势冲突</h2>
<p>通过<em>Listener</em>解决手势冲突的原因是竞争只是针对手势的，而<em>Listener</em>是监听原始指针事件，原始指针事件并非语义话的手势，所以根本不会走手势竞争的逻辑，所以也就不会相互影响。拿上面两个<em>GestureDetector</em>嵌套的例子来说，通过<em>Listener</em>的解决方式为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyApp</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">MyApp</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Listener</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">GestureDetector</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">child:</span> <span class="kd">const</span> <span class="n">ColoredBox</span><span class="p">(</span><span class="nl">color:</span> <span class="n">Colors</span><span class="p">.</span><span class="n">blueAccent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onTap:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;inner onTap&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onTapDown:</span> <span class="p">(</span><span class="n">TapDownDetails</span> <span class="n">details</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;inner onTapDown&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onTapUp:</span> <span class="p">(</span><span class="n">TapUpDetails</span> <span class="n">details</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;inner onTapUp&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onTapCancel:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;inner onTapCancel&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onPointerDown:</span> <span class="p">(</span><span class="n">PointerDownEvent</span> <span class="n">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;outer onPointerDown&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onPointerUp:</span> <span class="p">(</span><span class="n">PointerUpEvent</span> <span class="n">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;outer onPointerUp&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onPointerCancel:</span> <span class="p">(</span><span class="n">PointerCancelEvent</span> <span class="n">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;outer onPointerCancel&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>代码很简单，只需将<em>GestureDetector</em>换位<em>Listener</em>即可，可以两个都换，也可以只换一个。可以看见，通过<em>Listener</em>直接识别原始指针事件来解决冲突的方法很简单，因此，当遇到手势冲突时，我们应该优先考虑<em>Listener</em>。</p>
<h2 id="62通过自定义手势识别器recognizer解决手势冲突">6.2、通过自定义手势识别器<em>Recognizer</em>解决手势冲突</h2>
<p>自定义手势识别器的方式比较麻烦，原理是当确定手势竞争胜出者时，会调用胜出者的<em>acceptGesture</em>方法，表示“宣布成功”，然后会调用其它手势识别其的<em>rejectGesture</em>方法，表示“宣布失败”。</p>
<p>既然如此，我们可以自定义手势识别器（<em>Recognizer</em>），然后去重写它的<em>rejectGesture</em>方法：在里面调用<em>acceptGesture</em>方法，这就相当于它失败是强制将它也变成竞争的成功者了，这样它的回调也就会执行。</p>
<p>我们先自定义tap手势识别器（Recognizer）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyApp</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">MyApp</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">customGestureDetector</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">GestureDetector</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">child:</span> <span class="kd">const</span> <span class="n">ColoredBox</span><span class="p">(</span><span class="nl">color:</span> <span class="n">Colors</span><span class="p">.</span><span class="n">blueAccent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onTap:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;inner onTap&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onTapDown:</span> <span class="p">(</span><span class="n">TapDownDetails</span> <span class="n">details</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;inner onTapDown&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onTapUp:</span> <span class="p">(</span><span class="n">TapUpDetails</span> <span class="n">details</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;inner onTapUp&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onTapCancel:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;inner onTapCancel&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onTap:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;outer onTap&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onTapDown:</span> <span class="p">(</span><span class="n">TapDownDetails</span> <span class="n">details</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;outer onTapDown&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onTapUp:</span> <span class="p">(</span><span class="n">TapUpDetails</span> <span class="n">details</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;outer onTapUp&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onTapCancel:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;outer onTapCancel&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">CustomTapGestureRecognizer</span> <span class="kd">extends</span> <span class="n">TapGestureRecognizer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">rejectGesture</span><span class="p">(</span><span class="kt">int</span> <span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 宣布成功
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">acceptGesture</span><span class="p">(</span><span class="n">pointer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// NOTE：这里保留了后续清理操作，只是不知有无隐患
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">super</span><span class="p">.</span><span class="n">rejectGesture</span><span class="p">(</span><span class="n">pointer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">/// 创建一个新的GestureDetector，用我们自定义的TapGestureRecognizer替换默认的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">RawGestureDetector</span> <span class="n">customGestureDetector</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="n">GestureTapCallback</span><span class="o">?</span> <span class="n">onTap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">GestureTapDownCallback</span><span class="o">?</span> <span class="n">onTapDown</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">GestureTapUpCallback</span><span class="o">?</span> <span class="n">onTapUp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">GestureTapCancelCallback</span><span class="o">?</span> <span class="n">onTapCancel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span><span class="o">?</span> <span class="n">child</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">RawGestureDetector</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">gestures:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nl">CustomTapGestureRecognizer:</span> <span class="n">GestureRecognizerFactoryWithHandlers</span><span class="o">&lt;</span><span class="n">CustomTapGestureRecognizer</span><span class="o">&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">CustomTapGestureRecognizer</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">CustomTapGestureRecognizer</span> <span class="n">instance</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">instance</span>
</span></span><span class="line"><span class="cl">            <span class="p">..</span><span class="n">onTap</span> <span class="o">=</span> <span class="n">onTap</span>
</span></span><span class="line"><span class="cl">            <span class="p">..</span><span class="n">onTapDown</span> <span class="o">=</span> <span class="n">onTapDown</span>
</span></span><span class="line"><span class="cl">            <span class="p">..</span><span class="n">onTapUp</span> <span class="o">=</span> <span class="n">onTapUp</span>
</span></span><span class="line"><span class="cl">            <span class="p">..</span><span class="n">onTapCancel</span> <span class="o">=</span> <span class="n">onTapCancel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nl">child:</span> <span class="n">child</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>程序运行起来，轻点击后日志打印如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">I/flutter ( 9224): inner onTapDown
</span></span><span class="line"><span class="cl">I/flutter ( 9224): inner onTapUp
</span></span><span class="line"><span class="cl">I/flutter ( 9224): inner onTap
</span></span><span class="line"><span class="cl">I/flutter ( 9224): outer onTapDown
</span></span><span class="line"><span class="cl">I/flutter ( 9224): outer onTapUp
</span></span><span class="line"><span class="cl">I/flutter ( 9224): outer onTap
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样就<em>OK</em>了，需要注意，这个例子同时说明了一次手势处理过程也是可以有多个胜出者的。</p>
<h1 id="七总结">七、总结</h1>
<p>1、每一个手势识别器<em>GestureRecognizer</em>都是一个“竞争者”（<em>GestureArenaMember</em>），当发生指针事件时，它们都要在“竞技场”去竞争本次事件的处理权，默认情况最终只有一个“竞争者”会胜出(<em>win</em>)。</p>
<p>2、<em>GestureRecognizer</em>的<em>handleEvent</em>中会识别手势，如果发生了某个手势，竞争者可以宣布自己是否胜出，一旦有一个竞争者胜出，竞技场管理者（<em>GestureArenaManager</em>）就会通知其他竞争者失败。</p>
<p>3、胜出者的<em>acceptGesture</em>会被调用，其余失败者的<em>rejectGesture</em>将会被调用。</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">AndDevMK</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2023-11-14
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/wechat-qr-code.JPG">
        <span>微信打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/alipay-qr-code.JPG">
        <span>支付宝打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Bnavigator%E5%91%BD%E4%BB%A4%E5%BC%8F/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">解读Flutter源码之Navigator（命令式）</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Blistener/">
            <span class="next-text nav-default">解读Flutter源码之Listener</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="AndDevMK/blog-utterances"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    
    <div id="search_mask" class="search_mask">
    <div class="search_modal">
        <div id="close_search" class="close_search">关闭</div>
        <div class="search_divider"></div>
        <input id="input_search_key" class="input_search_key" placeholder="请输入你要搜索的内容" tabindex="0">
        <ul id="search_list">
        </ul>
    </div>
</div>

<script src="/js/fuse.js"></script> 
<script src="/js/fastsearch.js"></script>

    <footer id="footer" class="footer">
      

<div class="copyright">
  <span class="power-by">
    由 <a id="hexo-link" class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    
    <span id="run-time" class="run-time"></span> 
    <span class="heart"><i class="iconfont icon-heart"></i></span>
    &copy; 
    2023 - 
    2024&nbsp;
    <span>AndDevMK</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.11a4ba15caf2d921d57eaf6568c4ad21eafd5d2c001cbcb31693586c63f93005.js"></script>

<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?6db179fb88e600cf326b0515a8aa1de3";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>




<script src="/js/codecopy.js"></script>



<link disabled id="dark-mode-theme" rel="stylesheet" href="/css/dark.css"></link>
<script src="/js/dark.js"></script>


<script src="/js/site_runtime.js"></script>




</body>
</html>
