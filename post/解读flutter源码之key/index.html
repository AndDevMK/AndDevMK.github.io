<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>解读Flutter源码之Key - AndDevMK&#39;s android blog site</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="AndDevMK" /><meta name="description" content="注：本文代码基于Flutter SDK 3.13.5 一、Key是什么？ 在Flutter中，Key的使用是很常见的，就以Scaffold这个Widget来说，当人们使用它的Drawer功能时，必然会涉及openDrawer与closeDrawer这两个行为，它们的具体方法实现定义在ScaffoldS" /><meta name="keywords" content="Android, Java, Kotlin, C&#43;&#43;, C, Flutter, Dart, NDK" />


<meta name="baidu-site-verification" content="codeva-wQ7uOo4V09" />
<meta name="google-site-verification" content="yHzWB9BxTR74LiaUhuL5ncr89fnDYXiplTaPY565zqo" />


<meta name="generator" content="Hugo 0.111.3 with theme even" />


<link rel="canonical" href="https://anddevmk.github.io/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Bkey/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.c11aaf02bef1025d6b0813ba5e1a8a8551aee15fa8f2bcea906d41b20bdf5c69.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/codecopy.css">


<meta property="og:title" content="解读Flutter源码之Key" />
<meta property="og:description" content="注：本文代码基于Flutter SDK 3.13.5 一、Key是什么？ 在Flutter中，Key的使用是很常见的，就以Scaffold这个Widget来说，当人们使用它的Drawer功能时，必然会涉及openDrawer与closeDrawer这两个行为，它们的具体方法实现定义在ScaffoldS" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://anddevmk.github.io/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Bkey/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-10-27T11:28:31+08:00" />
<meta property="article:modified_time" content="2023-10-27T11:28:31+08:00" />
<meta itemprop="name" content="解读Flutter源码之Key">
<meta itemprop="description" content="注：本文代码基于Flutter SDK 3.13.5 一、Key是什么？ 在Flutter中，Key的使用是很常见的，就以Scaffold这个Widget来说，当人们使用它的Drawer功能时，必然会涉及openDrawer与closeDrawer这两个行为，它们的具体方法实现定义在ScaffoldS"><meta itemprop="datePublished" content="2023-10-27T11:28:31+08:00" />
<meta itemprop="dateModified" content="2023-10-27T11:28:31+08:00" />
<meta itemprop="wordCount" content="21889">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="解读Flutter源码之Key"/>
<meta name="twitter:description" content="注：本文代码基于Flutter SDK 3.13.5 一、Key是什么？ 在Flutter中，Key的使用是很常见的，就以Scaffold这个Widget来说，当人们使用它的Drawer功能时，必然会涉及openDrawer与closeDrawer这两个行为，它们的具体方法实现定义在ScaffoldS"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">AndDevMK</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>

    
    <li class="mobile-menu-item-search">
      <div id="mobile_open_search" class="mobile_open_search">
        搜索
      </div>
    </li>

    
    <li class="mobile-menu-item-dark-mode">
      <div id="mobile_dark_mode_toggle" class="mobile_light_mode">
       
      </div>
    </li>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">AndDevMK</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
    
    <div id="open_search" class="open_search">
      搜索
    </div>

    
    <div id="dark_mode_toggle" class="light_mode">

    </div>
  
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">解读Flutter源码之Key</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-10-27 </span>
        <div class="post-category">
            <a href="/categories/flutter/"> Flutter </a>
            </div>
          <span class="more-meta"> 约 21889 字 </span>
          <span class="more-meta"> 预计阅读 44 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#一key是什么">一、<em>Key</em>是什么？</a></li>
    <li><a href="#二3个小示例之问题">二、3个小示例之问题</a>
      <ul>
        <li><a href="#21示例1">2.1、示例1</a></li>
        <li><a href="#22示例2">2.2、示例2</a></li>
        <li><a href="#23示例3">2.3、示例3</a></li>
      </ul>
    </li>
    <li><a href="#三3个小示例之执行原理">三、3个小示例之执行原理</a>
      <ul>
        <li><a href="#31分析示例1">3.1、分析示例1</a>
          <ul>
            <li><a href="#311分析第一部分">3.1.1、分析第一部分</a></li>
            <li><a href="#312分析第二部分">3.1.2、分析第二部分</a></li>
            <li><a href="#313分析第三部分">3.1.3、分析第三部分</a>
              <ul>
                <li><a href="#3131第一轮循环">3.1.3.1、第一轮循环</a></li>
                <li><a href="#3132第二轮循环">3.1.3.2、第二轮循环</a></li>
                <li><a href="#3133第三轮循环">3.1.3.3、第三轮循环</a></li>
              </ul>
            </li>
            <li><a href="#314分析第五部分">3.1.4、分析第五部分</a></li>
            <li><a href="#315分析第十部分">3.1.5、分析第十部分</a></li>
          </ul>
        </li>
        <li><a href="#32分析示例2">3.2、分析示例2</a>
          <ul>
            <li><a href="#321分析第三部分">3.2.1、分析第三部分</a>
              <ul>
                <li><a href="#3211第二轮循环">3.2.1.1、第二轮循环</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#33分析示例3">3.3、分析示例3</a>
          <ul>
            <li><a href="#331分析第三部分">3.3.1、分析第三部分</a>
              <ul>
                <li><a href="#3311第二轮循环">3.3.1.1、第二轮循环</a></li>
              </ul>
            </li>
            <li><a href="#332分析第四部分">3.3.2、分析第四部分</a>
              <ul>
                <li><a href="#3321第一轮循环">3.3.2.1、第一轮循环</a></li>
                <li><a href="#3322第二轮循环">3.3.2.2、第二轮循环</a></li>
              </ul>
            </li>
            <li><a href="#333分析第五部分">3.3.3、分析第五部分</a>
              <ul>
                <li><a href="#3331第一轮循环">3.3.3.1、第一轮循环</a></li>
                <li><a href="#3332第二轮循环">3.3.3.2、第二轮循环</a></li>
              </ul>
            </li>
            <li><a href="#334分析第七部分">3.3.4、分析第七部分</a></li>
            <li><a href="#335分析第八部分">3.3.5、分析第八部分</a>
              <ul>
                <li><a href="#3351第一轮循环">3.3.5.1、第一轮循环</a></li>
                <li><a href="#3352第二轮循环">3.3.5.2、第二轮循环</a></li>
              </ul>
            </li>
            <li><a href="#336分析第九部分">3.3.6、分析第九部分</a></li>
            <li><a href="#337分析第十部分">3.3.7、分析第十部分</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#四key的分类">四、<em>Key</em>的分类</a>
      <ul>
        <li><a href="#41globalkey">4.1、<em>GlobalKey</em></a></li>
        <li><a href="#42localkey">4.2、<em>LocalKey</em></a>
          <ul>
            <li><a href="#421valuekey">4.2.1、<em>ValueKey</em></a></li>
            <li><a href="#422objectkey">4.2.2、<em>ObjectKey</em></a></li>
            <li><a href="#423uniquekey">4.2.3、<em>UniqueKey</em></a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <blockquote>
<p><em>注：本文代码基于Flutter SDK 3.13.5</em></p>
</blockquote>
<h1 id="一key是什么">一、<em>Key</em>是什么？</h1>
<p>在<em>Flutter</em>中，<em>Key</em>的使用是很常见的，就以<em>Scaffold</em>这个<em>Widget</em>来说，当人们使用它的<em>Drawer</em>功能时，必然会涉及<em>openDrawer</em>与<em>closeDrawer</em>这两个行为，它们的具体方法实现定义在<em>ScaffoldState</em>中，可通过如下<em>API</em>调用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">Scaffold</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">openDrawer</span><span class="p">();</span>  <span class="c1">// or Scaffold.of(context).closeDrawer();
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>不妨点进去看下<em>ScaffoldState</em>中的<em>openDrawer</em>与<em>closeDrawer</em>这两个方法的实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">GlobalKey</span><span class="o">&lt;</span><span class="n">DrawerControllerState</span><span class="o">&gt;</span> <span class="n">_drawerKey</span> <span class="o">=</span> <span class="n">GlobalKey</span><span class="o">&lt;</span><span class="n">DrawerControllerState</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">openDrawer</span><span class="p">()</span> <span class="p">{</span>                                                  
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_endDrawerKey</span><span class="p">.</span><span class="n">currentState</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">_endDrawerOpened</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_endDrawerKey</span><span class="p">.</span><span class="n">currentState</span><span class="o">!</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>                             
</span></span><span class="line"><span class="cl">  <span class="p">}</span>                                                                  
</span></span><span class="line"><span class="cl">  <span class="n">_drawerKey</span><span class="p">.</span><span class="n">currentState</span><span class="o">?</span><span class="p">.</span><span class="n">open</span><span class="p">();</span>                                   
</span></span><span class="line"><span class="cl"><span class="p">}</span>                                                                    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">closeDrawer</span><span class="p">()</span> <span class="p">{</span>                
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="p">(</span><span class="n">hasDrawer</span> <span class="o">&amp;&amp;</span> <span class="n">isDrawerOpen</span><span class="p">)</span> <span class="p">{</span>   
</span></span><span class="line"><span class="cl">   <span class="n">_drawerKey</span><span class="p">.</span><span class="n">currentState</span><span class="o">!</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>                                  
</span></span><span class="line"><span class="cl"><span class="p">}</span>                                       
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以发现，它们均使用了<code>_drawerKey</code>这一个<em>GlobalKey</em>来获取<em>currentState</em>，也就是获取了<em>DrawerControllerState</em>实例，然后再调用该实例的<em>open</em>或<em>close</em>方法。</p>
<p>那么，正如标题所言，<em>Key</em>是什么？<em>还是那句话：遇事不决，先看注释</em>。<em>Key</em>作为参数定义在<em>Widget</em>的构造方法中，默认值为<em>null</em>，也就是使用<em>Widget</em>时可以不传，来看下<em>Widget</em>中关于<em>Key</em>的注释。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">immutable</span>
</span></span><span class="line"><span class="cl"><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Widget</span> <span class="kd">extends</span> <span class="n">DiagnosticableTree</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">/// Initializes [key] for subclasses.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">const</span> <span class="n">Widget</span><span class="p">({</span> <span class="k">this</span><span class="p">.</span><span class="n">key</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">/// 控制一个widget如何替换树中的另一个widget。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// Controls how one widget replaces another widget in the tree.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// 如果两个widgets的 [runtimeType] 和 [key] 属性分别为 [operator==]，则新widget通过更新底层element来替换旧widget（即，通过使用新widget调用 [Element.update] ）。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// 否则，旧element将从树中删除，新的widget将创建出element，并将新element插入到树中。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// If the [runtimeType] and [key] properties of the two widgets are
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// [operator==], respectively, then the new widget replaces the old widget by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// updating the underlying element (i.e., by calling [Element.update] with the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// new widget). Otherwise, the old element is removed from the tree, the new
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// widget is inflated into an element, and the new element is inserted into the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// tree.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// 此外，使用 [GlobalKey] 作为widget的 [key] 允许element在树中移动（更改父级）而不会丢失状态。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// 当找到一个新的widget（其key和type与同一位置的前一个widget不匹配），但在前一帧的树中的其它位置有一个具有相同global key的widget时，该widget的element将移动到新地点。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// In addition, using a [GlobalKey] as the widget&#39;s [key] allows the element
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// to be moved around the tree (changing parent) without losing state. When a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// new widget is found (its key and type do not match a previous widget in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// the same location), but there was a widget with that same global key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// elsewhere in the tree in the previous frame, then that widget&#39;s element is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// moved to the new location.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// 通常，作为另一个widget的唯一child的widget不需要显式key。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// Generally, a widget that is the only child of another widget does not need
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// an explicit key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Key</span><span class="o">?</span> <span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>再点击进去看下<em>Key</em>本身的一个注释。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">/// [Key] 是 [Widget]、[Element] 和 [SemanticsNode] 的标识符。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// A [Key] is an identifier for [Widget]s, [Element]s and [SemanticsNode]s.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 如果新的widget的key与与该element关联的当前widget的key相同，则该新widget将仅用于更新现有element。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// A new widget will only be used to update an existing element if its key is
</span></span></span><span class="line"><span class="cl"><span class="c1">/// the same as the key of the current widget associated with the element.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// {@youtube 560 315 https://www.youtube.com/watch?v=kn0EOS-ZiIc}
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Key在具有相同父级的 [Element] 中必须是唯一的。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Keys must be unique amongst the [Element]s with the same parent.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [Key] 的子类应该是 [LocalKey] 或 [GlobalKey] 的子类。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Subclasses of [Key] should either subclass [LocalKey] or [GlobalKey].
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">@</span><span class="n">immutable</span>
</span></span><span class="line"><span class="cl"><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Key</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>结合上面<em>Widget</em>中对<em>Key</em>的注释以及<em>Key</em>本身的一个注释，总结下<em>Key</em>的特性：</p>
<p>1、<em>Key</em>用于控制一个<em>Widget</em>如何替换树中的另一个<em>Widget</em>。</p>
<p>2、如果两个<em>Widget</em>的<em>runtimeType</em>和<em>key</em>属性分别为相等，则新<em>Widget</em>通过更新底层<em>Element</em>来替换旧<em>Widget</em>；否则旧<em>Element</em>将从树中删除，新的<em>Widget</em>将创建出<em>Element</em>，并将新<em>Element</em>插入到树中。</p>
<p>3、使用<em>GlobalKey</em>作为<em>Widget</em>的<em>key</em>允许<em>Element</em>在树中移动（更改父级）而不会丢失状态。</p>
<p>4、<em>Key</em>在具有相同父级的<em>Element</em>中必须是唯一的。</p>
<p>5、&hellip;</p>
<p>这里给出了<em>Key</em>的部分特性，主要是想让大家对<em>Key</em>有一个初级认知。</p>
<h1 id="二3个小示例之问题">二、3个小示例之问题</h1>
<p>在分析<em>Key</em>的原理之前，先看个“<em>删除中间色块</em>”的小示例。</p>
<p>现有一需求：设计一个通用的色块<em>Widget</em>，然后在屏幕中横向摆放三个不同颜色的色块<em>Widget</em>，当点击<em>FloatingActionButton</em>按钮时会删除中间色块。</p>
<h2 id="21示例1">2.1、示例1</h2>
<p>基于<em>StatelessWidget</em>设计一个通用的色块<em>Widget</em>，并通过构造方法传入<em>ColorValue</em>枚举值参数来控制色块颜色，然后在<em>build</em>方法中进行<em>Color</em>初始化。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">runApp</span><span class="p">(</span><span class="kd">const</span> <span class="n">MyApp</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyApp</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">MyApp</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">MaterialApp</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">title:</span> <span class="s1">&#39;Flutter Demo&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">theme:</span> <span class="n">ThemeData</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">colorScheme:</span> <span class="n">ColorScheme</span><span class="p">.</span><span class="n">fromSeed</span><span class="p">(</span><span class="nl">seedColor:</span> <span class="n">Colors</span><span class="p">.</span><span class="n">deepPurple</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">useMaterial3:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">home:</span> <span class="kd">const</span> <span class="n">MyPage</span><span class="p">(</span><span class="nl">title:</span> <span class="s1">&#39;小示例&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyPage</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">MyPage</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="kd">required</span> <span class="k">this</span><span class="p">.</span><span class="n">title</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">String</span> <span class="n">title</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">State</span><span class="o">&lt;</span><span class="n">MyPage</span><span class="o">&gt;</span> <span class="n">createState</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="n">_MyPageState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">_MyPageState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">MyPage</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Widget</span><span class="o">&gt;</span> <span class="n">_boxes</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="kd">const</span> <span class="n">StatelessBox</span><span class="p">(</span><span class="nl">colorValue:</span> <span class="n">ColorValue</span><span class="p">.</span><span class="n">redAccent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="kd">const</span> <span class="n">StatelessBox</span><span class="p">(</span><span class="nl">colorValue:</span> <span class="n">ColorValue</span><span class="p">.</span><span class="n">greenAccent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="kd">const</span> <span class="n">StatelessBox</span><span class="p">(</span><span class="nl">colorValue:</span> <span class="n">ColorValue</span><span class="p">.</span><span class="n">blueAccent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">_refresh</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_boxes</span><span class="p">.</span><span class="n">removeAt</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">appBar:</span> <span class="n">AppBar</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">backgroundColor:</span> <span class="n">Theme</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">inversePrimary</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">title:</span> <span class="n">Text</span><span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">title</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">body:</span> <span class="n">Row</span><span class="p">(</span><span class="nl">children:</span> <span class="n">_boxes</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">floatingActionButton:</span> <span class="n">FloatingActionButton</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onPressed:</span> <span class="n">_refresh</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">tooltip:</span> <span class="s1">&#39;refresh&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">child:</span> <span class="kd">const</span> <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="p">.</span><span class="n">refresh</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">enum</span> <span class="n">ColorValue</span> <span class="p">{</span> <span class="n">redAccent</span><span class="p">,</span> <span class="n">greenAccent</span><span class="p">,</span> <span class="n">blueAccent</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">StatelessBox</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">ColorValue</span> <span class="n">colorValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">StatelessBox</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="kd">required</span> <span class="k">this</span><span class="p">.</span><span class="n">colorValue</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Color</span> <span class="n">_getColor</span><span class="p">(</span><span class="n">ColorValue</span> <span class="n">colorValue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">colorValue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">ColorValue</span><span class="p">.</span><span class="nl">redAccent:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Colors</span><span class="p">.</span><span class="n">redAccent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">ColorValue</span><span class="p">.</span><span class="nl">greenAccent:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Colors</span><span class="p">.</span><span class="n">greenAccent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">ColorValue</span><span class="p">.</span><span class="nl">blueAccent:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Colors</span><span class="p">.</span><span class="n">blueAccent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Color</span> <span class="n">color</span> <span class="o">=</span> <span class="n">_getColor</span><span class="p">(</span><span class="n">colorValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">debugPrint</span><span class="p">(</span><span class="s2">&#34;build: </span><span class="si">$</span><span class="n">color</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Container</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">width:</span> <span class="m">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">height:</span> <span class="m">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">color:</span> <span class="n">color</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>程序运行起来后，可以看到如下效果。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/示例1.gif" alt="" width="235">
<p>程序刚运行起来，日志打印如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">I/flutter (15182): build: MaterialAccentColor(primary value: Color(0xffff5252))
</span></span><span class="line"><span class="cl">I/flutter (15182): build: MaterialAccentColor(primary value: Color(0xff69f0ae))
</span></span><span class="line"><span class="cl">I/flutter (15182): build: MaterialAccentColor(primary value: Color(0xff448aff))
</span></span></code></pre></td></tr></table>
</div>
</div><p>点击<em>FloatingActionButton</em>按钮后，日志打印如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">I/flutter (15182): build: MaterialAccentColor(primary value: Color(0xff448aff))
</span></span></code></pre></td></tr></table>
</div>
</div><p>总结：初始时色块颜色从左到右的顺序为<em><strong>红、绿、蓝</strong></em>，当点击<em>FloatingActionButton</em>按钮后，色块颜色的顺序变为<em><strong>红、蓝</strong></em>，虽然程序运行效果与预期效果相同，但是还是存在一些疑问（也就是点击<em>FloatingActionButton</em>按钮后）：</p>
<p>1、为什么日志打印是蓝色？</p>
<p>2、为什么红色块自身的<em>build</em>方法不会触发？</p>
<p>3、&hellip;</p>
<h2 id="22示例2">2.2、示例2</h2>
<p>基于<em>StatefulWidget</em>设计一个通用的色块<em>Widget</em>，并通过构造方法传入<em>ColorValue</em>枚举值参数来控制色块颜色，然后在<em>initState</em>方法中进行<em>Color</em>初始化。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyPage</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">MyPage</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="kd">required</span> <span class="k">this</span><span class="p">.</span><span class="n">title</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">String</span> <span class="n">title</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">State</span><span class="o">&lt;</span><span class="n">MyPage</span><span class="o">&gt;</span> <span class="n">createState</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="n">_MyPageState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">_MyPageState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">MyPage</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Widget</span><span class="o">&gt;</span> <span class="n">_boxes</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="kd">const</span> <span class="n">StatefulBox</span><span class="p">(</span><span class="nl">colorValue:</span> <span class="n">ColorValue</span><span class="p">.</span><span class="n">redAccent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="kd">const</span> <span class="n">StatefulBox</span><span class="p">(</span><span class="nl">colorValue:</span> <span class="n">ColorValue</span><span class="p">.</span><span class="n">greenAccent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="kd">const</span> <span class="n">StatefulBox</span><span class="p">(</span><span class="nl">colorValue:</span> <span class="n">ColorValue</span><span class="p">.</span><span class="n">blueAccent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">_refresh</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_boxes</span><span class="p">.</span><span class="n">removeAt</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">appBar:</span> <span class="n">AppBar</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">backgroundColor:</span> <span class="n">Theme</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">inversePrimary</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">title:</span> <span class="n">Text</span><span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">title</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">body:</span> <span class="n">Row</span><span class="p">(</span><span class="nl">children:</span> <span class="n">_boxes</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">floatingActionButton:</span> <span class="n">FloatingActionButton</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onPressed:</span> <span class="n">_refresh</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">tooltip:</span> <span class="s1">&#39;refresh&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">child:</span> <span class="kd">const</span> <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="p">.</span><span class="n">refresh</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">enum</span> <span class="n">ColorValue</span> <span class="p">{</span> <span class="n">redAccent</span><span class="p">,</span> <span class="n">greenAccent</span><span class="p">,</span> <span class="n">blueAccent</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">StatefulBox</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">ColorValue</span> <span class="n">colorValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">StatefulBox</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="kd">required</span> <span class="k">this</span><span class="p">.</span><span class="n">colorValue</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">State</span><span class="o">&lt;</span><span class="n">StatefulBox</span><span class="o">&gt;</span> <span class="n">createState</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="n">_StatefulBoxState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">_StatefulBoxState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">StatefulBox</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">late</span> <span class="n">Color</span> <span class="n">_color</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">initState</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">initState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;initState&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_color</span> <span class="o">=</span> <span class="n">_getColor</span><span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">colorValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Color</span> <span class="n">_getColor</span><span class="p">(</span><span class="n">ColorValue</span> <span class="n">colorValue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">colorValue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">ColorValue</span><span class="p">.</span><span class="nl">redAccent:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Colors</span><span class="p">.</span><span class="n">redAccent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">ColorValue</span><span class="p">.</span><span class="nl">greenAccent:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Colors</span><span class="p">.</span><span class="n">greenAccent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">ColorValue</span><span class="p">.</span><span class="nl">blueAccent:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Colors</span><span class="p">.</span><span class="n">blueAccent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;build: </span><span class="si">$</span><span class="n">_color</span><span class="s1">&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Container</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">width:</span> <span class="m">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">height:</span> <span class="m">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">color:</span> <span class="n">_color</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>程序运行起来后，可以看到如下效果。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例2/示例2.gif" alt="" width="235">
<p>程序刚运行起来，日志打印如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">I/flutter (15657): initState
</span></span><span class="line"><span class="cl">I/flutter (15657): build: MaterialAccentColor(primary value: Color(0xffff5252))
</span></span><span class="line"><span class="cl">I/flutter (15657): initState
</span></span><span class="line"><span class="cl">I/flutter (15657): build: MaterialAccentColor(primary value: Color(0xff69f0ae))
</span></span><span class="line"><span class="cl">I/flutter (15657): initState
</span></span><span class="line"><span class="cl">I/flutter (15657): build: MaterialAccentColor(primary value: Color(0xff448aff))
</span></span></code></pre></td></tr></table>
</div>
</div><p>点击<em>FloatingActionButton</em>按钮后，日志打印如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">I/flutter (15657): build: MaterialAccentColor(primary value: Color(0xff69f0ae))
</span></span></code></pre></td></tr></table>
</div>
</div><p>总结：初始时色块颜色从左到右的顺序为<em><strong>红、绿、蓝</strong></em>，当点击<em>FloatingActionButton</em>按钮后，色块颜色的顺序变为<em><strong>红、绿</strong></em>，很明显程序运行效果与预期效果不相同，因此存在一些疑问（也就是点击<em>FloatingActionButton</em>按钮后）：</p>
<p>1、为什么删除的是蓝色块？</p>
<p>2、为什么日志打印是绿色？</p>
<p>3、为什么红色块自身的<em>build</em>方法不会触发？</p>
<p>4、&hellip;</p>
<h2 id="23示例3">2.3、示例3</h2>
<p>基于<em>StatefulWidget</em>设计一个通用的色块<em>Widget</em>，并通过构造方法传入<em>ColorValue</em>枚举值参数来控制色块颜色，然后在<em>initState</em>方法中进行<em>Color</em>初始化，最后在使用色块<em>Widget</em>时给它传入一个<em>Key</em>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyPage</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">MyPage</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="kd">required</span> <span class="k">this</span><span class="p">.</span><span class="n">title</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">String</span> <span class="n">title</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">State</span><span class="o">&lt;</span><span class="n">MyPage</span><span class="o">&gt;</span> <span class="n">createState</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="n">_MyPageState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">_MyPageState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">MyPage</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Widget</span><span class="o">&gt;</span> <span class="n">_boxes</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="kd">const</span> <span class="n">StatefulBox</span><span class="p">(</span><span class="nl">key:</span> <span class="n">ValueKey</span><span class="p">(</span><span class="m">1</span><span class="p">),</span> <span class="nl">colorValue:</span> <span class="n">ColorValue</span><span class="p">.</span><span class="n">redAccent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="kd">const</span> <span class="n">StatefulBox</span><span class="p">(</span><span class="nl">key:</span> <span class="n">ValueKey</span><span class="p">(</span><span class="m">2</span><span class="p">),</span> <span class="nl">colorValue:</span> <span class="n">ColorValue</span><span class="p">.</span><span class="n">greenAccent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="kd">const</span> <span class="n">StatefulBox</span><span class="p">(</span><span class="nl">key:</span> <span class="n">ValueKey</span><span class="p">(</span><span class="m">3</span><span class="p">),</span> <span class="nl">colorValue:</span> <span class="n">ColorValue</span><span class="p">.</span><span class="n">blueAccent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">_refresh</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_boxes</span><span class="p">.</span><span class="n">removeAt</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">appBar:</span> <span class="n">AppBar</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">backgroundColor:</span> <span class="n">Theme</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">inversePrimary</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">title:</span> <span class="n">Text</span><span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">title</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">body:</span> <span class="n">Row</span><span class="p">(</span><span class="nl">children:</span> <span class="n">_boxes</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">floatingActionButton:</span> <span class="n">FloatingActionButton</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onPressed:</span> <span class="n">_refresh</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">tooltip:</span> <span class="s1">&#39;refresh&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">child:</span> <span class="kd">const</span> <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="p">.</span><span class="n">refresh</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">enum</span> <span class="n">ColorValue</span> <span class="p">{</span> <span class="n">redAccent</span><span class="p">,</span> <span class="n">greenAccent</span><span class="p">,</span> <span class="n">blueAccent</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">StatefulBox</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">ColorValue</span> <span class="n">colorValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">StatefulBox</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="kd">required</span> <span class="k">this</span><span class="p">.</span><span class="n">colorValue</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">State</span><span class="o">&lt;</span><span class="n">StatefulBox</span><span class="o">&gt;</span> <span class="n">createState</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="n">_StatefulBoxState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">_StatefulBoxState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">StatefulBox</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">late</span> <span class="n">Color</span> <span class="n">_color</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">initState</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">initState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;initState&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_color</span> <span class="o">=</span> <span class="n">_getColor</span><span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">colorValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Color</span> <span class="n">_getColor</span><span class="p">(</span><span class="n">ColorValue</span> <span class="n">colorValue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">colorValue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">ColorValue</span><span class="p">.</span><span class="nl">redAccent:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Colors</span><span class="p">.</span><span class="n">redAccent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">ColorValue</span><span class="p">.</span><span class="nl">greenAccent:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Colors</span><span class="p">.</span><span class="n">greenAccent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">ColorValue</span><span class="p">.</span><span class="nl">blueAccent:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Colors</span><span class="p">.</span><span class="n">blueAccent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;build: </span><span class="si">$</span><span class="n">_color</span><span class="s1">&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Container</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">width:</span> <span class="m">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">height:</span> <span class="m">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">color:</span> <span class="n">_color</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>程序运行起来后，可以看到如下效果。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例3/示例3.gif" alt="" width="235">
<p>程序刚运行起来，日志打印如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">I/flutter (15938): initState
</span></span><span class="line"><span class="cl">I/flutter (15938): build: MaterialAccentColor(primary value: Color(0xffff5252))
</span></span><span class="line"><span class="cl">I/flutter (15938): initState
</span></span><span class="line"><span class="cl">I/flutter (15938): build: MaterialAccentColor(primary value: Color(0xff69f0ae))
</span></span><span class="line"><span class="cl">I/flutter (15938): initState
</span></span><span class="line"><span class="cl">I/flutter (15938): build: MaterialAccentColor(primary value: Color(0xff448aff))
</span></span></code></pre></td></tr></table>
</div>
</div><p>点击<em>FloatingActionButton</em>按钮后，无日志输出。</p>
<p>总结：初始时色块颜色从左到右的顺序为<em><strong>红、绿、蓝</strong></em>，当点击<em>FloatingActionButton</em>按钮后，色块颜色的顺序变为<em><strong>红、蓝</strong></em>，虽然程序运行效果与预期效果相同，但还是存在一些疑问（也就是点击<em>FloatingActionButton</em>按钮后）：</p>
<p>1、为什么在使用色块<em>Widget</em>时给它传入一个<em>Key</em>，程序运行效果相比示例2就又变得正常了？</p>
<p>2、为什么点击<em>FloatingActionButton</em>按钮后无日志输出？</p>
<p>3、&hellip;</p>
<p>看了上面3个小示例的演示，笔者想问它们的运行结果是在你的预料之中还是预料之外？</p>
<p><em>OK</em>，不管怎样，接下来分析这3个小示例的执行原理之后谜底就会揭开。</p>
<h1 id="三3个小示例之执行原理">三、3个小示例之执行原理</h1>
<h2 id="31分析示例1">3.1、分析示例1</h2>
<p>当点击<em>FloatingActionButton</em>按钮后，会执行<em>setState</em>方法，关于<em>setState</em>方法的分析可参考<a href="https://anddevmk.github.io/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Bsetstate/"><em>解读Flutter源码之setState</em></a>一文。</p>
<p>此处<em>setState</em>方法会先触发<em>Scaffold</em>的重建，<em>Scaffold</em>的重建也会触发其子<em>Widget</em>的重建，然后子<em>Widget</em>的重建也会触发其子<em>Widget</em>的重建，有点像“<em>核裂变的链式反应</em>”，直到所有子<em>Widget</em>均完成重建。</p>
<p>因为从<em>Scaffold</em>的重建一直到<em>Row</em>的重建，中间实在嵌套太多层了，很不方便分析，所以这里只从<em>Row</em>的父组件<em>KeyedSubtree</em>开始讲起。</p>
<p>当<em>KeyedSubtree</em>重建完成之后（即<em>KeyedSubtree</em>的父组件_<em>BodyBuilder</em>的<em>build</em>方法已执行），就会执行<em>Element</em>的<em>rebuild</em>方法，在<em>Element</em>的<em>rebuild</em>方法中，接着执行了<em>Element</em>的<em>performRebuild</em>方法，又因为<em>KeyedSubtree</em>是<em>StatelessWidget</em>的子类，所以执行的是<em>ComponentElement</em>的<em>performRebuild</em>方法。</p>
<p>在<em>ComponentElement</em>的<em>performRebuild</em>方法中，执行了<em>KeyedSubtree</em>的<em>build</em>方法重建了<em>Row</em>，然后执行了<em>Element</em>的<em>updateChild</em>方法。</p>
<p>在<em>Element</em>的<em>updateChild</em>方法中，虽然重建后的<em>Row</em>实例与之前的<em>Row</em>实例不同，但它们的<em>runtimeType</em>是一样的以及<em>key</em>均为<em>null</em>，所以执行了<em>Element</em>的<em>update</em>方法进行<em>Row</em>及其所有子<em>Widget</em>的更新。</p>
<p>又因为<em>Row</em>是<em>MultiChildRenderObjectWidget</em>的子类，所以执行的是<em>MultiChildRenderObjectElement</em>的<em>update</em>方法来进行<em>Row</em>及其所有子<em>Widget</em>的更新，以上描述所涉及的方法调用栈如下。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/Row方法调用栈.png" alt="" width="535">
<p>跟踪下<em>MultiChildRenderObjectElement</em>的<em>update</em>方法的源码，可以发现在<em>update</em>方法中，执行了<em>updateChildren</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">update</span><span class="p">(</span><span class="n">MultiChildRenderObjectWidget</span> <span class="n">newWidget</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">super</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">newWidget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">MultiChildRenderObjectWidget</span> <span class="n">multiChildRenderObjectWidget</span> <span class="o">=</span> <span class="n">widget</span> <span class="o">as</span> <span class="n">MultiChildRenderObjectWidget</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">widget</span> <span class="o">==</span> <span class="n">newWidget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">debugChildrenHaveDuplicateKeys</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">multiChildRenderObjectWidget</span><span class="p">.</span><span class="n">children</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">_children</span> <span class="o">=</span> <span class="n">updateChildren</span><span class="p">(</span><span class="n">_children</span><span class="p">,</span> <span class="n">multiChildRenderObjectWidget</span><span class="p">.</span><span class="n">children</span><span class="p">,</span> <span class="nl">forgottenChildren:</span> <span class="n">_forgottenChildren</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_forgottenChildren</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>为了方便本文后续的描述，笔者会把重建后的<em>Row</em>叫新<em>Row</em>，而之前的<em>Row</em>就变为旧<em>Row</em>。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/Row术语.png" alt="" width="535">
<p><em>OK</em>，现在解释下<em>updateChildren</em>方法的参数：</p>
<ul>
<li><code>oldChildren</code>：它是一个<code>List&lt;Element&gt;</code>，在本示例中，用来存放旧<em>Row</em>中所有子<em>Widget</em>所关联的<em>Element</em>，此处传入的是<code>_children</code>。</li>
</ul>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/1.png" alt="" width="535">
<ul>
<li><code>newWidgets</code>：它是一个<code>List&lt;Widget&gt;</code>，用来存放新<em>Row</em>中所有子<em>Widget</em>，此处传入的是<code>multiChildRenderObjectWidget.children</code>。</li>
</ul>
<p>因为删除了中间的绿色块<em>Widget</em>，所以相比初始时的三个色块<em>Widget</em>，现在只剩下红色块<em>Widget</em>与最后一个蓝色块<em>Widget</em>。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/2.png" alt="" width="535">
<ul>
<li><code>forgottenChildren</code>：一个可选的命名参数，它是一个<code>Set&lt;Element&gt;?</code>，用来存放旧<em>Row</em>中传入了<em>GlobalKey</em>的子<em>Widget</em>所关联的<em>Element</em>，主要作用是避免重复遍历<code>_children</code>来删除子节点的O(n^2) 工作，此处传入的是<code>_forgottenChildren</code>。</li>
</ul>
<p>在本示例中，因为旧<em>Row</em>中所有子<em>Widget</em>都没有用到<em>GlobalKey</em>，所以<code>_forgottenChildren</code>为空。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/3.png" alt="" width="535">
<ul>
<li><code>slots</code>：一个可选的命名参数，它是一个<code>List&lt;Object?&gt;?</code>，用来存放旧<em>Row</em>中所有子<em>Widget</em>所关联的槽位，用于定义该子级在其父级子级列表中的位置，因为此处没有传入，所以为<em>null</em>。</li>
</ul>
<p>多插一嘴，虽然此处没有传入为<em>null</em>，但是旧<em>Row</em>中所有子<em>Widget</em>所关联的槽位还是存在的，这在<em>MultiChildRenderObjectElement</em>的<em>mount</em>方法中已经为旧<em>Row</em>中所有子<em>Widget</em>分配了槽位。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/4.png" alt="" width="535">
<p>此时，旧<em>Row</em>中所有子<em>Widget</em>所关联的槽位如下。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/旧Slot.png" alt="" width="435">
<p><em>OK</em>，继续跟踪<em>Element</em>的<em>updateChildren</em>方法的源码，可以发现<em>updateChildren</em>方法的源码是比较长的，所以本文会对<em>updateChildren</em>方法的源码拆分为十部分，并且结合示例只讲解被执行到的那部分源码。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/5.png" alt="" width="535">
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/6.png" alt="" width="535" style="margin-top: 10px;">
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/7.png" alt="" width="535" style="margin-top: 10px;">
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/8.png" alt="" width="535" style="margin-top: 10px;">
<h3 id="311分析第一部分">3.1.1、分析第一部分</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">Element</span><span class="o">?</span> <span class="n">replaceWithNullIfForgotten</span><span class="p">(</span><span class="n">Element</span> <span class="n">child</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">forgottenChildren</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">forgottenChildren</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">child</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">Object</span><span class="o">?</span> <span class="n">slotFor</span><span class="p">(</span><span class="kt">int</span> <span class="n">newChildIndex</span><span class="p">,</span> <span class="n">Element</span><span class="o">?</span> <span class="n">previousChild</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">slots</span> <span class="o">!=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">      <span class="o">?</span> <span class="n">slots</span><span class="p">[</span><span class="n">newChildIndex</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="o">:</span> <span class="n">IndexedSlot</span><span class="o">&lt;</span><span class="n">Element</span><span class="o">?&gt;</span><span class="p">(</span><span class="n">newChildIndex</span><span class="p">,</span> <span class="n">previousChild</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>updateChildren</em>方法一开始，就定义了两个局部方法，来分析下：</p>
<ul>
<li>
<p><em><code>replaceWithNullIfForgotten()</code></em>：如果旧<em>Row</em>中存在传入了<em>GlobalKey</em>的子<em>Widget</em>，那么该子<em>Widget</em>所关联的<em>Element</em>就需要被过滤掉而不进行处理，避免后续遍历时导致<em>Element</em>被移除，这种情况下会返回<em>null</em>，否则返回传入的<em>child</em>本身。</p>
</li>
<li>
<p><em><code>slotFor()</code></em>：获取新<em>Row</em>中<em>newChildIndex</em>索引位置的槽位，之前讲过<em>updateChildren</em>方法并没有传入<em>slots</em>，所以这里会为每个<em>Element</em>创建一个新槽位<em>IndexedSlot</em>。</p>
</li>
</ul>
<h3 id="312分析第二部分">3.1.2、分析第二部分</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">newChildrenTop</span> <span class="o">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">oldChildrenTop</span> <span class="o">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">newChildrenBottom</span> <span class="o">=</span> <span class="n">newWidgets</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">oldChildrenBottom</span> <span class="o">=</span> <span class="n">oldChildren</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Element</span><span class="o">&gt;</span> <span class="n">newChildren</span> <span class="o">=</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Element</span><span class="o">&gt;</span><span class="p">.</span><span class="n">filled</span><span class="p">(</span><span class="n">newWidgets</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">_NullElement</span><span class="p">.</span><span class="n">instance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Element</span><span class="o">?</span> <span class="n">previousChild</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>updateChildren</em>方法中，定义了几个局部变量，来分析下：</p>
<table>
<thead>
<tr>
<th><em>局部变量</em></th>
<th><em>说明</em></th>
</tr>
</thead>
<tbody>
<tr>
<td><em>newChildrenTop</em></td>
<td><em>遍历newWidgets时的起始位置，从0开始</em></td>
</tr>
<tr>
<td><em>oldChildrenTop</em></td>
<td><em>遍历oldChildren时的起始位置，从0开始</em></td>
</tr>
<tr>
<td><em>newChildrenBottom</em></td>
<td><em>遍历newWidgets时的结束位置，结束位置为newWidgets.length - 1</em></td>
</tr>
<tr>
<td><em>oldChildrenBottom</em></td>
<td><em>遍历oldChildren时的结束位置，结束位置为oldChildren.length - 1</em></td>
</tr>
<tr>
<td><em>newChildren</em></td>
<td><em>它是一个<code>List&lt;Element&gt;</code>，用来存放新Row中所有子Widget所关联的Element</em></td>
</tr>
<tr>
<td><em>previousChild</em></td>
<td><em>新Row中子Widget所关联的槽位指向的前一个Element</em></td>
</tr>
</tbody>
</table>
<h3 id="313分析第三部分">3.1.3、分析第三部分</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// 更新列表顶部
</span></span></span><span class="line"><span class="cl"><span class="c1">// Update the top of the list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">while</span> <span class="p">((</span><span class="n">oldChildrenTop</span> <span class="o">&lt;=</span> <span class="n">oldChildrenBottom</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">newChildrenTop</span> <span class="o">&lt;=</span> <span class="n">newChildrenBottom</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析一
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Element</span><span class="o">?</span> <span class="n">oldChild</span> <span class="o">=</span> <span class="n">replaceWithNullIfForgotten</span><span class="p">(</span><span class="n">oldChildren</span><span class="p">[</span><span class="n">oldChildrenTop</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Widget</span> <span class="n">newWidget</span> <span class="o">=</span> <span class="n">newWidgets</span><span class="p">[</span><span class="n">newChildrenTop</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">oldChild</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">oldChild</span><span class="p">.</span><span class="n">_lifecycleState</span> <span class="o">==</span> <span class="n">_ElementLifecycle</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析二
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">oldChild</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">Widget</span><span class="p">.</span><span class="n">canUpdate</span><span class="p">(</span><span class="n">oldChild</span><span class="p">.</span><span class="n">widget</span><span class="p">,</span> <span class="n">newWidget</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析三
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Element</span> <span class="n">newChild</span> <span class="o">=</span> <span class="n">updateChild</span><span class="p">(</span><span class="n">oldChild</span><span class="p">,</span> <span class="n">newWidget</span><span class="p">,</span> <span class="n">slotFor</span><span class="p">(</span><span class="n">newChildrenTop</span><span class="p">,</span> <span class="n">previousChild</span><span class="p">))</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">newChild</span><span class="p">.</span><span class="n">_lifecycleState</span> <span class="o">==</span> <span class="n">_ElementLifecycle</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析四
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">newChildren</span><span class="p">[</span><span class="n">newChildrenTop</span><span class="p">]</span> <span class="o">=</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">previousChild</span> <span class="o">=</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">newChildrenTop</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">oldChildrenTop</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个<em>While</em>循环的工作原理是从列表顶部开始更新，也就是从旧<em>Row</em>中第一个子<em>Widget</em>所关联的<em>Element</em>与新<em>Row</em>中第一个子<em>Widget</em>开始往后遍历，判断新旧<em>Widget</em>是否同一个<em>Widget</em>（判断条件是<em>Widget</em>的<em>runtimeType</em>与<em>key</em>），如果是则更新<em>Element</em>所持有的旧<em>Widget</em>为新<em>Widget</em>，否则<em>break</em>退出该<em>While</em>循环。</p>
<p>当<em>Element</em>更新旧<em>Widget</em>成功时，<em>newChildrenTop</em>与<em>oldChildrenTop</em>就会<code>+1</code>，如果遍历过程中出现<em>Element</em>不能更新旧<em>Widget</em>，那么<em>break</em>退出该<em>While</em>循环，此时<em>newChildrenTop</em>与<em>oldChildrenTop</em>恰好记录了<em>Element</em>不能更新旧<em>Widget</em>时的位置索引。</p>
<h4 id="3131第一轮循环">3.1.3.1、第一轮循环</h4>
<p>第一轮<em>While</em>循环判断<code>while(oldChildrenTop &lt;= oldChildrenBottom) &amp;&amp; (newChildrenTop &lt;= newChildrenBottom)</code>，因为此时<em>oldChildrenTop</em>、<em>newChildrenTop</em>均为0，而<em>oldChildrenBottom</em>为2，<em>newChildrenBottom</em>为1，所以满足<em>While</em>循环判断进入循环体。</p>
<p>分析一：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">Element</span><span class="o">?</span> <span class="n">oldChild</span> <span class="o">=</span> <span class="n">replaceWithNullIfForgotten</span><span class="p">(</span><span class="n">oldChildren</span><span class="p">[</span><span class="n">oldChildrenTop</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">Widget</span> <span class="n">newWidget</span> <span class="o">=</span> <span class="n">newWidgets</span><span class="p">[</span><span class="n">newChildrenTop</span><span class="p">];</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><code>获取oldChild</code>：在本例中，旧<em>Row</em>中所有子<em>Widget</em>都没有传入<em>GlobalKey</em>，所以<code>replaceWithNullIfForgotten()</code>返回的是传入的<em>child</em>本身，也就是<code>oldChildren[0]</code>，它是旧<em>Row</em>中第一个子<em>Widget</em>所关联的<em>Element</em>。</li>
</ul>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/9.png" alt="" width="535">
<ul>
<li><code>获取newWidget</code>：获取新Row中第一个子<em>Widget</em>。</li>
</ul>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/10.png" alt="" width="535">
<p>分析二：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">oldChild</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">Widget</span><span class="p">.</span><span class="n">canUpdate</span><span class="p">(</span><span class="n">oldChild</span><span class="p">.</span><span class="n">widget</span><span class="p">,</span> <span class="n">newWidget</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>由分析一可以知道，<code>oldChild == null</code>是不成立的，所以执行了<code>Widget.canUpdate()</code>，来看下<em>canUpdate</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">bool</span> <span class="n">canUpdate</span><span class="p">(</span><span class="n">Widget</span> <span class="n">oldWidget</span><span class="p">,</span> <span class="n">Widget</span> <span class="n">newWidget</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">oldWidget</span><span class="p">.</span><span class="n">runtimeType</span> <span class="o">==</span> <span class="n">newWidget</span><span class="p">.</span><span class="n">runtimeType</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;&amp;</span> <span class="n">oldWidget</span><span class="p">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">newWidget</span><span class="p">.</span><span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以知道，<em>canUpdate</em>方法中比较了<em>runtimeType</em>与<em>key</em>，也就是比较了旧<em>Row</em>中第一个<em>Widget</em>与新<em>Row</em>中第一个<em>Widget</em>的<em>runtimeType</em>与<em>key</em>，因为两者均没传入<em>key</em>，所以<em>key</em>默认为<em>null</em>，那么比较的就是<em>runtimeType</em>了，而两者的<em>runtimeType</em>均为<em>StatelessBox</em>，所以<em>canUpdate</em>方法返回<em>true</em>，并不会执行<em>break</em>跳出<em>While</em>循环。</p>
<p>分析三：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">Element</span> <span class="n">newChild</span> <span class="o">=</span> <span class="n">updateChild</span><span class="p">(</span><span class="n">oldChild</span><span class="p">,</span> <span class="n">newWidget</span><span class="p">,</span> <span class="n">slotFor</span><span class="p">(</span><span class="n">newChildrenTop</span><span class="p">,</span> <span class="n">previousChild</span><span class="p">))</span><span class="o">!</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行了<em>Element</em>的<em>updateChild</em>方法，那么<em>updateChild</em>方法是用来干嘛的？</p>
<p><em>updateChild方法使用给定的新配置更新给定的child，它是widgets系统的核心，每次我们根据更新的配置添加、更新或删除child时都会调用它。</em></p>
<p>来看下<em>updateChild</em>方法的源码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">pragma</span><span class="p">(</span><span class="s1">&#39;vm:prefer-inline&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Element</span><span class="o">?</span> <span class="n">updateChild</span><span class="p">(</span><span class="n">Element</span><span class="o">?</span> <span class="n">child</span><span class="p">,</span> <span class="n">Widget</span><span class="o">?</span> <span class="n">newWidget</span><span class="p">,</span> <span class="kt">Object</span><span class="o">?</span> <span class="n">newSlot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">newWidget</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">deactivateChild</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Element</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">hasSameSuperclass</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldElementClass</span> <span class="o">=</span> <span class="n">Element</span><span class="p">.</span><span class="n">_debugConcreteSubtype</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="kt">int</span> <span class="n">newWidgetClass</span> <span class="o">=</span> <span class="n">Widget</span><span class="p">.</span><span class="n">_debugConcreteSubtype</span><span class="p">(</span><span class="n">newWidget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">hasSameSuperclass</span> <span class="o">=</span> <span class="n">oldElementClass</span> <span class="o">==</span> <span class="n">newWidgetClass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}());</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hasSameSuperclass</span> <span class="o">&amp;&amp;</span> <span class="n">child</span><span class="p">.</span><span class="n">widget</span> <span class="o">==</span> <span class="n">newWidget</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="n">slot</span> <span class="o">!=</span> <span class="n">newSlot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">updateSlotForChild</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">newSlot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">newChild</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hasSameSuperclass</span> <span class="o">&amp;&amp;</span> <span class="n">Widget</span><span class="p">.</span><span class="n">canUpdate</span><span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="n">widget</span><span class="p">,</span> <span class="n">newWidget</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="n">slot</span> <span class="o">!=</span> <span class="n">newSlot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">updateSlotForChild</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">newSlot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">child</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">newWidget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">newChild</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">deactivateChild</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">newChild</span> <span class="o">=</span> <span class="n">inflateWidget</span><span class="p">(</span><span class="n">newWidget</span><span class="p">,</span> <span class="n">newSlot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">newChild</span> <span class="o">=</span> <span class="n">inflateWidget</span><span class="p">(</span><span class="n">newWidget</span><span class="p">,</span> <span class="n">newSlot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里总结下<em>updateChild</em>方法的工作逻辑：</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:left"><em>newWidget == null</em></th>
<th style="text-align:left"><em>newWidget != null</em></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><em>child == null</em></td>
<td style="text-align:left">返回<em>null</em></td>
<td style="text-align:left">返回新的<em>Element</em></td>
</tr>
<tr>
<td style="text-align:center"><em>child != null</em></td>
<td style="text-align:left">旧的<em>child</em>被移除, 返回<em>null</em></td>
<td style="text-align:left">如果可能，更新旧<em>child</em>，返回<em>child</em>或新的<em>Element</em></td>
</tr>
</tbody>
</table>
<p>在本示例中，<em>updateChild</em>方法的第一个参数传入了旧<em>Row</em>中第一个<em>Widget</em>所关联的<em>Element</em>，第二个参数传入了新<em>Row</em>中第一个<em>Widget</em>，第三个参数是新<em>Row</em>中第一个<em>Widget</em>所关联的槽位。</p>
<p>来看下第一轮<em>While</em>循环中，会执行到的<em>updateChild</em>方法的相关源码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">pragma</span><span class="p">(</span><span class="s1">&#39;vm:prefer-inline&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Element</span><span class="o">?</span> <span class="n">updateChild</span><span class="p">(</span><span class="n">Element</span><span class="o">?</span> <span class="n">child</span><span class="p">,</span> <span class="n">Widget</span><span class="o">?</span> <span class="n">newWidget</span><span class="p">,</span> <span class="kt">Object</span><span class="o">?</span> <span class="n">newSlot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">newWidget</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">deactivateChild</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Element</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">hasSameSuperclass</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldElementClass</span> <span class="o">=</span> <span class="n">Element</span><span class="p">.</span><span class="n">_debugConcreteSubtype</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="kt">int</span> <span class="n">newWidgetClass</span> <span class="o">=</span> <span class="n">Widget</span><span class="p">.</span><span class="n">_debugConcreteSubtype</span><span class="p">(</span><span class="n">newWidget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">hasSameSuperclass</span> <span class="o">=</span> <span class="n">oldElementClass</span> <span class="o">==</span> <span class="n">newWidgetClass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}());</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hasSameSuperclass</span> <span class="o">&amp;&amp;</span> <span class="n">child</span><span class="p">.</span><span class="n">widget</span> <span class="o">==</span> <span class="n">newWidget</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="n">slot</span> <span class="o">!=</span> <span class="n">newSlot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">updateSlotForChild</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">newSlot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">newChild</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>updateChild</em>方法中，因为传入的参数<em>child</em>与<em>newWidget</em>都不为<em>null</em>，所以执行到<em>if</em>判断<code>if (hasSameSuperclass &amp;&amp; child.widget == newWidget)</code>，可以看到<code>child.widget == newWidget</code>比较的是两个<em>Widget</em>是否相等，而<em>Widget</em>对<code>==</code>操作符进行了重写，比较的是两者的引用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// Widget
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">nonVirtual</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="kd">operator</span> <span class="o">==</span><span class="p">(</span><span class="kt">Object</span> <span class="n">other</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">super</span> <span class="o">==</span> <span class="n">other</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>Row</em>的<em>children</em>列表是定义为<code>_MyPageState</code>的一个成员变量<code>_boxes</code>，当移除中间色块<em>Widget</em>时，第一个色块<em>Widget</em>的引用在列表中还是没发生变化，所以<em>if</em>判断<code>if (hasSameSuperclass &amp;&amp; child.widget == newWidget)</code>是成立的，然后进入另一个<em>if</em>判断<code>if (child.slot != newSlot)</code>。</p>
<p>之前讲过<code>newSlot</code>是在<code>slotFor()</code>局部方法中新创建的，而<code>child.slot</code>是在<em>MultiChildRenderObjectElement</em>的<em>mount</em>方法中创建的，所以这两个<em>slot</em>不是同一个实例。</p>
<p>但是，这里<code>!=</code>比较的并不是两者的<em>slot</em>引用，因为<em>IndexedSlot</em>重载了<code>==</code>操作符，它们比较的是<em>IndexedSlot</em>构造方法中传入的参数值，相当于执行了<code>equals()</code>，可以看下<em>IndexedSlot</em>的部分源码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// IndexedSlot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="kd">operator</span> <span class="o">==</span><span class="p">(</span><span class="kt">Object</span> <span class="n">other</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">runtimeType</span> <span class="o">!=</span> <span class="n">runtimeType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">other</span> <span class="k">is</span> <span class="n">IndexedSlot</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">index</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以知道，此时这两个<em>IndexedSlot</em>中参数值的比较是相等的，因而<em>if</em>判断<code>if (child.slot != newSlot)</code>是不成立的，不会执行<code>updateSlotForChild()</code>。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/11.png" alt="" width="535">
<p>然后执行<code>newChild = child</code>，直接将旧<em>Row</em>中第一个<em>Widget</em>所关联的<em>Element</em>返回，那么<em>updateChild</em>方法执行完成。</p>
<p>分析四：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">newChildren</span><span class="p">[</span><span class="n">newChildrenTop</span><span class="p">]</span> <span class="o">=</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">previousChild</span> <span class="o">=</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">newChildrenTop</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">oldChildrenTop</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>把返回的<em>newChild</em>添加到<em>newChildren</em>中，并且<em>newChild</em>成为了下一个槽位<em>slot</em>所指向的<em>Element</em>，然后执行<code>newChildrenTop += 1</code>与<code>oldChildrenTop += 1</code>，进入第二轮<em>While</em>循环判断。</p>
<h4 id="3132第二轮循环">3.1.3.2、第二轮循环</h4>
<p>第二轮<em>While</em>循环判断<code>while(oldChildrenTop &lt;= oldChildrenBottom) &amp;&amp; (newChildrenTop &lt;= newChildrenBottom)</code>，因为此时<em>oldChildrenTop</em>、<em>newChildrenTop</em>均为1，而<em>oldChildrenBottom</em>为2，<em>newChildrenBottom</em>为1，所以满足<em>While</em>循环判断进入循环体。</p>
<p>分析一、分析二与之前一样，先是获取<em>oldChild</em>与<em>newWidget</em>，然后继续执行<em>updateChild</em>方法。</p>
<p>分析三：</p>
<p>在本示例中，<em>updateChild</em>方法的第一个参数传入了旧<em>Row</em>中第二个<em>Widget</em>所关联的<em>Element</em>，第二个参数传入了新<em>Row</em>中第二个<em>Widget</em>，第三个参数是新<em>Row</em>中第二个<em>Widget</em>所关联的槽位。</p>
<p>来看下第二轮<em>While</em>循环中，会执行到的<em>updateChild</em>方法的相关源码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">pragma</span><span class="p">(</span><span class="s1">&#39;vm:prefer-inline&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Element</span><span class="o">?</span> <span class="n">updateChild</span><span class="p">(</span><span class="n">Element</span><span class="o">?</span> <span class="n">child</span><span class="p">,</span> <span class="n">Widget</span><span class="o">?</span> <span class="n">newWidget</span><span class="p">,</span> <span class="kt">Object</span><span class="o">?</span> <span class="n">newSlot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">newWidget</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">deactivateChild</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Element</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">hasSameSuperclass</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldElementClass</span> <span class="o">=</span> <span class="n">Element</span><span class="p">.</span><span class="n">_debugConcreteSubtype</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="kt">int</span> <span class="n">newWidgetClass</span> <span class="o">=</span> <span class="n">Widget</span><span class="p">.</span><span class="n">_debugConcreteSubtype</span><span class="p">(</span><span class="n">newWidget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">hasSameSuperclass</span> <span class="o">=</span> <span class="n">oldElementClass</span> <span class="o">==</span> <span class="n">newWidgetClass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}());</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hasSameSuperclass</span> <span class="o">&amp;&amp;</span> <span class="n">child</span><span class="p">.</span><span class="n">widget</span> <span class="o">==</span> <span class="n">newWidget</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hasSameSuperclass</span> <span class="o">&amp;&amp;</span> <span class="n">Widget</span><span class="p">.</span><span class="n">canUpdate</span><span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="n">widget</span><span class="p">,</span> <span class="n">newWidget</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="n">slot</span> <span class="o">!=</span> <span class="n">newSlot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">updateSlotForChild</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">newSlot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">child</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">newWidget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">newChild</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>updateChild</em>方法中，因为传入的参数<em>child</em>与<em>newWidget</em>都不为<em>null</em>，所以执行到<em>if</em>判断<code>if (hasSameSuperclass &amp;&amp; child.widget == newWidget)</code>。</p>
<p>但是，此时<code>child.widget == newWidget</code>是不成立的，为什么呢？</p>
<p>因为<code>child.widget</code>是旧<em>Row</em>中第二个<em>Widget</em>，而<code>newWidget</code>是新<em>Row</em>中第二个子<em>Widget</em>（它其实对应了旧<em>Row</em>中第三个<em>Widget</em>），所以相当于旧<em>Row</em>中第二个<em>Widget</em>与第三个<em>Widget</em>进行比较，很显然这两个引用是不相等的。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/12.png" alt="" width="535">
<p>接着执行<code>else if (hasSameSuperclass &amp;&amp; Widget.canUpdate(child.widget, newWidget))</code>，对于<code>Widget.canUpdate()</code>，之前讲过如果<em>Row</em>的子<em>Widget</em>没有传入<em>key</em>，那么比较的就是<em>runtimeType</em>，很显然两者的<em>runtimeType</em>都是<em>StatelessBox</em>，所以<em>if</em>判断<code>else if (hasSameSuperclass &amp;&amp; Widget.canUpdate(child.widget, newWidget))</code>成立，然后进入另一个if判断<code>if (child.slot != newSlot)</code>。</p>
<p>之前讲过<em>IndexedSlot</em>重写了操作符<code>==</code>，内部比较的是构造方法传入的参数值，相当于执行<code>equals()</code>，所以此时这两个<em>slot</em>依然相等，if判断<code>if (child.slot != newSlot)</code>不成立。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/13.png" alt="" width="535">
<p>接着继续执行<code>child.update(newWidget)</code>方法，又因为<em>child</em>的类型为<em>StatelessElement</em>，所以执行了<em>StatelessElement</em>的<em>update</em>方法。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/14.png" alt="" width="535">
<p>可以发现，在<em>update</em>方法中先是执行了<code>super.update(newWidget)</code>，也就是执行了<em>Element</em>的<em>update</em>方法，将<em>newWidget</em>赋值给旧<em>Row</em>中第二个<em>Widget</em>所关联的<em>Element</em>，换句话说，旧<em>Row</em>中第二个<em>Widget</em>所关联的<em>Element</em>持有了旧<em>Row</em>中第三个<em>Widget</em>。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/15.png" alt="" width="535">
<p>然后在<em>update</em>方法中还执行了<em>rebuild</em>方法，这会重建旧<em>Row</em>中第三个<em>Widget</em>，执行旧<em>Row</em>中第三个<em>Widget</em>的<em>build</em>方法。</p>
<p><em>OK</em>，我们回到这个<em>if</em>判断<code>else if (hasSameSuperclass &amp;&amp; Widget.canUpdate(child.widget, newWidget))</code>，最后执行了<code>newChild = child</code>，将旧<em>Row</em>中第二个<em>Widget</em>所关联的<em>Element</em>返回了。</p>
<p>分析四：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">newChildren</span><span class="p">[</span><span class="n">newChildrenTop</span><span class="p">]</span> <span class="o">=</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">previousChild</span> <span class="o">=</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">newChildrenTop</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">oldChildrenTop</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>把返回的<em>newChild</em>添加到<em>newChildren</em>中，并且<em>newChild</em>成为了下一个槽位<em>slot</em>所指向的<em>Element</em>，然后执行<code>newChildrenTop += 1</code>与<code>oldChildrenTop += 1</code>，进入第三轮<em>While</em>循环判断。</p>
<h4 id="3133第三轮循环">3.1.3.3、第三轮循环</h4>
<p>第三轮While循环判断<code>while(oldChildrenTop &lt;= oldChildrenBottom) &amp;&amp; (newChildrenTop &lt;= newChildrenBottom)</code>，因为此时<em>oldChildrenTop</em>、<em>newChildrenTop</em>均为2，而<em>oldChildrenBottom</em>为2，<em>newChildrenBottom</em>为1，所以不满足<em>While</em>循环判断。</p>
<h3 id="314分析第五部分">3.1.4、分析第五部分</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// 扫描列表中间的老孩子
</span></span></span><span class="line"><span class="cl"><span class="c1">// Scan the old children in the middle of the list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">final</span> <span class="kt">bool</span> <span class="n">haveOldChildren</span> <span class="o">=</span> <span class="n">oldChildrenTop</span> <span class="o">&lt;=</span> <span class="n">oldChildrenBottom</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span> <span class="n">Element</span><span class="o">&gt;?</span> <span class="n">oldKeyedChildren</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">haveOldChildren</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">oldKeyedChildren</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span> <span class="n">Element</span><span class="o">&gt;</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">oldChildrenTop</span> <span class="o">&lt;=</span> <span class="n">oldChildrenBottom</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Element</span><span class="o">?</span> <span class="n">oldChild</span> <span class="o">=</span> <span class="n">replaceWithNullIfForgotten</span><span class="p">(</span><span class="n">oldChildren</span><span class="p">[</span><span class="n">oldChildrenTop</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">oldChild</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">oldChild</span><span class="p">.</span><span class="n">_lifecycleState</span> <span class="o">==</span> <span class="n">_ElementLifecycle</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">oldChild</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">oldChild</span><span class="p">.</span><span class="n">widget</span><span class="p">.</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">oldKeyedChildren</span><span class="p">[</span><span class="n">oldChild</span><span class="p">.</span><span class="n">widget</span><span class="p">.</span><span class="n">key</span><span class="o">!</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">deactivateChild</span><span class="p">(</span><span class="n">oldChild</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">oldChildrenTop</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>第五部分的工作原理是扫描列表中间的老孩子，也就是扫描<em>oldChildrenTop</em>与<em>oldChildrenBottom</em>之间的旧<em>Widget</em>所关联的<em>Element</em>。</p>
<p>换句话说就是处理之前列表中间那些无法更新旧<em>Widget</em>为新<em>Widget</em>的<em>Element</em>，如果该<em>Element</em>之前关联的旧<em>Widget</em>传入了<em>key</em>，那么就会把该<em>Element</em>存入一个<em>Map</em>中，否则就会执行<em>deactivateChild</em>方法移除该<em>Element</em>。</p>
<p>可以发现，有一个<em>bool</em>类型的局部变量<em>haveOldChildren</em>，它的判断条件是<code>oldChildrenTop &lt;= oldChildrenBottom</code>，因为此时<em>oldChildrenTop</em>为2，<em>oldChildrenBottom</em>为2，那么<em>haveOldChildren</em>为<em>true</em>，满足<em>if</em>判断<code>if (haveOldChildren)</code>。</p>
<p>然后执行<em>While</em>循环判断<code> while (oldChildrenTop &lt;= oldChildrenBottom)</code>，这里的<em>While</em>循环判断条件与<em>haveOldChildren</em>的判断条件一样的，所以满足<em>While</em>循环判断而进入循环体。</p>
<p>在<em>While</em>循环体中，获取<em>oldChild</em>，此时的<em>oldChild</em>是旧<em>Row</em>中第三个子<em>Widget</em>所关联的<em>Element</em>。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/16.png" alt="" width="535">
<p>因为旧<em>Row</em>中所有子<em>Widget</em>都没有传入<em>Key</em>，并且旧<em>Row</em>中第三个子<em>Widget</em>所关联的<em>Element</em>在新<em>Row</em>中是找不到子<em>Widget</em>去关联的，所以执行<em>deactivateChild</em>方法把旧<em>Row</em>中第三个子<em>Widget</em>所关联的<em>Element</em>移除。</p>
<p>OK，继续跟踪<em>Element</em>的<em>updateChildren</em>方法源码时，发现后面第六、七、八、九部分都不满足相应的判断条件，所以这几部分都没有执行到，这里就不分析了。</p>
<h3 id="315分析第十部分">3.1.5、分析第十部分</h3>
<p>直接将<em>newChildren</em>返回，那么<em>updateChildren</em>方法就执行完毕了，意味着<em>Row</em>所关联的<em>MultiChildRenderObjectElement</em>也就更新了<code>_children</code>。</p>
<p>该示例中<em>Row</em>及其所有子<em>Widget</em>更新的核心原理如图所示。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例1/示例1原理.png" alt="" width="535">
<p>现在可以回过头来解释示例1中的疑问了：</p>
<ul>
<li>1、为什么日志打印是蓝色？</li>
</ul>
<blockquote>
<p><em>因为旧Row中第二个子Widget所关联的Element，它对绿色块Widget的持有关系发生了变化，由最初持有了绿色块Widget变为持有了蓝色块Widget，并且触发了蓝色块Widget的build方法，所以日志打印是蓝色。</em></p>
</blockquote>
<ul>
<li>2、为什么红色块自身的build方法不会触发？</li>
</ul>
<blockquote>
<p><em>因为旧Row中第一个子Widget所关联的Element，它对红色块Widget的持有关系没有发生变化。</em></p>
</blockquote>
<h2 id="32分析示例2">3.2、分析示例2</h2>
<p>与示例1中的颜色块<em>StatelessBox</em>不同，示例2中的颜色块<em>StatefulBox</em>是一个<em>StatefulWidget</em>，它的颜色值<code>_color</code>是在<em>initState</em>方法中初始化的。</p>
<p>我们知道，<em>Element</em>的生命周期比<em>Widget</em>长，而<em>State</em>是在<em>StatefulElement</em>的构造方法中创建的，在此之后，<em>StatefulElement</em>与<em>State</em>便互相持有对方引用，所以<em>State</em>的生命周期也会比<em>Widget</em>长。</p>
<p>这说明旧<em>Row</em>中子<em>Widget</em>所关联的<em>Element</em>，尽管它对<em>Widget</em>的持有关系发生了变化，也不会影响<em>State</em>中已初始化过的数据（这里指<code>_color</code>），除非<em>State</em>重新创建一个新实例。</p>
<p>前面有了示例1的详细分析过程为基础，下面分析示例2时不会再从头开始分析，而是分析与示例1不同的部分。</p>
<h3 id="321分析第三部分">3.2.1、分析第三部分</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// Update the top of the list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">while</span> <span class="p">((</span><span class="n">oldChildrenTop</span> <span class="o">&lt;=</span> <span class="n">oldChildrenBottom</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">newChildrenTop</span> <span class="o">&lt;=</span> <span class="n">newChildrenBottom</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析一
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Element</span><span class="o">?</span> <span class="n">oldChild</span> <span class="o">=</span> <span class="n">replaceWithNullIfForgotten</span><span class="p">(</span><span class="n">oldChildren</span><span class="p">[</span><span class="n">oldChildrenTop</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Widget</span> <span class="n">newWidget</span> <span class="o">=</span> <span class="n">newWidgets</span><span class="p">[</span><span class="n">newChildrenTop</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">oldChild</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">oldChild</span><span class="p">.</span><span class="n">_lifecycleState</span> <span class="o">==</span> <span class="n">_ElementLifecycle</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析二
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">oldChild</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">Widget</span><span class="p">.</span><span class="n">canUpdate</span><span class="p">(</span><span class="n">oldChild</span><span class="p">.</span><span class="n">widget</span><span class="p">,</span> <span class="n">newWidget</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析三
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Element</span> <span class="n">newChild</span> <span class="o">=</span> <span class="n">updateChild</span><span class="p">(</span><span class="n">oldChild</span><span class="p">,</span> <span class="n">newWidget</span><span class="p">,</span> <span class="n">slotFor</span><span class="p">(</span><span class="n">newChildrenTop</span><span class="p">,</span> <span class="n">previousChild</span><span class="p">))</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">newChild</span><span class="p">.</span><span class="n">_lifecycleState</span> <span class="o">==</span> <span class="n">_ElementLifecycle</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析四
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">newChildren</span><span class="p">[</span><span class="n">newChildrenTop</span><span class="p">]</span> <span class="o">=</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">previousChild</span> <span class="o">=</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">newChildrenTop</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">oldChildrenTop</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3211第二轮循环">3.2.1.1、第二轮循环</h4>
<p>在第二轮<em>While</em>循环中，执行了<em>updateChild</em>方法，此时第一个参数<em>child</em>为旧<em>Row</em>中第二个子<em>Widget</em>所关联的<em>Element</em>，第二个参数<em>newWidget</em>为新<em>Row</em>中的第二个<em>Widget</em>，也是旧<em>Row</em>中第三个子<em>Widget</em>。</p>
<p>来看下第二轮<em>While</em>循环中，会执行到的<em>updateChild</em>方法的相关源码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">pragma</span><span class="p">(</span><span class="s1">&#39;vm:prefer-inline&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Element</span><span class="o">?</span> <span class="n">updateChild</span><span class="p">(</span><span class="n">Element</span><span class="o">?</span> <span class="n">child</span><span class="p">,</span> <span class="n">Widget</span><span class="o">?</span> <span class="n">newWidget</span><span class="p">,</span> <span class="kt">Object</span><span class="o">?</span> <span class="n">newSlot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">newWidget</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">deactivateChild</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Element</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">hasSameSuperclass</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldElementClass</span> <span class="o">=</span> <span class="n">Element</span><span class="p">.</span><span class="n">_debugConcreteSubtype</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="kt">int</span> <span class="n">newWidgetClass</span> <span class="o">=</span> <span class="n">Widget</span><span class="p">.</span><span class="n">_debugConcreteSubtype</span><span class="p">(</span><span class="n">newWidget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">hasSameSuperclass</span> <span class="o">=</span> <span class="n">oldElementClass</span> <span class="o">==</span> <span class="n">newWidgetClass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}());</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hasSameSuperclass</span> <span class="o">&amp;&amp;</span> <span class="n">child</span><span class="p">.</span><span class="n">widget</span> <span class="o">==</span> <span class="n">newWidget</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hasSameSuperclass</span> <span class="o">&amp;&amp;</span> <span class="n">Widget</span><span class="p">.</span><span class="n">canUpdate</span><span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="n">widget</span><span class="p">,</span> <span class="n">newWidget</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="n">slot</span> <span class="o">!=</span> <span class="n">newSlot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">updateSlotForChild</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">newSlot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">child</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">newWidget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">newChild</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行<code>else if (hasSameSuperclass &amp;&amp; Widget.canUpdate(child.widget, newWidget))</code>，因为<em>Row</em>的所有子<em>Widget</em>均没有传入<em>Key</em>，所以<em>else if</em>判断成立。</p>
<p>然后执行<code>child.update(newWidget)</code>方法，又因为<em>child的</em>类型为<em>StatefulElement</em>，所以执行了<em>StatefulElement</em>的<em>update</em>方法。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例2/1.png" alt="" width="535">
<p>在<em>StatefulElement</em>的<em>update</em>方法中，一共做了4件事情：</p>
<p>1、执行<code>super.update(newWidget)</code>，也就是执行了<em>Element</em>的<em>update</em>方法，将<em>newWidget</em>赋值给旧<em>Row</em>中第二个<em>Widget</em>所关联的<em>Element</em>，换句话说，旧<em>Row</em>中第二个<em>Widget</em>所关联的<em>Element</em>持有了旧<em>Row</em>中第三个<em>Widget</em>。</p>
<p>2、执行<code>state._widget = widget as StatefulWidget</code>，旧<em>Row</em>中第二个<em>Widget</em>所关联的<em>Element</em>，它所持有的<em>State</em>也更新了<code>_widget</code>，也就是<em>State</em>持有了旧<em>Row</em>中第三个<em>Widget</em>。</p>
<p>3、执行<code>state.didUpdateWidget(oldWidget)</code>，触发了<em>State</em>的<em>didUpdateWidget</em>方法，传入的实参也就是旧<em>Row</em>中第二个<em>Widget</em>。</p>
<p>4、执行<em>rebuild</em>方法，触发了旧<em>Row</em>中第三个<em>Widget</em>的重建。</p>
<p>示例2与示例1的不同之处已经讲完，该示例中<em>Row</em>及其所有子<em>Widget</em>更新的核心原理如图所示。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例2/示例2原理.png" alt="" width="535">
<p>现在可以回过头来解释示例2中的疑问了：</p>
<ul>
<li>1、为什么删除的是蓝色块？</li>
</ul>
<blockquote>
<p><em>因为旧Row中第二个子Widget所关联的Element，它对绿色块Widget的持有关系发生了变化，由最初持有了绿色块Widget变为持有了蓝色块Widget，并且触发了所关联State的build方法。但是因为该Element所关联的State中_color值一直为绿色没发生变化，所以当执行build方法时读取到的颜色值还是绿色，打印的日志也就为绿色了，这就导致了看起来像是删除了蓝色块。</em></p>
</blockquote>
<ul>
<li>2、为什么日志打印是绿色？</li>
</ul>
<blockquote>
<p><em>解释与问题1相同。</em></p>
</blockquote>
<ul>
<li>3、为什么红色块自身的build方法不会触发？</li>
</ul>
<blockquote>
<p><em>因为旧Row中第一个子Widget所关联的Element，它对红色块Widget的持有关系没有发生变化。</em></p>
</blockquote>
<p>那么，有什么修复办法吗？</p>
<ul>
<li>方法1</li>
</ul>
<p>可以重写<em>State</em>的<em>didUpdateWidget</em>方法，然后对<code>_color</code>进行重新赋值，因为此时的<em>State</em>已经引用了蓝色块<code>_widget</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">didUpdateWidget</span><span class="p">(</span><span class="n">covariant</span> <span class="n">StatefulBox</span> <span class="n">oldWidget</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">super</span><span class="p">.</span><span class="n">didUpdateWidget</span><span class="p">(</span><span class="n">oldWidget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_color</span> <span class="o">=</span> <span class="n">_getColor</span><span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">colorValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>方法2</li>
</ul>
<p>也就是示例3中的给<em>StatefulBox</em>传入一个<em>Key</em>就行。</p>
<h2 id="33分析示例3">3.3、分析示例3</h2>
<p>前面有了示例1与示例2的详细分析过程为基础，下面分析示例3时不会再从头开始分析，而是分析与示例2不同的部分。</p>
<h3 id="331分析第三部分">3.3.1、分析第三部分</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// Update the top of the list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">while</span> <span class="p">((</span><span class="n">oldChildrenTop</span> <span class="o">&lt;=</span> <span class="n">oldChildrenBottom</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">newChildrenTop</span> <span class="o">&lt;=</span> <span class="n">newChildrenBottom</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析一
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Element</span><span class="o">?</span> <span class="n">oldChild</span> <span class="o">=</span> <span class="n">replaceWithNullIfForgotten</span><span class="p">(</span><span class="n">oldChildren</span><span class="p">[</span><span class="n">oldChildrenTop</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Widget</span> <span class="n">newWidget</span> <span class="o">=</span> <span class="n">newWidgets</span><span class="p">[</span><span class="n">newChildrenTop</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">oldChild</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">oldChild</span><span class="p">.</span><span class="n">_lifecycleState</span> <span class="o">==</span> <span class="n">_ElementLifecycle</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析二
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">oldChild</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">Widget</span><span class="p">.</span><span class="n">canUpdate</span><span class="p">(</span><span class="n">oldChild</span><span class="p">.</span><span class="n">widget</span><span class="p">,</span> <span class="n">newWidget</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析三
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Element</span> <span class="n">newChild</span> <span class="o">=</span> <span class="n">updateChild</span><span class="p">(</span><span class="n">oldChild</span><span class="p">,</span> <span class="n">newWidget</span><span class="p">,</span> <span class="n">slotFor</span><span class="p">(</span><span class="n">newChildrenTop</span><span class="p">,</span> <span class="n">previousChild</span><span class="p">))</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">newChild</span><span class="p">.</span><span class="n">_lifecycleState</span> <span class="o">==</span> <span class="n">_ElementLifecycle</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析四
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">newChildren</span><span class="p">[</span><span class="n">newChildrenTop</span><span class="p">]</span> <span class="o">=</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">previousChild</span> <span class="o">=</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">newChildrenTop</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">oldChildrenTop</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3311第二轮循环">3.3.1.1、第二轮循环</h4>
<p>在第二轮<em>While</em>循环中，看下分析二这里的源码，此时<em>oldChild</em>为旧<em>Row</em>中第二个子<em>Widget</em>所关联的<em>Element</em>，<em>newWidget</em>为新<em>Row</em>中的第二个<em>Widget</em>，也是旧<em>Row</em>中第三个子<em>Widget</em>。</p>
<p>执行<code>if (oldChild == null || !Widget.canUpdate(oldChild.widget, newWidget))</code>，因为<em>oldChild</em>不为<em>null</em>，所以看下<em>if</em>后半段<code>Widget.canUpdate()</code>。</p>
<p>因为旧<em>Row</em>中所有子<em>Widget</em>均传入了<em>Key</em>，所以比较的就不止<em>Widget</em>的<em>runtimeType</em>了了，还需要比较<em>key</em>，很明显两者的<em>runtimeType</em>均为<em>StatefulBox</em>，那么剩下的就是比较两者的<em>Key</em>了，
此时<code>oldChild.widget</code>的<em>Key</em>为<em>ValueKey(2)</em>，<code>newWidget</code>的<em>Key</em>为<em>ValueKey(3)</em>。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例3/1.png" alt="" width="535">
<p>一般情况下，<em>Key</em>之间的<code>==</code>操作符是比较两者的引用，但是呢，<em>ValueKey</em>重写了<code>==</code>操作符，比较的是<em>ValueKey</em>构造方法传入的参数，相当于执行了<code>equals()</code>方法，看下<em>ValueKey</em>的这部分源码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// ValueKey
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="kd">operator</span> <span class="o">==</span><span class="p">(</span><span class="kt">Object</span> <span class="n">other</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">runtimeType</span> <span class="o">!=</span> <span class="n">runtimeType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">other</span> <span class="k">is</span> <span class="n">ValueKey</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&amp;&amp;</span> <span class="n">other</span><span class="p">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>当<em>ValueKey(2)<em>与</em>ValueKey(3)<em>比较时，很明显</em>2 != 3</em>，因此<code>Widget.canUpdate()</code>返回<em>false</em>，<code>if (oldChild == null || !Widget.canUpdate(oldChild.widget, newWidget))</code>条件成立，执行了<em>break</em>退出<em>While</em>循环。</p>
<h3 id="332分析第四部分">3.3.2、分析第四部分</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// 扫描列表底部
</span></span></span><span class="line"><span class="cl"><span class="c1">// Scan the bottom of the list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">while</span> <span class="p">((</span><span class="n">oldChildrenTop</span> <span class="o">&lt;=</span> <span class="n">oldChildrenBottom</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">newChildrenTop</span> <span class="o">&lt;=</span> <span class="n">newChildrenBottom</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Element</span><span class="o">?</span> <span class="n">oldChild</span> <span class="o">=</span> <span class="n">replaceWithNullIfForgotten</span><span class="p">(</span><span class="n">oldChildren</span><span class="p">[</span><span class="n">oldChildrenBottom</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Widget</span> <span class="n">newWidget</span> <span class="o">=</span> <span class="n">newWidgets</span><span class="p">[</span><span class="n">newChildrenBottom</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">oldChild</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">oldChild</span><span class="p">.</span><span class="n">_lifecycleState</span> <span class="o">==</span> <span class="n">_ElementLifecycle</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">oldChild</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">Widget</span><span class="p">.</span><span class="n">canUpdate</span><span class="p">(</span><span class="n">oldChild</span><span class="p">.</span><span class="n">widget</span><span class="p">,</span> <span class="n">newWidget</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">oldChildrenBottom</span> <span class="o">-=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">newChildrenBottom</span> <span class="o">-=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个<em>While</em>循环的工作原理是扫描列表底部，也就是从旧<em>Row</em>中第3个子<em>Widget</em>所关联的<em>Element</em>与新<em>Row</em>中第二个子<em>Widget</em>开始往前遍历，判断新旧<em>Widget</em>是否同一个<em>Widget</em>（判断条件是<em>Widget</em>的<em>runtimeType</em>与<em>key</em>），如果不是则<em>break</em>退出该<em>While</em>循环，此时，<em>newChildrenTop</em>与<em>oldChildrenTop</em>恰好就记录了旧<em>Row</em>中子<em>Widget</em>所关联的<em>Element</em>不能够找到所关联的新<em>Row</em>中子<em>Widget</em>时的位置索引。</p>
<p>否则，当旧<em>Row</em>中子<em>Widget</em>所关联的<em>Element</em>能够找到所关联的新<em>Row</em>中子<em>Widget</em>时，<em>newChildrenTop</em>与<em>oldChildrenTop</em>就会<code>-1</code>。</p>
<h4 id="3321第一轮循环">3.3.2.1、第一轮循环</h4>
<p>在分析第四部分中，此时<em>oldChildrenTop</em>与<em>newChildrenTop</em>均为1，<em>oldChildrenBottom</em>为2，<em>newChildrenBottom</em>为1，满足<code>while ((oldChildrenTop &lt;= oldChildrenBottom) &amp;&amp; (newChildrenTop &lt;= newChildrenBottom))</code>进入循环体中。</p>
<p>分析1：获取<em>oldChild</em>，它是旧<em>Row</em>中第三个<em>Widget</em>所关联的<em>Element</em>。获取<em>newWidget</em>，它是新<em>Row</em>中第二个<em>Widget</em>，也就是旧<em>Row</em>中第三个<em>Widget</em>。</p>
<p>分析2：执行<code>Widget.canUpdate()</code>，此时<code>oldChild.widget</code>与<code>newWidget</code>所指的都是旧<em>Row</em>中第三个<em>Widget</em>，所以<code>Widget.canUpdate()</code>成立返回<em>true</em>，不会执行<em>break</em>跳出<em>While循环</em>。</p>
<p>分析3：执行<code>oldChildrenBottom -= 1</code>与<code>newChildrenBottom -= 1</code>，此时<em>oldChildrenTop</em>与<em>newChildrenTop</em>均为1，<em>oldChildrenBottom</em>为1，<em>newChildrenBottom</em>为0。</p>
<h4 id="3322第二轮循环">3.3.2.2、第二轮循环</h4>
<p>在进入下一轮<em>While</em>循环时，不满足<code>while ((oldChildrenTop &lt;= oldChildrenBottom) &amp;&amp; (newChildrenTop &lt;= newChildrenBottom))</code>。</p>
<h3 id="333分析第五部分">3.3.3、分析第五部分</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// 扫描列表中间的老孩子
</span></span></span><span class="line"><span class="cl"><span class="c1">// Scan the old children in the middle of the list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">final</span> <span class="kt">bool</span> <span class="n">haveOldChildren</span> <span class="o">=</span> <span class="n">oldChildrenTop</span> <span class="o">&lt;=</span> <span class="n">oldChildrenBottom</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Map</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span> <span class="n">Element</span><span class="o">&gt;?</span> <span class="n">oldKeyedChildren</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">haveOldChildren</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">oldKeyedChildren</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span> <span class="n">Element</span><span class="o">&gt;</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">oldChildrenTop</span> <span class="o">&lt;=</span> <span class="n">oldChildrenBottom</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Element</span><span class="o">?</span> <span class="n">oldChild</span> <span class="o">=</span> <span class="n">replaceWithNullIfForgotten</span><span class="p">(</span><span class="n">oldChildren</span><span class="p">[</span><span class="n">oldChildrenTop</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">oldChild</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">oldChild</span><span class="p">.</span><span class="n">_lifecycleState</span> <span class="o">==</span> <span class="n">_ElementLifecycle</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">oldChild</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">oldChild</span><span class="p">.</span><span class="n">widget</span><span class="p">.</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">oldKeyedChildren</span><span class="p">[</span><span class="n">oldChild</span><span class="p">.</span><span class="n">widget</span><span class="p">.</span><span class="n">key</span><span class="o">!</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">deactivateChild</span><span class="p">(</span><span class="n">oldChild</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">oldChildrenTop</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3331第一轮循环">3.3.3.1、第一轮循环</h4>
<p>在分析第五部分中，此时<em>oldChildrenTop</em>与<em>oldChildrenBottom</em>均为1，所以<em>haveOldChildren</em>为<em>true</em>。</p>
<p>执行<code>while (oldChildrenTop &lt;= oldChildrenBottom)</code>，此处条件与<em>haveOldChildren</em>的条件相同，所以满足<em>While</em>判断的。</p>
<p>然后获取<em>oldChild</em>，它是旧<em>Row</em>中第二个<em>Widget</em>所关联的<em>Element</em>。因为<em>Row</em>中所有子<em>Widget</em>都有传入<em>Key</em>，所以满足<code>if (oldChild.widget.key != null)</code>。</p>
<p>这里是将旧<em>Row</em>中第二个<em>Widget</em>所关联的<em>Element</em>存入到了一个<em>Map</em>里。接着执行<code>oldChildrenTop += 1</code>，此时<em>oldChildrenTop</em>为2。</p>
<h4 id="3332第二轮循环">3.3.3.2、第二轮循环</h4>
<p>在进入下一轮<em>While</em>循环时，不满足<code>while (oldChildrenTop &lt;= oldChildrenBottom)</code>。</p>
<h3 id="334分析第七部分">3.3.4、分析第七部分</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// 我们已经扫描了整个列表
</span></span></span><span class="line"><span class="cl"><span class="c1">// We&#39;ve scanned the whole list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">newChildrenBottom</span> <span class="o">=</span> <span class="n">newWidgets</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">oldChildrenBottom</span> <span class="o">=</span> <span class="n">oldChildren</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="m">1</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>整个列表的扫描工作完成后，重置<em>newChildrenBottom</em>与<em>oldChildrenBottom</em>，此时<em>oldChildrenBottom</em>为2，<em>newChildrenBottom</em>为1。</p>
<h3 id="335分析第八部分">3.3.5、分析第八部分</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// 更新列表底部
</span></span></span><span class="line"><span class="cl"><span class="c1">// Update the bottom of the list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">while</span> <span class="p">((</span><span class="n">oldChildrenTop</span> <span class="o">&lt;=</span> <span class="n">oldChildrenBottom</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">newChildrenTop</span> <span class="o">&lt;=</span> <span class="n">newChildrenBottom</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Element</span> <span class="n">oldChild</span> <span class="o">=</span> <span class="n">oldChildren</span><span class="p">[</span><span class="n">oldChildrenTop</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">replaceWithNullIfForgotten</span><span class="p">(</span><span class="n">oldChild</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">oldChild</span><span class="p">.</span><span class="n">_lifecycleState</span> <span class="o">==</span> <span class="n">_ElementLifecycle</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Widget</span> <span class="n">newWidget</span> <span class="o">=</span> <span class="n">newWidgets</span><span class="p">[</span><span class="n">newChildrenTop</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">Widget</span><span class="p">.</span><span class="n">canUpdate</span><span class="p">(</span><span class="n">oldChild</span><span class="p">.</span><span class="n">widget</span><span class="p">,</span> <span class="n">newWidget</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Element</span> <span class="n">newChild</span> <span class="o">=</span> <span class="n">updateChild</span><span class="p">(</span><span class="n">oldChild</span><span class="p">,</span> <span class="n">newWidget</span><span class="p">,</span> <span class="n">slotFor</span><span class="p">(</span><span class="n">newChildrenTop</span><span class="p">,</span> <span class="n">previousChild</span><span class="p">))</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">newChild</span><span class="p">.</span><span class="n">_lifecycleState</span> <span class="o">==</span> <span class="n">_ElementLifecycle</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">oldChild</span> <span class="o">==</span> <span class="n">newChild</span> <span class="o">||</span> <span class="n">oldChild</span><span class="p">.</span><span class="n">_lifecycleState</span> <span class="o">!=</span> <span class="n">_ElementLifecycle</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">newChildren</span><span class="p">[</span><span class="n">newChildrenTop</span><span class="p">]</span> <span class="o">=</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">previousChild</span> <span class="o">=</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">newChildrenTop</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">oldChildrenTop</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个<em>While</em>循环的工作原理是从列表底部开始更新，也就是从旧<em>Row</em>中第三个子<em>Widget</em>所关联的<em>Element</em>与新<em>Row</em>中第二个子<em>Widget</em>开始往后遍历，更新<em>Element</em>所持有的旧<em>Widget</em>为新<em>Widget</em>，为什么能这么干呢？这时因为之前扫描列表底部时已经记录了旧<em>Row</em>中子<em>Widget</em>所关联的<em>Element</em>能够找到所关联的新<em>Row</em>中子<em>Widget</em>时的位置索引，该位置索引之后的<em>Element</em>均能更新旧<em>Widget</em>为新<em>Widget</em>。</p>
<p>当<em>Element</em>更新旧<em>Widget</em>成功时，<em>newChildrenTop</em>与<em>oldChildrenTop</em>就会+1。</p>
<h4 id="3351第一轮循环">3.3.5.1、第一轮循环</h4>
<p>此时<em>oldChildrenTop</em>为2，<em>newChildrenTop</em>为1，<em>oldChildrenBottom</em>为2，<em>newChildrenBottom</em>为1。满足<code>while ((oldChildrenTop &lt;= oldChildrenBottom) &amp;&amp; (newChildrenTop &lt;= newChildrenBottom))</code>进入循环体。</p>
<p>分析1：获取<em>oldChild</em>，它是旧<em>Row</em>中第三个<em>Widget</em>所关联的<em>Element</em>。获取<em>newWidget</em>，它是新<em>Row</em>中第二个<em>Widget</em>，也就是旧<em>Row</em>中第三个<em>Widget</em>。</p>
<p>分析2：执行<em>Element</em>的<em>updateChild</em>方法，下面是会执行到的updateChild方法的相关源码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">pragma</span><span class="p">(</span><span class="s1">&#39;vm:prefer-inline&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Element</span><span class="o">?</span> <span class="n">updateChild</span><span class="p">(</span><span class="n">Element</span><span class="o">?</span> <span class="n">child</span><span class="p">,</span> <span class="n">Widget</span><span class="o">?</span> <span class="n">newWidget</span><span class="p">,</span> <span class="kt">Object</span><span class="o">?</span> <span class="n">newSlot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">newWidget</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">deactivateChild</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Element</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">hasSameSuperclass</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="kt">int</span> <span class="n">oldElementClass</span> <span class="o">=</span> <span class="n">Element</span><span class="p">.</span><span class="n">_debugConcreteSubtype</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="kt">int</span> <span class="n">newWidgetClass</span> <span class="o">=</span> <span class="n">Widget</span><span class="p">.</span><span class="n">_debugConcreteSubtype</span><span class="p">(</span><span class="n">newWidget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">hasSameSuperclass</span> <span class="o">=</span> <span class="n">oldElementClass</span> <span class="o">==</span> <span class="n">newWidgetClass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}());</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hasSameSuperclass</span> <span class="o">&amp;&amp;</span> <span class="n">child</span><span class="p">.</span><span class="n">widget</span> <span class="o">==</span> <span class="n">newWidget</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="n">slot</span> <span class="o">!=</span> <span class="n">newSlot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">updateSlotForChild</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">newSlot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">newChild</span> <span class="o">=</span> <span class="n">child</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">newChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为比较的两者都是旧<em>Row</em>中第三个子<em>Widget</em>，所以满足<code>if (hasSameSuperclass &amp;&amp; child.widget == newWidget)</code>，最后执行<code>newChild = child</code>把旧<em>Row</em>中第三个子<em>Widget</em>所关联的<em>Element</em>返回。</p>
<p>分析四：把返回的<em>newChild</em>添加到<em>newChildren</em>中，并且<em>newChild</em>成为了下一个槽位<em>slot</em>所指向的<em>Element</em>，然后执行<code>newChildrenTop += 1</code>与<code>oldChildrenTop += 1</code>，此时<em>oldChildrenTop</em>为3，<em>newChildrenTop</em>为2，<em>oldChildrenBottom</em>为2，<em>newChildrenBottom</em>为1。</p>
<h4 id="3352第二轮循环">3.3.5.2、第二轮循环</h4>
<p>在进入下一轮<em>While</em>循环时不满足<code>while ((oldChildrenTop &lt;= oldChildrenBottom) &amp;&amp; (newChildrenTop &lt;= newChildrenBottom))</code>。</p>
<h3 id="336分析第九部分">3.3.6、分析第九部分</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// 从旧列表中清除任何剩余的中间节点
</span></span></span><span class="line"><span class="cl"><span class="c1">// Clean up any of the remaining middle nodes from the old list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">haveOldChildren</span> <span class="o">&amp;&amp;</span> <span class="n">oldKeyedChildren</span><span class="o">!</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">Element</span> <span class="n">oldChild</span> <span class="k">in</span> <span class="n">oldKeyedChildren</span><span class="p">.</span><span class="n">values</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">forgottenChildren</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">forgottenChildren</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">oldChild</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">deactivateChild</span><span class="p">(</span><span class="n">oldChild</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里的原理是遍历<em>oldKeyedChildren</em>这个<em>Map</em>，它是第五部分中扫描列表中间的老孩子得出的<em>Map</em>，除了传入<em>GlobalKey</em>的子<em>Widget</em>所关联的<em>Element</em>，其它一律移除，因为新<em>Row</em>中没有子<em>Widget</em>与之关联了。</p>
<p>这里是把之前存入<em>Map</em>的旧<em>Row</em>中第二个<em>Widget</em>所关联的<em>Element</em>执行<em>deactivateChild</em>方法移除。</p>
<h3 id="337分析第十部分">3.3.7、分析第十部分</h3>
<p>直接将<em>newChildren</em>返回，那么<em>updateChildren</em>方法就执行完毕了，意味着<em>Row</em>所关联的<em>MultiChildRenderObjectElement</em>也就更新了<code>_children</code>。</p>
<p>示例3与示例2的不同之处已经讲完，该示例中<em>Row</em>及其所有子<em>Widget</em>更新的核心原理如图所示。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/示例3/示例3原理.png" alt="" width="535">
<p>现在可以回过头来解释示例3中的疑问了：</p>
<ul>
<li>1、为什么在使用色块<em>Widget</em>时给它传入一个<em>Key</em>，程序运行效果相比示例2就又变得正常了？</li>
</ul>
<blockquote>
<p>因为旧<em>Row</em>中子<em>Widget</em>所关联的<em>Element</em>，该<em>Element</em>是持有<em>Widget</em>引用的，可以根据<em>Widget</em>的<em>Key</em>去与新<em>Row</em>中子<em>Widget</em>的<em>Key</em>进行配对，如果<em>Key</em>配对成功，那么就会更新该<em>Element</em>所持有的<em>Widget</em>为新<em>Row</em>中子<em>Widget</em>。如果<em>Key</em>配对失败，并且该<em>Widget</em>没有设置<em>GlobalKey</em>，那么该<em>Widget</em>所关联的<em>Element</em>则会被移除。</p>
</blockquote>
<ul>
<li>2、为什么点击<em>FloatingActionButton</em>按钮后无日志输出？</li>
</ul>
<blockquote>
<p>因为<em>Element</em>根据<em>Widget</em>的<em>Key</em>来匹配更新<em>Widget</em>，<em>Widget</em>的引用是一直存在的，走的是<code>if (hasSameSuperclass &amp;&amp; child.widget == newWidget)</code>，所以不会执行<code>child.update(newWidget)</code>，也就不会执行<em>State</em>的<em>build</em>方法，所以无日志输出。</p>
</blockquote>
<h1 id="四key的分类">四、<em>Key</em>的分类</h1>
<img title="" src="/img/flutter/解读Flutter源码之Key/Key分类/Key分类.png" alt="" width="535">
<p>根据作用域的不同，可以将<em>Key</em>分为<em>GlobalKey</em>与<em>LocalKey</em>。<em>LocalKey</em>还可以进一步分为<em>ValueKey</em>、<em>ObjectKey</em>与<em>UniqueKey</em>。</p>
<h2 id="41globalkey">4.1、<em>GlobalKey</em></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">/// 在整个应用程序中唯一的key。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// A key that is unique across the entire app.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Global keys唯一标识elements。Global keys提供对与这些elements关联的其它对象的访问，例如 [BuildContext]。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 对于 [StatefulWidget]，global keys还提供对 [State] 的访问。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Global keys uniquely identify elements. Global keys provide access to other
</span></span></span><span class="line"><span class="cl"><span class="c1">/// objects that are associated with those elements, such as [BuildContext].
</span></span></span><span class="line"><span class="cl"><span class="c1">/// For [StatefulWidget]s, global keys also provide access to [State].
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 当具有global keys的Widgets从树中的一个位置移动到树中的另一位置时，它们会重新设置其子树的父级。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 为了重新设置其子树的父级，widget必须在其从树中旧位置删除的同一动画帧中到达其在树中的新位置。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Widgets that have global keys reparent their subtrees when they are moved
</span></span></span><span class="line"><span class="cl"><span class="c1">/// from one location in the tree to another location in the tree. In order to
</span></span></span><span class="line"><span class="cl"><span class="c1">/// reparent its subtree, a widget must arrive at its new location in the tree
</span></span></span><span class="line"><span class="cl"><span class="c1">/// in the same animation frame in which it was removed from its old location in
</span></span></span><span class="line"><span class="cl"><span class="c1">/// the tree.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 使用global key重新设置 [Element] 的父级相对昂贵，因为此操作将触发对关联的 [State] 及其所有后代的 [State.deactivate] 调用；然后强制重建所有依赖于 [InheritedWidget] 的widgets。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Reparenting an [Element] using a global key is relatively expensive, as
</span></span></span><span class="line"><span class="cl"><span class="c1">/// this operation will trigger a call to [State.deactivate] on the associated
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [State] and all of its descendants; then force all widgets that depends
</span></span></span><span class="line"><span class="cl"><span class="c1">/// on an [InheritedWidget] to rebuild.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 如果您不需要上面列出的任何功能，请考虑使用 [Key]、[ValueKey]、[ObjectKey] 或 [UniqueKey]。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// If you don&#39;t need any of the features listed above, consider using a [Key],
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [ValueKey], [ObjectKey], or [UniqueKey] instead.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 您不能同时在树中包含具有相同global key的两个widgets。尝试这样做将在运行时断言。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// You cannot simultaneously include two widgets in the tree with the same
</span></span></span><span class="line"><span class="cl"><span class="c1">/// global key. Attempting to do so will assert at runtime.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ## 陷阱
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ## Pitfalls
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 不应在每次构建时重新创建 GlobalKeys。例如，它们通常应该是 [State] 对象拥有的长期对象。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// GlobalKeys should not be re-created on every build. They should usually be
</span></span></span><span class="line"><span class="cl"><span class="c1">/// long-lived objects owned by a [State] object, for example.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 在每次构建时创建新的GlobalKey将丢弃与旧key关联的子树的状态，并为新key创建一个新的子树。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 除了损害性能之外，这还可能导致子树中的widgets出现意外行为。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 例如，子树中的 [GestureDetector] 将无法跟踪正在进行的手势，因为它将在每次构建时重新创建。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Creating a new GlobalKey on every build will throw away the state of the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// subtree associated with the old key and create a new fresh subtree for the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// new key. Besides harming performance, this can also cause unexpected
</span></span></span><span class="line"><span class="cl"><span class="c1">/// behavior in widgets in the subtree. For example, a [GestureDetector] in the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// subtree will be unable to track ongoing gestures since it will be recreated
</span></span></span><span class="line"><span class="cl"><span class="c1">/// on each build.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 相反，一个好的做法是让 State 对象拥有 GlobalKey，并在 build 方法之外实例化它，例如在 [State.initState] 中。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Instead, a good practice is to let a State object own the GlobalKey, and
</span></span></span><span class="line"><span class="cl"><span class="c1">/// instantiate it outside the build method, such as in [State.initState].
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">@</span><span class="n">optionalTypeArgs</span>
</span></span><span class="line"><span class="cl"><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">GlobalKey</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">StatefulWidget</span><span class="o">&gt;&gt;</span> <span class="kd">extends</span> <span class="n">Key</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">factory</span> <span class="n">GlobalKey</span><span class="p">({</span> <span class="kt">String</span><span class="o">?</span> <span class="n">debugLabel</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="n">LabeledGlobalKey</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">debugLabel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">GlobalKey</span><span class="p">.</span><span class="n">constructor</span><span class="p">()</span> <span class="o">:</span> <span class="k">super</span><span class="p">.</span><span class="n">empty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Element</span><span class="o">?</span> <span class="kd">get</span> <span class="n">_currentElement</span> <span class="o">=&gt;</span> <span class="n">WidgetsBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">buildOwner</span><span class="o">!</span><span class="p">.</span><span class="n">_globalKeyRegistry</span><span class="p">[</span><span class="k">this</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">/// 具有此key的widget在其中构建的build context。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// The build context in which the widget with this key builds.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// 如果树中没有与此global key匹配的widget，则当前上下文为null。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// The current context is null if there is no widget in the tree that matches
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// this global key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">BuildContext</span><span class="o">?</span> <span class="kd">get</span> <span class="n">currentContext</span> <span class="o">=&gt;</span> <span class="n">_currentElement</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">/// 树中当前具有此global key的widget。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// The widget in the tree that currently has this global key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// 如果树中没有与此global key匹配的widget，则当前widget为空。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// The current widget is null if there is no widget in the tree that matches
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// this global key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Widget</span><span class="o">?</span> <span class="kd">get</span> <span class="n">currentWidget</span> <span class="o">=&gt;</span> <span class="n">_currentElement</span><span class="o">?</span><span class="p">.</span><span class="n">widget</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">/// 树中当前具有此global key的widget的State 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// The [State] for the widget in the tree that currently has this global key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// 如果 (1) 树中没有与此global key匹配的widget，(2) 该widget不是 [StatefulWidget]，或者关联的 [State] 对象不是 `T` 的子类型，则当前state为null。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// The current state is null if (1) there is no widget in the tree that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// matches this global key, (2) that widget is not a [StatefulWidget], or the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// associated [State] object is not a subtype of `T`.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">T</span><span class="o">?</span> <span class="kd">get</span> <span class="n">currentState</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Element</span><span class="o">?</span> <span class="n">element</span> <span class="o">=</span> <span class="n">_currentElement</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">element</span> <span class="k">is</span> <span class="n">StatefulElement</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="n">StatefulElement</span> <span class="n">statefulElement</span> <span class="o">=</span> <span class="n">element</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="n">State</span> <span class="n">state</span> <span class="o">=</span> <span class="n">statefulElement</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="k">is</span> <span class="n">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>结合上面<em>GlobalKey</em>的注释以及源码，总结下<em>GlobalKey</em>的特性：</p>
<p>1、<em>GlobalKey</em>是在整个应用程序中唯一的<em>Key</em>，也就是不能给多个<em>Widget</em>传入同一个<em>GlobalKey</em>实例。</p>
<p>2、<em>GlobalKey</em>唯一标识<em>Element</em>。<em>GlobalKey</em>提供对与这些<em>Element</em>关联的其它对象的访问，例如<em>currentContext</em>、<em>currentWidget</em>与<em>currentState</em>。</p>
<p>3、不应在每次构建时重新创建<em>GlobalKey</em>，而是在<em>build</em>方法之外实例化它。</p>
<p>4、使用<em>GlobalKey</em>重新设置<em>Element</em>的父级相对昂贵，因为此操作将触发对关联的<em>State</em>及其所有后代的<em>State.deactivate</em>调用；然后强制重建所有依赖于<em>InheritedWidget</em>的<em>Widget</em>。</p>
<p>5、&hellip;</p>
<p>看下<em>GlobalKey</em>在<em>Flutter</em>源码中的体现过程。</p>
<ul>
<li><em>GlobalKey</em>注册与取消注册</li>
</ul>
<p>在<em>BuildOwner</em>中有一个<em>Map</em>，用来存放<em>GlobalKey</em>与<em>Element</em>这样的键值对，并且提供了<code>_registerGlobalKey</code>与<code>_unregisterGlobalKey</code>方法对<em>GlobalKey</em>注册与取消注册。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// BuildOwner
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">GlobalKey</span><span class="p">,</span> <span class="n">Element</span><span class="o">&gt;</span> <span class="n">_globalKeyRegistry</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">GlobalKey</span><span class="p">,</span> <span class="n">Element</span><span class="o">&gt;</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_registerGlobalKey</span><span class="p">(</span><span class="n">GlobalKey</span> <span class="n">key</span><span class="p">,</span> <span class="n">Element</span> <span class="n">element</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_globalKeyRegistry</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_unregisterGlobalKey</span><span class="p">(</span><span class="n">GlobalKey</span> <span class="n">key</span><span class="p">,</span> <span class="n">Element</span> <span class="n">element</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_globalKeyRegistry</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">element</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_globalKeyRegistry</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>那么，它是在哪执行<em>GlobalKey</em>注册与取消注册？</p>
<p>可以看到，<em>GlobalKey</em>注册是在<em>Element</em>的<em>mount</em>方法中触发的，<em>GlobalKey</em>取消注册是在<em>Element</em>的<em>unmount</em>方法中触发的。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/Key分类/1.png" alt="" width="535">
<img title="" src="/img/flutter/解读Flutter源码之Key/Key分类/2.png" alt="" width="535" style="margin-top: 10px;">
<ul>
<li>重新将不活跃的<em>Element</em>合并到树中</li>
</ul>
<img title="" src="/img/flutter/解读Flutter源码之Key/Key分类/3.png" alt="" width="535">
<p>在<em>Element</em>的<em>inflateWidget</em>方法中，一共做了3件事情：</p>
<p>1、执行<code>_retakeInactiveElement</code>方法，通过<em>GlobalKey</em>重新获取不活跃的<em>Element</em>。</p>
<img title="" src="/img/flutter/解读Flutter源码之Key/Key分类/4.png" alt="" width="535">
<p>在<code>_retakeInactiveElement</code>方法中，执行了<code>parent.forgetChild</code>，表示从<em>Element</em>的子级列表中删除给定的子级，为该子级在<em>Element</em>树中的其它位置重用做好准备。</p>
<p>在前面讲<em>Row</em>时，它所关联的<em>Element</em>是<em>MultiChildRenderObjectElement</em>，在<em>MultiChildRenderObjectElement</em>的<em>forgetChild</em>方法中，会把当前不活跃的<em>Element</em>添加进<code>_forgottenChildren</code>中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">forgetChild</span><span class="p">(</span><span class="n">Element</span> <span class="n">child</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_children</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">child</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">_forgottenChildren</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">child</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">_forgottenChildren</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">super</span><span class="p">.</span><span class="n">forgetChild</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>_retakeInactiveElement</code>方法中，继续执行了<code>parent.deactivateChild</code>，将给定元素移动到非活动元素列表，并将其渲染对象从渲染树中分离。</p>
<p>2、执行<code>newChild._activateWithParent</code>，让<em>Element</em>从“非活动”生命周期状态转换为“活动”生命周期状态，这里会执行<em>Element</em>的<em>activate</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_activateWithParent</span><span class="p">(</span><span class="n">Element</span> <span class="n">parent</span><span class="p">,</span> <span class="kt">Object</span><span class="o">?</span> <span class="n">newSlot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_lifecycleState</span> <span class="o">==</span> <span class="n">_ElementLifecycle</span><span class="p">.</span><span class="n">inactive</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_updateDepth</span><span class="p">(</span><span class="n">_parent</span><span class="o">!</span><span class="p">.</span><span class="n">depth</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_activateRecursively</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">attachRenderObject</span><span class="p">(</span><span class="n">newSlot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_lifecycleState</span> <span class="o">==</span> <span class="n">_ElementLifecycle</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="n">_activateRecursively</span><span class="p">(</span><span class="n">Element</span> <span class="n">element</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">element</span><span class="p">.</span><span class="n">_lifecycleState</span> <span class="o">==</span> <span class="n">_ElementLifecycle</span><span class="p">.</span><span class="n">inactive</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">element</span><span class="p">.</span><span class="n">activate</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">element</span><span class="p">.</span><span class="n">_lifecycleState</span> <span class="o">==</span> <span class="n">_ElementLifecycle</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">element</span><span class="p">.</span><span class="n">visitChildren</span><span class="p">(</span><span class="n">_activateRecursively</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>3、执行<code>updateChild</code>，更新<em>Element</em>对<em>Widget</em>的引用关系。</p>
<p>到此，这个<em>Element</em>就复用完成。</p>
<h2 id="42localkey">4.2、<em>LocalKey</em></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">/// 不是 [GlobalKey] 的key。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// A key that is not a [GlobalKey].
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Keys在具有相同父级的 [Element] 中必须是唯一的。相比之下，[GlobalKey] 在整个应用程序中必须是唯一的。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Keys must be unique amongst the [Element]s with the same parent. By
</span></span></span><span class="line"><span class="cl"><span class="c1">/// contrast, [GlobalKey]s must be unique across the entire app.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">LocalKey</span> <span class="kd">extends</span> <span class="n">Key</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">LocalKey</span><span class="p">()</span> <span class="o">:</span> <span class="k">super</span><span class="p">.</span><span class="n">empty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>结合上面<em>LocalKey</em>的注释以及源码，总结下<em>LocalKey</em>的特性：在同一级别的<em>Widget</em>中，<em>LocalKey</em>具有唯一性。</p>
<h3 id="421valuekey">4.2.1、<em>ValueKey</em></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">/// 使用特定类型的值来标识自身的key。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// A key that uses a value of a particular type to identify itself.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 当且仅当它们的值为 [operator==] 时，[ValueKey&lt;T&gt;] 才等于另一个 [ValueKey&lt;T&gt;]。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// A [ValueKey&lt;T&gt;] is equal to another [ValueKey&lt;T&gt;] if, and only if, their
</span></span></span><span class="line"><span class="cl"><span class="c1">/// values are [operator==].
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 可以对此类进行子类化，以创建与碰巧使用相同值的其它value keys不同的value keys。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 如果子类是私有的，这会导致value key类型不能与其它源的keys发生冲突，这可能很有用，例如，如果这些keys被用作与另一个widget提供的keys相同范围内的后备。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// This class can be subclassed to create value keys that will not be equal to
</span></span></span><span class="line"><span class="cl"><span class="c1">/// other value keys that happen to use the same value. If the subclass is
</span></span></span><span class="line"><span class="cl"><span class="c1">/// private, this results in a value key type that cannot collide with keys from
</span></span></span><span class="line"><span class="cl"><span class="c1">/// other sources, which could be useful, for example, if the keys are being
</span></span></span><span class="line"><span class="cl"><span class="c1">/// used as fallbacks in the same scope as keys supplied from another widget.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">class</span> <span class="nc">ValueKey</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">LocalKey</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">/// Creates a key that delegates its [operator==] to the given value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">const</span> <span class="n">ValueKey</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">/// The value to which this key delegates its [operator==]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">T</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="kd">operator</span> <span class="o">==</span><span class="p">(</span><span class="kt">Object</span> <span class="n">other</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">runtimeType</span> <span class="o">!=</span> <span class="n">runtimeType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">other</span> <span class="k">is</span> <span class="n">ValueKey</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="o">&amp;&amp;</span> <span class="n">other</span><span class="p">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="kd">get</span> <span class="n">hashCode</span> <span class="o">=&gt;</span> <span class="kt">Object</span><span class="p">.</span><span class="n">hash</span><span class="p">(</span><span class="n">runtimeType</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">String</span> <span class="n">toString</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">String</span> <span class="n">valueString</span> <span class="o">=</span> <span class="n">T</span> <span class="o">==</span> <span class="kt">String</span> <span class="o">?</span> <span class="s2">&#34;&lt;&#39;</span><span class="si">$</span><span class="n">value</span><span class="s2">&#39;&gt;&#34;</span> <span class="o">:</span> <span class="s1">&#39;&lt;</span><span class="si">$</span><span class="n">value</span><span class="s1">&gt;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The crazy on the next line is a workaround for
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// https://github.com/dart-lang/sdk/issues/33297
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">runtimeType</span> <span class="o">==</span> <span class="n">_TypeLiteral</span><span class="o">&lt;</span><span class="n">ValueKey</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">().</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="s1">&#39;[</span><span class="si">$</span><span class="n">valueString</span><span class="s1">]&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s1">&#39;[</span><span class="si">$</span><span class="n">T</span><span class="s1"> </span><span class="si">$</span><span class="n">valueString</span><span class="s1">]&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>之前讲过，<em>ValueKey</em>的<code>==</code>比较相当于<code>equals()</code>方法。</p>
<h3 id="422objectkey">4.2.2、<em>ObjectKey</em></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">/// 一个key，它从用作其值的对象中获取其标识。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// A key that takes its identity from the object used as its value.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 用于将widget的标识与用于生成该widget的对象的标识联系起来。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Used to tie the identity of a widget to the identity of an object used to
</span></span></span><span class="line"><span class="cl"><span class="c1">/// generate that widget.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">class</span> <span class="nc">ObjectKey</span> <span class="kd">extends</span> <span class="n">LocalKey</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">/// Creates a key that uses [identical] on [value] for its [operator==].
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">const</span> <span class="n">ObjectKey</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">/// The object whose identity is used by this key&#39;s [operator==].
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="kt">Object</span><span class="o">?</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="kd">operator</span> <span class="o">==</span><span class="p">(</span><span class="kt">Object</span> <span class="n">other</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">runtimeType</span> <span class="o">!=</span> <span class="n">runtimeType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">other</span> <span class="k">is</span> <span class="n">ObjectKey</span>
</span></span><span class="line"><span class="cl">        <span class="o">&amp;&amp;</span> <span class="n">identical</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="kd">get</span> <span class="n">hashCode</span> <span class="o">=&gt;</span> <span class="kt">Object</span><span class="p">.</span><span class="n">hash</span><span class="p">(</span><span class="n">runtimeType</span><span class="p">,</span> <span class="n">identityHashCode</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">String</span> <span class="n">toString</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">runtimeType</span> <span class="o">==</span> <span class="n">ObjectKey</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="s1">&#39;[</span><span class="si">${</span><span class="n">describeIdentity</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s1">&#39;[</span><span class="si">${</span><span class="n">objectRuntimeType</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;ObjectKey&#39;</span><span class="p">)</span><span class="si">}</span><span class="s1"> </span><span class="si">${</span><span class="n">describeIdentity</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>与<em>ValueKey</em>不同，<em>ObjectKey</em>重写了<code>==</code>操作符，内部调用的是<em>identical</em>方法来比较，而<em>identical</em>方法是用来检查两个对象引用是否指向同一个对象，所以<em>ObjectKey</em>的<code>==</code>比较的是引用。</p>
<h3 id="423uniquekey">4.2.3、<em>UniqueKey</em></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">/// 一个只等于它本身的key。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// A key that is only equal to itself.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 这不能使用const构造函数创建，因为这意味着所有实例化的keys都是同一个实例，因此不是唯一的。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// This cannot be created with a const constructor because that implies that
</span></span></span><span class="line"><span class="cl"><span class="c1">/// all instantiated keys would be the same instance and therefore not be unique.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">class</span> <span class="nc">UniqueKey</span> <span class="kd">extends</span> <span class="n">LocalKey</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">UniqueKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">String</span> <span class="n">toString</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="s1">&#39;[#</span><span class="si">${</span><span class="n">shortHash</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">AndDevMK</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2023-10-27
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/wechat-qr-code.JPG">
        <span>微信打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/alipay-qr-code.JPG">
        <span>支付宝打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Binheritedwidget/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">解读Flutter源码之InheritedWidget</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Bsetstate/">
            <span class="next-text nav-default">解读Flutter源码之setState</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="AndDevMK/blog-utterances"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    
    <div id="search_mask" class="search_mask">
    <div class="search_modal">
        <div id="close_search" class="close_search">关闭</div>
        <div class="search_divider"></div>
        <input id="input_search_key" class="input_search_key" placeholder="请输入你要搜索的内容" tabindex="0">
        <ul id="search_list">
        </ul>
    </div>
</div>

<script src="/js/fuse.js"></script> 
<script src="/js/fastsearch.js"></script>

    <footer id="footer" class="footer">
      

<div class="copyright">
  <span class="power-by">
    由 <a id="hexo-link" class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    
    <span id="run-time" class="run-time"></span> 
    <span class="heart"><i class="iconfont icon-heart"></i></span>
    &copy; 
    2023 - 
    2024&nbsp;
    <span>AndDevMK</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.11a4ba15caf2d921d57eaf6568c4ad21eafd5d2c001cbcb31693586c63f93005.js"></script>

<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?6db179fb88e600cf326b0515a8aa1de3";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>




<script src="/js/codecopy.js"></script>



<link disabled id="dark-mode-theme" rel="stylesheet" href="/css/dark.css"></link>
<script src="/js/dark.js"></script>


<script src="/js/site_runtime.js"></script>




</body>
</html>
