<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>解读Flutter源码之Navigator（命令式） - AndDevMK&#39;s android blog site</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="AndDevMK" /><meta name="description" content="注：本文代码基于Flutter SDK 3.13.5 一、什么是Navigator？ 先来看下Navigator的注释。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91" /><meta name="keywords" content="Android, Java, Kotlin, C&#43;&#43;, C, Flutter, Dart, NDK" />


<meta name="baidu-site-verification" content="codeva-wQ7uOo4V09" />
<meta name="google-site-verification" content="yHzWB9BxTR74LiaUhuL5ncr89fnDYXiplTaPY565zqo" />


<meta name="generator" content="Hugo 0.111.3 with theme even" />


<link rel="canonical" href="https://anddevmk.cn/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Bnavigator%E5%91%BD%E4%BB%A4%E5%BC%8F/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.c11aaf02bef1025d6b0813ba5e1a8a8551aee15fa8f2bcea906d41b20bdf5c69.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/codecopy.css">


<meta property="og:title" content="解读Flutter源码之Navigator（命令式）" />
<meta property="og:description" content="注：本文代码基于Flutter SDK 3.13.5 一、什么是Navigator？ 先来看下Navigator的注释。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://anddevmk.cn/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Bnavigator%E5%91%BD%E4%BB%A4%E5%BC%8F/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-11-19T09:28:31+08:00" />
<meta property="article:modified_time" content="2023-11-19T09:28:31+08:00" />
<meta itemprop="name" content="解读Flutter源码之Navigator（命令式）">
<meta itemprop="description" content="注：本文代码基于Flutter SDK 3.13.5 一、什么是Navigator？ 先来看下Navigator的注释。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91"><meta itemprop="datePublished" content="2023-11-19T09:28:31+08:00" />
<meta itemprop="dateModified" content="2023-11-19T09:28:31+08:00" />
<meta itemprop="wordCount" content="30192">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="解读Flutter源码之Navigator（命令式）"/>
<meta name="twitter:description" content="注：本文代码基于Flutter SDK 3.13.5 一、什么是Navigator？ 先来看下Navigator的注释。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">AndDevMK</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>

    
    <li class="mobile-menu-item-search">
      <div id="mobile_open_search" class="mobile_open_search">
        搜索
      </div>
    </li>

    
    <li class="mobile-menu-item-dark-mode">
      <div id="mobile_dark_mode_toggle" class="mobile_light_mode">
       
      </div>
    </li>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">AndDevMK</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
    
    <div id="open_search" class="open_search">
      搜索
    </div>

    
    <div id="dark_mode_toggle" class="light_mode">

    </div>
  
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">解读Flutter源码之Navigator（命令式）</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-11-19 </span>
        <div class="post-category">
            <a href="/categories/flutter/"> Flutter </a>
            </div>
          <span class="more-meta"> 约 30192 字 </span>
          <span class="more-meta"> 预计阅读 61 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#一什么是navigator">一、什么是<em>Navigator</em>？</a></li>
    <li><a href="#二navigator的相关方法">二、<em>Navigator</em>的相关方法</a>
      <ul>
        <li><a href="#21路由跳转方法">2.1、路由跳转方法</a>
          <ul>
            <li><a href="#211pushpushnamed方法">2.1.1、<em>push/pushNamed</em>方法</a></li>
            <li><a href="#212pushreplacementpushreplacementnamed方法">2.1.2、<em>pushReplacement/pushReplacementNamed</em>方法</a></li>
            <li><a href="#213pushandremoveuntilpushnamedandremoveuntil方法">2.1.3、<em>pushAndRemoveUntil/pushNamedAndRemoveUntil</em>方法</a></li>
          </ul>
        </li>
        <li><a href="#22路由出栈方法">2.2、路由出栈方法</a>
          <ul>
            <li><a href="#221pop方法">2.2.1、<em>pop</em>方法</a></li>
            <li><a href="#222popuntil方法">2.2.2、<em>popUntil</em>方法</a></li>
            <li><a href="#223popandpushnamed方法">2.2.3、<em>popAndPushNamed</em>方法</a></li>
            <li><a href="#224canpop方法">2.2.4、<em>canPop</em>方法</a></li>
            <li><a href="#225maybepop方法">2.2.5、<em>maybePop</em>方法</a></li>
          </ul>
        </li>
        <li><a href="#23路由删除方法">2.3、路由删除方法</a>
          <ul>
            <li><a href="#231removeroute方法">2.3.1、<em>removeRoute</em>方法</a></li>
            <li><a href="#232removeroutebelow方法">2.3.2、<em>removeRouteBelow</em>方法</a></li>
          </ul>
        </li>
        <li><a href="#24路由替换方法">2.4、路由替换方法</a>
          <ul>
            <li><a href="#241replace方法">2.4.1、<em>replace</em>方法</a></li>
            <li><a href="#242replaceroutebelow方法">2.4.2、<em>replaceRouteBelow</em>方法</a></li>
          </ul>
        </li>
        <li><a href="#25其它方法">2.5、其它方法</a>
          <ul>
            <li><a href="#251of方法">2.5.1、<em>of</em>方法</a></li>
            <li><a href="#252maybeof方法">2.5.2、<em>maybeOf</em>方法</a></li>
            <li><a href="#253restorablexxx方法">2.5.3、<em>restorableXXX</em>方法</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#三源码分析">三、源码分析</a>
      <ul>
        <li><a href="#31_materialappstate-的build方法">3.1、<em>_MaterialAppState</em> 的<em>build</em>方法</a></li>
        <li><a href="#32navigator的push方法">3.2、<em>Navigator</em>的<em>push</em>方法</a></li>
        <li><a href="#33navigator的pop方法">3.3、<em>Navigator</em>的<em>pop</em>方法</a></li>
        <li><a href="#34根布局materialapp的home之创建">3.4、根布局<em>MaterialApp</em>的<em>home</em>之创建</a></li>
        <li><a href="#35navigator的pushnamed方法">3.5、<em>Navigator</em>的<em>pushNamed</em>方法</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <blockquote>
<p><em>注：本文代码基于Flutter SDK 3.13.5</em></p>
</blockquote>
<h1 id="一什么是navigator">一、什么是<em>Navigator</em>？</h1>
<p>先来看下<em>Navigator</em>的注释。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">/// 一个使用堆栈规则管理一组子widgets的widget
</span></span></span><span class="line"><span class="cl"><span class="c1">/// A c that manages a set of child widgets with a stack discipline.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 许多应用程序在其widget层次结构顶部附近都有一个navigator，以便使用 [Overlay] 显示其逻辑历史记录，并将最近访问的页面直观地显示在旧页面的顶部。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 使用此模式可以让navigator通过在overlay中移动widgets来直观地从一个页面过渡到另一页面。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 同样，navigator可用于通过将对话框widget放置在当前页面上方来显示对话框。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Many apps have a navigator near the top of their widget hierarchy in order
</span></span></span><span class="line"><span class="cl"><span class="c1">/// to display their logical history using an [Overlay] with the most recently
</span></span></span><span class="line"><span class="cl"><span class="c1">/// visited pages visually on top of the older pages. Using this pattern lets
</span></span></span><span class="line"><span class="cl"><span class="c1">/// the navigator visually transition from one page to another by moving the widgets
</span></span></span><span class="line"><span class="cl"><span class="c1">/// around in the overlay. Similarly, the navigator can be used to show a dialog
</span></span></span><span class="line"><span class="cl"><span class="c1">/// by positioning the dialog widget above the current page.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ## 使用Pages API
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ## Using the Pages API
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 如果提供的话，[Navigator] 会将其 [Navigator.pages] 转换为一堆 [Route]。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [Navigator.pages] 中的更改将触发 [Route] 堆栈的更新
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [Navigator] 将更新其routes以匹配其 [Navigator.pages] 的新配置。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 要使用此 API，可以创建一个 [Page] 子类并为 [Navigator.pages] 定义一系列 [Page]。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 还需要 [Navigator.onPopPage] 回调来在弹出时正确清理输入页面。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// The [Navigator] will convert its [Navigator.pages] into a stack of [Route]s
</span></span></span><span class="line"><span class="cl"><span class="c1">/// if it is provided. A change in [Navigator.pages] will trigger an update to
</span></span></span><span class="line"><span class="cl"><span class="c1">/// the stack of [Route]s. The [Navigator] will update its routes to match the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// new configuration of its [Navigator.pages]. To use this API, one can create
</span></span></span><span class="line"><span class="cl"><span class="c1">/// a [Page] subclass and defines a list of [Page]s for [Navigator.pages]. A
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [Navigator.onPopPage] callback is also required to properly clean up the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// input pages in case of a pop.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 默认情况下，[Navigator] 将使用 [DefaultTransitionDelegate] 来决定routes如何转入或转出屏幕。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 要自定义它，请定义 [TransitionDelegate] 子类并将其提供给 [Navigator.transitionDelegate]。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// By Default, the [Navigator] will use [DefaultTransitionDelegate] to decide
</span></span></span><span class="line"><span class="cl"><span class="c1">/// how routes transition in or out of the screen. To customize it, define a
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [TransitionDelegate] subclass and provide it to the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [Navigator.transitionDelegate].
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 有关使用pages API 的更多信息，请参阅 [Router] widget.
</span></span></span><span class="line"><span class="cl"><span class="c1">/// For more information on using the pages API, see the [Router] widget.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ## 使用Navigator API
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ## Using the Navigator API
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 移动应用程序通常通过称为“屏幕”或“页面”的全屏元素显示其内容。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 在 Flutter 中，这些元素称为routes，它们由 [Navigator] widget管理。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 导航器管理 [Route] 对象的堆栈，并提供两种管理堆栈的方式，声明式 API [Navigator.pages] 或命令式 API [Navigator.push] 和 [Navigator.pop]。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Mobile apps typically reveal their contents via full-screen elements
</span></span></span><span class="line"><span class="cl"><span class="c1">/// called &#34;screens&#34; or &#34;pages&#34;. In Flutter these elements are called
</span></span></span><span class="line"><span class="cl"><span class="c1">/// routes and they&#39;re managed by a [Navigator] widget. The navigator
</span></span></span><span class="line"><span class="cl"><span class="c1">/// manages a stack of [Route] objects and provides two ways for managing
</span></span></span><span class="line"><span class="cl"><span class="c1">/// the stack, the declarative API [Navigator.pages] or imperative API
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [Navigator.push] and [Navigator.pop].
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 当您的用户界面适合这种堆栈范例时，用户应该能够_导航_回到堆栈中较早的元素，那么使用routes和Navigator是合适的。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 在某些平台（例如 Android）上，系统 UI 将提供后退按钮（在应用程序范围之外），允许用户导航回应用程序堆栈中较早的routes。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 在没有这种内置导航机制的平台上，使用 [AppBar]（通常在 [Scaffold.appBar] 属性中使用）可以自动添加用于用户导航的后退按钮。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// When your user interface fits this paradigm of a stack, where the user
</span></span></span><span class="line"><span class="cl"><span class="c1">/// should be able to _navigate_ back to an earlier element in the stack,
</span></span></span><span class="line"><span class="cl"><span class="c1">/// the use of routes and the Navigator is appropriate. On certain platforms,
</span></span></span><span class="line"><span class="cl"><span class="c1">/// such as Android, the system UI will provide a back button (outside the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// bounds of your application) that will allow the user to navigate back
</span></span></span><span class="line"><span class="cl"><span class="c1">/// to earlier routes in your application&#39;s stack. On platforms that don&#39;t
</span></span></span><span class="line"><span class="cl"><span class="c1">/// have this build-in navigation mechanism, the use of an [AppBar] (typically
</span></span></span><span class="line"><span class="cl"><span class="c1">/// used in the [Scaffold.appBar] property) can automatically add a back
</span></span></span><span class="line"><span class="cl"><span class="c1">/// button for user navigation.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ### 全屏显示route
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ### Displaying a full-screen route
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 虽然您可以直接创建导航器，但最常见的是使用“Router”创建的导航器，它本身是由 [WidgetsApp] 或 [MaterialApp] widget创建和配置的。您可以使用 [Navigator.of] 引用该导航器。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Although you can create a navigator directly, it&#39;s most common to use the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// navigator created by the `Router` which itself is created and configured by
</span></span></span><span class="line"><span class="cl"><span class="c1">/// a [WidgetsApp] or a [MaterialApp] widget. You can refer to that navigator
</span></span></span><span class="line"><span class="cl"><span class="c1">/// with [Navigator.of].
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [MaterialApp] 是最简单的设置方法。 [MaterialApp] 的home成为 [Navigator] 堆栈底部的route。这是您在启动应用程序时看到的内容。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// A [MaterialApp] is the simplest way to set things up. The [MaterialApp]&#39;s
</span></span></span><span class="line"><span class="cl"><span class="c1">/// home becomes the route at the bottom of the [Navigator]&#39;s stack. It is what
</span></span></span><span class="line"><span class="cl"><span class="c1">/// you see when the app is launched.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ```dart
</span></span></span><span class="line"><span class="cl"><span class="c1">/// void main() {
</span></span></span><span class="line"><span class="cl"><span class="c1">///   runApp(const MaterialApp(home: MyAppHome()));
</span></span></span><span class="line"><span class="cl"><span class="c1">/// }
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ```
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 要将新route推送到堆栈上，您可以使用builder函数创建 [MaterialPageRoute] 的实例，该builder函数可以创建您想要在屏幕上显示的任何内容。例如：
</span></span></span><span class="line"><span class="cl"><span class="c1">/// To push a new route on the stack you can create an instance of
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [MaterialPageRoute] with a builder function that creates whatever you
</span></span></span><span class="line"><span class="cl"><span class="c1">/// want to appear on the screen. For example:
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ```dart
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Navigator.push(context, MaterialPageRoute&lt;void&gt;(
</span></span></span><span class="line"><span class="cl"><span class="c1">///   builder: (BuildContext context) {
</span></span></span><span class="line"><span class="cl"><span class="c1">///     return Scaffold(
</span></span></span><span class="line"><span class="cl"><span class="c1">///       appBar: AppBar(title: const Text(&#39;My Page&#39;)),
</span></span></span><span class="line"><span class="cl"><span class="c1">///       body: Center(
</span></span></span><span class="line"><span class="cl"><span class="c1">///         child: TextButton(
</span></span></span><span class="line"><span class="cl"><span class="c1">///           child: const Text(&#39;POP&#39;),
</span></span></span><span class="line"><span class="cl"><span class="c1">///           onPressed: () {
</span></span></span><span class="line"><span class="cl"><span class="c1">///             Navigator.pop(context);
</span></span></span><span class="line"><span class="cl"><span class="c1">///           },
</span></span></span><span class="line"><span class="cl"><span class="c1">///         ),
</span></span></span><span class="line"><span class="cl"><span class="c1">///       ),
</span></span></span><span class="line"><span class="cl"><span class="c1">///     );
</span></span></span><span class="line"><span class="cl"><span class="c1">///   },
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ));
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ```
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 该route使用builder函数而不是子widget定义其widget，因为它将根据推送和弹出的时间在不同的上下文中构建和重建。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// The route defines its widget with a builder function instead of a
</span></span></span><span class="line"><span class="cl"><span class="c1">/// child widget because it will be built and rebuilt in different
</span></span></span><span class="line"><span class="cl"><span class="c1">/// contexts depending on when it&#39;s pushed and popped.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 如您所见，可以使用 Navigator 的 pop 方法弹出新路线，显示应用程序的主页：
</span></span></span><span class="line"><span class="cl"><span class="c1">/// As you can see, the new route can be popped, revealing the app&#39;s home
</span></span></span><span class="line"><span class="cl"><span class="c1">/// page, with the Navigator&#39;s pop method:
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ```dart
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Navigator.pop(context);
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ```
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 通常不需要提供一个使用 [Scaffold] 在路径中弹出Navigator的widget，因为 Scaffold 会自动向其 AppBar 添加“后退”按钮。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 按后退按钮会调用 [Navigator.pop]。在 Android 上，按系统后退按钮会执行相同的操作。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// It usually isn&#39;t necessary to provide a widget that pops the Navigator
</span></span></span><span class="line"><span class="cl"><span class="c1">/// in a route with a [Scaffold] because the Scaffold automatically adds a
</span></span></span><span class="line"><span class="cl"><span class="c1">/// &#39;back&#39; button to its AppBar. Pressing the back button causes
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [Navigator.pop] to be called. On Android, pressing the system back
</span></span></span><span class="line"><span class="cl"><span class="c1">/// button does the same thing.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ### 使用命名路由
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ### Using named navigator routes
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 移动应用程序通常管理大量routes，并且通常最容易通过名称引用它们。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 按照惯例，route名称使用类似路径的结构（例如“/a/b/c”）。应用程序的主页route默认命名为“/”。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Mobile apps often manage a large number of routes and it&#39;s often
</span></span></span><span class="line"><span class="cl"><span class="c1">/// easiest to refer to them by name. Route names, by convention,
</span></span></span><span class="line"><span class="cl"><span class="c1">/// use a path-like structure (for example, &#39;/a/b/c&#39;).
</span></span></span><span class="line"><span class="cl"><span class="c1">/// The app&#39;s home page route is named &#39;/&#39; by default.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [MaterialApp] 可以使用 [Map&lt;String, WidgetBuilder&gt;] 创建，它将route的名称map到将创建它的builder函数。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [MaterialApp] 使用此map为其导航器的 [onGenerateRoute] 回调创建一个值。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// The [MaterialApp] can be created
</span></span></span><span class="line"><span class="cl"><span class="c1">/// with a [Map&lt;String, WidgetBuilder&gt;] which maps from a route&#39;s name to
</span></span></span><span class="line"><span class="cl"><span class="c1">/// a builder function that will create it. The [MaterialApp] uses this
</span></span></span><span class="line"><span class="cl"><span class="c1">/// map to create a value for its navigator&#39;s [onGenerateRoute] callback.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ```dart
</span></span></span><span class="line"><span class="cl"><span class="c1">/// void main() {
</span></span></span><span class="line"><span class="cl"><span class="c1">///   runApp(MaterialApp(
</span></span></span><span class="line"><span class="cl"><span class="c1">///     home: const MyAppHome(), // becomes the route named &#39;/&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1">///     routes: &lt;String, WidgetBuilder&gt; {
</span></span></span><span class="line"><span class="cl"><span class="c1">///       &#39;/a&#39;: (BuildContext context) =&gt; const MyPage(title: Text(&#39;page A&#39;)),
</span></span></span><span class="line"><span class="cl"><span class="c1">///       &#39;/b&#39;: (BuildContext context) =&gt; const MyPage(title: Text(&#39;page B&#39;)),
</span></span></span><span class="line"><span class="cl"><span class="c1">///       &#39;/c&#39;: (BuildContext context) =&gt; const MyPage(title: Text(&#39;page C&#39;)),
</span></span></span><span class="line"><span class="cl"><span class="c1">///     },
</span></span></span><span class="line"><span class="cl"><span class="c1">///   ));
</span></span></span><span class="line"><span class="cl"><span class="c1">/// }
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ```
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 要按名称显示route：
</span></span></span><span class="line"><span class="cl"><span class="c1">/// To show a route by name:
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ```dart
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Navigator.pushNamed(context, &#39;/b&#39;);
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ```
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ### route可以返回一个值
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ### Routes can return a value
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 当推送route向用户询问值时，可以通过 [pop] 方法的结果参数返回该值。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// When a route is pushed to ask the user for a value, the value can be
</span></span></span><span class="line"><span class="cl"><span class="c1">/// returned via the [pop] method&#39;s result parameter.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 推送route的方法返回 [Future]。当弹出路由时，Future会解析，并且 [Future] 的值是 [pop] 方法的“result”参数。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Methods that push a route return a [Future]. The Future resolves when the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// route is popped and the [Future]&#39;s value is the [pop] method&#39;s `result`
</span></span></span><span class="line"><span class="cl"><span class="c1">/// parameter.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 例如，如果我们想要求用户按“确定”来确认操作，我们可以“等待”[Navigator.push]的结果：
</span></span></span><span class="line"><span class="cl"><span class="c1">/// For example if we wanted to ask the user to press &#39;OK&#39; to confirm an
</span></span></span><span class="line"><span class="cl"><span class="c1">/// operation we could `await` the result of [Navigator.push]:
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ```dart
</span></span></span><span class="line"><span class="cl"><span class="c1">/// bool? value = await Navigator.push(context, MaterialPageRoute&lt;bool&gt;(
</span></span></span><span class="line"><span class="cl"><span class="c1">///   builder: (BuildContext context) {
</span></span></span><span class="line"><span class="cl"><span class="c1">///     return Center(
</span></span></span><span class="line"><span class="cl"><span class="c1">///       child: GestureDetector(
</span></span></span><span class="line"><span class="cl"><span class="c1">///         child: const Text(&#39;OK&#39;),
</span></span></span><span class="line"><span class="cl"><span class="c1">///         onTap: () { Navigator.pop(context, true); }
</span></span></span><span class="line"><span class="cl"><span class="c1">///       ),
</span></span></span><span class="line"><span class="cl"><span class="c1">///     );
</span></span></span><span class="line"><span class="cl"><span class="c1">///   }
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ));
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ```
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 如果用户按“确定”，则值将为 true。如果用户退出路线，例如按 Scaffold 的后退按钮，则该值将为 null。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// If the user presses &#39;OK&#39; then value will be true. If the user backs
</span></span></span><span class="line"><span class="cl"><span class="c1">/// out of the route, for example by pressing the Scaffold&#39;s back button,
</span></span></span><span class="line"><span class="cl"><span class="c1">/// the value will be null.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 当route用于返回值时，route的类型参数必须与[pop]结果的类型匹配。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 这就是为什么我们使用 `MaterialPageRoute&lt;bool&gt;` 而不是 `MaterialPageRoute&lt;void&gt;` 或只是 `MaterialPageRoute`。 （不过，如果您不想指定类型，也没关系。）
</span></span></span><span class="line"><span class="cl"><span class="c1">/// When a route is used to return a value, the route&#39;s type parameter must
</span></span></span><span class="line"><span class="cl"><span class="c1">/// match the type of [pop]&#39;s result. That&#39;s why we&#39;ve used
</span></span></span><span class="line"><span class="cl"><span class="c1">/// `MaterialPageRoute&lt;bool&gt;` instead of `MaterialPageRoute&lt;void&gt;` or just
</span></span></span><span class="line"><span class="cl"><span class="c1">/// `MaterialPageRoute`. (If you prefer to not specify the types, though, that&#39;s
</span></span></span><span class="line"><span class="cl"><span class="c1">/// fine too.)
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ### Popup路由
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ### Popup routes
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Routes不必遮盖整个屏幕。 [PopupRoute] 使用 [ModalRoute.barrierColor] 覆盖屏幕，该颜色只能部分不透明，以允许当前屏幕显示出来。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 弹出路由是“模态的”，因为它们阻止对下面的小部件的输入。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Routes don&#39;t have to obscure the entire screen. [PopupRoute]s cover the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// screen with a [ModalRoute.barrierColor] that can be only partially opaque to
</span></span></span><span class="line"><span class="cl"><span class="c1">/// allow the current screen to show through. Popup routes are &#34;modal&#34; because
</span></span></span><span class="line"><span class="cl"><span class="c1">/// they block input to the widgets below.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 有一些功能可以创建和显示popup路由。例如：[showDialog]、[showMenu] 和 [showModalBottomSheet]。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 这些函数返回其推送路线的 Future，如上所述。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 调用者可以等待返回值，以便在弹出路由时采取操作，或者发现路由的值。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// There are functions which create and show popup routes. For
</span></span></span><span class="line"><span class="cl"><span class="c1">/// example: [showDialog], [showMenu], and [showModalBottomSheet]. These
</span></span></span><span class="line"><span class="cl"><span class="c1">/// functions return their pushed route&#39;s Future as described above.
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Callers can await the returned value to take an action when the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// route is popped, or to discover the route&#39;s value.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 还有一些创建popup路由的widgets，例如 [PopupMenuButton] 和 [DropdownButton]。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 这些widgets创建 PopupRoute 的内部子类，并使用导航器的推送和弹出方法来显示和关闭它们。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// There are also widgets which create popup routes, like [PopupMenuButton] and
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [DropdownButton]. These widgets create internal subclasses of PopupRoute
</span></span></span><span class="line"><span class="cl"><span class="c1">/// and use the Navigator&#39;s push and pop methods to show and dismiss them.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ### 自定义路由
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ### Custom routes
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 您可以创建自己的widget库路由类之一的子类，例如 [PopupRoute]、[ModalRoute] 或 [PageRoute]，以控制用于显示路由的动画过渡、路由模态屏障的颜色和行为，以及route的其它方面。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// You can create your own subclass of one of the widget library route classes
</span></span></span><span class="line"><span class="cl"><span class="c1">/// like [PopupRoute], [ModalRoute], or [PageRoute], to control the animated
</span></span></span><span class="line"><span class="cl"><span class="c1">/// transition employed to show the route, the color and behavior of the route&#39;s
</span></span></span><span class="line"><span class="cl"><span class="c1">/// modal barrier, and other aspects of the route.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [PageRouteBuilder] 类可以根据回调定义自定义路由。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 下面是一个示例，当route出现或消失时，其子级会旋转和淡出。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 该route不会遮挡整个屏幕，因为它指定了“opaque: false”，就像popup路由一样。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// The [PageRouteBuilder] class makes it possible to define a custom route
</span></span></span><span class="line"><span class="cl"><span class="c1">/// in terms of callbacks. Here&#39;s an example that rotates and fades its child
</span></span></span><span class="line"><span class="cl"><span class="c1">/// when the route appears or disappears. This route does not obscure the entire
</span></span></span><span class="line"><span class="cl"><span class="c1">/// screen because it specifies `opaque: false`, just as a popup route does.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ```dart
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Navigator.push(context, PageRouteBuilder&lt;void&gt;(
</span></span></span><span class="line"><span class="cl"><span class="c1">///   opaque: false,
</span></span></span><span class="line"><span class="cl"><span class="c1">///   pageBuilder: (BuildContext context, _, __) {
</span></span></span><span class="line"><span class="cl"><span class="c1">///     return const Center(child: Text(&#39;My PageRoute&#39;));
</span></span></span><span class="line"><span class="cl"><span class="c1">///   },
</span></span></span><span class="line"><span class="cl"><span class="c1">///   transitionsBuilder: (___, Animation&lt;double&gt; animation, ____, Widget child) {
</span></span></span><span class="line"><span class="cl"><span class="c1">///     return FadeTransition(
</span></span></span><span class="line"><span class="cl"><span class="c1">///       opacity: animation,
</span></span></span><span class="line"><span class="cl"><span class="c1">///       child: RotationTransition(
</span></span></span><span class="line"><span class="cl"><span class="c1">///         turns: Tween&lt;double&gt;(begin: 0.5, end: 1.0).animate(animation),
</span></span></span><span class="line"><span class="cl"><span class="c1">///         child: child,
</span></span></span><span class="line"><span class="cl"><span class="c1">///       ),
</span></span></span><span class="line"><span class="cl"><span class="c1">///     );
</span></span></span><span class="line"><span class="cl"><span class="c1">///   }
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ));
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ```
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 页面路由由两部分组成：“页面”和“转换”。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 该页面成为传递给“transitionsBuilder”函数的子级的后代。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 通常，页面仅构建一次，因为它不依赖于其动画参数（在本例中用“_”和“__”省略）。过渡是在其持续时间内的每一帧上构建的。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// The page route is built in two parts, the &#34;page&#34; and the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// &#34;transitions&#34;. The page becomes a descendant of the child passed to
</span></span></span><span class="line"><span class="cl"><span class="c1">/// the `transitionsBuilder` function. Typically the page is only built once,
</span></span></span><span class="line"><span class="cl"><span class="c1">/// because it doesn&#39;t depend on its animation parameters (elided with `_`
</span></span></span><span class="line"><span class="cl"><span class="c1">/// and `__` in this example). The transition is built on every frame
</span></span></span><span class="line"><span class="cl"><span class="c1">/// for its duration.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 在此示例中，“void”用作路由的返回类型，因为它不返回值。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// (In this example, `void` is used as the return type for the route, because
</span></span></span><span class="line"><span class="cl"><span class="c1">/// it does not return a value.)
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ### 嵌套导航
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ### Nesting Navigators
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 一个应用程序可以使用多个[Navigator]。将一个 [Navigator] 嵌套在另一个 [Navigator] 之下可用于创建“内部旅程”，例如选项卡式导航、用户注册、商店结帐或代表整个应用程序的一部分的其他独立旅程。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// An app can use more than one [Navigator]. Nesting one [Navigator] below
</span></span></span><span class="line"><span class="cl"><span class="c1">/// another [Navigator] can be used to create an &#34;inner journey&#34; such as tabbed
</span></span></span><span class="line"><span class="cl"><span class="c1">/// navigation, user registration, store checkout, or other independent journeys
</span></span></span><span class="line"><span class="cl"><span class="c1">/// that represent a subsection of your overall application.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// #### 示例
</span></span></span><span class="line"><span class="cl"><span class="c1">/// #### Example
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// iOS应用程序的标准做法是使用选项卡式导航，其中每个选项卡都维护自己的导航历史记录。因此，每个选项卡都有自己的[Navigator]，创建了一种“并行导航”。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="c1">/// It is standard practice for iOS apps to use tabbed navigation where each
</span></span></span><span class="line"><span class="cl"><span class="c1">/// tab maintains its own navigation history. Therefore, each tab has its own
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [Navigator], creating a kind of &#34;parallel navigation.&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 除了选项卡的并行导航之外，仍然可以启动完全覆盖选项卡的全屏页面。例如：入门流程或警报对话框。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 因此，必须存在一个位于选项卡导航上方的“根”[Navigator]。因此，每个选项卡的 [Navigator] 实际上都是嵌套的 [Navigator]，位于单个根 [Navigator] 的下方。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// In addition to the parallel navigation of the tabs, it is still possible to
</span></span></span><span class="line"><span class="cl"><span class="c1">/// launch full-screen pages that completely cover the tabs. For example: an
</span></span></span><span class="line"><span class="cl"><span class="c1">/// on-boarding flow, or an alert dialog. Therefore, there must exist a &#34;root&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [Navigator] that sits above the tab navigation. As a result, each of the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// tab&#39;s [Navigator]s are actually nested [Navigator]s sitting below a single
</span></span></span><span class="line"><span class="cl"><span class="c1">/// root [Navigator].
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 实际上，用于选项卡式导航的嵌套 [Navigator] 位于 [WidgetsApp] 和 [CupertinoTabView] widgets中，不需要显式创建或管理。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// In practice, the nested [Navigator]s for tabbed navigation sit in the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [WidgetsApp] and [CupertinoTabView] widgets and do not need to be explicitly
</span></span></span><span class="line"><span class="cl"><span class="c1">/// created or managed.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// {@tool sample}
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 以下示例演示了如何使用嵌套的 [Navigator] 来呈现独立的用户注册过程。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// The following example demonstrates how a nested [Navigator] can be used to
</span></span></span><span class="line"><span class="cl"><span class="c1">/// present a standalone user registration journey.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 尽管此示例使用两个 [Navigator] 来演示嵌套的 [Navigator]，但仅使用单个 [Navigator] 也可能获得类似的结果。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Even though this example uses two [Navigator]s to demonstrate nested
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [Navigator]s, a similar result is possible using only a single [Navigator].
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 使用“flutter run --route=/signup”运行此示例，以通过注册流程而不是在主页上启动它。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Run this example with `flutter run --route=/signup` to start it with
</span></span></span><span class="line"><span class="cl"><span class="c1">/// the signup flow instead of on the home page.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ** See code in examples/api/lib/widgets/navigator/navigator.0.dart **
</span></span></span><span class="line"><span class="cl"><span class="c1">/// {@end-tool}
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [Navigator.of] 对给定 [BuildContext] 最近的祖先 [Navigator] 进行操作。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 请务必在预期的 [Navigator] 下方提供 [BuildContext]，尤其是在创建嵌套 [Navigator] 的大型“构建”方法中。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [Builder] widget可用于访问widget子树中所需位置的 [BuildContext]。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [Navigator.of] operates on the nearest ancestor [Navigator] from the given
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [BuildContext]. Be sure to provide a [BuildContext] below the intended
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [Navigator], especially in large `build` methods where nested [Navigator]s
</span></span></span><span class="line"><span class="cl"><span class="c1">/// are created. The [Builder] widget can be used to access a [BuildContext] at
</span></span></span><span class="line"><span class="cl"><span class="c1">/// a desired location in the widget subtree.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ### 寻找封闭route
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ### Finding the enclosing route
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 在模态路由的常见情况下，可以使用 [ModalRoute.of] 从构建方法内部获取封闭路由。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 要确定封闭路由是否是活动路由（例如，以便在路由不活动时控件可以变暗），可以在返回的路由上检查 [Route.isCurrent] 属性。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// In the common case of a modal route, the enclosing route can be obtained
</span></span></span><span class="line"><span class="cl"><span class="c1">/// from inside a build method using [ModalRoute.of]. To determine if the
</span></span></span><span class="line"><span class="cl"><span class="c1">/// enclosing route is the active route (e.g. so that controls can be dimmed
</span></span></span><span class="line"><span class="cl"><span class="c1">/// when the route is not active), the [Route.isCurrent] property can be checked
</span></span></span><span class="line"><span class="cl"><span class="c1">/// on the returned route.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ## 状态恢复
</span></span></span><span class="line"><span class="cl"><span class="c1">/// ## State Restoration
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 如果提供了 [restorationScopeId] 并且当被有效的 [RestorationScope] 包围时，[Navigator] 将通过在状态恢复期间重新创建 [Route] 的当前历史堆栈以及恢复这些 [Route] 的内部状态来恢复其状态。然而，并不是堆栈上的所有[Route]都可以恢复：
</span></span></span><span class="line"><span class="cl"><span class="c1">/// If provided with a [restorationScopeId] and when surrounded by a valid
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [RestorationScope] the [Navigator] will restore its state by recreating
</span></span></span><span class="line"><span class="cl"><span class="c1">/// the current history stack of [Route]s during state restoration and by
</span></span></span><span class="line"><span class="cl"><span class="c1">/// restoring the internal state of those [Route]s. However, not all [Route]s
</span></span></span><span class="line"><span class="cl"><span class="c1">/// on the stack can be restored:
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">///  * 如果提供了 [Page.restorationId]，基于 [Page] 的路由将恢复其状态。
</span></span></span><span class="line"><span class="cl"><span class="c1">///  * [Page]-based routes restore their state if [Page.restorationId] is
</span></span></span><span class="line"><span class="cl"><span class="c1">///    provided.
</span></span></span><span class="line"><span class="cl"><span class="c1">///  * 使用经典命令式 API（[push]、[pushNamed] 等）添加的 [Route] 永远无法恢复其状态。
</span></span></span><span class="line"><span class="cl"><span class="c1">///  * [Route]s added with the classic imperative API ([push], [pushNamed], and
</span></span></span><span class="line"><span class="cl"><span class="c1">///    friends) can never restore their state.
</span></span></span><span class="line"><span class="cl"><span class="c1">///  * 添加了可恢复命令式 API（[restorablePush]、[restorablePushNamed] 以及名称中带有“restorable”的所有其他命令式方法）的 [Route] 将恢复其状态，如果它下面的所有路由一直到并包括第一个 [Page]-其下方的基本路线已恢复。如果它下面没有基于 [Page] 的路由，则只有当它下面的所有路由都恢复其状态时，它才会恢复其状态。
</span></span></span><span class="line"><span class="cl"><span class="c1">///  * A [Route] added with the restorable imperative API ([restorablePush],
</span></span></span><span class="line"><span class="cl"><span class="c1">///    [restorablePushNamed], and all other imperative methods with &#34;restorable&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1">///    in their name) restores its state if all routes below it up to and
</span></span></span><span class="line"><span class="cl"><span class="c1">///    including the first [Page]-based route below it are restored. If there
</span></span></span><span class="line"><span class="cl"><span class="c1">///    is no [Page]-based route below it, it only restores its state if all
</span></span></span><span class="line"><span class="cl"><span class="c1">///    routes below it restore theirs.
</span></span></span><span class="line"><span class="cl"><span class="c1">///
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 如果 [Route] 被视为可恢复，[Navigator] 会将其 [Route.restorationScopeId] 设置为非空值。路由可以使用该 ID 来存储和恢复自己的状态。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// 例如，[ModalRoute] 将使用此 ID 为其内容widgets创建 [RestorationScope]。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// If a [Route] is deemed restorable, the [Navigator] will set its
</span></span></span><span class="line"><span class="cl"><span class="c1">/// [Route.restorationScopeId] to a non-null value. Routes can use that ID to
</span></span></span><span class="line"><span class="cl"><span class="c1">/// store and restore their own state. As an example, the [ModalRoute] will
</span></span></span><span class="line"><span class="cl"><span class="c1">/// use this ID to create a [RestorationScope] for its content widgets.
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>由上面注释可以总结一下<em>Navigator</em>的特性：</p>
<p>1、<em>Navigator</em>是一个使用堆栈规则管理一组子<em>Widgets</em>的<em>Widget</em></p>
<p>2、<em>Navigator</em>通过在<em>Overlay</em>中移动<em>Widgets</em>来直观地从一个页面过渡到另一页面</p>
<p>3、移动<em>App</em>通常通过称为“屏幕”或“页面”的全屏元素显示其内容，而在<em>Flutter</em>中，这些元素称为<em>Routes</em>，它们由<em>Navigator</em>管理</p>
<p>4、<em>Navigator</em>管理<em>Route</em>对象的堆栈，并提供两种管理堆栈的方式，声明式<em>API</em><code>Navigator.pages</code>或命令式<em>API</em><code>Navigator.push</code>和<code>Navigator.pop</code>，本文所讲的是命令式<em>API</em></p>
<p>5、对于声明式<em>API</em>，<em>Navigator</em>会将其<em>Navigator.pages</em>转换为一堆<em>Route</em>。<em>Navigator.pages</em>中的更改将触发<em>Route</em>堆栈的更新；同理，<em>Navigator</em>将更新其<em>Routes</em>以匹配其<em>Navigator.pages</em>的新配置</p>
<p>6、<em>WidgetsApp</em>或<em>MaterialApp</em>底层已创建和配置<em>Navigator</em>，<em>MaterialApp</em>的<em>home</em>成为<em>Navigator</em>堆栈底部的<em>Route</em>，然后可以使用<em>Navigator.of</em>引用该<em>Navigator</em></p>
<p>7、默认情况下，<em>Navigator</em>将使用<em>DefaultTransitionDelegate</em>来决定<em>Routes</em>如何转入或转出屏幕。要自定义它，请定义<em>TransitionDelegate</em>子类并将其提供给<em>Navigator.transitionDelegate</em></p>
<p>8、移动<em>App</em>通常管理大量<em>Routes</em>，并且通常最容易通过名称引用它们。按照惯例，<em>Route</em>名称使用类似路径的结构（例如“/a/b/c”）。应用程序的主页<em>Route</em>默认命名为“/”。</p>
<p>这里给出了<em>Navigator</em>的部分特性，主要是想让大家对<em>Navigator</em>有一个初级认知。</p>
<h1 id="二navigator的相关方法">二、<em>Navigator</em>的相关方法</h1>
<h2 id="21路由跳转方法">2.1、路由跳转方法</h2>
<p>对于路由跳转方法，它有两种方式：</p>
<ul>
<li><em><strong>组件路由跳转</strong></em>：想要跳转到哪个<em>Page</em>，那么直接将<em>Page</em>当作参数传递进去就可以了。</li>
</ul>
<blockquote>
<p><em>注意：不建议组件路由跳转与命名路由跳转进行混用，对于组件路由跳转来说，它没有路由名称，在使用pushAndRemoveUntil或pushNamedAndRemoveUntil方法时会因为无法找到ModalRoute.withName配置的路由名称而导致不能实现预期效果。</em></p>
</blockquote>
<ul>
<li><em><strong>命名路由跳转</strong></em>：先将<em>Page</em>注册到路由表内并起一个名字，然后其它页面通过这个名字进行跳转。</li>
</ul>
<blockquote>
<p><em>官方建议：对于大多数应用程序，我们不建议使用命名路由。虽然命名路由可以处理深层链接，但其行为始终相同，无法定制。当平台收到新的深度链接时，Flutter将新的Route推到Navigator上，而不管用户当前在哪里。对于应用程序使用命名路由Flutter也是不支持浏览器的前进按钮，出于这些原因，我们不建议在大多数应用程序中使用命名路由。具有高级导航和路由要求的Flutter应用应该使用一个路由包，如<a href="https://pub-web.flutter-io.cn/packages/go_router"><em>go_router</em></a>，它可以解析路由路径并在应用程序收到新的深度链接时配置Navigator。因为像go_router这样的包是声明性的，所以当接收到深度链接时，它们将始终显示相同的屏幕。</em></p>
</blockquote>
<p><em>OK</em>，接下来开始分析路由跳转方法。</p>
<h3 id="211pushpushnamed方法">2.1.1、<em>push/pushNamed</em>方法</h3>
<p>方法描述：在栈顶入栈一个新的路由</p>
<p><em>push</em>方法执行后，路由栈的变化情况：</p>
<p>1、当前路由栈中的路由顺序为A-&gt;B-&gt;C（由下往上）</p>
<p>2、从C <em>push</em> D</p>
<p>3、当前路由栈中的路由顺序变为A-&gt;B-&gt;C-&gt;D</p>
<h3 id="212pushreplacementpushreplacementnamed方法">2.1.2、<em>pushReplacement/pushReplacementNamed</em>方法</h3>
<p>方法描述：将当前栈顶路由替换为一个新的路由</p>
<p><em>pushReplacement</em>方法执行后，路由栈的变化情况：</p>
<p>1、当前路由栈中的路由顺序为A-&gt;B-&gt;C（由下往上）</p>
<p>2、从C <em>pushReplacement</em> D</p>
<p>3、当前路由栈中的路由顺序变为A-&gt;B-&gt;D</p>
<h3 id="213pushandremoveuntilpushnamedandremoveuntil方法">2.1.3、<em>pushAndRemoveUntil/pushNamedAndRemoveUntil</em>方法</h3>
<p>方法描述：在栈顶入栈一个新的路由，然后删除所有先前的路由，直到<em>predicate</em>返回<em>true</em>。</p>
<p>这里分为两种情况：</p>
<p>如果要删除推送路由下面的所有路由，请使用始终返回<em>false</em>的<em>RoutePredicate</em> （例如(<code>Route&lt;dynamic&gt; route) =&gt; false</code>），<em>pushAndRemoveUntil</em>方法执行后，路由栈的变化情况：</p>
<p>1、当前路由栈中的路由顺序为A-&gt;B-&gt;C（由下往上）</p>
<p>2、从C <em>pushAndRemoveUntil</em> D</p>
<p>3、当前路由栈中的路由顺序变为D，此时D成为根路由</p>
<p>如果要删除路由直到具有特定名称的路由，请使用从<em>ModalRoute.withName</em>返回的<em>RoutePredicate</em>（例如<code>ModalRoute.withName('/')</code>），<em>pushAndRemoveUntil</em>方法执行后，路由栈的变化情况：</p>
<p>1、当前路由栈中的路由顺序为A-&gt;B-&gt;C（由下往上）</p>
<p>2、从C <em>pushAndRemoveUntil</em> D</p>
<p>3、当前路由栈中的路由顺序变为A-&gt;D</p>
<h2 id="22路由出栈方法">2.2、路由出栈方法</h2>
<h3 id="221pop方法">2.2.1、<em>pop</em>方法</h3>
<p>方法描述：将栈顶路由出栈</p>
<p><em>pop</em>方法执行后，路由栈的变化情况：</p>
<p>1、当前路由栈中的路由顺序为A-&gt;B-&gt;C（由下往上）</p>
<p>2、从C <em>pop</em></p>
<p>3、当前路由栈中的路由顺序变为A-&gt;B</p>
<h3 id="222popuntil方法">2.2.2、<em>popUntil</em>方法</h3>
<p>方法描述：将栈顶路由逐个出栈，直到<em>predicate</em>返回<em>true</em>。</p>
<p>要弹出具有特定名称的路由，请使用从<em>ModalRoute.withName</em>返回的<em>RoutePredicate</em>（例如<code>ModalRoute.withName('/')</code>），<em>popUntil</em>方法执行后，路由栈的变化情况：</p>
<p>1、当前路由栈中的路由顺序为A-&gt;B-&gt;C（由下往上）</p>
<p>2、从C <em>popUntil</em></p>
<p>3、当前路由栈中的路由顺序变为A</p>
<h3 id="223popandpushnamed方法">2.2.3、<em>popAndPushNamed</em>方法</h3>
<p>方法描述：将栈顶路由出栈，然后在栈顶入栈一个新的路由，弹出和推送的动画是同时执行的，即使旧<em>Route</em>和新<em>Route</em>都是不透明的，下面的<em>Route</em>也可能会短暂可见</p>
<p><em>popAndPushNamed</em>方法执行后，路由栈的变化情况：</p>
<p>1、当前路由栈中的路由顺序为A-&gt;B-&gt;C（由下往上）</p>
<p>2、从C <em>popAndPushNamed</em> D</p>
<p>3、当前路由栈中的路由顺序变为A-&gt;B-&gt;D</p>
<h3 id="224canpop方法">2.2.4、<em>canPop</em>方法</h3>
<p>方法描述：判断当前路由是否可以出栈，如果栈内只有当前路由，返回<em>false</em>，如果当前路由前面还有路由，返回<em>true</em></p>
<h3 id="225maybepop方法">2.2.5、<em>maybePop</em>方法</h3>
<p>方法描述：当前路由如能出栈就出栈，如果不能就什么都不做。</p>
<h2 id="23路由删除方法">2.3、路由删除方法</h2>
<h3 id="231removeroute方法">2.3.1、<em>removeRoute</em>方法</h3>
<p>方法描述：删除<em>Route</em>，然后<em>Route.dispose</em>它。此方法调用不会运行任何动画。给定的<em>Route</em>必须在历史记录中；如果不是，此方法将抛出异常。使用场景例如：此方法用于立即关闭屏幕方向更改时出现的下拉菜单。</p>
<p><em>removeRoute</em>方法执行后，路由栈的变化情况：</p>
<p>1、当前路由栈中的路由顺序为A-&gt;B-&gt;C（由下往上）</p>
<p>2、从C <em>removeRoute</em> B</p>
<p>3、当前路由栈中的路由顺序变为A-&gt;C</p>
<h3 id="232removeroutebelow方法">2.3.2、<em>removeRouteBelow</em>方法</h3>
<p>方法描述：删除<em>Route</em>，然后Route.dispose它。要删除的<em>Route</em>是给定的<em>anchorRoute</em>下面的<em>Route</em>。此方法调用不会运行任何动画。给定的<em>anchorRoute</em>必须在历史记录中，并且下面必须有一条<em>Route</em>；如果不是或者没有，这个方法会抛出异常</p>
<p><em>removeRouteBelow</em>方法执行后，路由栈的变化情况：</p>
<p>1、当前路由栈中的路由顺序为A-&gt;B-&gt;C（由下往上）</p>
<p>2、从C <em>removeRouteBelow</em> B</p>
<p>3、当前路由栈中的路由顺序变为B-&gt;C</p>
<h2 id="24路由替换方法">2.4、路由替换方法</h2>
<h3 id="241replace方法">2.4.1、<em>replace</em>方法</h3>
<p>方法描述：用一个新的<em>Route</em>，将路由表内的一个已存在的<em>Route</em>替换掉。旧<em>Route</em>当前不得可见，因为此方法会跳过动画，因此如果旧<em>Route</em>可见，则删除会很不和谐。要替换最顶层的路由，请考虑使用<em>pushReplacement</em>，它会为新路由设置动画，并延迟删除旧路由，直到新路由完成动画处理。</p>
<p><em>replace</em>方法执行后，路由栈的变化情况：</p>
<p>1、当前路由栈中的路由顺序为A-&gt;B-&gt;C（由下往上）</p>
<p>2、从B <em>replace</em> newB</p>
<p>3、当前路由栈中的路由顺序变为A-&gt;newB-&gt;C</p>
<h3 id="242replaceroutebelow方法">2.4.2、<em>replaceRouteBelow</em>方法</h3>
<p>方法描述：用一个新的<em>Route</em>，将路由表内的一个已存在的<em>anchorRoute</em>的前面的<em>Route</em>给替换掉。旧<em>Route</em>当前不得可见，因为此方法会跳过动画，因此如果旧<em>Route</em>可见，则删除会很不和谐。要替换最顶层的路由，请考虑使用<em>pushReplacement</em>，它会为新路由设置动画，并延迟删除旧路由，直到新路由完成动画处理。</p>
<p><em>replaceRouteBelow</em>方法执行后，路由栈的变化情况：</p>
<p>1、当前路由栈中的路由顺序为A-&gt;B-&gt;C（由下往上）</p>
<p>2、从B <em>replaceRouteBelow</em> newB</p>
<p>3、当前路由栈中的路由顺序变为newB-&gt;B-&gt;C</p>
<h2 id="25其它方法">2.5、其它方法</h2>
<h3 id="251of方法">2.5.1、<em>of</em>方法</h3>
<p>方法描述：获取给定上下文的此类的最近实例的<em>NavigatorState</em>。如果<em>rootNavigator</em>设置为 <em>true</em>，则给出距此类最远实例的<em>NavigatorState</em>。如果给定<em>context</em>中没有<em>Navigator</em>，则该函数将在调试模式下抛出<em>FlutterError</em>，并在发布模式下抛出异常。这种方法可能很昂贵（它遍历<em>Element</em>树）。</p>
<h3 id="252maybeof方法">2.5.2、<em>maybeOf</em>方法</h3>
<p>方法描述：获取给定上下文（如果有）的此类的最近实例的<em>NavigatorState</em>。如果<em>rootNavigator</em>设置为<em>true</em>，则给出距此类最远实例的状态。如果<em>context</em>中没有祖先<em>Navigator</em>，则返回<em>null</em>。这种方法可能很昂贵（它遍历<em>Element</em>树）。</p>
<h3 id="253restorablexxx方法">2.5.3、<em>restorableXXX</em>方法</h3>
<p>这些方法与<em>Route</em>的恢复相关，一般情况下用不到这些方法，感兴趣可以自行学习。</p>
<h1 id="三源码分析">三、源码分析</h1>
<p>在<em>Flutter</em>中，万物皆<em>Widget</em>，<em>Navigator</em>自然也不例外，只是我们没有主动添加过<em>Navigator</em>，但是又可以通过<em>Navigator</em>来进行页面跳转，这是怎么一回事呢？</p>
<p>在进行<em>Flutter</em>开发时，一般情况下需要以<em>MaterialApp</em>或<em>WidgetsApp</em>（<em>MaterialApp</em>是对<em>WidgetsApp</em>的包装）来作为第一个<em>Widget</em>，否则可能会出现一些不可预估的错误。</p>
<p>例如，如果你没有以<em>MaterialApp</em>作为第一个<em>Widget</em>，后续在使用<em>Navigator</em>的方法时，可能就会因为找不到<em>Navigator</em>而报错。</p>
<p>这是因为<em>Flutter</em>默认在<em>MaterialApp</em>中添加了第一个<em>Navigator</em>，也就是根<em>Navigator</em>，如果您不主动添加过其它<em>Navigator</em>的话，一般情况下的跳转就是通过这个根<em>Navigator</em>来实现的。</p>
<p>看下面的例子，通过<em>Navigator</em>跳转传参以及将数据返回给上一个页面。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">runApp</span><span class="p">(</span><span class="kd">const</span> <span class="n">MyApp</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyApp</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">MyApp</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">MaterialApp</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">title:</span> <span class="s1">&#39;Flutter Demo&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">theme:</span> <span class="n">ThemeData</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">colorScheme:</span> <span class="n">ColorScheme</span><span class="p">.</span><span class="n">fromSeed</span><span class="p">(</span><span class="nl">seedColor:</span> <span class="n">Colors</span><span class="p">.</span><span class="n">deepPurple</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">useMaterial3:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">home:</span> <span class="kd">const</span> <span class="n">MyHomePage</span><span class="p">(</span><span class="nl">title:</span> <span class="s1">&#39;Navigator示例&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyHomePage</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">MyHomePage</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="kd">required</span> <span class="k">this</span><span class="p">.</span><span class="n">title</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">String</span> <span class="n">title</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">State</span><span class="o">&lt;</span><span class="n">MyHomePage</span><span class="o">&gt;</span> <span class="n">createState</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="n">_MyHomePageState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">_MyHomePageState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">MyHomePage</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">appBar:</span> <span class="n">AppBar</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">backgroundColor:</span> <span class="n">Theme</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">inversePrimary</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">title:</span> <span class="n">Text</span><span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">title</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">body:</span> <span class="n">Center</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">child:</span> <span class="n">Column</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nl">mainAxisSize:</span> <span class="n">MainAxisSize</span><span class="p">.</span><span class="n">min</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nl">children:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">OutlinedButton</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="nl">onPressed:</span> <span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">Object</span><span class="o">?</span> <span class="n">value</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">Navigator</span><span class="p">.</span><span class="n">push</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                  <span class="n">context</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">MaterialPageRoute</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">builder:</span> <span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kd">const</span> <span class="n">SecondPage</span><span class="p">(</span><span class="nl">argument:</span> <span class="m">888</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                  <span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mounted</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">ScaffoldMessenger</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  <span class="p">..</span><span class="n">removeCurrentSnackBar</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                  <span class="p">..</span><span class="n">showSnackBar</span><span class="p">(</span><span class="n">SnackBar</span><span class="p">(</span><span class="nl">content:</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;SecondPage返回的数据为：</span><span class="si">$</span><span class="n">value</span><span class="s1">&#39;</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nl">child:</span> <span class="kd">const</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;跳转（从SecondPage构造方法传入参数）&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">OutlinedButton</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="nl">onPressed:</span> <span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">Object</span><span class="o">?</span> <span class="n">value</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">Navigator</span><span class="p">.</span><span class="n">push</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                  <span class="n">context</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">MaterialPageRoute</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">builder:</span> <span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kd">const</span> <span class="n">SecondPage</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">settings:</span> <span class="kd">const</span> <span class="n">RouteSettings</span><span class="p">(</span><span class="nl">arguments:</span> <span class="m">999</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                  <span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mounted</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">ScaffoldMessenger</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  <span class="p">..</span><span class="n">removeCurrentSnackBar</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                  <span class="p">..</span><span class="n">showSnackBar</span><span class="p">(</span><span class="n">SnackBar</span><span class="p">(</span><span class="nl">content:</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;SecondPage返回的数据为：</span><span class="si">$</span><span class="n">value</span><span class="s1">&#39;</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nl">child:</span> <span class="kd">const</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;跳转（从settings传入参数）&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">SecondPage</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">Object</span><span class="o">?</span> <span class="n">argument</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">SecondPage</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">argument</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">Object</span><span class="o">?</span> <span class="n">value</span> <span class="o">=</span> <span class="n">argument</span> <span class="o">??</span> <span class="n">ModalRoute</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">arguments</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">appBar:</span> <span class="n">AppBar</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">backgroundColor:</span> <span class="n">Theme</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">inversePrimary</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">title:</span> <span class="kd">const</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;SecondPage&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">body:</span> <span class="n">Center</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">child:</span> <span class="n">OutlinedButton</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nl">onPressed:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">Navigator</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="nl">child:</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;获取的返回值为：</span><span class="si">$</span><span class="n">value</span><span class="s1">，点击返回&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>程序运行起来后，<em>UI</em>效果如下所示。</p>
<img title="" src="/img/flutter/解读Flutter源码之Navigator（命令式）/navigator示例.gif" alt="" width="235">
<p>然后通过<em>Flutter Inspector</em>查看<em>Widget</em>层次结构，可以发现<em>MaterialApp</em>中的确默认添加了第一个<em>Navigator</em>。</p>
<img title="" src="/img/flutter/解读Flutter源码之Navigator（命令式）/navigator层次结构.png" alt="" width="535">
<p><em>OK</em>，下面按照示例来分析<em>Navigator</em>的源码（命令式部分）。</p>
<h2 id="31_materialappstate-的build方法">3.1、<em>_MaterialAppState</em> 的<em>build</em>方法</h2>
<p>从<em>MaterialApp</em>入手，因为它是一个<em>StatefulWidget</em>，所以看下 <em>_MaterialAppState</em> 的<em>build</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行_buildWidgetApp方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Widget</span> <span class="n">result</span> <span class="o">=</span> <span class="n">_buildWidgetApp</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">ScrollConfiguration</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">behavior:</span> <span class="n">widget</span><span class="p">.</span><span class="n">scrollBehavior</span> <span class="o">??</span> <span class="kd">const</span> <span class="n">MaterialScrollBehavior</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="nl">child:</span> <span class="n">HeroControllerScope</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">controller:</span> <span class="n">_heroController</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">result</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下 <em>_MaterialAppState</em> 的 <em>_buildWidgetApp</em> 方法，可以发现它根据 <em>_usesRouter</em> 来选择不同的<em>WidgetsApp</em>构造方法进行创建<em>WidgetsApp</em>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// _usesRouter表示是否使用Router，它是声明式的范畴，本文所讲是命令式，因此_usesRouter可视为false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="kd">get</span> <span class="n">_usesRouter</span> <span class="o">=&gt;</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerDelegate</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerConfig</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Widget</span> <span class="n">_buildWidgetApp</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_usesRouter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Router方式实现路由导航（声明式）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">WidgetsApp</span><span class="p">.</span><span class="n">router</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 直接Navigator方式实现路由导航（命令式）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">WidgetsApp</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">key:</span> <span class="n">GlobalObjectKey</span><span class="p">(</span><span class="k">this</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 此处是MaterialApp传入的navigatorKey
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">navigatorKey:</span> <span class="n">widget</span><span class="p">.</span><span class="n">navigatorKey</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">navigatorObservers:</span> <span class="n">widget</span><span class="p">.</span><span class="n">navigatorObservers</span><span class="o">!</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 返回MaterialPageRoute，这个和根布局Route相关，后面讲
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">pageRouteBuilder:</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">RouteSettings</span> <span class="n">settings</span><span class="p">,</span> <span class="n">WidgetBuilder</span> <span class="n">builder</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">MaterialPageRoute</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nl">settings:</span> <span class="n">settings</span><span class="p">,</span> <span class="nl">builder:</span> <span class="n">builder</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 此处是MaterialApp传入的根布局
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">home:</span> <span class="n">widget</span><span class="p">.</span><span class="n">home</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 此处是MaterialApp传入的路由表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">routes:</span> <span class="n">widget</span><span class="p">.</span><span class="n">routes</span><span class="o">!</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 此处是MaterialApp传入的初始路由名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">initialRoute:</span> <span class="n">widget</span><span class="p">.</span><span class="n">initialRoute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 此处是MaterialApp传入的onGenerateRoute路由钩子函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">onGenerateRoute:</span> <span class="n">widget</span><span class="p">.</span><span class="n">onGenerateRoute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 此处是MaterialApp传入的onGenerateInitialRoutes初始路由钩子函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">onGenerateInitialRoutes:</span> <span class="n">widget</span><span class="p">.</span><span class="n">onGenerateInitialRoutes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 此处是MaterialApp传入的onUnknownRoute未知路由钩子函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">onUnknownRoute:</span> <span class="n">widget</span><span class="p">.</span><span class="n">onUnknownRoute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于<em>WidgetsApp</em>构造方法传入的<em>navigatorKey</em>，如果没在<em>MaterialApp</em>中传入，那么它会创建一个默认的<em>navigatorKey</em>，先看下 <em>_WidgetsAppState</em> 的<em>initState</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">initState</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">super</span><span class="p">.</span><span class="n">initState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行_updateRouting方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_updateRouting</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">_locale</span> <span class="o">=</span> <span class="n">_resolveLocales</span><span class="p">(</span><span class="n">WidgetsBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">platformDispatcher</span><span class="p">.</span><span class="n">locales</span><span class="p">,</span> <span class="n">widget</span><span class="p">.</span><span class="n">supportedLocales</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">WidgetsBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下 <em>_WidgetsAppState</em> 的 <em>_updateRouting</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="kd">get</span> <span class="n">_usesNavigator</span> <span class="o">=&gt;</span> <span class="n">widget</span><span class="p">.</span><span class="n">home</span> <span class="o">!=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">    <span class="o">||</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">routes</span><span class="o">?</span><span class="p">.</span><span class="n">isNotEmpty</span> <span class="o">??</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">||</span> <span class="n">widget</span><span class="p">.</span><span class="n">onGenerateRoute</span> <span class="o">!=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">    <span class="o">||</span> <span class="n">widget</span><span class="p">.</span><span class="n">onUnknownRoute</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">GlobalKey</span><span class="o">&lt;</span><span class="n">NavigatorState</span><span class="o">&gt;?</span> <span class="n">_navigator</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_updateRouting</span><span class="p">({</span><span class="n">WidgetsApp</span><span class="o">?</span> <span class="n">oldWidget</span><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_usesRouterWithDelegates</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_usesNavigator</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">_usesRouterWithDelegates</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_usesRouterWithConfig</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_clearRouterResource</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建一个默认的navigatorKey，也就是GlobalObjectKey&lt;NavigatorState&gt;，赋值给_navigator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_navigator</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">widget</span><span class="p">.</span><span class="n">navigatorKey</span> <span class="o">!=</span> <span class="n">oldWidget</span><span class="o">!</span><span class="p">.</span><span class="n">navigatorKey</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_navigator</span> <span class="o">=</span> <span class="n">widget</span><span class="p">.</span><span class="n">navigatorKey</span> <span class="o">??</span> <span class="n">GlobalObjectKey</span><span class="o">&lt;</span><span class="n">NavigatorState</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">_navigator</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// If we use a navigator, we have a navigator key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">assert</span><span class="p">(</span><span class="n">_usesNavigator</span> <span class="o">==</span> <span class="p">(</span><span class="n">_navigator</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>再看下 <em>_WidgetsAppState</em> 的 <em>build</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="kd">get</span> <span class="n">_usesRouterWithDelegates</span> <span class="o">=&gt;</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerDelegate</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="kd">get</span> <span class="n">_usesRouterWithConfig</span> <span class="o">=&gt;</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerConfig</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="kd">get</span> <span class="n">_usesNavigator</span> <span class="o">=&gt;</span> <span class="n">widget</span><span class="p">.</span><span class="n">home</span> <span class="o">!=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">    <span class="o">||</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">routes</span><span class="o">?</span><span class="p">.</span><span class="n">isNotEmpty</span> <span class="o">??</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">||</span> <span class="n">widget</span><span class="p">.</span><span class="n">onGenerateRoute</span> <span class="o">!=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">    <span class="o">||</span> <span class="n">widget</span><span class="p">.</span><span class="n">onUnknownRoute</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span><span class="o">?</span> <span class="n">routing</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_usesRouterWithDelegates</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Router方式实现路由导航（声明式）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">routing</span> <span class="o">=</span> <span class="n">Router</span><span class="o">&lt;</span><span class="kt">Object</span><span class="o">&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">restorationScopeId:</span> <span class="s1">&#39;router&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">routeInformationProvider:</span> <span class="n">_effectiveRouteInformationProvider</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">routeInformationParser:</span> <span class="n">widget</span><span class="p">.</span><span class="n">routeInformationParser</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">routerDelegate:</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerDelegate</span><span class="o">!</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">backButtonDispatcher:</span> <span class="n">_effectiveBackButtonDispatcher</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_usesNavigator</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 直接Navigator方式实现路由导航（命令式）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">assert</span><span class="p">(</span><span class="n">_navigator</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">routing</span> <span class="o">=</span> <span class="n">FocusScope</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">debugLabel:</span> <span class="s1">&#39;Navigator Scope&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">autofocus:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">Navigator</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">clipBehavior:</span> <span class="n">Clip</span><span class="p">.</span><span class="n">none</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">restorationScopeId:</span> <span class="s1">&#39;nav&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 因为我们没在MaterialApp中传入navigatorKey，所以这里使用了前面创建的默认_navigator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nl">key:</span> <span class="n">_navigator</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 引用成员变量_initialRouteName，后面讲
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nl">initialRoute:</span> <span class="n">_initialRouteName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 引用成员方法_onGenerateRoute，后面讲
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nl">onGenerateRoute:</span> <span class="n">_onGenerateRoute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// onGenerateInitialRoutes这里的判断后面再讲
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nl">onGenerateInitialRoutes:</span> <span class="n">widget</span><span class="p">.</span><span class="n">onGenerateInitialRoutes</span> <span class="o">==</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">          <span class="o">?</span> <span class="n">Navigator</span><span class="p">.</span><span class="n">defaultGenerateInitialRoutes</span>
</span></span><span class="line"><span class="cl">          <span class="o">:</span> <span class="p">(</span><span class="n">NavigatorState</span> <span class="n">navigator</span><span class="p">,</span> <span class="kt">String</span> <span class="n">initialRouteName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">widget</span><span class="p">.</span><span class="n">onGenerateInitialRoutes</span><span class="o">!</span><span class="p">(</span><span class="n">initialRouteName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 引用成员方法_onUnknownRoute，后面讲 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nl">onUnknownRoute:</span> <span class="n">_onUnknownRoute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">observers:</span> <span class="n">widget</span><span class="p">.</span><span class="n">navigatorObservers</span><span class="o">!</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">reportsRouteUpdateToEngine:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_usesRouterWithConfig</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 带config的Router方式实现路由导航（声明式）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">routing</span> <span class="o">=</span> <span class="n">Router</span><span class="o">&lt;</span><span class="kt">Object</span><span class="o">&gt;</span><span class="p">.</span><span class="n">withConfig</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">restorationScopeId:</span> <span class="s1">&#39;router&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">config:</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerConfig</span><span class="o">!</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">RootRestorationScope</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">restorationId:</span> <span class="n">widget</span><span class="p">.</span><span class="n">restorationScopeId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">child:</span> <span class="n">SharedAppData</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">Shortcuts</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">debugLabel:</span> <span class="s1">&#39;&lt;Default WidgetsApp Shortcuts&gt;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">shortcuts:</span> <span class="n">widget</span><span class="p">.</span><span class="n">shortcuts</span> <span class="o">??</span> <span class="n">WidgetsApp</span><span class="p">.</span><span class="n">defaultShortcuts</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">child:</span> <span class="n">DefaultTextEditingShortcuts</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nl">child:</span> <span class="n">Actions</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">...</span>
</span></span><span class="line"><span class="cl">            <span class="nl">child:</span> <span class="n">FocusTraversalGroup</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="nl">policy:</span> <span class="n">ReadingOrderTraversalPolicy</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">              <span class="nl">child:</span> <span class="n">TapRegionSurface</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nl">child:</span> <span class="n">ShortcutRegistrar</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                  <span class="nl">child:</span> <span class="n">Localizations</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">locale:</span> <span class="n">appLocale</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">delegates:</span> <span class="n">_localizationsDelegates</span><span class="p">.</span><span class="n">toList</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 最后将包装多层的routing，放到这里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">child:</span> <span class="n">title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="p">),</span>
</span></span><span class="line"><span class="cl">              <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面已知道 <em>_WidgetsAppState</em> 的 <em>build</em> 方法中用到了<em>Navigator</em>，而<em>Navigator</em>是一个<em>StatefulWidget</em>，看下创建的<em>NavigatorState</em>的<em>build</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// 注意：_overlayKey是延迟初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">late</span> <span class="n">GlobalKey</span><span class="o">&lt;</span><span class="n">OverlayState</span><span class="o">&gt;</span> <span class="n">_overlayKey</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">/// Navigator套了Overlay，Overlay是一个StatefulWidget，此处是Overlay的OverlayState
</span></span></span><span class="line"><span class="cl"><span class="c1">/// The overlay this navigator uses for its visual presentation.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">OverlayState</span><span class="o">?</span> <span class="kd">get</span> <span class="n">overlay</span> <span class="o">=&gt;</span> <span class="n">_overlayKey</span><span class="p">.</span><span class="n">currentState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 此处是Overlay的initialEntries，后面讲
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">OverlayEntry</span><span class="o">&gt;</span> <span class="kd">get</span> <span class="n">_allRouteOverlayEntries</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="o">&lt;</span><span class="n">OverlayEntry</span><span class="o">&gt;</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">_RouteEntry</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">_history</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span><span class="n">entry</span><span class="p">.</span><span class="n">route</span><span class="p">.</span><span class="n">overlayEntries</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">HeroControllerScope</span><span class="p">.</span><span class="n">none</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">child:</span> <span class="n">Listener</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onPointerDown:</span> <span class="n">_handlePointerDown</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onPointerUp:</span> <span class="n">_handlePointerUpOrCancel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onPointerCancel:</span> <span class="n">_handlePointerUpOrCancel</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">AbsorbPointer</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">absorbing:</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">// it&#39;s mutated directly by _cancelActivePointers above
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nl">child:</span> <span class="n">FocusTraversalGroup</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nl">policy:</span> <span class="n">FocusTraversalGroup</span><span class="p">.</span><span class="n">maybeOf</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="nl">child:</span> <span class="n">Focus</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nl">focusNode:</span> <span class="n">focusNode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nl">autofocus:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nl">skipTraversal:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nl">includeSemantics:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nl">child:</span> <span class="n">UnmanagedRestorationScope</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="nl">bucket:</span> <span class="n">bucket</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="c1">// 此处用到了Overlay，它是可以独立管理的条目堆栈
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="c1">// 通过将独立的子widgets插入到overlay的堆栈中，overlay可以让独立的子widgets将视觉元素“浮动”在其它widgets的顶部。overlay允许每个widgets使用OverlayEntry对象管理它们在overlay中的参与。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="nl">child:</span> <span class="n">Overlay</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nl">key:</span> <span class="n">_overlayKey</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nl">clipBehavior:</span> <span class="n">widget</span><span class="p">.</span><span class="n">clipBehavior</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 因为_overlayKey是late延迟加载，所以一开始overlay会为null，此处传入的是_allRouteOverlayEntries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nl">initialEntries:</span> <span class="n">overlay</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span>  <span class="n">_allRouteOverlayEntries</span><span class="p">.</span><span class="n">toList</span><span class="p">(</span><span class="nl">growable:</span> <span class="kc">false</span><span class="p">)</span> <span class="o">:</span> <span class="kd">const</span> <span class="o">&lt;</span><span class="n">OverlayEntry</span><span class="o">&gt;</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">              <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="32navigator的push方法">3.2、<em>Navigator</em>的<em>push</em>方法</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">optionalTypeArgs</span>
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">?&gt;</span> <span class="n">push</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="kt">Object</span><span class="o">?&gt;</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Route</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">route</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">Navigator</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">push</span><span class="p">(</span><span class="n">route</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>of</em>方法，它的返回是<em>NavigatorState</em>对象，然后可以通过该对象实现路由跳转，例如调用上面的<em>push</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">static</span> <span class="n">NavigatorState</span> <span class="n">of</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">BuildContext</span> <span class="n">context</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">rootNavigator</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Handles the case where the input context is a navigator element.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 处理输入上下文是navigator element的情况。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">NavigatorState</span><span class="o">?</span> <span class="n">navigator</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="k">is</span> <span class="n">StatefulElement</span> <span class="o">&amp;&amp;</span> <span class="n">context</span><span class="p">.</span><span class="n">state</span> <span class="k">is</span> <span class="n">NavigatorState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">navigator</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">state</span> <span class="o">as</span> <span class="n">NavigatorState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// rootNavigator表示是否查找根Navigator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">rootNavigator</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 向上查找根Navigator所创建的NavigatorState，如果找到就赋值给navigator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">navigator</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">findRootAncestorStateOfType</span><span class="o">&lt;</span><span class="n">NavigatorState</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">??</span> <span class="n">navigator</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 向上查找最近的一个Navigator所创建的NavigatorState，，如果找到就赋值给navigator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">navigator</span> <span class="o">=</span> <span class="n">navigator</span> <span class="o">??</span> <span class="n">context</span><span class="p">.</span><span class="n">findAncestorStateOfType</span><span class="o">&lt;</span><span class="n">NavigatorState</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果上面context中没有找到navigator，就会报错
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 这也就是前面说的如果你没有以MaterialApp作为第一个Widget，后续在使用Navigator的方法时，可能就会因为找不到Navigator而报错。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">navigator</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">throw</span> <span class="n">FlutterError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;Navigator operation requested with a context that does not include a Navigator.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;The context used to push or pop routes from the Navigator must be that of a &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;widget that is a descendant of a Navigator widget.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}());</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 最后把查找的NavigatorState返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">navigator</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>context</em>的<em>findRootAncestorStateOfType</em>方法，因为<em>context</em>是一个句柄，所以看它的实现类<em>Element</em>的<em>findRootAncestorStateOfType</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="n">T</span><span class="o">?</span> <span class="n">findRootAncestorStateOfType</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">StatefulWidget</span><span class="o">&gt;&gt;</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_debugCheckStateIsActiveForAncestorLookup</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">Element</span><span class="o">?</span> <span class="n">ancestor</span> <span class="o">=</span> <span class="n">_parent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">StatefulElement</span><span class="o">?</span> <span class="n">statefulAncestor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 从当前Element的父Element开始遍历，一直找到最远的一个StatefulElement，然后将它的State转为T
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="n">ancestor</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ancestor</span> <span class="k">is</span> <span class="n">StatefulElement</span> <span class="o">&amp;&amp;</span> <span class="n">ancestor</span><span class="p">.</span><span class="n">state</span> <span class="k">is</span> <span class="n">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">statefulAncestor</span> <span class="o">=</span> <span class="n">ancestor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ancestor</span> <span class="o">=</span> <span class="n">ancestor</span><span class="p">.</span><span class="n">_parent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">statefulAncestor</span><span class="o">?</span><span class="p">.</span><span class="n">state</span> <span class="o">as</span> <span class="n">T</span><span class="o">?</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下实现类<em>Element</em>的<em>findAncestorStateOfType</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="n">T</span><span class="o">?</span> <span class="n">findAncestorStateOfType</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">StatefulWidget</span><span class="o">&gt;&gt;</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_debugCheckStateIsActiveForAncestorLookup</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">Element</span><span class="o">?</span> <span class="n">ancestor</span> <span class="o">=</span> <span class="n">_parent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 从当前Element的父Element开始遍历，一直找到最近的一个StatefulElement，然后将它的State转为T
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="n">ancestor</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ancestor</span> <span class="k">is</span> <span class="n">StatefulElement</span> <span class="o">&amp;&amp;</span> <span class="n">ancestor</span><span class="p">.</span><span class="n">state</span> <span class="k">is</span> <span class="n">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ancestor</span> <span class="o">=</span> <span class="n">ancestor</span><span class="p">.</span><span class="n">_parent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">StatefulElement</span><span class="o">?</span> <span class="n">statefulAncestor</span> <span class="o">=</span> <span class="n">ancestor</span> <span class="o">as</span> <span class="n">StatefulElement</span><span class="o">?</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">statefulAncestor</span><span class="o">?</span><span class="p">.</span><span class="n">state</span> <span class="o">as</span> <span class="n">T</span><span class="o">?</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，<em>of</em>方法需要传入一个<em>context</em>来获取根<em>Navigator</em>或者最近一个<em>Navigator</em>所创建的<em>NavigatorState</em>。</p>
<p>但是，在某些需求（如<em>Token</em>失效跳转登录页）下，无法拿到<em>context</em>对象，但又需要跳转，那该如何处理？</p>
<p>之前讲过，<em>MaterialApp</em>可以传入一个<em>navigatorKey</em>，在不传的情况下底层也会创建一个默认的<em>navigatorKey</em>，现在的解决办法就是可以通过传入<em>navigatorKey</em>来获取根<em>Navigator</em>所创建的<em>NavigatorState</em>。</p>
<p><em>OK</em>，再来看下<em>NavigatorState</em>的<em>push</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">optionalTypeArgs</span>
</span></span><span class="line"><span class="cl"><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">?&gt;</span> <span class="n">push</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="kt">Object</span><span class="o">?&gt;</span><span class="p">(</span><span class="n">Route</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">route</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 将Route包装为_RouteEntry对象，然后交给_pushEntry方法处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 注意此时initialState为_RouteLifecycle.push，等下用到
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_pushEntry</span><span class="p">(</span><span class="n">_RouteEntry</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="nl">pageBased:</span> <span class="kc">false</span><span class="p">,</span> <span class="nl">initialState:</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">push</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 此处popped是一个Completer，其内部用到Future，等到_RouteLifecycle的状态变为complete，就会调用Route的didComplete方法，然后将结果值放入Completer中，这个后面讲。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">route</span><span class="p">.</span><span class="n">popped</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>先看下 <em>_RouteEntry</em> 的部分源码，可以发现它继承自<em>RouteTransitionRecord</em>，而<em>RouteTransitionRecord</em>是为<em>TransitionDelegate</em>暂存的<em>Route</em>包装器接口，用来决定其底层<em>Route</em>应如何在屏幕上或屏幕外转换。</p>
<p><em>RouteTransitionRecord</em>提供了几个<em>markXXX</em>抽象方法，例如<em>markForPush</em>、<em>markForAdd</em>等，用来标记<em>Route</em>，表示它会进行一些操作，子类 <em>_RouteEntry</em> 对<em>markXXX</em>方法的实现一般是修改当前所处的 <em>_RouteLifecycle</em> 状态。</p>
<p>对于 <em>_RouteEntry</em>，因为构造方法传入了<em>Route</em>，所以 <em>_RouteEntry</em> 实际上是对<em>Route</em>的方法操作与<em>Route</em>的生命周期管理，例如<em>handleAdd</em>方法等。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">_RouteEntry</span> <span class="kd">extends</span> <span class="n">RouteTransitionRecord</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_RouteEntry</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 传入Route对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="n">route</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Route生命周期的初始状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kd">required</span> <span class="n">_RouteLifecycle</span> <span class="n">initialState</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 这个和声明式的page相关，不会讲
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kd">required</span> <span class="k">this</span><span class="p">.</span><span class="n">pageBased</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 恢复信息，这里用不到这个
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">this</span><span class="p">.</span><span class="n">restorationInformation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span> <span class="o">:</span> <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">pageBased</span> <span class="o">||</span> <span class="n">route</span><span class="p">.</span><span class="n">settings</span> <span class="k">is</span> <span class="n">Page</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">         <span class="k">assert</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">           <span class="n">initialState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">staging</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">           <span class="n">initialState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">add</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">           <span class="n">initialState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">push</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">           <span class="n">initialState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">pushReplace</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">           <span class="n">initialState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">replace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="p">),</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// 将初始状态赋值给当前状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="n">currentState</span> <span class="o">=</span> <span class="n">initialState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 重写父类RouteTransitionRecord的成员变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">_RestorationInformation</span><span class="o">?</span> <span class="n">restorationInformation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">bool</span> <span class="n">pageBased</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">static</span> <span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">notAnnounced</span> <span class="o">=</span> <span class="n">_NotAnnounced</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">_RouteLifecycle</span> <span class="n">currentState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">handleAdd</span><span class="p">({</span> <span class="kd">required</span> <span class="n">NavigatorState</span> <span class="n">navigator</span><span class="p">,</span> <span class="kd">required</span> <span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;?</span> <span class="n">previousPresent</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">currentState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">add</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">navigator</span><span class="p">.</span><span class="n">_debugLocked</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">route</span><span class="p">.</span><span class="n">_navigator</span> <span class="o">==</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">route</span><span class="p">.</span><span class="n">_navigator</span> <span class="o">=</span> <span class="n">navigator</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 管理Route的操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">route</span><span class="p">.</span><span class="n">install</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">route</span><span class="p">.</span><span class="n">overlayEntries</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 管理Route的生命周期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">currentState</span> <span class="o">=</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">adding</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">navigator</span><span class="p">.</span><span class="n">_observedRouteAdditions</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">_NavigatorPushObservation</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">previousPresent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">markForPush</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">isWaitingForEnteringDecision</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isWaitingForExitingDecision</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;This route cannot be marked for push. Either a decision has already been &#39;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;made or it does not require an explicit decision on how to transition in.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 管理Route的生命周期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">currentState</span> <span class="o">=</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">push</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面涉及一个<em>Route</em>生命周期类 <em>_RouteLifecycle</em>，看下它的源码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// _RouteLifecycle 状态机（仅下降）：
</span></span></span><span class="line"><span class="cl"><span class="c1">// The _RouteLifecycle state machine (only goes down):
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//                    [creation of a _RouteEntry]
</span></span></span><span class="line"><span class="cl"><span class="c1">//                                 |
</span></span></span><span class="line"><span class="cl"><span class="c1">//                                 +
</span></span></span><span class="line"><span class="cl"><span class="c1">//                                 |\
</span></span></span><span class="line"><span class="cl"><span class="c1">//                                 | \
</span></span></span><span class="line"><span class="cl"><span class="c1">//                                 | staging
</span></span></span><span class="line"><span class="cl"><span class="c1">//                                 | /
</span></span></span><span class="line"><span class="cl"><span class="c1">//                                 |/
</span></span></span><span class="line"><span class="cl"><span class="c1">//                    +-+----------+--+-------+
</span></span></span><span class="line"><span class="cl"><span class="c1">//                   /  |             |       |
</span></span></span><span class="line"><span class="cl"><span class="c1">//                  /   |             |       |
</span></span></span><span class="line"><span class="cl"><span class="c1">//                 /    |             |       |
</span></span></span><span class="line"><span class="cl"><span class="c1">//                /     |             |       |
</span></span></span><span class="line"><span class="cl"><span class="c1">//               /      |             |       |
</span></span></span><span class="line"><span class="cl"><span class="c1">//      pushReplace   push*         add*   replace*
</span></span></span><span class="line"><span class="cl"><span class="c1">//               \       |            |       |
</span></span></span><span class="line"><span class="cl"><span class="c1">//                \      |            |      /
</span></span></span><span class="line"><span class="cl"><span class="c1">//                 +--pushing#      adding  /
</span></span></span><span class="line"><span class="cl"><span class="c1">//                          \        /     /
</span></span></span><span class="line"><span class="cl"><span class="c1">//                           \      /     /
</span></span></span><span class="line"><span class="cl"><span class="c1">//                           idle--+-----+
</span></span></span><span class="line"><span class="cl"><span class="c1">//                           /  \
</span></span></span><span class="line"><span class="cl"><span class="c1">//                          /    +------+
</span></span></span><span class="line"><span class="cl"><span class="c1">//                         /     |      |
</span></span></span><span class="line"><span class="cl"><span class="c1">//                        /      |  complete*
</span></span></span><span class="line"><span class="cl"><span class="c1">//                        |      |    /
</span></span></span><span class="line"><span class="cl"><span class="c1">//                       pop*  remove*
</span></span></span><span class="line"><span class="cl"><span class="c1">//                        /        \
</span></span></span><span class="line"><span class="cl"><span class="c1">//                       /       removing#
</span></span></span><span class="line"><span class="cl"><span class="c1">//                     popping#       |
</span></span></span><span class="line"><span class="cl"><span class="c1">//                      |             |
</span></span></span><span class="line"><span class="cl"><span class="c1">//                   [finalizeRoute]  |
</span></span></span><span class="line"><span class="cl"><span class="c1">//                              \     |
</span></span></span><span class="line"><span class="cl"><span class="c1">//                              dispose*
</span></span></span><span class="line"><span class="cl"><span class="c1">//                                 |
</span></span></span><span class="line"><span class="cl"><span class="c1">//                              disposing
</span></span></span><span class="line"><span class="cl"><span class="c1">//                                 |
</span></span></span><span class="line"><span class="cl"><span class="c1">//                              disposed
</span></span></span><span class="line"><span class="cl"><span class="c1">//                                 |
</span></span></span><span class="line"><span class="cl"><span class="c1">//                                 |
</span></span></span><span class="line"><span class="cl"><span class="c1">//                  [_RouteEntry garbage collected]
</span></span></span><span class="line"><span class="cl"><span class="c1">//                          (terminal state)
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// *号表示这些状态是暂时的；一旦 _flushHistoryUpdates 运行，路由entry就会退出该状态。
</span></span></span><span class="line"><span class="cl"><span class="c1">// * These states are transient; as soon as _flushHistoryUpdates is run the
</span></span></span><span class="line"><span class="cl"><span class="c1">//   route entry will exit that state.
</span></span></span><span class="line"><span class="cl"><span class="c1">// #号表示这些状态等待futures或其它事件，然后自动转换。
</span></span></span><span class="line"><span class="cl"><span class="c1">// # These states await futures or other events, then transition automatically.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">enum</span> <span class="n">_RouteLifecycle</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 我们将等待过渡代理决定如何处理该路由。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">staging</span><span class="p">,</span> <span class="c1">// we will wait for transition delegate to decide what to do with this route.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 存在的路由:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// routes that are present:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  
</span></span><span class="line"><span class="cl">  <span class="c1">// 我们需要运行install、didAdd等；由onGenerateInitialRoutes或初始widget.pages创建的路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">add</span><span class="p">,</span> <span class="c1">// we&#39;ll want to run install, didAdd, etc; a route created by onGenerateInitialRoutes or by the initial widget.pages
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 我们将等待来自最顶层路由的didPush完成的future
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">adding</span><span class="p">,</span> <span class="c1">// we&#39;ll waiting for the future from didPush of top-most route to complete
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 已准备好过渡的路由。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// routes that are ready for transition.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 我们需要运行install、didPush等；通过push()和friends添加的路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">push</span><span class="p">,</span> <span class="c1">// we&#39;ll want to run install, didPush, etc; a route added via push() and friends
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 我们需要运行install、didPush等；通过pushReplace()和friends添加的路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pushReplace</span><span class="p">,</span> <span class="c1">// we&#39;ll want to run install, didPush, etc; a route added via pushReplace() and friends
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 我们正在等待来自didPush完成的future
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pushing</span><span class="p">,</span> <span class="c1">// we&#39;re waiting for the future from didPush to complete
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 我们需要运行install、didReplace等；通过replace()和friends添加的路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">replace</span><span class="p">,</span> <span class="c1">// we&#39;ll want to run install, didReplace, etc; a route added via replace() and friends
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 路由是无害的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">idle</span><span class="p">,</span> <span class="c1">// route is being harmless
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 不存在的路由：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// routes that are not present:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 应包含在路由公告中并且仍应侦听转换更改的路由。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// routes that should be included in route announcement and should still listen to transition changes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 我们要调用didPop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pop</span><span class="p">,</span> <span class="c1">// we&#39;ll want to call didPop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 我们要调用didComplete
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">complete</span><span class="p">,</span> <span class="c1">// we&#39;ll want to call didComplete,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 我们要运行didReplace/didRemove等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">remove</span><span class="p">,</span> <span class="c1">// we&#39;ll want to run didReplace/didRemove etc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 路由不应包含在路由公告中，但仍应监听转换更改。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// routes should not be included in route announcement but should still listen to transition changes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 我们正在等待路由调用finalizeRoute来切换到dispose
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">popping</span><span class="p">,</span> <span class="c1">// we&#39;re waiting for the route to call finalizeRoute to switch to dispose
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 我们正在等待后续路由完成动画，然后将切换到dispose
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">removing</span><span class="p">,</span> <span class="c1">// we are waiting for subsequent routes to be done animating, then will switch to dispose
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 从navigator和overlay中完全删除的路由。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// routes that are completely removed from the navigator and overlay.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 我们将立即dispose路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">dispose</span><span class="p">,</span> <span class="c1">// we will dispose the route momentarily
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 该entry正在等待其widget子树首先被dispose。在等待时，它存储在 _entryWaitingForSubTreeDisposal中。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">disposing</span><span class="p">,</span> <span class="c1">// The entry is waiting for its widget subtree to be disposed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>             <span class="c1">// first. It is stored in _entryWaitingForSubTreeDisposal while
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>             <span class="c1">// awaiting that.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 我们已经dispose了路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">disposed</span><span class="p">,</span> <span class="c1">// we have disposed the route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>OK</em>，关于 <em>_RouteEntry</em> 和 <em>_RouteLifecycle</em> 的表达&amp;功能，现已大致了解清楚，继续看<em>NavigatorState</em>的 <em>_pushEntry</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span> <span class="n">_history</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_pushEntry</span><span class="p">(</span><span class="n">_RouteEntry</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">_debugLocked</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_debugLocked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}());</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">route</span><span class="p">.</span><span class="n">_navigator</span> <span class="o">==</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">currentState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">push</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 将_RouteEntry存入_history这个List中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_history</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行_flushHistoryUpdates方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_flushHistoryUpdates</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_debugLocked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}());</span>
</span></span><span class="line"><span class="cl">  <span class="n">_afterNavigation</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">route</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <em>_pushEntry</em> 方法中，执行了 <em>_flushHistoryUpdates</em> 方法，此时<em>currentState</em>为 <em>_RouteLifecycle.push</em>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_flushHistoryUpdates</span><span class="p">({</span><span class="kt">bool</span> <span class="n">rearrangeOverlay</span> <span class="o">=</span> <span class="kc">true</span><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_debugLocked</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_debugUpdatingPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_flushingHistory</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// _history中最后一个索引位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">_history</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 下一个_RouteEntry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_RouteEntry</span><span class="o">?</span> <span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// _history中最后一个索引位置的_RouteEntry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_RouteEntry</span><span class="o">?</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">_history</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 前一个_RouteEntry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_RouteEntry</span><span class="o">?</span> <span class="n">previous</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="o">?</span> <span class="n">_history</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="m">1</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 顶部是否有完全不透明的路由以静默删除或添加下面的路由。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">bool</span> <span class="n">canRemoveOrAdd</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// Whether there is a fully opaque route on top to silently remove or add route underneath.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 应在顶部活动路由上触发didPopNext的路由。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;?</span> <span class="n">poppedRoute</span><span class="p">;</span> <span class="c1">// The route that should trigger didPopNext on the top active route.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 我们是否已经看到将获得didPopNext的路由。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">bool</span> <span class="n">seenTopActiveRoute</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// Whether we&#39;ve seen the route that would get didPopNext.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span> <span class="n">toBeDisposed</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// while循环倒序遍历
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">entry</span><span class="o">!</span><span class="p">.</span><span class="n">currentState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="p">...</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="nl">push:</span>  <span class="c1">// 此时currentState为_RouteLifecycle.push，所以执行这里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">case</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="nl">pushReplace:</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="nl">replace:</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span><span class="p">(</span><span class="n">rearrangeOverlay</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 执行_RouteEntry的handlePush方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">entry</span><span class="p">.</span><span class="n">handlePush</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nl">navigator:</span> <span class="k">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nl">previous:</span> <span class="n">previous</span><span class="o">?</span><span class="p">.</span><span class="n">route</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nl">previousPresent:</span> <span class="n">_getRouteBefore</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="m">1</span><span class="p">,</span> <span class="n">_RouteEntry</span><span class="p">.</span><span class="n">isPresentPredicate</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="n">route</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nl">isNewFirst:</span> <span class="n">next</span> <span class="o">==</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">currentState</span> <span class="o">!=</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">push</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">currentState</span> <span class="o">!=</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">pushReplace</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">currentState</span> <span class="o">!=</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">replace</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">currentState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">idle</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 更新循环条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">index</span> <span class="o">-=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">next</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span> <span class="o">=</span> <span class="n">previous</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">previous</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="o">?</span> <span class="n">_history</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="m">1</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 重点：因为_flushHistoryUpdates方法没有传入rearrangeOverlay，所以rearrangeOverlay默认为true，此时会执行OverlayState的rearrange方法。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 有两个情况：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 1、如果是根布局home，因为一开始OverlayKey是延迟加载，所以这里overlay为null，不会执行rearrange方法，后面讲。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 2、如果是跳转新页面，这里的overlay已经有值了，所以会执行rearrange方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">rearrangeOverlay</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">overlay</span><span class="o">?</span><span class="p">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">_allRouteOverlayEntries</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">_flushingHistory</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>while</em>循环中，此时<em>currentState</em>为 <em>_RouteLifecycle.push</em> ，所以会执行 <em>_RouteEntry</em> 的 <em>handlePush</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">handlePush</span><span class="p">({</span> <span class="kd">required</span> <span class="n">NavigatorState</span> <span class="n">navigator</span><span class="p">,</span> <span class="kd">required</span> <span class="kt">bool</span> <span class="n">isNewFirst</span><span class="p">,</span> <span class="kd">required</span> <span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;?</span> <span class="n">previous</span><span class="p">,</span> <span class="kd">required</span> <span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;?</span> <span class="n">previousPresent</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 将currentState赋值给前一个状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">_RouteLifecycle</span> <span class="n">previousState</span> <span class="o">=</span> <span class="n">currentState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Route持有navigator引用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">route</span><span class="p">.</span><span class="n">_navigator</span> <span class="o">=</span> <span class="n">navigator</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行Route的install方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">route</span><span class="p">.</span><span class="n">install</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">route</span><span class="p">.</span><span class="n">overlayEntries</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">currentState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">push</span> <span class="o">||</span> <span class="n">currentState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">pushReplace</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行Route的didPush方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="n">TickerFuture</span> <span class="n">routeFuture</span> <span class="o">=</span> <span class="n">route</span><span class="p">.</span><span class="n">didPush</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 将currentState修改为_RouteLifecycle.pushing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">currentState</span> <span class="o">=</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">pushing</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">routeFuture</span><span class="p">.</span><span class="n">whenCompleteOrCancel</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">currentState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">pushing</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 等到didPush方法处理完成（这里是等待页面跳转动画完成），将currentState修改为_RouteLifecycle.idle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">currentState</span> <span class="o">=</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">idle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">navigator</span><span class="p">.</span><span class="n">_debugLocked</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span> <span class="n">navigator</span><span class="p">.</span><span class="n">_debugLocked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 再次调用_flushHistoryUpdates方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">navigator</span><span class="p">.</span><span class="n">_flushHistoryUpdates</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span> <span class="n">navigator</span><span class="p">.</span><span class="n">_debugLocked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}());</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">currentState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">replace</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">route</span><span class="p">.</span><span class="n">didReplace</span><span class="p">(</span><span class="n">previous</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">currentState</span> <span class="o">=</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">idle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// isNewFirst传入的next == null，那么倒序遍历第一个_RouteEntry时next肯定为null，所以这里为true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">isNewFirst</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行Route的didChangeNext方法，该方法和动画操作相关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">route</span><span class="p">.</span><span class="n">didChangeNext</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">previousState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">replace</span> <span class="o">||</span> <span class="n">previousState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">pushReplace</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">navigator</span><span class="p">.</span><span class="n">_observedRouteAdditions</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">_NavigatorReplaceObservation</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">previousPresent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">previousState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">push</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// previousState当前为_RouteLifecycle.push，所以创建一个_NavigatorPushObservation对象添加进_observedRouteAdditions，采用观察者模式，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 后续通知去执行Route的一些操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">navigator</span><span class="p">.</span><span class="n">_observedRouteAdditions</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">_NavigatorPushObservation</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">previousPresent</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <em>_RouteEntry</em> 的<em>handlePush</em>方法中，执行了<em>Route</em>的<em>install</em>方法，但是<em>install</em>是个抽象方法，需要<em>Route</em>的子类来实现。</p>
<p>一般情况下，当调用<em>Navigator</em>的<em>push</em>方法时，传入的<em>Route</em>为<em>MaterialPageRoute</em>，它的继承关系如下。</p>
<img title="" src="/img/flutter/解读Flutter源码之Navigator（命令式）/MaterialPageRoute继承关系.png" alt="" width="335">
<p>在上面的继承关系中，<em>MaterialPageRoute</em>与<em>PageRoute</em>均没有实现<em>install</em>方法，所以看下
<em>ModalRoute</em>的<em>install</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">install</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行父类的install方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">super</span><span class="p">.</span><span class="n">install</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">_animationProxy</span> <span class="o">=</span> <span class="n">ProxyAnimation</span><span class="p">(</span><span class="k">super</span><span class="p">.</span><span class="n">animation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_secondaryAnimationProxy</span> <span class="o">=</span> <span class="n">ProxyAnimation</span><span class="p">(</span><span class="k">super</span><span class="p">.</span><span class="n">secondaryAnimation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，这里只是<em>ProxyAnimation</em>动画初始化，看下父类<em>TransitionRoute</em>的<em>install</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">install</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行父类的install方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">super</span><span class="p">.</span><span class="n">install</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_animation</span><span class="o">!</span><span class="p">.</span><span class="n">isCompleted</span> <span class="o">&amp;&amp;</span> <span class="n">overlayEntries</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">overlayEntries</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">opaque</span> <span class="o">=</span> <span class="n">opaque</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>继续看下父类<em>OverlayRoute</em>的<em>install</em>方法，<em>OverlayRoute</em>是在<em>Navigator</em>的<em>Overlay</em>中显示<em>Widgets</em>的路由。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">/// 子类应该重写此getter以返回overlay的构建器
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Subclasses should override this getter to return the builders for the overlay.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">@</span><span class="kd">factory</span>
</span></span><span class="line"><span class="cl"><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">OverlayEntry</span><span class="o">&gt;</span> <span class="n">createOverlayEntries</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="n">List</span><span class="o">&lt;</span><span class="n">OverlayEntry</span><span class="o">&gt;</span> <span class="kd">get</span> <span class="n">overlayEntries</span> <span class="o">=&gt;</span> <span class="n">_overlayEntries</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">OverlayEntry</span><span class="o">&gt;</span> <span class="n">_overlayEntries</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">OverlayEntry</span><span class="o">&gt;</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">install</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_overlayEntries</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 通过createOverlayEntries方法创建OverlayEntry放入_overlayEntries，以待后续使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_overlayEntries</span><span class="p">.</span><span class="n">addAll</span><span class="p">(</span><span class="n">createOverlayEntries</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="k">super</span><span class="p">.</span><span class="n">install</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中，<em>createOverlayEntries</em>方法由子类<em>ModalRoute</em>实现，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// one of the builders
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">late</span> <span class="n">OverlayEntry</span> <span class="n">_modalBarrier</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Widget</span> <span class="n">_buildModalBarrier</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">barrier</span> <span class="o">=</span> <span class="n">buildModalBarrier</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">barrier</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">/// 为此[ModalRoute]构建障碍，子类可以重写此方法以使用自定义功能（例如颜色或辅助功能焦点大小）创建自己的障碍。
</span></span></span><span class="line"><span class="cl"><span class="c1">/// Build the barrier for this [ModalRoute], subclasses can override
</span></span></span><span class="line"><span class="cl"><span class="c1">/// this method to create their own barrier with customized features such as
</span></span></span><span class="line"><span class="cl"><span class="c1">/// color or accessibility focus size.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Widget</span> <span class="n">buildModalBarrier</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">barrier</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">barrierColor</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">barrierColor</span><span class="o">!</span><span class="p">.</span><span class="n">alpha</span> <span class="o">!=</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">offstage</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">barrier</span> <span class="o">=</span> <span class="n">ModalBarrier</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">dismissible:</span> <span class="n">barrierDismissible</span><span class="p">,</span> <span class="c1">// changedInternalState is called if barrierDismissible updates
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nl">semanticsLabel:</span> <span class="n">barrierLabel</span><span class="p">,</span> <span class="c1">// changedInternalState is called if barrierLabel updates
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nl">barrierSemanticsDismissible:</span> <span class="n">semanticsDismissible</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">barrier</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 我们缓存模态范围中不随帧变化的部分，以便最大限度地减少发生的构建量。
</span></span></span><span class="line"><span class="cl"><span class="c1">// We cache the part of the modal scope that doesn&#39;t change from frame to
</span></span></span><span class="line"><span class="cl"><span class="c1">// frame so that we minimize the amount of building that happens.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Widget</span><span class="o">?</span> <span class="n">_modalScopeCache</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// one of the builders
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Widget</span> <span class="n">_buildModalScope</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// To be sorted before the _modalBarrier.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">_modalScopeCache</span> <span class="o">??=</span> <span class="n">Semantics</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">sortKey:</span> <span class="kd">const</span> <span class="n">OrdinalSortKey</span><span class="p">(</span><span class="m">0.0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="nl">child:</span> <span class="n">_ModalScope</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">key:</span> <span class="n">_scopeKey</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 此处this指MaterialPageRoute
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nl">route:</span> <span class="k">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// _ModalScope calls buildTransitions() and buildChild(), defined above
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">late</span> <span class="n">OverlayEntry</span> <span class="n">_modalScope</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">OverlayEntry</span><span class="o">&gt;</span> <span class="n">createOverlayEntries</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="o">&lt;</span><span class="n">OverlayEntry</span><span class="o">&gt;</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建了一个Barrier所对应的OverlayEntry（屏障）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_modalBarrier</span> <span class="o">=</span> <span class="n">OverlayEntry</span><span class="p">(</span><span class="nl">builder:</span> <span class="n">_buildModalBarrier</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建了一个跳转新页面所对应的OverlayEntry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_modalScope</span> <span class="o">=</span> <span class="n">OverlayEntry</span><span class="p">(</span><span class="nl">builder:</span> <span class="n">_buildModalScope</span><span class="p">,</span> <span class="nl">maintainState:</span> <span class="n">maintainState</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面通过<em>createOverlayEntries</em>方法已创建了两个<em>OverlayEntry</em>，然后添加给 <em>_overlayEntries</em>，它的结构是这样的。</p>
<img title="" src="/img/flutter/解读Flutter源码之Navigator（命令式）/createOverlayEntries结构.png" alt="" width="335">
<p>那么，<em>OverlayRoute</em>中的<em>overlayEntries</em>是在哪里被用到呢？它是在<em>NavigatorState</em>的成员变量 <em>_allRouteOverlayEntries</em> 中被用到。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// install方法后，此时_allRouteOverlayEntries的元素为[根布局屏障、根布局页面，新布局屏障、新布局页面]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">OverlayEntry</span><span class="o">&gt;</span> <span class="kd">get</span> <span class="n">_allRouteOverlayEntries</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="o">&lt;</span><span class="n">OverlayEntry</span><span class="o">&gt;</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 遍历了_history中所有的_RouteEntry，每个_RouteEntry都包装了一个Route，每个Route都有一层Barrier和一层跳转新页面
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">_RouteEntry</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">_history</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span><span class="n">entry</span><span class="p">.</span><span class="n">route</span><span class="p">.</span><span class="n">overlayEntries</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>而成员变量 <em>_allRouteOverlayEntries</em> 会在两个地方被用到。</p>
<p>1、<em>NavigatorState</em>的<em>build</em>方法，作为<em>Overlay</em>的<em>initialEntries</em>传入，这个前面讲过了，因为 <em>_overlayKey</em> 是<em>late</em>延迟加载，所以一开始<em>overlay</em>会为<em>null</em>，传入的就是 <em>_allRouteOverlayEntries</em>，它所包含的是一层<em>Barrier</em>和一层根布局<em>home</em>页面，根布局<em>home</em>的初始化后面讲。</p>
<p>2、在 <em>_flushHistoryUpdates</em> 方法中执行，因为当执行完<em>handlePush</em>方法后，就会接着执行<em>overlay</em>的<em>rearrange</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">rearrangeOverlay</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">overlay</span><span class="o">?</span><span class="p">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">_allRouteOverlayEntries</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>overlay</em>的<em>rearrange</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">rearrange</span><span class="p">(</span><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">OverlayEntry</span><span class="o">&gt;</span> <span class="n">newEntries</span><span class="p">,</span> <span class="p">{</span> <span class="n">OverlayEntry</span><span class="o">?</span> <span class="n">below</span><span class="p">,</span> <span class="n">OverlayEntry</span><span class="o">?</span> <span class="n">above</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 取出newEntries（也就是传入的_allRouteOverlayEntries），赋值给newEntriesList
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// growable为false，表示列表是固定长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">OverlayEntry</span><span class="o">&gt;</span> <span class="n">newEntriesList</span> <span class="o">=</span> <span class="n">newEntries</span> <span class="k">is</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">OverlayEntry</span><span class="o">&gt;</span> <span class="o">?</span> <span class="n">newEntries</span> <span class="o">:</span> <span class="n">newEntries</span><span class="p">.</span><span class="n">toList</span><span class="p">(</span><span class="nl">growable:</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 此时newEntriesList不为null，因为已经包含了根布局的两层OverlayEntry以及新页面的两层OverlayEntry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">newEntriesList</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 判断OverlayState中的_entries是否与newEntriesList相同，此处肯定不相同，因为跳转了新页面，多出两层OverlayEntry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 但是要注意：因为handlePush方法中还会执行_flushHistoryUpdates方法，造成第二次执行rearrange，此时两个List已经相等，所以此处会被拦截
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">listEquals</span><span class="p">(</span><span class="n">_entries</span><span class="p">,</span> <span class="n">newEntriesList</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 将旧的OverlayEntry列表包装为LinkedHashSet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">LinkedHashSet</span><span class="o">&lt;</span><span class="n">OverlayEntry</span><span class="o">&gt;</span> <span class="n">old</span> <span class="o">=</span> <span class="n">LinkedHashSet</span><span class="o">&lt;</span><span class="n">OverlayEntry</span><span class="o">&gt;</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">_entries</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 让newEntriesList中所有的OverlayEntry持有OverlayState引用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">OverlayEntry</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">newEntriesList</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span><span class="p">.</span><span class="n">_overlay</span> <span class="o">??=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 刷新Overlay页面UI，触发OverlayState的build方法执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 更新OverlayState中的_entries为newEntriesList
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_entries</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_entries</span><span class="p">.</span><span class="n">addAll</span><span class="p">(</span><span class="n">newEntriesList</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 移除与newEntriesList相交部分（根布局两层OverlayEntry），那么此时old为空了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">old</span><span class="p">.</span><span class="n">removeAll</span><span class="p">(</span><span class="n">newEntriesList</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 此处below为null，above为null，所以_insertionIndex的值为_entries的长度，也就是此时newEntriesList的长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 然后重新把旧_entries在新_entries末尾插入，old为空了相当于插入了个寂寞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_entries</span><span class="p">.</span><span class="n">insertAll</span><span class="p">(</span><span class="n">_insertionIndex</span><span class="p">(</span><span class="n">below</span><span class="p">,</span> <span class="n">above</span><span class="p">),</span> <span class="n">old</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>OK</em>，总结下<em>OverlayState</em>的<em>build</em>方法两次执行过程。</p>
<p>1、我们知道，跳转新页面会伴随着动画，这个动画控制类在<em>TransitionRoute</em>的<em>install</em>方法中初始化。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">install</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 添加动画状态监听_handleStatusChanged
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_animation</span> <span class="o">=</span> <span class="n">createAnimation</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">..</span><span class="n">addStatusListener</span><span class="p">(</span><span class="n">_handleStatusChanged</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_animation</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">$</span><span class="n">runtimeType</span><span class="s1">.createAnimation() returned null.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">super</span><span class="p">.</span><span class="n">install</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_animation</span><span class="o">!</span><span class="p">.</span><span class="n">isCompleted</span> <span class="o">&amp;&amp;</span> <span class="n">overlayEntries</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">overlayEntries</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">opaque</span> <span class="o">=</span> <span class="n">opaque</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，在<em>TransitionRoute</em>的<em>install</em>方法中添加了动画状态监听，看下 <em>_handleStatusChanged</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_handleStatusChanged</span><span class="p">(</span><span class="n">AnimationStatus</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">AnimationStatus</span><span class="p">.</span><span class="nl">completed:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 动画完成
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">overlayEntries</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">overlayEntries</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">opaque</span> <span class="o">=</span> <span class="n">opaque</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">_performanceModeRequestHandle</span><span class="o">?</span><span class="p">.</span><span class="n">dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">_performanceModeRequestHandle</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">AnimationStatus</span><span class="p">.</span><span class="nl">forward:</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">AnimationStatus</span><span class="p">.</span><span class="nl">reverse:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 动画正向/反向执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">overlayEntries</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">overlayEntries</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">opaque</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">_performanceModeRequestHandle</span> <span class="o">??=</span>
</span></span><span class="line"><span class="cl">        <span class="n">SchedulerBinding</span><span class="p">.</span><span class="n">instance</span>
</span></span><span class="line"><span class="cl">          <span class="p">.</span><span class="n">requestPerformanceMode</span><span class="p">(</span><span class="n">ui</span><span class="p">.</span><span class="n">DartPerformanceMode</span><span class="p">.</span><span class="n">latency</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">AnimationStatus</span><span class="p">.</span><span class="nl">dismissed:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 动画未开始
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// We might still be an active route if a subclass is controlling the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// transition and hits the dismissed status. For example, the iOS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// back gesture drives this animation to the dismissed status before
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// removing the route and disposing it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isActive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">navigator</span><span class="o">!</span><span class="p">.</span><span class="n">finalizeRoute</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_popFinalized</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_performanceModeRequestHandle</span><span class="o">?</span><span class="p">.</span><span class="n">dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_performanceModeRequestHandle</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>当 <em>_RouteEntry</em> 的<em>handlePush</em>方法执行时，会执行<em>route.didPush()</em>，看下<em>Route</em>子类<em>TransitionRoute</em>的<em>didPush</em>方法，可以看到，动画开始正向执行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="n">TickerFuture</span> <span class="n">didPush</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_controller</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">$</span><span class="n">runtimeType</span><span class="s1">.didPush called before calling install() or after calling dispose().&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">_transitionCompleter</span><span class="p">.</span><span class="n">isCompleted</span><span class="p">,</span> <span class="s1">&#39;Cannot reuse a </span><span class="si">$</span><span class="n">runtimeType</span><span class="s1"> after disposing it.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">super</span><span class="p">.</span><span class="n">didPush</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 动画开始正向执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">_controller</span><span class="o">!</span><span class="p">.</span><span class="n">forward</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>那么，<em>_handleStatusChanged</em> 方法就会被回调，一开始动画状态为<em>AnimationStatus.forward</em>时，会设置<em>overlayEntries.first.opaque = false</em>。此处<em>overlayEntries</em>正是<em>createOverlayEntries</em>方法创建，前面讲过有两层，一层是新布局屏障，一层是新布局页面，那么这里就是将新布局屏障<em>OverlayEntry</em>的<em>opaque</em>设置为<em>false</em>。</p>
<p>看下<em>OverlayEntry</em>的成员变量<em>opaque</em>，在<em>OverlayEntry</em>的构造方法中，如果不设置<em>opaque</em>，它默认为<em>false</em>。</p>
<p>之前讲<em>ModalRoute</em>的<em>createOverlayEntries</em>方法时，它内部创建了两个<em>OverlayEntry</em>，可以发现它们都没设置<em>opaque</em>，也就是<em>opaque</em>默认为<em>false</em>。</p>
<p>因而 <em>_opaque</em> 相同值会被拦截，不会执行下面的 <em>_didChangeEntryOpacity</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">OverlayEntry</span> <span class="kd">implements</span> <span class="n">Listenable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">OverlayEntry</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="kd">required</span> <span class="k">this</span><span class="p">.</span><span class="n">builder</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// opaque默认为false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">opaque</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">maintainState</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span> <span class="o">:</span> <span class="n">_opaque</span> <span class="o">=</span> <span class="n">opaque</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="n">_maintainState</span> <span class="o">=</span> <span class="n">maintainState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="kd">get</span> <span class="n">opaque</span> <span class="o">=&gt;</span> <span class="n">_opaque</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">_opaque</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">set</span> <span class="n">opaque</span><span class="p">(</span><span class="kt">bool</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">_disposedByOwner</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _opaque相同值会被拦截
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_opaque</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">_opaque</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _didChangeEntryOpacity方法中会执行setState方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_overlay</span><span class="o">?</span><span class="p">.</span><span class="n">_didChangeEntryOpacity</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>2、当<em>handlePush</em>方法执行完后，就会执行到<em>overlay</em>的<em>rearrange</em>方法，此时会触发<em>setState</em>方法，然后第一次执行<em>build</em>方法。在<em>build</em>方法中会倒序遍历 <em>_entries</em>，新布局页面<em>OverlayEntry</em>是第一个被遍历到，根布局屏障<em>OverlayEntry</em>是最后一个被遍历到，那么<em>children</em>的最后一个是根布局屏障<em>OverlayEntry</em>。</p>
<p>之前讲了，新布局屏障<em>OverlayEntry</em>的<em>opaque</em>设置为<em>false</em>，所以当倒序遍历 <em>_entries</em> 时，遇到<em>opaque</em>为<em>false</em>时，<em>onstage</em>不会被修改为<em>false</em>，因此走的都是 <em>if (onstage)</em> 逻辑。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 该列表在添加到树之前先向后填充，然后在下面反转。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// This list is filled backwards and then reversed below before
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// it is added to the tree.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">_OverlayEntryWidget</span><span class="o">&gt;</span> <span class="n">children</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">_OverlayEntryWidget</span><span class="o">&gt;</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// onstage表示是否在舞台上，也就是我们自己的页面
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">bool</span> <span class="n">onstage</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">onstageCount</span> <span class="o">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 倒序遍历_entries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 注意：只有onstage或maintainState的情况，Route在内存中才会被保留下来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">OverlayEntry</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">_entries</span><span class="p">.</span><span class="n">reversed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">onstage</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">onstageCount</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">children</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">_OverlayEntryWidget</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">key:</span> <span class="n">entry</span><span class="p">.</span><span class="n">_key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">overlayState:</span> <span class="k">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">entry:</span> <span class="n">entry</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// opaque表示该OverlayEntry是否遮挡整个Overlay
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// 如果某个OverlayEntry声称是不透明的，那么为了提高效率，覆盖层将跳过该OverlayEntry下方的构建OverlayEntry，除非它们设置了maintainState 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// 当一条不透明Route的入口过渡完成后，该不透明Route后面的Route将不再被构建，以节省资源。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">opaque</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">onstage</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">maintainState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// maintainState表示Route处于非活动状态时是否应保留在内存中。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// 如果MaterialPageRoute设置了maintainState为true，那么该Route将被维护，以便在下一个Route弹出时，它持有的下一个Route的任何future都将正确解析。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// 如果没有必要，可以将其设置为false，以允许框架在Route的widget层次结构不可见时完全丢弃它，当下次返回到上一个页面时会重新创建，也就是build方法会被触发。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">children</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">_OverlayEntryWidget</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">key:</span> <span class="n">entry</span><span class="p">.</span><span class="n">_key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">overlayState:</span> <span class="k">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">entry:</span> <span class="n">entry</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">tickerEnabled:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 到这里第一次build方法时，children变为[新页面（有屏障），根布局（有屏障）]，但是第二次build方法时，children变为[新页面（有屏障），根布局（无屏障）]，根布局屏障因为maintainState为false，所以被干掉了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// _Theater是Stack的特殊版本，不会布局和渲染第一个skipCount children。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 第一个skipCount children被认为是“offstage（不在舞台，即幕后）”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">_Theater</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">skipCount:</span> <span class="n">children</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">onstageCount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">clipBehavior:</span> <span class="n">widget</span><span class="p">.</span><span class="n">clipBehavior</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 再次反转List，传入的children变为[根布局(无屏障)，新页面（有屏障）]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">children:</span> <span class="n">children</span><span class="p">.</span><span class="n">reversed</span><span class="p">.</span><span class="n">toList</span><span class="p">(</span><span class="nl">growable:</span> <span class="kc">false</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>3、等到动画状态变为<em>AnimationStatus.completed</em>时，会设置<em>overlayEntries.first.opaque = opaque</em>，将<em>TransitionRoute</em>的成员变量<em>opaque</em>赋值给新布局屏障<em>OverlayEntry</em>的<em>opaque</em>，因为子类<em>PageRoute</em>重写了<em>opaque</em>并赋值为<em>true</em>，那么，新布局屏障<em>OverlayEntry</em>的<em>opaque</em>为<em>true</em>。</p>
<p>此时 <em>_opaque</em> 的值不相同，就会执行 <em>_overlay?._didChangeEntryOpacity()</em>，再次触发<em>OverlayState</em>的<em>setState</em>方法，接着<em>build</em>方法执行。</p>
<p>4、此时<em>build</em>方法执行，因为新布局屏障<em>OverlayEntry</em>的<em>opaque</em>为<em>true</em>，当倒序遍历 <em>_entries</em> 时，遇到第一个<em>opaque</em>为<em>true</em>时，<em>onstage</em>会被修改为<em>false</em>，因此后续不再走 <em>if (onstage)</em> 逻辑，而是走 <em>else if (entry.maintainState)</em> 逻辑，根布局屏障因为<em>maintainState</em>为<em>false</em>，所以被干掉了。</p>
<p>此时整个页面的情况如下。</p>
<img title="" src="/img/flutter/解读Flutter源码之Navigator（命令式）/push后的路由栈.png" alt="" width="535">
<h2 id="33navigator的pop方法">3.3、<em>Navigator</em>的<em>pop</em>方法</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">optionalTypeArgs</span>
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="n">pop</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="kt">Object</span><span class="o">?&gt;</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">,</span> <span class="p">[</span> <span class="n">T</span><span class="o">?</span> <span class="n">result</span> <span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Navigator</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">pop</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>Navigator</em>的<em>of</em>方法前面讲过了，看下<em>NavigatorState</em>的<em>pop</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">optionalTypeArgs</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">pop</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="kt">Object</span><span class="o">?&gt;</span><span class="p">([</span> <span class="n">T</span><span class="o">?</span> <span class="n">result</span> <span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 获取_history中满足isPresentPredicate条件的最后一个元素（此处条件为present，也就是Route是存在的）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">_RouteEntry</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">_history</span><span class="p">.</span><span class="n">lastWhere</span><span class="p">(</span><span class="n">_RouteEntry</span><span class="p">.</span><span class="n">isPresentPredicate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// pageBased之前说过，和声明式相关，这里不会讲
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">pageBased</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 所以执行这里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">entry</span><span class="p">.</span><span class="n">pop</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">currentState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">pop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 此时currentState为_RouteLifecycle.pop，所以执行_flushHistoryUpdates，注意rearrangeOverlay为false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">currentState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">pop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_flushHistoryUpdates</span><span class="p">(</span><span class="nl">rearrangeOverlay:</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下 <em>_RouteEntry</em> 的<em>pop</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">Object</span><span class="o">?</span> <span class="n">pendingResult</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">pop</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">T</span><span class="o">?</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">isPresent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 将result保存为成员变量pendingResult，以备后续使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pendingResult</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 修改currentState为_RouteLifecycle.pop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">currentState</span> <span class="o">=</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">pop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>再看下<em>NavigatorState</em>的 <em>_flushHistoryUpdates</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_flushHistoryUpdates</span><span class="p">({</span><span class="kt">bool</span> <span class="n">rearrangeOverlay</span> <span class="o">=</span> <span class="kc">true</span><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_debugLocked</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_debugUpdatingPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_flushingHistory</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">_history</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_RouteEntry</span><span class="o">?</span> <span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_RouteEntry</span><span class="o">?</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">_history</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">_RouteEntry</span><span class="o">?</span> <span class="n">previous</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="o">?</span> <span class="n">_history</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="m">1</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">canRemoveOrAdd</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// Whether there is a fully opaque route on top to silently remove or add route underneath.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;?</span> <span class="n">poppedRoute</span><span class="p">;</span> <span class="c1">// The route that should trigger didPopNext on the top active route.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">bool</span> <span class="n">seenTopActiveRoute</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// Whether we&#39;ve seen the route that would get didPopNext.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span> <span class="n">toBeDisposed</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">entry</span><span class="o">!</span><span class="p">.</span><span class="n">currentState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="p">...</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="nl">pop:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 执行了_RouteEntry的handlePop方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">.</span><span class="n">handlePop</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="nl">navigator:</span> <span class="k">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nl">previousPresent:</span> <span class="n">_getRouteBefore</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">_RouteEntry</span><span class="p">.</span><span class="n">willBePresentPredicate</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="n">route</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">          <span class="k">assert</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">currentState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">idle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">seenTopActiveRoute</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">poppedRoute</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">entry</span><span class="p">.</span><span class="n">handleDidPopNext</span><span class="p">(</span><span class="n">poppedRoute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="n">poppedRoute</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">_observedRouteDeletions</span><span class="p">.</span><span class="n">add</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">_NavigatorPopObservation</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">route</span><span class="p">,</span> <span class="n">_getRouteBefore</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">_RouteEntry</span><span class="p">.</span><span class="n">willBePresentPredicate</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="n">route</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">currentState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">dispose</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// The pop finished synchronously. This can happen if transition
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="c1">// duration is zero.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">currentState</span> <span class="o">==</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">popping</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">canRemoveOrAdd</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">index</span> <span class="o">-=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">next</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span> <span class="o">=</span> <span class="n">previous</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">previous</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="o">?</span> <span class="n">_history</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="m">1</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 因为传入的rearrangeOverlay为false，所以这里不会执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">rearrangeOverlay</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">overlay</span><span class="o">?</span><span class="p">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">_allRouteOverlayEntries</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下 <em>_RouteEntry</em>的<em>handlePop</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">handlePop</span><span class="p">({</span> <span class="kd">required</span> <span class="n">NavigatorState</span> <span class="n">navigator</span><span class="p">,</span> <span class="kd">required</span> <span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;?</span> <span class="n">previousPresent</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">navigator</span><span class="p">.</span><span class="n">_debugLocked</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">route</span><span class="p">.</span><span class="n">_navigator</span> <span class="o">==</span> <span class="n">navigator</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">currentState</span> <span class="o">=</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">popping</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 此时状态不是isCompleted，这里不会执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">route</span><span class="p">.</span><span class="n">_popCompleter</span><span class="p">.</span><span class="n">isCompleted</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// This is a page-based route popped through the Navigator.pop. The
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// didPop should have been called. No further action is needed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">assert</span><span class="p">(</span><span class="n">pageBased</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">pendingResult</span> <span class="o">==</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行Route的didPop方法，返回true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">route</span><span class="p">.</span><span class="n">didPop</span><span class="p">(</span><span class="n">pendingResult</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">currentState</span> <span class="o">=</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">idle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 将pendingResult置空，释放资源
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pendingResult</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 最后返回true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>Route</em>的<em>didPop</em>方法，此时会先执行子类<em>TransitionRoute</em>的<em>didPop</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">didPop</span><span class="p">(</span><span class="n">T</span><span class="o">?</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_controller</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">$</span><span class="n">runtimeType</span><span class="s1">.didPop called before calling install() or after calling dispose().&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">_transitionCompleter</span><span class="p">.</span><span class="n">isCompleted</span><span class="p">,</span> <span class="s1">&#39;Cannot reuse a </span><span class="si">$</span><span class="n">runtimeType</span><span class="s1"> after disposing it.&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 动画反向执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_controller</span><span class="o">!</span><span class="p">.</span><span class="n">reverse</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行父类的didPop方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="k">super</span><span class="p">.</span><span class="n">didPop</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下父类<em>OverlayRoute</em>的<em>didPop</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">didPop</span><span class="p">(</span><span class="n">T</span><span class="o">?</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行父类的didPop方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="kt">bool</span> <span class="n">returnValue</span> <span class="o">=</span> <span class="k">super</span><span class="p">.</span><span class="n">didPop</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">returnValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 此处finishedWhenPopped为false不会执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">finishedWhenPopped</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">navigator</span><span class="o">!</span><span class="p">.</span><span class="n">finalizeRoute</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 这里是父类didPop方法的返回值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">returnValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下父类<em>Route</em>的<em>didPop</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">mustCallSuper</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">didPop</span><span class="p">(</span><span class="n">T</span><span class="o">?</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行了didComplete方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">didComplete</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>Route</em>的<em>didComplete</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// 当弹出此路由时（请参阅Navigator.pop ），如果未指定结果或结果为null，则将使用此值。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">T</span><span class="o">?</span> <span class="kd">get</span> <span class="n">currentResult</span> <span class="o">=&gt;</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">mustCallSuper</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">didComplete</span><span class="p">(</span><span class="n">T</span><span class="o">?</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 将result结果返回给await push()方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_popCompleter</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="n">result</span> <span class="o">??</span> <span class="n">currentResult</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>前面<em>TransitionRoute</em>的<em>didPop</em>方法中执行了 <em>_controller!.reverse()</em> ，这里是启动了反向动画，那么<em>TransitionRoute</em>的 <em>_handleStatusChanged</em> 方法将会监听动画状态。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_handleStatusChanged</span><span class="p">(</span><span class="n">AnimationStatus</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">AnimationStatus</span><span class="p">.</span><span class="nl">completed:</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">AnimationStatus</span><span class="p">.</span><span class="nl">forward:</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">AnimationStatus</span><span class="p">.</span><span class="nl">reverse:</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="n">AnimationStatus</span><span class="p">.</span><span class="nl">dismissed:</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 动画未开始
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// We might still be an active route if a subclass is controlling the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// transition and hits the dismissed status. For example, the iOS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// back gesture drives this animation to the dismissed status before
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// removing the route and disposing it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// navigator上是否有该路由，此处是栈顶，必须有
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isActive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">navigator</span><span class="o">!</span><span class="p">.</span><span class="n">finalizeRoute</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_popFinalized</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_performanceModeRequestHandle</span><span class="o">?</span><span class="p">.</span><span class="n">dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_performanceModeRequestHandle</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>再看下<em>Navigator</em>的<em>finalizeRoute</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">finalizeRoute</span><span class="p">(</span><span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">route</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">_history</span><span class="p">.</span><span class="n">indexWhere</span><span class="p">(</span><span class="n">_RouteEntry</span><span class="p">.</span><span class="n">isRoutePredicate</span><span class="p">(</span><span class="n">route</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">_RouteEntry</span> <span class="n">entry</span> <span class="o">=</span>  <span class="n">_history</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 此处将currentState修改为_RouteLifecycle.dispose
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">entry</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果 pop 同步完成，则可以在 _flushHistoryUpdates 期间调用 FinalizeRoute。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// finalizeRoute can be called during _flushHistoryUpdates if a pop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// finishes synchronously.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_flushingHistory</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 再次执行_flushHistoryUpdates方法，rearrangeOverlay为false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_flushHistoryUpdates</span><span class="p">(</span><span class="nl">rearrangeOverlay:</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span> <span class="n">_debugLocked</span> <span class="o">=</span> <span class="n">wasDebugLocked</span><span class="o">!</span><span class="p">;</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>NavigatorState</em>的 <em>_flushHistoryUpdates</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_flushHistoryUpdates</span><span class="p">({</span><span class="kt">bool</span> <span class="n">rearrangeOverlay</span> <span class="o">=</span> <span class="kc">true</span><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_debugLocked</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_debugUpdatingPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_flushingHistory</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">_history</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_RouteEntry</span><span class="o">?</span> <span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_RouteEntry</span><span class="o">?</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">_history</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">_RouteEntry</span><span class="o">?</span> <span class="n">previous</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="o">?</span> <span class="n">_history</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="m">1</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">canRemoveOrAdd</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// Whether there is a fully opaque route on top to silently remove or add route underneath.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;?</span> <span class="n">poppedRoute</span><span class="p">;</span> <span class="c1">// The route that should trigger didPopNext on the top active route.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">bool</span> <span class="n">seenTopActiveRoute</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// Whether we&#39;ve seen the route that would get didPopNext.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span> <span class="n">toBeDisposed</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">entry</span><span class="o">!</span><span class="p">.</span><span class="n">currentState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="p">...</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="nl">dispose:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Delay disposal until didChangeNext/didChangePrevious have been sent.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 将要删除的_RouteEntry添加进toBeDisposed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">toBeDisposed</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">_history</span><span class="p">.</span><span class="n">removeAt</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">index</span> <span class="o">-=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">next</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span> <span class="o">=</span> <span class="n">previous</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">previous</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="o">?</span> <span class="n">_history</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="m">1</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Lastly, removes the overlay entries of all marked entries and disposes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// them.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">_RouteEntry</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">toBeDisposed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行_disposeRouteEntry方法，注意graceful传入了true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_disposeRouteEntry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="nl">graceful:</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 传入的rearrangeOverlay为false，此处不会执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">rearrangeOverlay</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">overlay</span><span class="o">?</span><span class="p">.</span><span class="n">rearrange</span><span class="p">(</span><span class="n">_allRouteOverlayEntries</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>NavigatorState</em>的 <em>_disposeRouteEntry</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">static</span> <span class="kt">void</span> <span class="n">_disposeRouteEntry</span><span class="p">(</span><span class="n">_RouteEntry</span> <span class="n">entry</span><span class="p">,</span> <span class="p">{</span><span class="kd">required</span> <span class="kt">bool</span> <span class="n">graceful</span><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 遍历删除当前_RouteEntry所关联Route的所有overlayEntry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">OverlayEntry</span> <span class="n">overlayEntry</span> <span class="k">in</span> <span class="n">entry</span><span class="p">.</span><span class="n">route</span><span class="p">.</span><span class="n">overlayEntries</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">overlayEntry</span><span class="p">.</span><span class="n">remove</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">graceful</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 主要是执行route.dispose()，主要工作是销毁动画资源，以及遍历Route中的_overlayEntries，进行OverlayEntry资源清除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">entry</span><span class="p">.</span><span class="n">dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span><span class="p">.</span><span class="n">forcedDispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>OverlayEntry</em>的<em>remove</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">remove</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_overlay</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">_disposedByOwner</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">OverlayState</span> <span class="n">overlay</span> <span class="o">=</span> <span class="n">_overlay</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_overlay</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">overlay</span><span class="p">.</span><span class="n">mounted</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 在overlay的_entries中，删除当前的OverlayEntry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">overlay</span><span class="p">.</span><span class="n">_entries</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">SchedulerBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">schedulerPhase</span> <span class="o">==</span> <span class="n">SchedulerPhase</span><span class="p">.</span><span class="n">persistentCallbacks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SchedulerBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">addPostFrameCallback</span><span class="p">((</span><span class="n">Duration</span> <span class="n">duration</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">overlay</span><span class="p">.</span><span class="n">_markDirty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行overlay的_markDirty方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">overlay</span><span class="p">.</span><span class="n">_markDirty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>OverlayState</em>的 <em>_markDirty</em> 方法，可以看到，实际上还是执行了<em>setState</em>方法来更新<em>Overlay</em>中的<em>Widget</em>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_markDirty</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">mounted</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">setState</span><span class="p">(()</span> <span class="p">{});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="34根布局materialapp的home之创建">3.4、根布局<em>MaterialApp</em>的<em>home</em>之创建</h2>
<p>先来回顾一下根<em>Navigator</em>的声明地方，它是在 <em>_WidgetsAppState</em> 的<em>build</em>方法中声明。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// 如果 window.defaultRouteName 不是 &#39;/&#39;，我们应该假设它是通过 `setInitialRoute` 有意设置的，并且应该覆盖 [widget.initialRoute] 中的任何内容。
</span></span></span><span class="line"><span class="cl"><span class="c1">// If window.defaultRouteName isn&#39;t &#39;/&#39;, we should assume it was set
</span></span></span><span class="line"><span class="cl"><span class="c1">// intentionally via `setInitialRoute`, and should override whatever is in
</span></span></span><span class="line"><span class="cl"><span class="c1">// [widget.initialRoute].
</span></span></span><span class="line"><span class="cl"><span class="c1">// 如果特定平台的初始路由不是&#39;/&#39;时，以特定平台的初始路由为准。
</span></span></span><span class="line"><span class="cl"><span class="c1">// 如果特定平台的初始路由是&#39;/&#39;时，以Flutter中的initialRoute为准，但是如果Flutter中的initialRoute为null，那么依然以特定平台的初始路由为准，也就是&#39;/&#39;。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">String</span> <span class="kd">get</span> <span class="n">_initialRouteName</span> <span class="o">=&gt;</span> <span class="n">WidgetsBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">platformDispatcher</span><span class="p">.</span><span class="n">defaultRouteName</span> <span class="o">!=</span> <span class="n">Navigator</span><span class="p">.</span><span class="n">defaultRouteName</span>
</span></span><span class="line"><span class="cl">  <span class="o">?</span> <span class="n">WidgetsBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">platformDispatcher</span><span class="p">.</span><span class="n">defaultRouteName</span>
</span></span><span class="line"><span class="cl">  <span class="o">:</span> <span class="n">widget</span><span class="p">.</span><span class="n">initialRoute</span> <span class="o">??</span> <span class="n">WidgetsBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">platformDispatcher</span><span class="p">.</span><span class="n">defaultRouteName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span><span class="o">?</span> <span class="n">routing</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_usesRouterWithDelegates</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_usesNavigator</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">_navigator</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">routing</span> <span class="o">=</span> <span class="n">FocusScope</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">debugLabel:</span> <span class="s1">&#39;Navigator Scope&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">autofocus:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">Navigator</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">clipBehavior:</span> <span class="n">Clip</span><span class="p">.</span><span class="n">none</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">restorationScopeId:</span> <span class="s1">&#39;nav&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">key:</span> <span class="n">_navigator</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 此处调用成员变量_initialRouteName
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nl">initialRoute:</span> <span class="n">_initialRouteName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 此处会调用_onGenerateRoute方法，后面会讲
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nl">onGenerateRoute:</span> <span class="n">_onGenerateRoute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果外部没传入onGenerateInitialRoutes，那么就会调用Navigator的defaultGenerateInitialRoutes方法，后面会讲
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nl">onGenerateInitialRoutes:</span> <span class="n">widget</span><span class="p">.</span><span class="n">onGenerateInitialRoutes</span> <span class="o">==</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">          <span class="o">?</span> <span class="n">Navigator</span><span class="p">.</span><span class="n">defaultGenerateInitialRoutes</span>
</span></span><span class="line"><span class="cl">          <span class="o">:</span> <span class="p">(</span><span class="n">NavigatorState</span> <span class="n">navigator</span><span class="p">,</span> <span class="kt">String</span> <span class="n">initialRouteName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">widget</span><span class="p">.</span><span class="n">onGenerateInitialRoutes</span><span class="o">!</span><span class="p">(</span><span class="n">initialRouteName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 此处会调用_onUnknownRoute方法，后面会讲
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nl">onUnknownRoute:</span> <span class="n">_onUnknownRoute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">observers:</span> <span class="n">widget</span><span class="p">.</span><span class="n">navigatorObservers</span><span class="o">!</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">reportsRouteUpdateToEngine:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_usesRouterWithConfig</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">RootRestorationScope</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">restorationId:</span> <span class="n">widget</span><span class="p">.</span><span class="n">restorationScopeId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">child:</span> <span class="p">...,</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先会执行<em>NavigatorState</em>的<em>didChangeDependencies</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">didChangeDependencies</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行父类的didChangeDependencies方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">super</span><span class="p">.</span><span class="n">didChangeDependencies</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">_updateHeroController</span><span class="p">(</span><span class="n">HeroControllerScope</span><span class="p">.</span><span class="n">maybeOf</span><span class="p">(</span><span class="n">context</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">_RouteEntry</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">_history</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span><span class="p">.</span><span class="n">route</span><span class="p">.</span><span class="n">changedExternalState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为<em>NavigatorState</em>混入了<em>RestorationMixin</em>，所以执行了<em>RestorationMixin</em>的<em>didChangeDependencies</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">didChangeDependencies</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">super</span><span class="p">.</span><span class="n">didChangeDependencies</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">RestorationBucket</span><span class="o">?</span> <span class="n">oldBucket</span> <span class="o">=</span> <span class="n">_bucket</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">bool</span> <span class="n">needsRestore</span> <span class="o">=</span> <span class="n">restorePending</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_currentParent</span> <span class="o">=</span> <span class="n">RestorationScope</span><span class="p">.</span><span class="n">maybeOf</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">bool</span> <span class="n">didReplaceBucket</span> <span class="o">=</span> <span class="n">_updateBucketIfNecessary</span><span class="p">(</span><span class="nl">parent:</span> <span class="n">_currentParent</span><span class="p">,</span> <span class="nl">restorePending:</span> <span class="n">needsRestore</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">needsRestore</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行这里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_doRestore</span><span class="p">(</span><span class="n">oldBucket</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">didReplaceBucket</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">oldBucket</span> <span class="o">!=</span> <span class="n">_bucket</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">oldBucket</span><span class="o">?</span><span class="p">.</span><span class="n">dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>RestorationMixin</em>的<em>didChangeDependencies</em>方法中，执行了 <em>_doRestore</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_doRestore</span><span class="p">(</span><span class="n">RestorationBucket</span><span class="o">?</span> <span class="n">oldBucket</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_debugPropertiesWaitingForReregistration</span> <span class="o">=</span> <span class="n">_properties</span><span class="p">.</span><span class="n">keys</span><span class="p">.</span><span class="n">toList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行这里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">restoreState</span><span class="p">(</span><span class="n">oldBucket</span><span class="p">,</span> <span class="n">_firstRestorePending</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_firstRestorePending</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>RestorationMixin</em>的 <em>_doRestore</em> 方法中，执行了<em>restoreState</em>方法，这是一个空实现，由子类<em>NavigatorState</em>实现，看下<em>NavigatorState</em>的<em>restoreState</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">restoreState</span><span class="p">(</span><span class="n">RestorationBucket</span><span class="o">?</span> <span class="n">oldBucket</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">initialRestore</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">registerForRestoration</span><span class="p">(</span><span class="n">_rawNextPagelessRestorationScopeId</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">registerForRestoration</span><span class="p">(</span><span class="n">_serializableHistory</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 删除旧历史记录中的所有内容并清除overlay。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Delete everything in the old history and clear the overlay.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_forcedDisposeAllRouteEntries</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_history</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// _overlayKey延迟到这里才创建
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_overlayKey</span> <span class="o">=</span> <span class="n">GlobalKey</span><span class="o">&lt;</span><span class="n">OverlayState</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 从恢复数据填充新历史记录。 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 此处因为是根布局初始化，所以没有数据可恢复，_history添加了个寂寞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Populate the new history from restoration data.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_history</span><span class="p">.</span><span class="n">addAll</span><span class="p">(</span><span class="n">_serializableHistory</span><span class="p">.</span><span class="n">restoreEntriesForPage</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 这是声明式的范畴，不会讲
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">Page</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">page</span> <span class="k">in</span> <span class="n">widget</span><span class="p">.</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">_RouteEntry</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">_RouteEntry</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">page</span><span class="p">.</span><span class="n">createRoute</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">pageBased:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">initialState:</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">add</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">entry</span><span class="p">.</span><span class="n">route</span><span class="p">.</span><span class="n">settings</span> <span class="o">==</span> <span class="n">page</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;The settings getter of a page-based Route must return a Page object. &#39;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;Please set the settings to the Page in the Page.createRoute method.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_history</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_history</span><span class="p">.</span><span class="n">addAll</span><span class="p">(</span><span class="n">_serializableHistory</span><span class="p">.</span><span class="n">restoreEntriesForPage</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果没有什么可恢复的，我们需要处理初始路由。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 所以执行这里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// If there was nothing to restore, we need to process the initial route.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_serializableHistory</span><span class="p">.</span><span class="n">hasData</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 获取传入的initialRoute
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">String</span><span class="o">?</span> <span class="n">initialRoute</span> <span class="o">=</span> <span class="n">widget</span><span class="p">.</span><span class="n">initialRoute</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// widget.pages为空，说明采用命令式方案
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">pages</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 如果传入的initialRoute为null，取默认值为&#39;/&#39;，否则不变
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// 本示例中是没有设置initialRoute的，所以取默认值为&#39;/&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">initialRoute</span> <span class="o">=</span> <span class="n">initialRoute</span> <span class="o">??</span> <span class="n">Navigator</span><span class="p">.</span><span class="n">defaultRouteName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">initialRoute</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 将onGenerateInitialRoutes返回的List&lt;Route&gt;转换为List&lt;_RouteEntry&gt;，然后添加进_history中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">_history</span><span class="p">.</span><span class="n">addAll</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">widget</span><span class="p">.</span><span class="n">onGenerateInitialRoutes</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="k">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// 如果传入的initialRoute为null，取默认值为&#39;/&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">widget</span><span class="p">.</span><span class="n">initialRoute</span> <span class="o">??</span> <span class="n">Navigator</span><span class="p">.</span><span class="n">defaultRouteName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">).</span><span class="n">map</span><span class="p">((</span><span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">route</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">_RouteEntry</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">route</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 表示非声明式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nl">pageBased:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 初始状态为_RouteLifecycle.add
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nl">initialState:</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">add</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nl">restorationInformation:</span> <span class="n">route</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">              <span class="o">?</span> <span class="n">_RestorationInformation</span><span class="p">.</span><span class="n">named</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nl">name:</span> <span class="n">route</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">name</span><span class="o">!</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nl">arguments:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nl">restorationScopeId:</span> <span class="n">_nextPagelessRestorationScopeId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 最后执行_flushHistoryUpdates方法，之前讲过该方法会调用setState来刷新UI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_flushHistoryUpdates</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span> <span class="n">_debugLocked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>之前讲过，如果外部没传入<em>onGenerateInitialRoutes</em>，那么就会调用<em>Navigator</em>的<em>defaultGenerateInitialRoutes</em>方法，本示例的确没传入。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// 此处传入的initialRouteName为：如果传入的initialRoute为null，取默认值为&#39;/&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1">// 本示例没有设置initialRoute，所以取默认值为&#39;/&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;&gt;</span> <span class="n">defaultGenerateInitialRoutes</span><span class="p">(</span><span class="n">NavigatorState</span> <span class="n">navigator</span><span class="p">,</span> <span class="kt">String</span> <span class="n">initialRouteName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 创建一个List&lt;Route&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;?&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;?&gt;</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果initialRouteName以&#39;/&#39;开始，并且字符串长度大于1时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">initialRouteName</span><span class="p">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">initialRouteName</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 截取&#39;/&#39;之后的字符串作为initialRouteName，比如/A/B/C变为A/B/C
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">initialRouteName</span> <span class="o">=</span> <span class="n">initialRouteName</span><span class="p">.</span><span class="n">substring</span><span class="p">(</span><span class="m">1</span><span class="p">);</span> <span class="c1">// strip leading &#39;/&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行navigator的_routeNamed方法创建Route，添加进result，这里的第一个Route命名为&#39;/&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 此处添加进来的Route就是home了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">result</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">navigator</span><span class="p">.</span><span class="n">_routeNamed</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Navigator</span><span class="p">.</span><span class="n">defaultRouteName</span><span class="p">,</span> <span class="nl">arguments:</span> <span class="kc">null</span><span class="p">,</span> <span class="nl">allowNull:</span> <span class="kc">true</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果你的initialRouteName是这种形式：a/b/c，那么根据&#39;/&#39;进行分解[a, b, c]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="kt">String</span><span class="o">&gt;</span> <span class="n">routeParts</span> <span class="o">=</span> <span class="n">initialRouteName</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">initialRouteName</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">String</span> <span class="n">routeName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="kt">String</span> <span class="k">part</span> <span class="k">in</span> <span class="n">routeParts</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// routeName变为这种形式：/a , /a/b，/a/b/c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">routeName</span> <span class="o">+=</span> <span class="s1">&#39;/</span><span class="si">$</span><span class="n">part</span><span class="s1">&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 执行navigator的_routeNamed方法创建Route，添加进result
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">result</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">navigator</span><span class="p">.</span><span class="n">_routeNamed</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span><span class="p">(</span><span class="n">routeName</span><span class="p">,</span> <span class="nl">arguments:</span> <span class="kc">null</span><span class="p">,</span> <span class="nl">allowNull:</span> <span class="kc">true</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果List&lt;Route&gt;中最后一个元素为null，报错
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 如果你没有配置路由表，那么是找不到/a , /a/b，/a/b/c这些路由的，所以返回为null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">last</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 清空List&lt;Route&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">result</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">initialRouteName</span> <span class="o">!=</span> <span class="n">Navigator</span><span class="p">.</span><span class="n">defaultRouteName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果initialRouteName不是&#39;/&#39;，那么我们尝试使用allowNull:true来获取它，这样如果失败，我们就会回退到&#39;/&#39;（没有allowNull:true，见下文）。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 如果initialRouteName不存在于路由表，那么Route会返回null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// If initialRouteName wasn&#39;t &#39;/&#39;, then we try to get it with allowNull:true, so that if that fails,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// we fall back to &#39;/&#39; (without allowNull:true, see below).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">result</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">navigator</span><span class="p">.</span><span class="n">_routeNamed</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span><span class="p">(</span><span class="n">initialRouteName</span><span class="p">,</span> <span class="nl">arguments:</span> <span class="kc">null</span><span class="p">,</span> <span class="nl">allowNull:</span> <span class="kc">true</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 空路由可能是由于initialRouteName中的间隙造成的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Null route might be a result of gap in initialRouteName
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 例如，routes = [&#39;A&#39;, &#39;A/B/C&#39;], 且initialRouteName = &#39;A/B/C&#39; 这应导致 result = [&#39;A&#39;, null,&#39;A/B/C&#39;]，其中 &#39;A/B&#39; 生成null。在本例中，我们要过滤掉 null 并返回 result = [&#39;A&#39;, &#39;A/B/C&#39;]。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// For example, routes = [&#39;A&#39;, &#39;A/B/C&#39;], and initialRouteName = &#39;A/B/C&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// This should result in result = [&#39;A&#39;, null,&#39;A/B/C&#39;] where &#39;A/B&#39; produces
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// the null. In this case, we want to filter out the null and return
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// result = [&#39;A&#39;, &#39;A/B/C&#39;].
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 当解析initialRouteName为A/B/C时，A/B在路由表中没有配置，就会造成Route为null，这里要移除List&lt;Route&gt;中null的情况
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">result</span><span class="p">.</span><span class="n">removeWhere</span><span class="p">((</span><span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;?</span> <span class="n">route</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">route</span> <span class="o">==</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果List&lt;Route&gt;依然为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行navigator的_routeNamed方法创建Route，添加进result，name为&#39;/&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 本示例会执行这里，此处添加进来的Route就是home了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">result</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">navigator</span><span class="p">.</span><span class="n">_routeNamed</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Navigator</span><span class="p">.</span><span class="n">defaultRouteName</span><span class="p">,</span> <span class="nl">arguments:</span> <span class="kc">null</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>NavigatorState</em>的 <em>_routeNamed</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">Route</span><span class="o">&lt;</span><span class="n">T</span><span class="o">?&gt;?</span> <span class="n">_routeNamed</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="kt">String</span> <span class="n">name</span><span class="p">,</span> <span class="p">{</span> <span class="kd">required</span> <span class="kt">Object</span><span class="o">?</span> <span class="n">arguments</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">allowNull</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">_debugLocked</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果allowNull为true，并且外部没设置onGenerateRoute时，Route直接返回null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 当然在本示例中，根布局内部已有Navigator，会有一个默认的_onGenerateRoute方法，这里不会执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 如果你是自己添加的Navigator，就需要考虑onGenerateRoute为null的情况
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">allowNull</span> <span class="o">&amp;&amp;</span> <span class="n">widget</span><span class="p">.</span><span class="n">onGenerateRoute</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">onGenerateRoute</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">throw</span> <span class="n">FlutterError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;Navigator.onGenerateRoute was null, but the route named &#34;</span><span class="si">$</span><span class="n">name</span><span class="s1">&#34; was referenced.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;To use the Navigator API with named routes (pushNamed, pushReplacementNamed, or &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;pushNamedAndRemoveUntil), the Navigator must be provided with an &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;onGenerateRoute handler.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;The Navigator was:</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;  </span><span class="si">$</span><span class="n">this</span><span class="s1">&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}());</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">RouteSettings</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">RouteSettings</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">name:</span> <span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">arguments:</span> <span class="n">arguments</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行外部传入的onGenerateRoute方法，这里调用了默认的_onGenerateRoute方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Route</span><span class="o">&lt;</span><span class="n">T</span><span class="o">?&gt;?</span> <span class="n">route</span> <span class="o">=</span> <span class="n">widget</span><span class="p">.</span><span class="n">onGenerateRoute</span><span class="o">!</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span> <span class="o">as</span> <span class="n">Route</span><span class="o">&lt;</span><span class="n">T</span><span class="o">?&gt;?</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果Route为null，并且allowNull为false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">route</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">allowNull</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">onUnknownRoute</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">FlutterError</span><span class="p">.</span><span class="n">fromParts</span><span class="p">(</span><span class="o">&lt;</span><span class="n">DiagnosticsNode</span><span class="o">&gt;</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="n">ErrorSummary</span><span class="p">(</span><span class="s1">&#39;Navigator.onGenerateRoute returned null when requested to build route &#34;</span><span class="si">$</span><span class="n">name</span><span class="s1">&#34;.&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="n">ErrorDescription</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;The onGenerateRoute callback must never return null, unless an onUnknownRoute &#39;</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;callback is provided as well.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="n">DiagnosticsProperty</span><span class="o">&lt;</span><span class="n">NavigatorState</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;The Navigator was&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nl">style:</span> <span class="n">DiagnosticsTreeStyle</span><span class="p">.</span><span class="n">errorProperty</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行外部传入的onUnknownRoute方法，这里调用了默认的_onUnknownRoute方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">route</span> <span class="o">=</span> <span class="n">widget</span><span class="p">.</span><span class="n">onUnknownRoute</span><span class="o">!</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span> <span class="o">as</span> <span class="n">Route</span><span class="o">&lt;</span><span class="n">T</span><span class="o">?&gt;?</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">route</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="n">FlutterError</span><span class="p">.</span><span class="n">fromParts</span><span class="p">(</span><span class="o">&lt;</span><span class="n">DiagnosticsNode</span><span class="o">&gt;</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="n">ErrorSummary</span><span class="p">(</span><span class="s1">&#39;Navigator.onUnknownRoute returned null when requested to build route &#34;</span><span class="si">$</span><span class="n">name</span><span class="s1">&#34;.&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="n">ErrorDescription</span><span class="p">(</span><span class="s1">&#39;The onUnknownRoute callback must never return null.&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="n">DiagnosticsProperty</span><span class="o">&lt;</span><span class="n">NavigatorState</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;The Navigator was&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nl">style:</span> <span class="n">DiagnosticsTreeStyle</span><span class="p">.</span><span class="n">errorProperty</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}());</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">route</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">allowNull</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下 <em>_WidgetsAppState</em>的 <em>_onGenerateRoute</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;?</span> <span class="n">_onGenerateRoute</span><span class="p">(</span><span class="n">RouteSettings</span> <span class="n">settings</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">String</span><span class="o">?</span> <span class="n">name</span> <span class="o">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果你的Route的name是&#39;/&#39;，那么包装widget.home为WidgetBuilder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 如果你的Route的name不是&#39;/&#39;或者widget.home为空，那么从路由表中获取name对应的WidgetBuilder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">WidgetBuilder</span><span class="o">?</span> <span class="n">pageContentBuilder</span> <span class="o">=</span> <span class="n">name</span> <span class="o">==</span> <span class="n">Navigator</span><span class="p">.</span><span class="n">defaultRouteName</span> <span class="o">&amp;&amp;</span> <span class="n">widget</span><span class="p">.</span><span class="n">home</span> <span class="o">!=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">      <span class="o">?</span> <span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">widget</span><span class="p">.</span><span class="n">home</span><span class="o">!</span>
</span></span><span class="line"><span class="cl">      <span class="o">:</span> <span class="n">widget</span><span class="p">.</span><span class="n">routes</span><span class="o">!</span><span class="p">[</span><span class="n">name</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">pageContentBuilder</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">widget</span><span class="p">.</span><span class="n">pageRouteBuilder</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;The default onGenerateRoute handler for WidgetsApp must have a &#39;</span>
</span></span><span class="line"><span class="cl">      <span class="s1">&#39;pageRouteBuilder set if the home or routes properties are set.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 在_MaterialAppState中，WidgetsApp传入的pageRouteBuilder实际上是创建了MaterialPageRoute
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">route</span> <span class="o">=</span> <span class="n">widget</span><span class="p">.</span><span class="n">pageRouteBuilder</span><span class="o">!&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">settings</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">pageContentBuilder</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果你的Route的name不是&#39;/&#39;并且路由表也没有配置该name，就会执行这里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">onGenerateRoute</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">widget</span><span class="p">.</span><span class="n">onGenerateRoute</span><span class="o">!</span><span class="p">(</span><span class="n">settings</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果没有设置onGenerateRoute兜底，最后Route返回null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下 <em>_WidgetsAppState</em>的 <em>_onUnknownRoute</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">_onUnknownRoute</span><span class="p">(</span><span class="n">RouteSettings</span> <span class="n">settings</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">onUnknownRoute</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">throw</span> <span class="n">FlutterError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;Could not find a generator for route </span><span class="si">$</span><span class="n">settings</span><span class="s1"> in the </span><span class="si">$</span><span class="n">runtimeType</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;Make sure your root app widget has provided a way to generate </span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;this route.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;Generators for routes are searched for in the following order:</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39; 1. For the &#34;/&#34; route, the &#34;home&#34; property, if non-null, is used.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39; 2. Otherwise, the &#34;routes&#34; table is used, if it has an entry for &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;the route.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39; 3. Otherwise, onGenerateRoute is called. It should return a &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;non-null value for any valid route not handled by &#34;home&#34; and &#34;routes&#34;.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39; 4. Finally if all else fails onUnknownRoute is called.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;Unfortunately, onUnknownRoute was not set.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}());</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行外部传入的onUnknownRoute方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;?</span> <span class="n">result</span> <span class="o">=</span> <span class="n">widget</span><span class="p">.</span><span class="n">onUnknownRoute</span><span class="o">!</span><span class="p">(</span><span class="n">settings</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">throw</span> <span class="n">FlutterError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;The onUnknownRoute callback returned null.</span><span class="se">\n</span><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;When the </span><span class="si">$</span><span class="n">runtimeType</span><span class="s1"> requested the route </span><span class="si">$</span><span class="n">settings</span><span class="s1"> from its &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;onUnknownRoute callback, the callback returned null. Such callbacks &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;must never return null.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}());</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">result</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="35navigator的pushnamed方法">3.5、<em>Navigator</em>的<em>pushNamed</em>方法</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">optionalTypeArgs</span>
</span></span><span class="line"><span class="cl"><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">?&gt;</span> <span class="n">pushNamed</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="kt">Object</span><span class="o">?&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="kt">String</span> <span class="n">routeName</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">Object</span><span class="o">?</span> <span class="n">arguments</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">push</span><span class="o">&lt;</span><span class="n">T</span><span class="o">?&gt;</span><span class="p">(</span><span class="n">_routeNamed</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">routeName</span><span class="p">,</span> <span class="nl">arguments:</span> <span class="n">arguments</span><span class="p">)</span><span class="o">!</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>_routeNamed</em> 方法返回一个Route对象，<em>push</em>方法和之前一样的逻辑，这里就不分析了，至于其它的<em>Navigator</em>的方法相信你也能举一反三。</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">AndDevMK</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2023-11-19
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/wechat-qr-code.JPG">
        <span>微信打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/alipay-qr-code.JPG">
        <span>支付宝打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      
      <nav class="post-nav">
        
        <a class="next" href="/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Bgesturedetector/">
            <span class="next-text nav-default">解读Flutter源码之GestureDetector</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="AndDevMK/blog-utterances"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    
    <div id="search_mask" class="search_mask">
    <div class="search_modal">
        <div id="close_search" class="close_search">关闭</div>
        <div class="search_divider"></div>
        <input id="input_search_key" class="input_search_key" placeholder="请输入你要搜索的内容" tabindex="0">
        <ul id="search_list">
        </ul>
    </div>
</div>

<script src="/js/fuse.js"></script> 
<script src="/js/fastsearch.js"></script>

    <footer id="footer" class="footer">
      

<div class="copyright">
  <span class="power-by">
    由 <a id="hexo-link" class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    
    <span id="run-time" class="run-time"></span> 
    <span class="heart"><i class="iconfont icon-heart"></i></span>
    &copy; 
    2023&nbsp;
    <span>AndDevMK</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.11a4ba15caf2d921d57eaf6568c4ad21eafd5d2c001cbcb31693586c63f93005.js"></script>

<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?6db179fb88e600cf326b0515a8aa1de3";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>




<script src="/js/codecopy.js"></script>



<link disabled id="dark-mode-theme" rel="stylesheet" href="/css/dark.css"></link>
<script src="/js/dark.js"></script>


<script src="/js/site_runtime.js"></script>




</body>
</html>
