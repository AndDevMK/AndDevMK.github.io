<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>解读Flutter源码之Navigator（声明式） - AndDevMK&#39;s android blog site</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="AndDevMK" /><meta name="description" content="注：本文代码基于Flutter SDK 3.13.5 一、前言 在之前解读Flutter源码之Navigator（命令式）一文中，已分析过Navigator的相关方法API与底层原理，知道了Navigator内部通过Overlay组件来管理路由页面堆栈。 在Flutter1.22版本发布之后，可以发现本" /><meta name="keywords" content="Android, Java, Kotlin, C&#43;&#43;, C, Flutter, Dart, NDK" />


<meta name="baidu-site-verification" content="codeva-wQ7uOo4V09" />
<meta name="google-site-verification" content="yHzWB9BxTR74LiaUhuL5ncr89fnDYXiplTaPY565zqo" />


<meta name="generator" content="Hugo 0.111.3 with theme even" />


<link rel="canonical" href="https://anddevmk.cn/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Bnavigator%E5%A3%B0%E6%98%8E%E5%BC%8F/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.c11aaf02bef1025d6b0813ba5e1a8a8551aee15fa8f2bcea906d41b20bdf5c69.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/codecopy.css">


<meta property="og:title" content="解读Flutter源码之Navigator（声明式）" />
<meta property="og:description" content="注：本文代码基于Flutter SDK 3.13.5 一、前言 在之前解读Flutter源码之Navigator（命令式）一文中，已分析过Navigator的相关方法API与底层原理，知道了Navigator内部通过Overlay组件来管理路由页面堆栈。 在Flutter1.22版本发布之后，可以发现本" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://anddevmk.cn/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Bnavigator%E5%A3%B0%E6%98%8E%E5%BC%8F/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-11-26T09:28:31+08:00" />
<meta property="article:modified_time" content="2023-11-26T09:28:31+08:00" />
<meta itemprop="name" content="解读Flutter源码之Navigator（声明式）">
<meta itemprop="description" content="注：本文代码基于Flutter SDK 3.13.5 一、前言 在之前解读Flutter源码之Navigator（命令式）一文中，已分析过Navigator的相关方法API与底层原理，知道了Navigator内部通过Overlay组件来管理路由页面堆栈。 在Flutter1.22版本发布之后，可以发现本"><meta itemprop="datePublished" content="2023-11-26T09:28:31+08:00" />
<meta itemprop="dateModified" content="2023-11-26T09:28:31+08:00" />
<meta itemprop="wordCount" content="20159">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="解读Flutter源码之Navigator（声明式）"/>
<meta name="twitter:description" content="注：本文代码基于Flutter SDK 3.13.5 一、前言 在之前解读Flutter源码之Navigator（命令式）一文中，已分析过Navigator的相关方法API与底层原理，知道了Navigator内部通过Overlay组件来管理路由页面堆栈。 在Flutter1.22版本发布之后，可以发现本"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">AndDevMK</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>

    
    <li class="mobile-menu-item-search">
      <div id="mobile_open_search" class="mobile_open_search">
        搜索
      </div>
    </li>

    
    <li class="mobile-menu-item-dark-mode">
      <div id="mobile_dark_mode_toggle" class="mobile_light_mode">
       
      </div>
    </li>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">AndDevMK</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
    
    <div id="open_search" class="open_search">
      搜索
    </div>

    
    <div id="dark_mode_toggle" class="light_mode">

    </div>
  
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">解读Flutter源码之Navigator（声明式）</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-11-26 </span>
        <div class="post-category">
            <a href="/categories/flutter/"> Flutter </a>
            </div>
          <span class="more-meta"> 约 20159 字 </span>
          <span class="more-meta"> 预计阅读 41 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#一前言">一、前言</a></li>
    <li><a href="#二为什么需要新的api">二、为什么需要新的<em>API</em>？</a></li>
    <li><a href="#三分析关键api">三、分析关键<em>API</em></a>
      <ul>
        <li><a href="#31在navigator中配置">3.1、在<em>Navigator</em>中配置</a>
          <ul>
            <li><a href="#311pages属性">3.1.1、<em>pages</em>属性</a></li>
            <li><a href="#312onpoppage属性">3.1.2、<em>onPopPage</em>属性</a></li>
          </ul>
        </li>
        <li><a href="#32在materialapprouter中配置">3.2、在<em>MaterialApp.router</em>中配置</a>
          <ul>
            <li><a href="#321routeinformationprovider属性">3.2.1、<em>routeInformationProvider</em>属性</a></li>
            <li><a href="#322routeinformationparser属性">3.2.2、<em>routeInformationParser</em>属性</a></li>
            <li><a href="#323routerdelegate属性">3.2.3、<em>routerDelegate</em>属性</a></li>
            <li><a href="#324backbuttondispatcher属性">3.2.4、<em>backButtonDispatcher</em>属性</a></li>
          </ul>
        </li>
        <li><a href="#33materialapprouter的两种配置方式">3.3、<em>MaterialApp.router</em>的两种配置方式</a></li>
        <li><a href="#34router交互原理">3.4、<em>Router</em>交互原理</a></li>
      </ul>
    </li>
    <li><a href="#四navigator-20实战">四、<em>Navigator 2.0</em>实战</a></li>
    <li><a href="#五源码分析">五、源码分析</a>
      <ul>
        <li><a href="#51系统平台navigation信息传递">5.1、系统平台<em>Navigation</em>信息传递</a></li>
        <li><a href="#52_materialappstate-的build方法">5.2、<em>_MaterialAppState</em> 的<em>build</em>方法</a></li>
        <li><a href="#53根布局路由信息解析">5.3、根布局路由信息解析</a></li>
        <li><a href="#54navigator中pages转化">5.4、<em>Navigator</em>中<em>pages</em>转化</a></li>
        <li><a href="#55pushnamed执行逻辑">5.5、<em>pushNamed</em>执行逻辑</a></li>
        <li><a href="#56pop执行逻辑">5.6、<em>pop</em>执行逻辑</a></li>
      </ul>
    </li>
    <li><a href="#六参考文献">六、参考文献</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <blockquote>
<p><em>注：本文代码基于Flutter SDK 3.13.5</em></p>
</blockquote>
<h1 id="一前言">一、前言</h1>
<p>在之前<a href="https://anddevmk.cn/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Bnavigator%E5%91%BD%E4%BB%A4%E5%BC%8F/"><em>解读Flutter源码之Navigator（命令式）</em></a>一文中，已分析过<em>Navigator</em>的相关方法<em>API</em>与底层原理，知道了<em>Navigator</em>内部通过<em>Overlay</em>组件来管理路由页面堆栈。</p>
<p>在<em>Flutter1.22</em>版本发布之后，可以发现本次对路由相关<em>API</em>的改动较大，官方表示由于传统的命令式并没有给开发者一种灵活的方式去直接管理路由栈，甚至觉得已经过时了，一点也不<em>Flutter</em>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">As</span> <span class="n">mentioned</span> <span class="n">by</span> <span class="n">a</span> <span class="n">participant</span> <span class="k">in</span> <span class="n">one</span> <span class="n">of</span> <span class="n">Flutter</span><span class="s1">&#39;s user studies, the API also feels outdated and not very Flutter-y.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>而<em>Navigator 2.0</em>引入了一套全新的声明式<em>API</em>，与以往不同，这类<em>API</em>可以实现用一组声明式的不可变的<em>Page</em>页面列表表示应用中的历史路由页面，从而转换成实际代码中<em>Navigator</em>的<em>Routes</em>。</p>
<p>因此，本文会带你逐步了解<em>Navigator 2.0</em>的实现方式以及它的底层原理。</p>
<h1 id="二为什么需要新的api">二、为什么需要新的<em>API</em>？</h1>
<p><em>Flutter</em>团队为什么要不惜这些代价对<em>Navigator API</em>做这么大的重构，肯定不只是为了让<em>Navigator API</em>的使用更像声明式那么简单，可能有如下几点原因：</p>
<p>1、原始<em>Navigator API</em>中的<em>initialRoute</em>参数，即系统默认的初始页面，在应用运行后就不能再更改了。这种情况下，如果用户接收到一个系统通知，点击后想要从当前的路由栈状态 <em>[Main -&gt; Profile -&gt; Settings]</em> 切换到新的 <em>Main -&gt; List -&gt; Detail[id=24]</em>，<em>Navigator 1.0</em>并没有一种优雅的实现方式实现这种效果。</p>
<p>2、原始的命令式<em>Navigator API</em>只提供给了开发者一些非常针对性的接口，如<em>push</em>、<em>pop</em>等方法，而没有给出一种更灵活的方式让我们直接操作路由栈，这种做法其实与<em>Flutter</em>理念相违背。</p>
<p>3、在嵌套路由的情况下，手机设备自带的回退按钮只能由根<em>Navigator</em>响应。在目前的应用中，我们很多场景都需要在某个子<em>tab</em>内单独管理一个子路由栈，假设有这个场景，用户在子路由栈中做一系列路由操作之后，点击系统回退按钮，消失的将是整个上层的根路由，我们当然可以使用某种措施来避免这种状况，但归咎起来，这也不应该是应用开发者应该考虑的问题。</p>
<p>4、还有更重要的一点就是对<em>Web</em>的支持，声明式<em>Navigator API</em>支持浏览器的前进按钮、后退按钮以及地址栏索引，这是原始<em>Navigator API</em>做不到的。</p>
<h1 id="三分析关键api">三、分析关键<em>API</em></h1>
<p><em>Navigator 2.0</em>提供了一系列全新的接口，可以实现将路由状态成为应用状态的一部分，并能够通过底层<em>API</em>实现参数解析的功能，新增的<em>API</em>一些是在<em>Navigator</em>中配置，另一些是在<em>MaterialApp.router</em>中配置。</p>
<h2 id="31在navigator中配置">3.1、在<em>Navigator</em>中配置</h2>
<h3 id="311pages属性">3.1.1、<em>pages</em>属性</h3>
<p><em>pages</em>属性需要传入一组<em>Page</em>对象，它与<em>Navigator</em>底层路由栈一一对应。换句话说，当你修改<em>pages</em>列表时其实也是对<em>Navigator</em>底层路由栈的修改。</p>
<p><em>Page</em>继承自<em>RouteSettings</em>，它用来描述<em>Route</em>的配置，包含路由名称（<em>name</em>，如&quot;/<em>settings</em>&quot;），参数（<em>arguments</em>）等信息。如果你想<em>push</em>一个<em>Route</em>，不再是调用<em>Navigator</em>的<em>push</em>方法，而是往<em>pages</em>列表添加一个<em>Page</em>对象。与此相反，如果你想<em>pop</em>一个<em>Route</em>，不再是调用<em>Navigator</em>的<em>pop</em>方法，而是移除<em>pages</em>列表最后一个<em>Page</em>对象。当修改<em>pages</em>列表后，底层会对之前<em>pages</em>与当前<em>pages</em>进行<em>diff</em>算法比较，然后更新<em>Navigator</em>底层路由栈。</p>
<p><em>Page</em>的实现类有两个，一个是<em>MaterialPage</em>，另一个是<em>CupertinoPage</em>。一般情况下，这两个实现类已经够用了，当然了你也可以自定义<em>Page</em>。</p>
<p>从下面源码也可以发现，<em>Page</em>与<em>Widget</em>的相似度很高。<em>Widget</em>只保存组件配置信息，框架层内置了一个<em>createElement()<em>可以创建与之对应的</em>Element</em>实例。<em>Page</em>同样只保存页面路由相关信息，框架层也存在一个<em>createRoute()<em>方法可以创建与之对应的</em>Route</em>实例。</p>
<p><em>Widget</em>和<em>Page</em>中也都有一个<em>canUpdate()<em>方法，用于底层判断</em>Page</em>是否已更新或改变，甚至连比较的条件都是<em>runtimeType</em>与<em>key</em>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Page</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">RouteSettings</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">Page</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">arguments</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">restorationId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">LocalKey</span><span class="o">?</span> <span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">String</span><span class="o">?</span> <span class="n">restorationId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">canUpdate</span><span class="p">(</span><span class="n">Page</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">other</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">other</span><span class="p">.</span><span class="n">runtimeType</span> <span class="o">==</span> <span class="n">runtimeType</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">           <span class="n">other</span><span class="p">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="kd">factory</span>
</span></span><span class="line"><span class="cl">  <span class="n">Route</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">createRoute</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">String</span> <span class="n">toString</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="s1">&#39;</span><span class="si">${</span><span class="n">objectRuntimeType</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;Page&#39;</span><span class="p">)</span><span class="si">}</span><span class="s1">(&#34;</span><span class="si">$</span><span class="n">name</span><span class="s1">&#34;, </span><span class="si">$</span><span class="n">key</span><span class="s1">, </span><span class="si">$</span><span class="n">arguments</span><span class="s1">)&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>除此之外，<em>Navigator 2.0</em>与<em>Navigator 1.0</em>也可以一起工作，但是对于<em>Navigator 1.0</em>来说，使用<em>push</em>等方法添加到历史记录中的这些<em>Route</em>不对应于<em>Page</em>对象。</p>
<p>不对应于<em>Page</em>对象的<em>Route</em>称为无页路由，并绑定到与历史中位于其下方的<em>Page</em>对象对应的<em>Route</em>。如果一个页面被移除，而该页面上有其它使用<em>push</em>方法推送的无页路由，那么这些无页路由也会被移除。</p>
<p>最后，在<em>Navigator</em>中使用<em>pages</em>属性，例如下面代码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">Navigator</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nl">pages:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">MaterialPage</span><span class="p">(</span><span class="nl">child:</span> <span class="n">HomePage</span><span class="p">(),</span> <span class="nl">key:</span> <span class="n">ValueKey</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span> <span class="nl">name:</span> <span class="s1">&#39;/&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">MaterialPage</span><span class="p">(</span><span class="nl">child:</span> <span class="n">SecondPage</span><span class="p">(),</span> <span class="nl">key:</span> <span class="n">ValueKey</span><span class="p">(</span><span class="s1">&#39;/secondPage&#39;</span><span class="p">),</span> <span class="nl">name:</span> <span class="s1">&#39;/secondPage&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="312onpoppage属性">3.1.2、<em>onPopPage</em>属性</h3>
<p>如果你使用了上面的<em>pages</em>属性，那么还必须提供<em>onPopPage</em>回调，否则在<em>Navigator</em>的<em>initState</em>方法中进行<em>assert</em>校验时会抛出错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">The Navigator.onPopPage must be provided to use the Navigator.pages API
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>onPopPage</em>回调的作用是系统在<em>pop</em>页面时给你清理<em>pages</em>列表中该页面的机会。在<em>onPopPage</em>方法中，如果你同意关闭该页面，就可以调用<em>route.didPop(result)</em>，该方法默认返回<em>true</em>。在<em>Navigator</em>中使用<em>onPopPage</em>属性，例如下面代码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">_onPopPage</span><span class="p">(</span><span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">route</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">route</span><span class="p">.</span><span class="n">didPop</span><span class="p">(</span><span class="n">result</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 这里做一些工作，例如：清理pages列表中栈顶page与通知pages更新等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>那么问题来了，当你接收到<em>onPopPage</em>回调并且同意关闭该页面（<em>onPopPage</em>回调返回<em>true</em>），但是你没有从<em>pages</em>中移除相应的<em>Page</em>对象时，这会发生什么现象呢？</p>
<p>首先<em>Flutter</em>底层依然会移除路由栈中该页面的历史记录，其次是当下次<em>pages</em>列表更新时，如果该<em>Route</em>对应的<em>Page</em>仍然存在，则会被解释为新的路由进行显示。</p>
<p>很明显，<em>onPopPage</em>回调已经把底层页面关闭的逻辑下放给开发者了，也就是说，某个页面是否能够关闭完全由你掌控，而不是单纯交给系统的<em>Navigator.pop()</em>。在<em>onPopPage</em>回调中，如果你不想关闭某个页面可以做相应的判断并返回<em>false</em>。</p>
<p>至此，<em>Navigator</em>有了<em>pages</em>与<em>onPopPage</em>两大属性，就可以实现声明式的路由管理了。只是如果还要兼容<em>Web</em>端的话，例如处理浏览器的前进与后退按钮，同步浏览器地址栏中的链接等，就需要在<em>MaterialApp.router</em>中配置了。</p>
<h2 id="32在materialapprouter中配置">3.2、在<em>MaterialApp.router</em>中配置</h2>
<h3 id="321routeinformationprovider属性">3.2.1、<em>routeInformationProvider</em>属性</h3>
<p><em>routeInformationProvider</em>属性需要传入一个<em>RouteInformationProvider</em>对象，可以为<em>null</em>，也可以使用自定义的<em>RouteInformationProvider</em>对象。如果不传入时<em>Flutter</em>会使用默认的<em>PlatformRouteInformationProvider</em>对象。</p>
<p>它向<em>WidgetsBinding</em>注册了一个<em>WidgetsBindingObserver</em>监听回调，当在某系统平台上触发了与导航相关的操作时，例如在<em>Web</em>端中，点击了浏览器的前进按钮与后退按钮等，<em>WidgetsBinding</em>就会把来自某系统平台的导航信息<em>MethodCall</em>转换为<em>RouteInformation</em>，然后分发给<em>RouteInformationProvider</em>。</p>
<p>最后，<em>RouteInformationProvider</em>对象将持有的<em>RouteInformation</em>给到<em>RouteInformationParser</em>去解析处理。</p>
<p>如果该<em>Router</em>不依赖路由信息来构建其内容，则该<em>RouteInformationProvider</em>可以为空。在这种情况下，<em>RouteInformationParser</em>也必须为<em>null</em>。</p>
<h3 id="322routeinformationparser属性">3.2.2、<em>routeInformationParser</em>属性</h3>
<p><em>routeInformationProvider</em>属性需要传入一个<em>RouteInformationParser</em>对象，它用于将来自<em>routeInformationProvider</em>的路由信息​​解析为通用数据类型，以便稍后由<em>routerDelegate</em>处理。</p>
<p><em>routeInformationProvider</em>对象需要开发者自己去实现，它有两个要实现的方法：</p>
<ul>
<li><em>parseRouteInformation</em>方法</li>
</ul>
<p>该方法的入参<em>RouteInformation</em>来自之前的<em>RouteInformationProvider</em>，在这里可以去将<em>RouteInformation</em>解析成你想要的数据类型。</p>
<p>该方法要求返回一个<em>Future</em>对象，如果可以同步计算结果，请考虑使用<em>SynchronousFuture</em>，这样<em>Router</em>就不需要等待下一个微任务将数据传递给<em>RouterDelegate</em>。</p>
<p>除此之外，还有一个<em>parseRouteInformationWithDependencies</em>方法，与<em>parseRouteInformation</em>方法一样，只不过多了一个<em>BuildContext</em>入参。如果解析依赖于<em>BuildContext</em>中的其它依赖项，则可以实现<em>parseRouteInformationWithDependencies</em>。</p>
<ul>
<li><em>restoreRouteInformation</em>方法</li>
</ul>
<p>该方法可以从<em>RouterDelegate</em>对象的<em>currentConfiguration</em>返回的当前配置恢复<em>RouteInformation</em>。</p>
<p>等后续再需要用到该<em>RouteInformation</em>对象，就可以重新解析使用，例如当执行了<em>RouterState</em>的<em>didChangeDependencies</em>方法。</p>
<h3 id="323routerdelegate属性">3.2.3、<em>routerDelegate</em>属性</h3>
<p><em>routerDelegate</em>属性需要传入一个<em>RouterDelegate</em>对象，它是一个委托，用于配置<em>Navigator</em>，并使用来自<em>RouteInformationParser</em>的解析结果。</p>
<p>另外，该委托也是<em>Router</em>的核心部分，用来响应来自引擎的推送路由和弹出路由意图，并通知<em>Router</em>进行重建。</p>
<p><em>routerDelegate</em>对象需要开发者自己去实现，一般情况下，它有三个要实现的方法&amp;属性：</p>
<ul>
<li><em>setNewRoutePath</em>方法</li>
</ul>
<p>当<em>Router.routeInformationProvider</em>报告操作系统已将新路由推送到应用程序时，该方法由<em>Router</em>调用，一般情况下，可以在<em>setNewRoutePath</em>方法中根据条件去更新你的<em>pages</em>。</p>
<p>对于该方法的返回值，如果可以同步计算结果，请考虑使用<em>SynchronousFuture</em>，这样<em>Router</em>就不需要等待下一个微任务来安排构建。</p>
<ul>
<li><em>build</em>方法</li>
</ul>
<p>通常，此方法返回一个适当配置的<em>Navigator</em>。</p>
<ul>
<li><em>currentConfiguration</em>属性</li>
</ul>
<p>当<em>Router</em>检测到路由信息可能因重建而发生更改时调用。如果此<em>getter</em>返回非空，则<em>Router</em>将开始向引擎报告新的路由信息​​。在<em>Web</em>应用程序中，新的路由信息​​用于填充浏览器历史记录，以支持前进和后退按钮。</p>
<p>当重写此方法时，此<em>getter</em>返回的配置必须能够构造当前的应用程序状态，并在<em>build</em>方法中使用相同的配置来构建<em>Widget</em>。否则，浏览器的后退和前进按钮将无法正常工作。</p>
<p>默认情况下，该<em>getter</em>返回<em>null</em>，这会阻止<em>Router</em>上报路由信息。要选择加入，子类可以重写此<em>getter</em>以返回当前配置。</p>
<p>最多一个<em>Router</em>可以选择加入路由信息报告。通常，只有<em>WidgetsApp.router</em>创建的最顶层<em>Router</em>才应选择路由信息报告。</p>
<h3 id="324backbuttondispatcher属性">3.2.4、<em>backButtonDispatcher</em>属性</h3>
<p><em>backButtonDispatcher</em>属性决定是否处理<em>Android</em>后退按钮意图的委托。如果未提供，应用程序将默认创建<em>RootBackButtonDispatcher</em>。一般情况下，当用到<em>BackButtonListener</em>时才会与此关联。</p>
<h2 id="33materialapprouter的两种配置方式">3.3、<em>MaterialApp.router</em>的两种配置方式</h2>
<p><em>MaterialApp.router</em>有两种配置方式，一种是直接传入<em>routeInformationParser</em>、<em>routerDelegate</em>等属性。另一种是传入一个<em>routerConfig</em>。</p>
<p>上面两种方式没区别，但是如果提供了<em>routerConfig</em>，则其它与路由器相关的委托、 <em>routeInformationParser</em>、<em>routeInformationProvider</em>、<em>routerDelegate</em>和<em>backButtonDispatcher</em>必须全部为<em>null</em>。</p>
<h2 id="34router交互原理">3.4、<em>Router</em>交互原理</h2>
<p>如果上面文字看不明白，可以看下面这张图，它展示了<em>RouterDelegate</em>与<em>Router</em>、<em>RouteInformationParser</em>以及应用状态的交互原理。</p>
<img title="" src="/img/flutter/解读Flutter源码之Navigator（声明式）/Router交互原理.png" alt="" width="535">
<p>结合上面图示，大致流程如下：</p>
<p>1、当系统打开新页面（如 “<em>books</em>/ 2”）时，<em>RouteInformationParser</em>会将其转换为应用中的具体数据类型T（如<em>BooksRoutePath</em>）。</p>
<p>2、该数据类型会被传递给<em>RouterDelegate</em>的<em>setNewRoutePath</em>方法，我们可以在这里更新路由状态（如通过设置<em>selectedBookId</em>）并调用<em>notifyListeners</em>响应该操作。</p>
<p>3、<em>notifyListeners</em>会通知<em>Router</em>重建<em>RouterDelegate</em>（通过 <em>build()</em> 方法）。</p>
<p>4、<em>RouterDelegate.build()<em>返回一个新的</em>Navigator</em>实例，并最终展示出我们想要打开的页面（如<em>selectedBookId</em>）。</p>
<h1 id="四navigator-20实战">四、<em>Navigator 2.0</em>实战</h1>
<p><em>Navigator 2.0</em>需要做到以下几点实现：</p>
<p>1、 实现解析路由信息，其中包括系统初始路由、浏览器前进按钮、后退按钮以及地址栏索引，这个对应于<em>RouteInformationParser</em>的<em>parseRouteInformation</em>方法。</p>
<p>2、 实现<em>pages</em>的管理，对于<em>push</em>页面情况，如果要打开的页面在栈中已存在，则将该页面之上的所有页面进行出栈（这里可按需求处理，这是其中一个方案）。对于<em>pop</em>页面情况，将栈顶页面出栈即可。</p>
<p>3、 对于<em>Page</em>的创建，统一采用<em>MaterialPage</em>，这里不需要用到自定义<em>Page</em>，其所关联的<em>Widget</em>通过路由表配置后来获取，并且页面传参通过<em>Widget</em>的构造方法来完成。</p>
<p>4、 实现<em>onPopPage</em>方法，更新<em>pages</em>列表，最后通知<em>RouterDelegate</em>去更新<em>Navigator</em>。</p>
<p>5、 实现恢复路由信息，对于<em>Web</em>端是很有必要的。这个对应于<em>RouteInformationParser</em>的<em>restoreRouteInformation</em>方法。</p>
<p>6、 实现统一的跳转逻辑，例如提供一个统一的<em>pushNamed</em>方法。这时可能有人会感到疑惑，说好的声明式，现在怎么又变回命令式了。其实要明白，声明式的尽头还是命令式。</p>
<p>不像之前<em>Navigator 1.0</em>那样的<em>push</em>去操作<em>Route</em>，<em>pushNamed</em>方法还是去更新<em>pages</em>，所以本质上也还是声明式的，为了方便更新<em>pages</em>不得已而为之。这样做也有一个好处，就是不需要通过<em>Widget</em>去传入大量回调。</p>
<p>7、 实现页面监听<em>onResume</em>或<em>onPause</em>方法，这也是一个比较有意思的功能，也只有<em>Navigator 2.0</em>才可以做到（注意：手机<em>HOME</em>退到后台，再切换到前台，这种情况不支持）。</p>
<p>8、 实现统一的页面弹出控制，把<em>result</em>回传给上一个页面，这里和<em>Navigator 1.0</em>通过<em>Future</em>去等待结果不同，因为无法获取<em>Route.popped</em>，所以这里通过监听回调来完成。</p>
<p>9、 &hellip;</p>
<p><em>OK</em>，这里就不带大家一步步实现了，直接给出最终源码，一些欠考虑的地方请看注释，最后运行效果<em>UI</em>请自行运行程序查看。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">runApp</span><span class="p">(</span><span class="kd">const</span> <span class="n">MyApp</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">MyApp</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">MyApp</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">MaterialApp</span><span class="p">.</span><span class="n">router</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">title:</span> <span class="s1">&#39;Flutter Demo&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">theme:</span> <span class="n">ThemeData</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">colorScheme:</span> <span class="n">ColorScheme</span><span class="p">.</span><span class="n">fromSeed</span><span class="p">(</span><span class="nl">seedColor:</span> <span class="n">Colors</span><span class="p">.</span><span class="n">deepPurple</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">useMaterial3:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">routeInformationParser:</span> <span class="n">CustomRouteInformationParser</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">routerDelegate:</span> <span class="n">CustomRouterDelegate</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">CustomRouteInformationParser</span> <span class="kd">extends</span> <span class="n">RouteInformationParser</span><span class="o">&lt;</span><span class="n">RouteSettings</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Future</span><span class="o">&lt;</span><span class="n">RouteSettings</span><span class="o">&gt;</span> <span class="n">parseRouteInformation</span><span class="p">(</span><span class="n">RouteInformation</span> <span class="n">routeInformation</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">routeInformation</span><span class="p">.</span><span class="n">uri</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">String</span> <span class="n">location</span> <span class="o">=</span> <span class="n">Uri</span><span class="p">.</span><span class="n">decodeComponent</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="n">toString</span><span class="p">());</span> <span class="c1">// == uri.toString
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;CustomRouteInformationParser-&gt;parseRouteInformation：</span><span class="si">$</span><span class="n">location</span><span class="s1">&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 这里只对移动端做了路由解析，例如：&#34;/&#34;、&#34;/secondPage&#34;这样的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 如果要适配Web端，这里路由解析不会那么简单，例如：&#34;/details/3&#34;这样的地址，这段path后面的3可以是传给详情页面的ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 所以在本案例中，Web端通过地址栏输入地址来跳转到要创建的新页面或者点击浏览器前进后退按钮时，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 这里RouteSettings因为没有传入参数，此时会导致跳转后的页面获取不了参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">final</span> <span class="n">RouteSettings</span> <span class="n">routeSettings</span> <span class="o">=</span> <span class="n">RouteSettings</span><span class="p">(</span><span class="nl">name:</span> <span class="n">uri</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isEmpty</span> <span class="o">?</span> <span class="s1">&#39;/&#39;</span> <span class="o">:</span> <span class="n">uri</span><span class="p">.</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SynchronousFuture</span><span class="o">&lt;</span><span class="n">RouteSettings</span><span class="o">&gt;</span><span class="p">(</span><span class="n">routeSettings</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">RouteInformation</span><span class="o">?</span> <span class="n">restoreRouteInformation</span><span class="p">(</span><span class="n">RouteSettings</span> <span class="n">configuration</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;CustomRouteInformationParser-&gt;restoreRouteInformation：</span><span class="si">${</span><span class="n">configuration</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">RouteInformation</span><span class="p">(</span><span class="nl">uri:</span> <span class="n">Uri</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">configuration</span><span class="p">.</span><span class="n">name</span><span class="o">!</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">CustomRouterDelegate</span> <span class="kd">extends</span> <span class="n">RouterDelegate</span><span class="o">&lt;</span><span class="n">RouteSettings</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">with</span> <span class="n">ChangeNotifier</span><span class="p">,</span> <span class="n">PopNavigatorRouterDelegateMixin</span><span class="o">&lt;</span><span class="n">RouteSettings</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">_PagesHandler</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">CustomRouterDelegate</span><span class="p">()</span> <span class="o">:</span> <span class="n">navigatorKey</span> <span class="o">=</span> <span class="n">GlobalKey</span><span class="o">&lt;</span><span class="n">NavigatorState</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">NavigatorHelper</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="p">..</span><span class="n">registerOnJumpListener</span><span class="p">((</span><span class="n">RouteSettings</span> <span class="n">routeSettings</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;跳转回调：</span><span class="si">$</span><span class="n">routeSettings</span><span class="s1">&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_routeSettings</span> <span class="o">=</span> <span class="n">routeSettings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_updatePages</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">})</span>
</span></span><span class="line"><span class="cl">      <span class="p">..</span><span class="n">registerOnRoutePopListener</span><span class="p">(</span><span class="n">_onRoutePop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 问题：Hot Reload时，_pages为空，导致报错：The Navigator.pages must not be empty to use the Navigator.pages API
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// bug位置：NavigatorState-&gt;initState
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 最初fix方案：当_pages为空时，给_pages赋值为const &lt;Page&lt;dynamic&gt;&gt;[]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 但是产生新问题：Hot Reload时，_pages为空，导致报错：Navigator.onGenerateRoute was null, but the route named
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// bug位置：NavigatorState-&gt;restoreState-&gt;defaultGenerateInitialRoutes-&gt;_routeNamed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 最终fix：在NavigatorState-&gt;initState执行之前，给_pages一个初始值即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_pages</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">_buildPage</span><span class="p">(</span><span class="nl">name:</span> <span class="n">Routes</span><span class="p">.</span><span class="n">rootPage</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">Object</span><span class="o">?</span> <span class="n">_result</span><span class="p">;</span> <span class="c1">// 从栈顶页面返回的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">_onRoutePop</span><span class="p">([</span><span class="kt">Object</span><span class="o">?</span> <span class="n">result</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">popRoute</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">List</span><span class="o">&lt;</span><span class="n">Page</span><span class="o">&gt;</span> <span class="n">_pages</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">RouteSettings</span> <span class="n">_routeSettings</span> <span class="o">=</span> <span class="kd">const</span> <span class="n">RouteSettings</span><span class="p">(</span><span class="nl">name:</span> <span class="n">Routes</span><span class="p">.</span><span class="n">rootPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;CustomRouterDelegate-&gt;build&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Navigator</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">key:</span> <span class="n">navigatorKey</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 问题：如果_pages用final修饰，会导致oldWidget.pages != widget.pages判断不成立，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// 从而无法执行_updatePages方法，也就触发不了路由栈映射，所以页面UI就无法跳转。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// bug位置：NavigatorState-&gt;didUpdateWidget
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// fix：在每次build时，这里的_pages引用需要不相等，也就是要创建一个_pages新对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nl">pages:</span> <span class="n">_pages</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">onPopPage:</span> <span class="n">_onPopPage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">_onPopPage</span><span class="p">(</span><span class="n">Route</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">route</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;CustomRouterDelegate-&gt;_onPopPage&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">route</span><span class="p">.</span><span class="n">didPop</span><span class="p">(</span><span class="n">result</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">_routeSettings</span> <span class="o">=</span> <span class="n">_pages</span><span class="p">[</span><span class="n">_pages</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="m">2</span><span class="p">];</span> <span class="c1">// 前一个页面的_routeSettings
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_updatePages</span><span class="p">(</span><span class="nl">pop:</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_result</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">NavigatorHelper</span><span class="p">().</span><span class="n">notifyRoutePop</span><span class="p">(</span><span class="n">_routeSettings</span><span class="p">,</span> <span class="n">_result</span><span class="o">!</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">_result</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">GlobalKey</span><span class="o">&lt;</span><span class="n">NavigatorState</span><span class="o">&gt;?</span> <span class="n">navigatorKey</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">RouteSettings</span><span class="o">?</span> <span class="kd">get</span> <span class="n">currentConfiguration</span> <span class="o">=&gt;</span> <span class="n">_routeSettings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">setNewRoutePath</span><span class="p">(</span><span class="n">RouteSettings</span> <span class="n">configuration</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;CustomRouterDelegate-&gt;setNewRoutePath: </span><span class="si">${</span><span class="n">configuration</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_routeSettings</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_updatePages</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SynchronousFuture</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">_updatePages</span><span class="p">({</span><span class="kt">bool</span> <span class="n">pop</span> <span class="o">=</span> <span class="kc">false</span><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Page</span><span class="o">&gt;</span> <span class="n">tempPages</span> <span class="o">=</span> <span class="p">[...</span><span class="n">_pages</span><span class="p">];</span> <span class="c1">// 用副本处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">pop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">tempPages</span><span class="p">.</span><span class="n">removeLast</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">_getCurPageIndex</span><span class="p">(</span><span class="n">tempPages</span><span class="p">,</span> <span class="n">_routeSettings</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="m">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">tempPages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">is</span> <span class="n">MaterialPage</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">MaterialPage</span> <span class="n">materialPage</span> <span class="o">=</span> <span class="n">tempPages</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">as</span> <span class="n">MaterialPage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;将</span><span class="si">${</span><span class="n">materialPage</span><span class="p">.</span><span class="n">child</span><span class="si">}</span><span class="s1">页面之上的所有页面进行出栈&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 这里可根据实际情况处理，这里给个一般方案：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 要打开的页面在栈中已存在，则将该页面之上的所有页面进行出栈
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">tempPages</span> <span class="o">=</span> <span class="n">tempPages</span><span class="p">.</span><span class="n">sublist</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="m">1</span><span class="p">);</span> <span class="c1">// [0, index]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Page</span> <span class="n">newPage</span> <span class="o">=</span> <span class="n">_buildPage</span><span class="p">(</span><span class="nl">name:</span> <span class="n">_routeSettings</span><span class="p">.</span><span class="n">name</span><span class="o">!</span><span class="p">,</span> <span class="nl">arguments:</span> <span class="n">_routeSettings</span><span class="p">.</span><span class="n">arguments</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">newPage</span> <span class="k">is</span> <span class="n">MaterialPage</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;创建新页面：</span><span class="si">${</span><span class="n">newPage</span><span class="p">.</span><span class="n">child</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">tempPages</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">newPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">NavigatorHelper</span><span class="p">().</span><span class="n">notifyRouteChange</span><span class="p">(</span><span class="n">_pages</span><span class="p">,</span> <span class="n">tempPages</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">_pages</span> <span class="o">=</span> <span class="n">tempPages</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Widget</span><span class="o">&gt;</span> <span class="n">widgets</span> <span class="o">=</span> <span class="n">_pages</span><span class="p">.</span><span class="n">whereType</span><span class="o">&lt;</span><span class="n">MaterialPage</span><span class="o">&gt;</span><span class="p">().</span><span class="n">map</span><span class="p">((</span><span class="n">page</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">page</span><span class="p">.</span><span class="n">child</span><span class="p">).</span><span class="n">toList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;此时路由栈：</span><span class="si">$</span><span class="n">widgets</span><span class="s1">&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">notifyListeners</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">/// Pages处理相关方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">mixin</span> <span class="n">_PagesHandler</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">_getCurPageIndex</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Page</span><span class="o">&gt;</span> <span class="n">pages</span><span class="p">,</span> <span class="n">RouteSettings</span> <span class="n">routeSettings</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pages</span><span class="p">.</span><span class="n">indexWhere</span><span class="p">((</span><span class="n">page</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">page</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">routeSettings</span><span class="p">.</span><span class="n">name</span><span class="p">);</span> <span class="c1">// 找不到返回-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Page</span> <span class="n">_buildPage</span><span class="p">({</span><span class="kd">required</span> <span class="kt">String</span> <span class="n">name</span><span class="p">,</span> <span class="kt">Object</span><span class="o">?</span> <span class="n">arguments</span><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">MaterialPage</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">_buildWidget</span><span class="p">(</span><span class="nl">name:</span> <span class="n">name</span><span class="p">,</span> <span class="nl">arguments:</span> <span class="n">arguments</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">key:</span> <span class="n">ValueKey</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">name:</span> <span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">arguments:</span> <span class="n">arguments</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">_buildWidget</span><span class="p">({</span><span class="kd">required</span> <span class="kt">String</span> <span class="n">name</span><span class="p">,</span> <span class="kt">Object</span><span class="o">?</span> <span class="n">arguments</span><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">dynamic</span> <span class="n">widgetBuilder</span> <span class="o">=</span> <span class="n">Routes</span><span class="p">.</span><span class="n">routeMap</span><span class="p">[</span><span class="n">name</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">widgetBuilder</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kd">const</span> <span class="n">UnknownPage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">arguments</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">widgetBuilder</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">widgetBuilder</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nl">arguments:</span> <span class="n">arguments</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">/// 路由表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">class</span> <span class="nc">Routes</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">static</span> <span class="kd">const</span> <span class="kt">String</span> <span class="n">rootPage</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">static</span> <span class="kd">const</span> <span class="kt">String</span> <span class="n">secondPage</span> <span class="o">=</span> <span class="s1">&#39;/secondPage&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">static</span> <span class="kd">const</span> <span class="kt">String</span> <span class="n">thirdPage</span> <span class="o">=</span> <span class="s1">&#39;/thirdPage&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">static</span> <span class="kd">var</span> <span class="n">routeMap</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nl">rootPage:</span> <span class="p">(</span><span class="kt">String</span> <span class="n">name</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kd">const</span> <span class="n">HomePage</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="nl">secondPage:</span> <span class="p">(</span><span class="kt">String</span> <span class="n">name</span><span class="p">,</span> <span class="p">{</span><span class="kt">Object</span><span class="o">?</span> <span class="n">arguments</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="n">SecondPage</span><span class="p">(</span><span class="nl">arguments:</span> <span class="n">arguments</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="nl">thirdPage:</span> <span class="p">(</span><span class="kt">String</span> <span class="n">name</span><span class="p">,</span> <span class="p">{</span><span class="kt">Object</span><span class="o">?</span> <span class="n">arguments</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="n">ThirdPage</span><span class="p">(</span><span class="nl">arguments:</span> <span class="n">arguments</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">NavigatorHelper</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">static</span> <span class="kd">final</span> <span class="n">NavigatorHelper</span> <span class="n">_singleton</span> <span class="o">=</span> <span class="n">NavigatorHelper</span><span class="p">.</span><span class="n">_internal</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">NavigatorHelper</span><span class="p">.</span><span class="n">_internal</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">factory</span> <span class="n">NavigatorHelper</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="n">_singleton</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">OnRouteJumpListener</span><span class="o">?</span> <span class="n">_onRouteJumpListener</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">registerOnJumpListener</span><span class="p">(</span><span class="n">OnRouteJumpListener</span> <span class="n">onRouteJumpListener</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_onRouteJumpListener</span> <span class="o">=</span> <span class="n">onRouteJumpListener</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">pushNamed</span><span class="p">({</span><span class="kd">required</span> <span class="kt">String</span> <span class="n">name</span><span class="p">,</span> <span class="kt">Object</span><span class="o">?</span> <span class="n">arguments</span><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_onRouteJumpListener</span><span class="o">?</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">RouteSettings</span><span class="p">(</span><span class="nl">name:</span> <span class="n">name</span><span class="p">,</span> <span class="nl">arguments:</span> <span class="n">arguments</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="kt">String</span><span class="p">,</span> <span class="n">OnRouteChangeListener</span><span class="o">&gt;</span> <span class="n">onRouteChangeListeners</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">registerOnRouteChangeListener</span><span class="p">(</span><span class="kt">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">OnRouteChangeListener</span> <span class="n">onRouteChangeListener</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">onRouteChangeListeners</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">onRouteChangeListener</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">unregisterOnRouteChangeListener</span><span class="p">(</span><span class="kt">String</span> <span class="n">name</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">onRouteChangeListeners</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">RouteSettings</span><span class="o">?</span> <span class="n">previous</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">/// 遗憾之处：新建Page的onResume无法监听，因为notifyRouteChange方法先于
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// 新建Page的initState方法执行，所以新建Page还没注册OnRouteChangeListeners
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// fix：SchedulerBinding.instance.addPostFrameCallback
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">/// 但是，当页面很复杂并且渲染出现丢帧时，不知道此处回调是否在build方法之后执行，如果不在，则此处该处理无意义
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="n">notifyRouteChange</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Page</span><span class="o">&gt;</span> <span class="n">previousPages</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Page</span><span class="o">&gt;</span> <span class="n">currentPages</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">previousPages</span> <span class="o">==</span> <span class="n">currentPages</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 此方法不请求新帧。如果帧已经在进行中并且帧后回调的执行尚未开始，则注册的回调将在当前帧结束时执行。否则，注册的回调将在下一帧之后执行（无论何时，如果有的话）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 帧后回调无法取消注册。它们只被调用一次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SchedulerBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">addPostFrameCallback</span><span class="p">((</span><span class="n">timeStamp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;分发RouteChange回调：</span><span class="si">$</span><span class="n">onRouteChangeListeners</span><span class="s1">&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">onRouteChangeListeners</span><span class="p">.</span><span class="n">forEach</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">previous</span><span class="o">?</span><span class="p">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">key</span> <span class="o">&amp;&amp;</span> <span class="n">currentPages</span><span class="p">.</span><span class="n">last</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">value</span><span class="p">(</span><span class="n">RoutePageStatus</span><span class="p">.</span><span class="n">resume</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">previous</span><span class="o">?</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">key</span> <span class="o">&amp;&amp;</span> <span class="n">currentPages</span><span class="p">.</span><span class="n">last</span><span class="p">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">value</span><span class="p">(</span><span class="n">RoutePageStatus</span><span class="p">.</span><span class="n">pause</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="n">previous</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">          <span class="n">RouteSettings</span><span class="p">(</span><span class="nl">name:</span> <span class="n">currentPages</span><span class="p">.</span><span class="n">last</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="nl">arguments:</span> <span class="n">currentPages</span><span class="p">.</span><span class="n">last</span><span class="p">.</span><span class="n">arguments</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">OnRoutePopListener</span><span class="o">?</span> <span class="n">_onRoutePopListener</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">registerOnRoutePopListener</span><span class="p">(</span><span class="n">OnRoutePopListener</span> <span class="n">onRoutePopListener</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_onRoutePopListener</span> <span class="o">=</span> <span class="n">onRoutePopListener</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">pop</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="kt">Object</span><span class="o">?&gt;</span><span class="p">([</span><span class="n">T</span><span class="o">?</span> <span class="n">result</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_onRoutePopListener</span><span class="o">?</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="kt">String</span><span class="p">,</span> <span class="n">OnRoutePopListener</span><span class="o">&gt;</span> <span class="n">_onRoutePopListeners</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">registerOnRoutePopListenerForResult</span><span class="p">(</span><span class="kt">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">OnRoutePopListener</span> <span class="n">onRoutePopListener</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_onRoutePopListeners</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">onRoutePopListener</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">unregisterOnRoutePopListenerForResult</span><span class="p">(</span><span class="kt">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_onRoutePopListeners</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">notifyRoutePop</span><span class="p">(</span><span class="n">RouteSettings</span> <span class="n">settings</span><span class="p">,</span> <span class="kt">Object</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_onRoutePopListeners</span><span class="p">.</span><span class="n">forEach</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">settings</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="n">value</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">typedef</span> <span class="n">OnRouteJumpListener</span> <span class="o">=</span> <span class="kt">void</span> <span class="n">Function</span><span class="p">(</span><span class="n">RouteSettings</span> <span class="n">routeSettings</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">typedef</span> <span class="n">OnRouteChangeListener</span> <span class="o">=</span> <span class="kt">void</span> <span class="n">Function</span><span class="p">(</span><span class="n">RoutePageStatus</span> <span class="n">routePageStatus</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">enum</span> <span class="n">RoutePageStatus</span> <span class="p">{</span> <span class="n">resume</span><span class="p">,</span> <span class="n">pause</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">typedef</span> <span class="n">OnRoutePopListener</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="kt">Object</span><span class="o">?&gt;</span> <span class="o">=</span> <span class="kt">void</span> <span class="n">Function</span><span class="p">([</span><span class="n">T</span><span class="o">?</span> <span class="n">result</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">HomePage</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">HomePage</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">State</span><span class="o">&lt;</span><span class="n">HomePage</span><span class="o">&gt;</span> <span class="n">createState</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="n">_HomePageState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">_HomePageState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">HomePage</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">initState</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">initState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;HomePage-&gt;initState&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">NavigatorHelper</span><span class="p">().</span><span class="n">registerOnRouteChangeListener</span><span class="p">(</span><span class="n">Routes</span><span class="p">.</span><span class="n">rootPage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">RoutePageStatus</span> <span class="n">routePageStatus</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">routePageStatus</span> <span class="o">==</span> <span class="n">RoutePageStatus</span><span class="p">.</span><span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;HomePage-&gt;onResume&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">routePageStatus</span> <span class="o">==</span> <span class="n">RoutePageStatus</span><span class="p">.</span><span class="n">pause</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;HomePage-&gt;onPause&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">NavigatorHelper</span><span class="p">().</span><span class="n">registerOnRoutePopListenerForResult</span><span class="p">(</span><span class="n">Routes</span><span class="p">.</span><span class="n">rootPage</span><span class="p">,</span> <span class="p">([</span><span class="n">result</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mounted</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">ScaffoldMessenger</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">..</span><span class="n">removeCurrentSnackBar</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">..</span><span class="n">showSnackBar</span><span class="p">(</span><span class="n">SnackBar</span><span class="p">(</span><span class="nl">content:</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">$</span><span class="n">result</span><span class="s1">&#39;</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">dispose</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">NavigatorHelper</span><span class="p">().</span><span class="n">unregisterOnRouteChangeListener</span><span class="p">(</span><span class="n">Routes</span><span class="p">.</span><span class="n">rootPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">NavigatorHelper</span><span class="p">().</span><span class="n">unregisterOnRoutePopListenerForResult</span><span class="p">(</span><span class="n">Routes</span><span class="p">.</span><span class="n">rootPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;HomePage-&gt;build&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">appBar:</span> <span class="n">AppBar</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">backgroundColor:</span> <span class="n">Theme</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">inversePrimary</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">title:</span> <span class="kd">const</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;HomePage&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">body:</span> <span class="n">Center</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">child:</span> <span class="n">OutlinedButton</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nl">onPressed:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">NavigatorHelper</span><span class="p">().</span><span class="n">pushNamed</span><span class="p">(</span><span class="nl">name:</span> <span class="n">Routes</span><span class="p">.</span><span class="n">secondPage</span><span class="p">,</span> <span class="nl">arguments:</span> <span class="m">20</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="nl">child:</span> <span class="kd">const</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;带参数跳转SecondPage&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">SecondPage</span> <span class="kd">extends</span> <span class="n">StatefulWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">Object</span><span class="o">?</span> <span class="n">arguments</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">SecondPage</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">arguments</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">State</span><span class="o">&lt;</span><span class="n">SecondPage</span><span class="o">&gt;</span> <span class="n">createState</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="n">_SecondPageState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">_SecondPageState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">SecondPage</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">initState</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">initState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;SecondPage-&gt;initState&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">NavigatorHelper</span><span class="p">().</span><span class="n">registerOnRouteChangeListener</span><span class="p">(</span><span class="n">Routes</span><span class="p">.</span><span class="n">secondPage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">RoutePageStatus</span> <span class="n">routePageStatus</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">routePageStatus</span> <span class="o">==</span> <span class="n">RoutePageStatus</span><span class="p">.</span><span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;SecondPage-&gt;onResume&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">routePageStatus</span> <span class="o">==</span> <span class="n">RoutePageStatus</span><span class="p">.</span><span class="n">pause</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;SecondPage-&gt;onPause&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="n">NavigatorHelper</span><span class="p">().</span><span class="n">registerOnRoutePopListenerForResult</span><span class="p">(</span><span class="n">Routes</span><span class="p">.</span><span class="n">secondPage</span><span class="p">,</span> <span class="p">([</span><span class="n">result</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mounted</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">ScaffoldMessenger</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">..</span><span class="n">removeCurrentSnackBar</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">..</span><span class="n">showSnackBar</span><span class="p">(</span><span class="n">SnackBar</span><span class="p">(</span><span class="nl">content:</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">$</span><span class="n">result</span><span class="s1">&#39;</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">dispose</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">NavigatorHelper</span><span class="p">().</span><span class="n">unregisterOnRouteChangeListener</span><span class="p">(</span><span class="n">Routes</span><span class="p">.</span><span class="n">secondPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">NavigatorHelper</span><span class="p">().</span><span class="n">unregisterOnRoutePopListenerForResult</span><span class="p">(</span><span class="n">Routes</span><span class="p">.</span><span class="n">secondPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;SecondPage-&gt;build&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">itemCount</span> <span class="o">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">arguments</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">widget</span><span class="p">.</span><span class="n">arguments</span> <span class="k">is</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">itemCount</span> <span class="o">=</span> <span class="n">widget</span><span class="p">.</span><span class="n">arguments</span> <span class="o">as</span> <span class="kt">int</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">appBar:</span> <span class="n">AppBar</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">backgroundColor:</span> <span class="n">Theme</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">inversePrimary</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">title:</span> <span class="kd">const</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;SecondPage&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">body:</span> <span class="n">ListView</span><span class="p">.</span><span class="n">builder</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">itemBuilder:</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="n">ListTile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nl">title:</span> <span class="n">Text</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="s1">&#39;第</span><span class="si">$</span><span class="n">index</span><span class="s1">条&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nl">style:</span> <span class="kd">const</span> <span class="n">TextStyle</span><span class="p">(</span><span class="nl">fontSize:</span> <span class="m">24</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nl">trailing:</span> <span class="n">OutlinedButton</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="nl">onPressed:</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="n">NavigatorHelper</span><span class="p">().</span><span class="n">pop</span><span class="p">(</span><span class="m">999999</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="n">NavigatorHelper</span><span class="p">().</span><span class="n">pushNamed</span><span class="p">(</span><span class="nl">name:</span> <span class="n">Routes</span><span class="p">.</span><span class="n">thirdPage</span><span class="p">,</span> <span class="nl">arguments:</span> <span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nl">child:</span> <span class="n">index</span> <span class="o">==</span> <span class="m">0</span> <span class="o">?</span> <span class="kd">const</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;带参数999999返回HomePage&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="kd">const</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;带参数跳转ThirdPage&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nl">itemCount:</span> <span class="n">itemCount</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">ThirdPage</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">Object</span><span class="o">?</span> <span class="n">arguments</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">ThirdPage</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">arguments</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">debugPrint</span><span class="p">(</span><span class="s1">&#39;ThirdPage-&gt;build&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">appBar:</span> <span class="n">AppBar</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">backgroundColor:</span> <span class="n">Theme</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">inversePrimary</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">title:</span> <span class="kd">const</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;ThirdPage&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">body:</span> <span class="n">Center</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">child:</span> <span class="n">Column</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nl">mainAxisSize:</span> <span class="n">MainAxisSize</span><span class="p">.</span><span class="n">min</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nl">children:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">Text</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="s1">&#39;获取SecondPage的传参：</span><span class="si">$</span><span class="n">arguments</span><span class="s1">&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nl">style:</span> <span class="kd">const</span> <span class="n">TextStyle</span><span class="p">(</span><span class="nl">fontSize:</span> <span class="m">24</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="kd">const</span> <span class="n">SizedBox</span><span class="p">(</span><span class="nl">height:</span> <span class="m">10</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">OutlinedButton</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="nl">onPressed:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">NavigatorHelper</span><span class="p">().</span><span class="n">pushNamed</span><span class="p">(</span><span class="nl">name:</span> <span class="n">Routes</span><span class="p">.</span><span class="n">rootPage</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">              <span class="nl">child:</span> <span class="kd">const</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;返回首页&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="kd">const</span> <span class="n">SizedBox</span><span class="p">(</span><span class="nl">height:</span> <span class="m">10</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">OutlinedButton</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="nl">onPressed:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">NavigatorHelper</span><span class="p">().</span><span class="n">pop</span><span class="p">(</span><span class="m">888888</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">              <span class="nl">child:</span> <span class="kd">const</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;带参数666666返回SecondPage&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">UnknownPage</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="n">UnknownPage</span><span class="p">({</span><span class="k">super</span><span class="p">.</span><span class="n">key</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kd">const</span> <span class="n">ColoredBox</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">color:</span> <span class="n">Colors</span><span class="p">.</span><span class="n">redAccent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">Center</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">child:</span> <span class="n">Text</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="s1">&#39;未知页面&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nl">style:</span> <span class="n">TextStyle</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nl">fontSize:</span> <span class="m">24</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nl">color:</span> <span class="n">Colors</span><span class="p">.</span><span class="n">white</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="五源码分析">五、源码分析</h1>
<h2 id="51系统平台navigation信息传递">5.1、系统平台<em>Navigation</em>信息传递</h2>
<p>不禁让人联想到<em>WidgetsBinding</em>，因为它是<em>widgets layer</em>和<em>Flutter engine</em>之间的粘合剂，看下它的<em>initInstances</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">initInstances</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">super</span><span class="p">.</span><span class="n">initInstances</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">_instance</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 注册了用于在此通道上接收方法调用的回调
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 当系统平台触发导航操作时，例如点击Web端的前进按钮等，就会回调到_handleNavigationInvocation方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">SystemChannels</span><span class="p">.</span><span class="n">navigation</span><span class="p">.</span><span class="n">setMethodCallHandler</span><span class="p">(</span><span class="n">_handleNavigationInvocation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>WidgetsBinding</em>的 <em>_handleNavigationInvocation</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">Future</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">_handleNavigationInvocation</span><span class="p">(</span><span class="n">MethodCall</span> <span class="n">methodCall</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">switch</span> <span class="p">(</span><span class="n">methodCall</span><span class="p">.</span><span class="n">method</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 当系统希望删除当前路由时（例如，如果用户点击系统级后退按钮），就会调用它。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="s1">&#39;popRoute&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">handlePopRoute</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 当操作系统指示应用程序打开特定页面时，使用单个字符串参数调用它。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="s1">&#39;pushRoute&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">handlePushRoute</span><span class="p">(</span><span class="n">methodCall</span><span class="p">.</span><span class="n">arguments</span> <span class="o">as</span> <span class="kt">String</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 当操作系统指示应用程序打开特定页面时，将使用包含位置字符串和状态对象的Map来调用它。这些参数存储在Map中的键“location”和“state”下。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="s1">&#39;pushRouteInformation&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">_handlePushRouteInformation</span><span class="p">(</span><span class="n">methodCall</span><span class="p">.</span><span class="n">arguments</span> <span class="o">as</span> <span class="n">Map</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="p">,</span> <span class="kt">dynamic</span><span class="o">&gt;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">Future</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里以<em>handlePushRoute</em>方法为例，看下它的源码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">WidgetsBindingObserver</span><span class="o">&gt;</span> <span class="n">_observers</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">WidgetsBindingObserver</span><span class="o">&gt;</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">addObserver</span><span class="p">(</span><span class="n">WidgetsBindingObserver</span> <span class="n">observer</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">_observers</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">observer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">removeObserver</span><span class="p">(</span><span class="n">WidgetsBindingObserver</span> <span class="n">observer</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">_observers</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">observer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">protected</span>
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">mustCallSuper</span>
</span></span><span class="line"><span class="cl"><span class="n">Future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">handlePushRoute</span><span class="p">(</span><span class="kt">String</span> <span class="n">route</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 将route字符串转化为RouteInformation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">RouteInformation</span> <span class="n">routeInformation</span> <span class="o">=</span> <span class="n">RouteInformation</span><span class="p">(</span><span class="nl">uri:</span> <span class="n">Uri</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">route</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 遍历_observers，只要有对象注册了WidgetsBindingObserver，这里就会通过didPushRouteInformation方法分发RouteInformation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">WidgetsBindingObserver</span> <span class="n">observer</span> <span class="k">in</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">WidgetsBindingObserver</span><span class="o">&gt;</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">_observers</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="kd">await</span> <span class="n">observer</span><span class="p">.</span><span class="n">didPushRouteInformation</span><span class="p">(</span><span class="n">routeInformation</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>WidgetsBindingObserver</em>的<em>didPushRouteInformation</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">Future</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">didPushRouteInformation</span><span class="p">(</span><span class="n">RouteInformation</span> <span class="n">routeInformation</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">routeInformation</span><span class="p">.</span><span class="n">uri</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">didPushRoute</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">Uri</span><span class="p">.</span><span class="n">decodeComponent</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">Uri</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">path:</span> <span class="n">uri</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isEmpty</span> <span class="o">?</span> <span class="s1">&#39;/&#39;</span> <span class="o">:</span> <span class="n">uri</span><span class="p">.</span><span class="n">path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">queryParameters:</span> <span class="n">uri</span><span class="p">.</span><span class="n">queryParametersAll</span><span class="p">.</span><span class="n">isEmpty</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">uri</span><span class="p">.</span><span class="n">queryParametersAll</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">fragment:</span> <span class="n">uri</span><span class="p">.</span><span class="n">fragment</span><span class="p">.</span><span class="n">isEmpty</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">uri</span><span class="p">.</span><span class="n">fragment</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">).</span><span class="n">toString</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">Deprecated</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;Use didPushRouteInformation instead. &#39;</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;This feature was deprecated after v3.8.0-14.0.pre.&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Future</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">didPushRoute</span><span class="p">(</span><span class="kt">String</span> <span class="n">route</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">Future</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，在<em>WidgetsBindingObserver</em>的<em>didPushRouteInformation</em>方法中执行了<em>didPushRoute</em>方法，什么也没做。</p>
<p>其实这里的<em>didPushRouteInformation</em>方法由注册了<em>WidgetsBindingObserver</em>的对象去实现，这里是<em>PlatformRouteInformationProvider</em>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// PlatformRouteInformationProvider混入了WidgetsBindingObserver，ChangeNotifier
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">class</span> <span class="nc">PlatformRouteInformationProvider</span> <span class="kd">extends</span> <span class="n">RouteInformationProvider</span> <span class="kd">with</span> <span class="n">WidgetsBindingObserver</span><span class="p">,</span> <span class="n">ChangeNotifier</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">RouteInformation</span> <span class="kd">get</span> <span class="n">value</span> <span class="o">=&gt;</span> <span class="n">_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">RouteInformation</span> <span class="n">_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">RouteInformation</span> <span class="n">_valueInEngine</span> <span class="o">=</span> <span class="n">RouteInformation</span><span class="p">(</span><span class="nl">uri:</span> <span class="n">Uri</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">WidgetsBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">platformDispatcher</span><span class="p">.</span><span class="n">defaultRouteName</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">_platformReportsNewRouteInformation</span><span class="p">(</span><span class="n">RouteInformation</span> <span class="n">routeInformation</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_value</span> <span class="o">==</span> <span class="n">routeInformation</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 将RouteInformation缓存一下，后续通过_value可以获取
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_value</span> <span class="o">=</span> <span class="n">routeInformation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_valueInEngine</span> <span class="o">=</span> <span class="n">routeInformation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 这里非常关键，因为混入了ChangeNotifier，所以会触发addListener传入的VoidCallback回调
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 这里调用地方等下讲
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">notifyListeners</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 外部调用PlatformRouteInformationProvider的addListener方法时，就会注册WidgetsBindingObserver回调
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 这里调用地方等下讲
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">addListener</span><span class="p">(</span><span class="n">VoidCallback</span> <span class="n">listener</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hasListeners</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">WidgetsBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">addListener</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">removeListener</span><span class="p">(</span><span class="n">VoidCallback</span> <span class="n">listener</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">removeListener</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hasListeners</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">WidgetsBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">removeObserver</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Future</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">didPushRouteInformation</span><span class="p">(</span><span class="n">RouteInformation</span> <span class="n">routeInformation</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">hasListeners</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_platformReportsNewRouteInformation</span><span class="p">(</span><span class="n">routeInformation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>至此，系统<em>Navigation</em>信息传递给了<em>PlatformRouteInformationProvider</em>。</p>
<h2 id="52_materialappstate-的build方法">5.2、<em>_MaterialAppState</em> 的<em>build</em>方法</h2>
<p>从<em>MaterialApp</em>入手，因为它是一个<em>StatefulWidget</em>，所以看下 <em>_MaterialAppState</em> 的<em>build</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行_buildWidgetApp方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Widget</span> <span class="n">result</span> <span class="o">=</span> <span class="n">_buildWidgetApp</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">ScrollConfiguration</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">behavior:</span> <span class="n">widget</span><span class="p">.</span><span class="n">scrollBehavior</span> <span class="o">??</span> <span class="kd">const</span> <span class="n">MaterialScrollBehavior</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="nl">child:</span> <span class="n">HeroControllerScope</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">controller:</span> <span class="n">_heroController</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">result</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下 <em>_MaterialAppState</em> 的 <em>_buildWidgetApp</em> 方法，可以发现它根据 <em>_usesRouter</em> 来选择不同的<em>WidgetsApp</em>构造方法进行创建<em>WidgetsApp</em>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// _usesRouter表示是否使用Router，此处为true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="kd">get</span> <span class="n">_usesRouter</span> <span class="o">=&gt;</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerDelegate</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerConfig</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Widget</span> <span class="n">_buildWidgetApp</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_usesRouter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Router方式实现路由导航（声明式）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">WidgetsApp</span><span class="p">.</span><span class="n">router</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">key:</span> <span class="n">GlobalObjectKey</span> <span class="p">(</span><span class="k">this</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">routeInformationProvider:</span> <span class="n">widget</span><span class="p">.</span><span class="n">routeInformationProvider</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">routeInformationParser:</span> <span class="n">widget</span><span class="p">.</span><span class="n">routeInformationParser</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">routerDelegate:</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerDelegate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">routerConfig:</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">backButtonDispatcher:</span> <span class="n">widget</span><span class="p">.</span><span class="n">backButtonDispatcher</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 直接Navigator方式实现路由导航（命令式）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">WidgetsApp</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>先看下 <em>_WidgetsAppState</em> 的<em>initState</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">initState</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">super</span><span class="p">.</span><span class="n">initState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">_updateRouting</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下 <em>_WidgetsAppState</em> 的 <em>_updateRouting</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">String</span> <span class="kd">get</span> <span class="n">_initialRouteName</span> <span class="o">=&gt;</span> <span class="n">WidgetsBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">platformDispatcher</span><span class="p">.</span><span class="n">defaultRouteName</span> <span class="o">!=</span> <span class="n">Navigator</span><span class="p">.</span><span class="n">defaultRouteName</span>
</span></span><span class="line"><span class="cl">  <span class="o">?</span> <span class="n">WidgetsBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">platformDispatcher</span><span class="p">.</span><span class="n">defaultRouteName</span>
</span></span><span class="line"><span class="cl">  <span class="o">:</span> <span class="n">widget</span><span class="p">.</span><span class="n">initialRoute</span> <span class="o">??</span> <span class="n">WidgetsBinding</span><span class="p">.</span><span class="n">instance</span><span class="p">.</span><span class="n">platformDispatcher</span><span class="p">.</span><span class="n">defaultRouteName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 此处_usesRouterWithDelegates为true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="kd">get</span> <span class="n">_usesRouterWithDelegates</span> <span class="o">=&gt;</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerDelegate</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_updateRouting</span><span class="p">({</span><span class="n">WidgetsApp</span><span class="o">?</span> <span class="n">oldWidget</span><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_usesRouterWithDelegates</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">_usesNavigator</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_usesRouterWithConfig</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_clearNavigatorResource</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果没有传入routeInformationProvider，那么创建一个默认的PlatformRouteInformationProvider
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">routeInformationProvider</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">widget</span><span class="p">.</span><span class="n">routeInformationParser</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_defaultRouteInformationProvider</span> <span class="o">??=</span> <span class="n">PlatformRouteInformationProvider</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 此处创建的RouteInformation会赋值给PlatformRouteInformationProvider中的_value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nl">initialRouteInformation:</span> <span class="n">RouteInformation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// 设置初始路由_initialRouteName，一般为&#39;/&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="nl">uri:</span> <span class="n">Uri</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">_initialRouteName</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_defaultRouteInformationProvider</span><span class="o">?</span><span class="p">.</span><span class="n">dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">_defaultRouteInformationProvider</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果没有传入backButtonDispatcher，那么创建一个默认的RootBackButtonDispatcher
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">backButtonDispatcher</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_defaultBackButtonDispatcher</span> <span class="o">??=</span> <span class="n">RootBackButtonDispatcher</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_usesNavigator</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>再看下 <em>_WidgetsAppState</em> 的 <em>build</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// 此处_usesRouterWithDelegates为true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="kd">get</span> <span class="n">_usesRouterWithDelegates</span> <span class="o">=&gt;</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerDelegate</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="kd">get</span> <span class="n">_usesRouterWithConfig</span> <span class="o">=&gt;</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerConfig</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="kd">get</span> <span class="n">_usesNavigator</span> <span class="o">=&gt;</span> <span class="n">widget</span><span class="p">.</span><span class="n">home</span> <span class="o">!=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">    <span class="o">||</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">routes</span><span class="o">?</span><span class="p">.</span><span class="n">isNotEmpty</span> <span class="o">??</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">||</span> <span class="n">widget</span><span class="p">.</span><span class="n">onGenerateRoute</span> <span class="o">!=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">    <span class="o">||</span> <span class="n">widget</span><span class="p">.</span><span class="n">onUnknownRoute</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span><span class="o">?</span> <span class="n">routing</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">_usesRouterWithDelegates</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Router方式实现路由导航（声明式）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">routing</span> <span class="o">=</span> <span class="n">Router</span><span class="o">&lt;</span><span class="kt">Object</span><span class="o">&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">restorationScopeId:</span> <span class="s1">&#39;router&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">routeInformationProvider:</span> <span class="n">_effectiveRouteInformationProvider</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">routeInformationParser:</span> <span class="n">widget</span><span class="p">.</span><span class="n">routeInformationParser</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">routerDelegate:</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerDelegate</span><span class="o">!</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">backButtonDispatcher:</span> <span class="n">_effectiveBackButtonDispatcher</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_usesNavigator</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 直接Navigator方式实现路由导航（命令式）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">assert</span><span class="p">(</span><span class="n">_navigator</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">routing</span> <span class="o">=</span> <span class="n">FocusScope</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">debugLabel:</span> <span class="s1">&#39;Navigator Scope&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">autofocus:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">Navigator</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">clipBehavior:</span> <span class="n">Clip</span><span class="p">.</span><span class="n">none</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">restorationScopeId:</span> <span class="s1">&#39;nav&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">key:</span> <span class="n">_navigator</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">initialRoute:</span> <span class="n">_initialRouteName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onGenerateRoute:</span> <span class="n">_onGenerateRoute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onGenerateInitialRoutes:</span> <span class="n">widget</span><span class="p">.</span><span class="n">onGenerateInitialRoutes</span> <span class="o">==</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">          <span class="o">?</span> <span class="n">Navigator</span><span class="p">.</span><span class="n">defaultGenerateInitialRoutes</span>
</span></span><span class="line"><span class="cl">          <span class="o">:</span> <span class="p">(</span><span class="n">NavigatorState</span> <span class="n">navigator</span><span class="p">,</span> <span class="kt">String</span> <span class="n">initialRouteName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">widget</span><span class="p">.</span><span class="n">onGenerateInitialRoutes</span><span class="o">!</span><span class="p">(</span><span class="n">initialRouteName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nl">onUnknownRoute:</span> <span class="n">_onUnknownRoute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">observers:</span> <span class="n">widget</span><span class="p">.</span><span class="n">navigatorObservers</span><span class="o">!</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">reportsRouteUpdateToEngine:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_usesRouterWithConfig</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 带config的Router方式实现路由导航（声明式）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">routing</span> <span class="o">=</span> <span class="n">Router</span><span class="o">&lt;</span><span class="kt">Object</span><span class="o">&gt;</span><span class="p">.</span><span class="n">withConfig</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">restorationScopeId:</span> <span class="s1">&#39;router&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">config:</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerConfig</span><span class="o">!</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">RootRestorationScope</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">restorationId:</span> <span class="n">widget</span><span class="p">.</span><span class="n">restorationScopeId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">child:</span> <span class="n">SharedAppData</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">Shortcuts</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">debugLabel:</span> <span class="s1">&#39;&lt;Default WidgetsApp Shortcuts&gt;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">shortcuts:</span> <span class="n">widget</span><span class="p">.</span><span class="n">shortcuts</span> <span class="o">??</span> <span class="n">WidgetsApp</span><span class="p">.</span><span class="n">defaultShortcuts</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">child:</span> <span class="n">DefaultTextEditingShortcuts</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nl">child:</span> <span class="n">Actions</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">...</span>
</span></span><span class="line"><span class="cl">            <span class="nl">child:</span> <span class="n">FocusTraversalGroup</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="nl">policy:</span> <span class="n">ReadingOrderTraversalPolicy</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">              <span class="nl">child:</span> <span class="n">TapRegionSurface</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nl">child:</span> <span class="n">ShortcutRegistrar</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                  <span class="nl">child:</span> <span class="n">Localizations</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">locale:</span> <span class="n">appLocale</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">delegates:</span> <span class="n">_localizationsDelegates</span><span class="p">.</span><span class="n">toList</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 最后将包装多层的routing，放到这里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">child:</span> <span class="n">title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="p">),</span>
</span></span><span class="line"><span class="cl">              <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面已知道 <em>_WidgetsAppState</em> 的 <em>build</em> 方法中用到了<em>Router</em>，而<em>Router</em>是一个<em>StatefulWidget</em>，看下创建的 <em>_RouterState</em> 的<em>initState</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">initState</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">super</span><span class="p">.</span><span class="n">initState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// routeInformationProvider注册了监听，也就是routeInformationProvider内部执行notifyListeners方法时，_handleRouteInformationProviderNotification方法就会被回调
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">widget</span><span class="p">.</span><span class="n">routeInformationProvider</span><span class="o">?</span><span class="p">.</span><span class="n">addListener</span><span class="p">(</span><span class="n">_handleRouteInformationProviderNotification</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">widget</span><span class="p">.</span><span class="n">backButtonDispatcher</span><span class="o">?</span><span class="p">.</span><span class="n">addCallback</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="n">_handleBackButtonDispatcherNotification</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// routerDelegate注册了监听，也就是routerDelegate内部执行notifyListeners方法时，_handleRouterDelegateNotification方法就会被回调
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">widget</span><span class="p">.</span><span class="n">routerDelegate</span><span class="p">.</span><span class="n">addListener</span><span class="p">(</span><span class="n">_handleRouterDelegateNotification</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>再看下 <em>_RouterState</em> 的<em>build</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">UnmanagedRestorationScope</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">bucket:</span> <span class="n">bucket</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _RouterScope是一个InheritedWidget，外部可以获取它的属性routerState，比如Route的navigate方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">child:</span> <span class="n">_RouterScope</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">routeInformationProvider:</span> <span class="n">widget</span><span class="p">.</span><span class="n">routeInformationProvider</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">backButtonDispatcher:</span> <span class="n">widget</span><span class="p">.</span><span class="n">backButtonDispatcher</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">routeInformationParser:</span> <span class="n">widget</span><span class="p">.</span><span class="n">routeInformationParser</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">routerDelegate:</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerDelegate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 此处传入了routerState
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nl">routerState:</span> <span class="k">this</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">Builder</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Use a Builder so that the build method below will have a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// BuildContext that contains the _RouterScope. This also prevents
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// dependencies look ups in routerDelegate from rebuilding Router
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// widget that may result in re-parsing the route information.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 此处调用的是routerDelegate的build方法，也就是说只要Router通过setState更新UI，routerDelegate的build方法就会被调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nl">builder:</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerDelegate</span><span class="p">.</span><span class="n">build</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在上面实战中，<em>Navigator</em>定义在<em>routerDelegate</em>的<em>build</em>方法里。<em>Navigator</em>是一个<em>StatefulWidget</em>，看下它创建的 <em>NavigatorState</em> 的<em>initState</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">initState</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">super</span><span class="p">.</span><span class="n">initState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 初始化时，如果pages为空，就会抛出异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">pages</span> <span class="o">!=</span> <span class="kd">const</span> <span class="o">&lt;</span><span class="n">Page</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;&gt;</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// This navigator uses page API.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">pages</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">FlutterError</span><span class="p">.</span><span class="n">reportError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">FlutterErrorDetails</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nl">exception:</span> <span class="n">FlutterError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="s1">&#39;The Navigator.pages must not be empty to use the &#39;</span>
</span></span><span class="line"><span class="cl">              <span class="s1">&#39;Navigator.pages API&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="k">library</span><span class="o">:</span> <span class="s1">&#39;widget library&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nl">stack:</span> <span class="n">StackTrace</span><span class="p">.</span><span class="n">current</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">onPopPage</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果使用了pages，那么onPopPage也必须不为null，否则抛出异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">FlutterError</span><span class="p">.</span><span class="n">reportError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">FlutterErrorDetails</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nl">exception:</span> <span class="n">FlutterError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="s1">&#39;The Navigator.onPopPage must be provided to use the &#39;</span>
</span></span><span class="line"><span class="cl">              <span class="s1">&#39;Navigator.pages API&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="k">library</span><span class="o">:</span> <span class="s1">&#39;widget library&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nl">stack:</span> <span class="n">StackTrace</span><span class="p">.</span><span class="n">current</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}());</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>关于<em>Navigator</em>的更多细节，这里就不展开讲解了，可参考前言中提到的一文。</p>
<h2 id="53根布局路由信息解析">5.3、根布局路由信息解析</h2>
<p>当执行到 <em>_RouterState</em> 的<em>didChangeDependencies</em>方法，看下它的源码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">didChangeDependencies</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_routeParsePending</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析一
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">super</span><span class="p">.</span><span class="n">didChangeDependencies</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// super.didChangeDependencies可能已经解析了路由信息。如果didChangeDependencies是由状态恢复或首次构建触发的，则可能会发生这种情况。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// The super.didChangeDependencies may have parsed the route information.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// This can happen if the didChangeDependencies is triggered by state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// restoration or first build.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 分析二
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">routeInformationProvider</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">_routeParsePending</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_processRouteInformation</span><span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">routeInformationProvider</span><span class="o">!</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerDelegate</span><span class="p">.</span><span class="n">setNewRoutePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">_routeParsePending</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 分析三
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_maybeNeedToReportRouteInformation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>分析一：</p>
<p>因为 <em>_RouterState</em> 混入了<em>RestorationMixin</em>，所以执行<em>RestorationMixin</em>的<em>didChangeDependencies</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">didChangeDependencies</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">super</span><span class="p">.</span><span class="n">didChangeDependencies</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">RestorationBucket</span><span class="o">?</span> <span class="n">oldBucket</span> <span class="o">=</span> <span class="n">_bucket</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">bool</span> <span class="n">needsRestore</span> <span class="o">=</span> <span class="n">restorePending</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_currentParent</span> <span class="o">=</span> <span class="n">RestorationScope</span><span class="p">.</span><span class="n">maybeOf</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="kt">bool</span> <span class="n">didReplaceBucket</span> <span class="o">=</span> <span class="n">_updateBucketIfNecessary</span><span class="p">(</span><span class="nl">parent:</span> <span class="n">_currentParent</span><span class="p">,</span> <span class="nl">restorePending:</span> <span class="n">needsRestore</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行这里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">needsRestore</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_doRestore</span><span class="p">(</span><span class="n">oldBucket</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">didReplaceBucket</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">oldBucket</span> <span class="o">!=</span> <span class="n">_bucket</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">oldBucket</span><span class="o">?</span><span class="p">.</span><span class="n">dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>RestorationMixin</em>的 <em>_doRestore</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_doRestore</span><span class="p">(</span><span class="n">RestorationBucket</span><span class="o">?</span> <span class="n">oldBucket</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="n">restoreState</span><span class="p">(</span><span class="n">oldBucket</span><span class="p">,</span> <span class="n">_firstRestorePending</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">_firstRestorePending</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>RestorationMixin</em>的 <em>_doRestore</em> 方法中，执行了<em>restoreState</em>方法，该方法由子类 <em>_RouterState</em> 实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">restoreState</span><span class="p">(</span><span class="n">RestorationBucket</span><span class="o">?</span> <span class="n">oldBucket</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">initialRestore</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 注册RestorableProperty以进行状态恢复
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">registerForRestoration</span><span class="p">(</span><span class="n">_routeInformation</span><span class="p">,</span> <span class="s1">&#39;route&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 此处_routeInformation.value为null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">_routeInformation</span><span class="p">.</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">routeInformationParser</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_processRouteInformation</span><span class="p">(</span><span class="n">_routeInformation</span><span class="p">.</span><span class="n">value</span><span class="o">!</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerDelegate</span><span class="p">.</span><span class="n">setRestoredRoutePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">routeInformationProvider</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行这里，其中routeInformationProvider!.value已经在_WidgetsAppState的 _updateRouting方法中赋值了，后面则是routerDelegate的setInitialRoutePath方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_processRouteInformation</span><span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">routeInformationProvider</span><span class="o">!</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerDelegate</span><span class="p">.</span><span class="n">setInitialRoutePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下 <em>_RouterState</em> 的 <em>_processRouteInformation</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_processRouteInformation</span><span class="p">(</span><span class="n">RouteInformation</span> <span class="n">information</span><span class="p">,</span> <span class="n">ValueGetter</span><span class="o">&lt;</span><span class="n">_RouteSetter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">delegateRouteSetter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">_routeParsePending</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 此处_routeParsePending赋值为false，表示路由不需要延迟解析。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_routeParsePending</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_currentRouterTransaction</span> <span class="o">=</span> <span class="kt">Object</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行routeInformationParser的parseRouteInformationWithDependencies方法，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 该方法返回一个Future，等到该Future执行完成，就会执行_processParsedRouteInformation方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">widget</span><span class="p">.</span><span class="n">routeInformationParser</span><span class="o">!</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">parseRouteInformationWithDependencies</span><span class="p">(</span><span class="n">information</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">then</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_processParsedRouteInformation</span><span class="p">(</span><span class="n">_currentRouterTransaction</span><span class="p">,</span> <span class="n">delegateRouteSetter</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>RouteInformationParser</em>的<em>parseRouteInformationWithDependencies</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">Future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">parseRouteInformationWithDependencies</span><span class="p">(</span><span class="n">RouteInformation</span> <span class="n">routeInformation</span><span class="p">,</span> <span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">parseRouteInformation</span><span class="p">(</span><span class="n">routeInformation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>RouteInformationParser</em>的<em>parseRouteInformationWithDependencies</em>方法中，执行了<em>parseRouteInformation</em>方法，该方法由子类<em>CustomRouteInformationParser</em>实现。</p>
<p>至此，<em>CustomRouteInformationParser</em>的<em>parseRouteInformation</em>方法被触发，上面实战示例中返回了一个<em>SynchronousFuture</em>，表示同步等待结果。</p>
<p>继续看下 <em>_RouterState</em> 的 <em>_processParsedRouteInformation</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="c1">// 此处delegateRouteSetter为routerDelegate的setInitialRoutePath方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">_RouteSetter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">_processParsedRouteInformation</span><span class="p">(</span><span class="kt">Object</span><span class="o">?</span> <span class="n">transaction</span><span class="p">,</span> <span class="n">ValueGetter</span><span class="o">&lt;</span><span class="n">_RouteSetter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">delegateRouteSetter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="n">T</span> <span class="n">data</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_currentRouterTransaction</span> <span class="o">!=</span> <span class="n">transaction</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 等待routerDelegate的setInitialRoutePath方法执行完成
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">await</span> <span class="n">delegateRouteSetter</span><span class="p">()(</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_currentRouterTransaction</span> <span class="o">==</span> <span class="n">transaction</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 执行这里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">_rebuild</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>RouterDelegate</em>的<em>setInitialRoutePath</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">Future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">setInitialRoutePath</span><span class="p">(</span><span class="n">T</span> <span class="n">configuration</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">setNewRoutePath</span><span class="p">(</span><span class="n">configuration</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>RouterDelegate</em>的<em>setInitialRoutePath</em>方法中，执行了<em>setNewRoutePath</em>方法，该方法由子类<em>CustomRouterDelegate</em>实现。</p>
<p>至此，<em>CustomRouterDelegate</em>的<em>setNewRoutePath</em>方法被触发，上面实战示例中返回了一个<em>SynchronousFuture</em>，表示同步等待结果。</p>
<p>在上面实战示例中，<em>CustomRouterDelegate</em>的<em>setNewRoutePath</em>方法里执行了 <em>_updatePages</em> 方法，在 <em>_updatePages</em> 方法中又会执行<em>notifyListeners</em>方法。</p>
<p>之前讲的 <em>_RouterState</em> 的<em>initState</em>中，<em>routerDelegate</em>添加了监听回调方法 <em>_handleRouterDelegateNotification</em>，此时就会执行该方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_handleRouterDelegateNotification</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 此处触发Router的UI更新，那么CustomRouterDelegate的build方法也会更新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span><span class="cm">/* routerDelegate wants to rebuild */</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="n">_maybeNeedToReportRouteInformation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <em>_RouterState</em> 的 <em>_handleRouterDelegateNotification</em> 方法中，执行了 <em>_maybeNeedToReportRouteInformation</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_maybeNeedToReportRouteInformation</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 这里讲RouteInformation赋值给_routeInformation.value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_routeInformation</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">_retrieveNewRouteInformation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">_currentIntentionToReport</span> <span class="o">??=</span> <span class="n">RouteInformationReportingType</span><span class="p">.</span><span class="n">none</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">_scheduleRouteInformationReportingTask</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下 <em>_RouterState</em> 的 <em>_maybeNeedToReportRouteInformation</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">RouteInformation</span><span class="o">?</span> <span class="n">_retrieveNewRouteInformation</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行了routerDelegate的currentConfiguration，获取当前配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">T</span><span class="o">?</span> <span class="n">configuration</span> <span class="o">=</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerDelegate</span><span class="p">.</span><span class="n">currentConfiguration</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">configuration</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行routeInformationParser的restoreRouteInformation方法，返回一个RouteInformation，这是第一次执行restoreRouteInformation方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">widget</span><span class="p">.</span><span class="n">routeInformationParser</span><span class="o">?</span><span class="p">.</span><span class="n">restoreRouteInformation</span><span class="p">(</span><span class="n">configuration</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>等待<em>routerDelegate</em>的<em>setInitialRoutePath</em>方法执行完成，就会执行<em>then</em>之后的方法，也就是 <em>_processParsedRouteInformation</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">_RouteSetter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">_processParsedRouteInformation</span><span class="p">(</span><span class="kt">Object</span><span class="o">?</span> <span class="n">transaction</span><span class="p">,</span> <span class="n">ValueGetter</span><span class="o">&lt;</span><span class="n">_RouteSetter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">delegateRouteSetter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="n">T</span> <span class="n">data</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_currentRouterTransaction</span> <span class="o">!=</span> <span class="n">transaction</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">await</span> <span class="n">delegateRouteSetter</span><span class="p">()(</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_currentRouterTransaction</span> <span class="o">==</span> <span class="n">transaction</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 执行这里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">_rebuild</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>继续看下 <em>_RouterState</em> 的 <em>_rebuild</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">Future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">_rebuild</span><span class="p">([</span><span class="kt">void</span> <span class="n">value</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 此处触发Router的UI更新，那么CustomRouterDelegate的build方法也会更新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span><span class="cm">/* routerDelegate is ready to rebuild */</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="n">_maybeNeedToReportRouteInformation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">SynchronousFuture</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 <em>_RouterState</em> 的 <em>_maybeNeedToReportRouteInformation</em> 方法中，接着又会执行<em>routeInformationParser</em>的<em>restoreRouteInformation</em>方法，这是第二次执行。</p>
<p>分析二：</p>
<p>回到 <em>_RouterState</em> 的<em>didChangeDependencies</em>方法，前面分析一<em>super.didChangeDependencies</em>中已经解析了路由信息，并且 <em>_routeParsePending</em> 被赋值为<em>false</em>，所以这里<em>if</em>条件不成立。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">routeInformationProvider</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">_routeParsePending</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">_processRouteInformation</span><span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">routeInformationProvider</span><span class="o">!</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">widget</span><span class="p">.</span><span class="n">routerDelegate</span><span class="p">.</span><span class="n">setNewRoutePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>分析三：</p>
<p>回到 <em>_RouterState</em> 的<em>didChangeDependencies</em>方法，继续执行了 <em>_RouterState</em> 的 <em>_maybeNeedToReportRouteInformation</em> 方法，这与分析一中的逻辑一样，也就是说会再次执行<em>routeInformationParser</em>的<em>restoreRouteInformation</em>方法，这是第三次执行。</p>
<h2 id="54navigator中pages转化">5.4、<em>Navigator</em>中<em>pages</em>转化</h2>
<p>当<em>CustomRouterDelegate</em>的<em>build</em>被触发后，因为此时<em>pages</em>发生了变化，所以<em>Navigator</em>会执行<em>NavigatorState</em>的<em>didUpdateWidget</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">didUpdateWidget</span><span class="p">(</span><span class="n">Navigator</span> <span class="n">oldWidget</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">super</span><span class="p">.</span><span class="n">didUpdateWidget</span><span class="p">(</span><span class="n">oldWidget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">oldWidget</span><span class="p">.</span><span class="n">pages</span> <span class="o">!=</span> <span class="n">widget</span><span class="p">.</span><span class="n">pages</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">restorePending</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">pages</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">FlutterError</span><span class="p">.</span><span class="n">reportError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">FlutterErrorDetails</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nl">exception:</span> <span class="n">FlutterError</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="s1">&#39;The Navigator.pages must not be empty to use the &#39;</span>
</span></span><span class="line"><span class="cl">              <span class="s1">&#39;Navigator.pages API&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="k">library</span><span class="o">:</span> <span class="s1">&#39;widget library&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nl">stack:</span> <span class="n">StackTrace</span><span class="p">.</span><span class="n">current</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}());</span>
</span></span><span class="line"><span class="cl">    <span class="n">_updatePages</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Route进行重建
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">_RouteEntry</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">_history</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span><span class="p">.</span><span class="n">route</span><span class="p">.</span><span class="n">changedExternalState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>NavigatorState</em>的<em>didUpdateWidget</em>方法中，执行了 <em>_updatePages</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">_updatePages</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 这尝试将新页面列表 (widget.pages) 与旧 _RouteEntry(s) 列表 (_history) 进行比较，并生成新的 _RouteEntry(s) 列表作为新的 _history 列表。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 此方法大致遵循 RenderObjectElement.updateChildren 的相同轮廓。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// This attempts to diff the new pages list (widget.pages) with
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// the old _RouteEntry(s) list (_history), and produces a new list of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// _RouteEntry(s) to be the new list of _history. This method roughly
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// follows the same outline of RenderObjectElement.updateChildren.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 它尝试优化的情况是：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// The cases it tries to optimize for are:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//  - 旧列表为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//  - 新列表中的所有页面都可以匹配旧列表中的基于页面的路由，并且它们的顺序相同。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//  - 新列表中的所有页面都可以匹配旧列表中的基于页面的路由，并且它们的顺序相同。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//  - the old list is empty
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//  - All the pages in the new list can match the page-based routes in the old
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//    list, and their orders are the same.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//  - there is an insertion or removal of one or more page-based route in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//    only one place in the list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 如果带有键的基于页面的路由同时存在于两个列表中，则它将同步。没有密钥的基于页面的路由可能会同步，但不能保证。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// If a page-based route with a key is in both lists, it will be synced.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Page-based routes without keys might be synced but there is no guarantee.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 一般的做法是向后同步整个新列表，如下所示：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// The general approach is to sync the entire new list backwards, as follows:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 1. 从底部开始遍历列表，同步节点并记录无页路由，直到不再有匹配的节点。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 1. Walk the lists from the bottom, syncing nodes, and record pageless routes,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//    until you no longer have matching nodes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 2. 从顶部开始遍历列表，不同步节点，直到不再有匹配的节点。我们将在最后同步这些节点。我们现在不同步它们，因为我们想要从头到尾按顺序同步所有节点。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 2. Walk the lists from the top, without syncing nodes, until you no
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//    longer have matching nodes. We&#39;ll sync these nodes at the end. We
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//    don&#39;t sync them now because we want to sync all the nodes in order
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//    from beginning to end.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 此时，我们将新旧列表缩小到节点不再匹配的程度。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// At this point we narrowed the old and new lists to the point
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// where the nodes no longer match.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 3. 遍历旧列表的缩小部分以获取键列表。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 3. Walk the narrowed part of the old list to get the list of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//    keys.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 4. 向前移动新列表的缩小部分：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 4. Walk the narrowed part of the new list forwards:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//     * 为非键控项创建一个新的_RouteEntry，并为transitionDelegate记录它们。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//     * Create a new _RouteEntry for non-keyed items and record them for
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//       transitionDelegate.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//     * 将键控项与源同步（如果存在）。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//     * Sync keyed items with the source if it exists.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 5. 再次遍历旧列表的缩小部分以记录需要为transitionDelegate删除的_RouteEntry（s）以及无页路由。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 5. Walk the narrowed part of the old list again to records the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//    _RouteEntry(s), as well as pageless routes, needed to be removed for
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//    transitionDelegate.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 5. 再次走到列表顶部，同步节点并记录无页路由。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 5. Walk the top of the list again, syncing the nodes and recording
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//    pageless routes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 6. 使用transitionDelegate 明确决定 _RouteEntry(s) 如何在屏幕上过渡或过渡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 6. Use transitionDelegate for explicit decisions on how _RouteEntry(s)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//    transition in or off the screens.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 7. 将无页路由填回新历史记录中。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 7. Fill pageless routes back into the new history.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">needsExplicitDecision</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">newPagesBottom</span> <span class="o">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">oldEntriesBottom</span> <span class="o">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">newPagesTop</span> <span class="o">=</span> <span class="n">widget</span><span class="p">.</span><span class="n">pages</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">oldEntriesTop</span> <span class="o">=</span> <span class="n">_history</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span> <span class="n">newHistory</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">?</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;&gt;</span> <span class="n">pageRouteToPagelessRoutes</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">?</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;&gt;</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 更新列表底部。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Updates the bottom of the list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_RouteEntry</span><span class="o">?</span> <span class="n">previousOldPageRouteEntry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">oldEntriesBottom</span> <span class="o">&lt;=</span> <span class="n">oldEntriesTop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">_RouteEntry</span> <span class="n">oldEntry</span> <span class="o">=</span> <span class="n">_history</span><span class="p">[</span><span class="n">oldEntriesBottom</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">oldEntry</span><span class="p">.</span><span class="n">currentState</span> <span class="o">!=</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">disposed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 记录无页路由。最底部的无页路由将存储在 key = null 中。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Records pageless route. The bottom most pageless routes will be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stored in key = null.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oldEntry</span><span class="p">.</span><span class="n">pageBased</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span> <span class="n">pagelessRoutes</span> <span class="o">=</span> <span class="n">pageRouteToPagelessRoutes</span><span class="p">.</span><span class="n">putIfAbsent</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">previousOldPageRouteEntry</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">()</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">pagelessRoutes</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">oldEntry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">oldEntriesBottom</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">newPagesBottom</span> <span class="o">&gt;</span> <span class="n">newPagesTop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Page</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">newPage</span> <span class="o">=</span> <span class="n">widget</span><span class="p">.</span><span class="n">pages</span><span class="p">[</span><span class="n">newPagesBottom</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oldEntry</span><span class="p">.</span><span class="n">canUpdateFrom</span><span class="p">(</span><span class="n">newPage</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">previousOldPageRouteEntry</span> <span class="o">=</span> <span class="n">oldEntry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">oldEntry</span><span class="p">.</span><span class="n">route</span><span class="p">.</span><span class="n">_updateSettings</span><span class="p">(</span><span class="n">newPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">newHistory</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">oldEntry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">newPagesBottom</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">oldEntriesBottom</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span> <span class="n">unattachedPagelessRoutes</span><span class="o">=&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 扫描列表顶部，直到找到无法更新的基于页面的路由。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Scans the top of the list until we found a page-based route that cannot be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">while</span> <span class="p">((</span><span class="n">oldEntriesBottom</span> <span class="o">&lt;=</span> <span class="n">oldEntriesTop</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">newPagesBottom</span> <span class="o">&lt;=</span> <span class="n">newPagesTop</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">_RouteEntry</span> <span class="n">oldEntry</span> <span class="o">=</span> <span class="n">_history</span><span class="p">[</span><span class="n">oldEntriesTop</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">oldEntry</span><span class="p">.</span><span class="n">currentState</span> <span class="o">!=</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">disposed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oldEntry</span><span class="p">.</span><span class="n">pageBased</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">unattachedPagelessRoutes</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">oldEntry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">oldEntriesTop</span> <span class="o">-=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Page</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">newPage</span> <span class="o">=</span> <span class="n">widget</span><span class="p">.</span><span class="n">pages</span><span class="p">[</span><span class="n">newPagesTop</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oldEntry</span><span class="p">.</span><span class="n">canUpdateFrom</span><span class="p">(</span><span class="n">newPage</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 我们找到了下面所有连续无页路由的页面。将这些无页路由附加到页面。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// We found the page for all the consecutive pageless routes below. Attach these
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// pageless routes to the page.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">unattachedPagelessRoutes</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">pageRouteToPagelessRoutes</span><span class="p">.</span><span class="n">putIfAbsent</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">oldEntry</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">()</span> <span class="o">=&gt;</span>  <span class="n">List</span><span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span><span class="p">.</span><span class="n">from</span><span class="p">(</span><span class="n">unattachedPagelessRoutes</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">unattachedPagelessRoutes</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">oldEntriesTop</span> <span class="o">-=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">newPagesTop</span> <span class="o">-=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 恢复无法更新的无页路由。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Reverts the pageless routes that cannot be updated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">oldEntriesTop</span> <span class="o">+=</span> <span class="n">unattachedPagelessRoutes</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 扫描旧条目的中间并将页面密钥记录到旧条目映射。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Scans middle of the old entries and records the page key to old entry map.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">oldEntriesBottomToScan</span> <span class="o">=</span> <span class="n">oldEntriesBottom</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">LocalKey</span><span class="p">,</span> <span class="n">_RouteEntry</span><span class="o">&gt;</span> <span class="n">pageKeyToOldEntry</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">LocalKey</span><span class="p">,</span> <span class="n">_RouteEntry</span><span class="o">&gt;</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 该集合包含正在转出但仍在路由堆栈中的条目。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// This set contains entries that are transitioning out but are still in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// the route stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span> <span class="n">phantomEntries</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">oldEntriesBottomToScan</span> <span class="o">&lt;=</span> <span class="n">oldEntriesTop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">_RouteEntry</span> <span class="n">oldEntry</span> <span class="o">=</span> <span class="n">_history</span><span class="p">[</span><span class="n">oldEntriesBottomToScan</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">oldEntriesBottomToScan</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">oldEntry</span><span class="p">.</span><span class="n">currentState</span> <span class="o">!=</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">disposed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 当我们更新旧列表的中间部分时，将记录无页路由。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Pageless routes will be recorded when we update the middle of the old
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oldEntry</span><span class="p">.</span><span class="n">pageBased</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Page</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">oldEntry</span><span class="p">.</span><span class="n">route</span><span class="p">.</span><span class="n">settings</span> <span class="o">as</span> <span class="n">Page</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">.</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oldEntry</span><span class="p">.</span><span class="n">willBePresent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">phantomEntries</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">oldEntry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="o">!</span><span class="n">pageKeyToOldEntry</span><span class="p">.</span><span class="n">containsKey</span><span class="p">(</span><span class="n">page</span><span class="p">.</span><span class="n">key</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">pageKeyToOldEntry</span><span class="p">[</span><span class="n">page</span><span class="p">.</span><span class="n">key</span><span class="o">!</span><span class="p">]</span> <span class="o">=</span> <span class="n">oldEntry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 更新列表的中间部分。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Updates the middle of the list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="n">newPagesBottom</span> <span class="o">&lt;=</span> <span class="n">newPagesTop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Page</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">nextPage</span> <span class="o">=</span> <span class="n">widget</span><span class="p">.</span><span class="n">pages</span><span class="p">[</span><span class="n">newPagesBottom</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">newPagesBottom</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">nextPage</span><span class="p">.</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="o">!</span><span class="n">pageKeyToOldEntry</span><span class="p">.</span><span class="n">containsKey</span><span class="p">(</span><span class="n">nextPage</span><span class="p">.</span><span class="n">key</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="o">!</span><span class="n">pageKeyToOldEntry</span><span class="p">[</span><span class="n">nextPage</span><span class="p">.</span><span class="n">key</span><span class="p">]</span><span class="o">!</span><span class="p">.</span><span class="n">canUpdateFrom</span><span class="p">(</span><span class="n">nextPage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 旧历史记录中没有匹配的键，我们需要创建一个新路由并等待转换委托决定如何将其添加到历史记录中。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// There is no matching key in the old history, we need to create a new
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// route and wait for the transition delegate to decide how to add
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// it into the history.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kd">final</span> <span class="n">_RouteEntry</span> <span class="n">newEntry</span> <span class="o">=</span> <span class="n">_RouteEntry</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">nextPage</span><span class="p">.</span><span class="n">createRoute</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">pageBased:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">initialState:</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">staging</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">needsExplicitDecision</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">assert</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">newEntry</span><span class="p">.</span><span class="n">route</span><span class="p">.</span><span class="n">settings</span> <span class="o">==</span> <span class="n">nextPage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;The settings getter of a page-based Route must return a Page object. &#39;</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;Please set the settings to the Page in the Page.createRoute method.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">newHistory</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">newEntry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 从 pageKeyToOldEntry 中删除键以指示它已被占用。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// Removes the key from pageKeyToOldEntry to indicate it is taken.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kd">final</span> <span class="n">_RouteEntry</span> <span class="n">matchingEntry</span> <span class="o">=</span> <span class="n">pageKeyToOldEntry</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">nextPage</span><span class="p">.</span><span class="n">key</span><span class="p">)</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">assert</span><span class="p">(</span><span class="n">matchingEntry</span><span class="p">.</span><span class="n">canUpdateFrom</span><span class="p">(</span><span class="n">nextPage</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="n">matchingEntry</span><span class="p">.</span><span class="n">route</span><span class="p">.</span><span class="n">_updateSettings</span><span class="p">(</span><span class="n">nextPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">newHistory</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">matchingEntry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 任何剩余的不匹配的旧路由都需要被删除。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Any remaining old routes that do not have a match will need to be removed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">RouteTransitionRecord</span><span class="o">?</span><span class="p">,</span> <span class="n">RouteTransitionRecord</span><span class="o">&gt;</span> <span class="n">locationToExitingPageRoute</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">RouteTransitionRecord</span><span class="o">?</span><span class="p">,</span> <span class="n">RouteTransitionRecord</span><span class="o">&gt;</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="n">oldEntriesBottom</span> <span class="o">&lt;=</span> <span class="n">oldEntriesTop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">_RouteEntry</span> <span class="n">potentialEntryToRemove</span> <span class="o">=</span> <span class="n">_history</span><span class="p">[</span><span class="n">oldEntriesBottom</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">oldEntriesBottom</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">potentialEntryToRemove</span><span class="p">.</span><span class="n">pageBased</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">assert</span><span class="p">(</span><span class="n">previousOldPageRouteEntry</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span> <span class="n">pagelessRoutes</span> <span class="o">=</span> <span class="n">pageRouteToPagelessRoutes</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">putIfAbsent</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">previousOldPageRouteEntry</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">()</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">pagelessRoutes</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">potentialEntryToRemove</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">previousOldPageRouteEntry</span><span class="o">!</span><span class="p">.</span><span class="n">isWaitingForExitingDecision</span> <span class="o">&amp;&amp;</span> <span class="n">potentialEntryToRemove</span><span class="p">.</span><span class="n">willBePresent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">potentialEntryToRemove</span><span class="p">.</span><span class="n">markNeedsExitingDecision</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Page</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">potentialPageToRemove</span> <span class="o">=</span> <span class="n">potentialEntryToRemove</span><span class="p">.</span><span class="n">route</span><span class="p">.</span><span class="n">settings</span> <span class="o">as</span> <span class="n">Page</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果此旧页面没有密钥、在更新新页面的中间期间未获取或已过渡出去，则需要删除转换委托的标记。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Marks for transition delegate to remove if this old page does not have
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// a key, was not taken during updating the middle of new page, or is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// already transitioning out.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">potentialPageToRemove</span><span class="p">.</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">pageKeyToOldEntry</span><span class="p">.</span><span class="n">containsKey</span><span class="p">(</span><span class="n">potentialPageToRemove</span><span class="p">.</span><span class="n">key</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="n">phantomEntries</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">potentialEntryToRemove</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">locationToExitingPageRoute</span><span class="p">[</span><span class="n">previousOldPageRouteEntry</span><span class="p">]</span> <span class="o">=</span> <span class="n">potentialEntryToRemove</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 只有在尚未弹出的情况下我们才需要做出决定。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// We only need a decision if it has not already been popped.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">potentialEntryToRemove</span><span class="p">.</span><span class="n">willBePresent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">potentialEntryToRemove</span><span class="p">.</span><span class="n">markNeedsExitingDecision</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">previousOldPageRouteEntry</span> <span class="o">=</span> <span class="n">potentialEntryToRemove</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 我们已经扫描了整个列表。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// We&#39;ve scanned the whole list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">assert</span><span class="p">(</span><span class="n">oldEntriesBottom</span> <span class="o">==</span> <span class="n">oldEntriesTop</span> <span class="o">+</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(</span><span class="n">newPagesBottom</span> <span class="o">==</span> <span class="n">newPagesTop</span> <span class="o">+</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">newPagesTop</span> <span class="o">=</span> <span class="n">widget</span><span class="p">.</span><span class="n">pages</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">oldEntriesTop</span> <span class="o">=</span> <span class="n">_history</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 验证我们是否到达底部或 oldEntriesBottom 必须可由 newPagesBottom 更新。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Verifies we either reach the bottom or the oldEntriesBottom must be updatable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// by newPagesBottom.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">oldEntriesBottom</span> <span class="o">&lt;=</span> <span class="n">oldEntriesTop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">newPagesBottom</span> <span class="o">&lt;=</span> <span class="n">newPagesTop</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_history</span><span class="p">[</span><span class="n">oldEntriesBottom</span><span class="p">].</span><span class="n">pageBased</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_history</span><span class="p">[</span><span class="n">oldEntriesBottom</span><span class="p">].</span><span class="n">canUpdateFrom</span><span class="p">(</span><span class="n">widget</span><span class="p">.</span><span class="n">pages</span><span class="p">[</span><span class="n">newPagesBottom</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">newPagesBottom</span> <span class="o">&gt;</span> <span class="n">newPagesTop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 更新列表顶部。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Updates the top of the list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">while</span> <span class="p">((</span><span class="n">oldEntriesBottom</span> <span class="o">&lt;=</span> <span class="n">oldEntriesTop</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">newPagesBottom</span> <span class="o">&lt;=</span> <span class="n">newPagesTop</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">_RouteEntry</span> <span class="n">oldEntry</span> <span class="o">=</span> <span class="n">_history</span><span class="p">[</span><span class="n">oldEntriesBottom</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">oldEntry</span><span class="p">.</span><span class="n">currentState</span> <span class="o">!=</span> <span class="n">_RouteLifecycle</span><span class="p">.</span><span class="n">disposed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oldEntry</span><span class="p">.</span><span class="n">pageBased</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">assert</span><span class="p">(</span><span class="n">previousOldPageRouteEntry</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span> <span class="n">pagelessRoutes</span> <span class="o">=</span> <span class="n">pageRouteToPagelessRoutes</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">putIfAbsent</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">previousOldPageRouteEntry</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">()</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">pagelessRoutes</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">oldEntry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">previousOldPageRouteEntry</span> <span class="o">=</span> <span class="n">oldEntry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Page</span><span class="o">&lt;</span><span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">newPage</span> <span class="o">=</span> <span class="n">widget</span><span class="p">.</span><span class="n">pages</span><span class="p">[</span><span class="n">newPagesBottom</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">oldEntry</span><span class="p">.</span><span class="n">canUpdateFrom</span><span class="p">(</span><span class="n">newPage</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">oldEntry</span><span class="p">.</span><span class="n">route</span><span class="p">.</span><span class="n">_updateSettings</span><span class="p">(</span><span class="n">newPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">newHistory</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">oldEntry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">oldEntriesBottom</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">newPagesBottom</span> <span class="o">+=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 最后，如果需要，使用转换委托做出明确的决定。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Finally, uses transition delegate to make explicit decision if needed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">needsExplicitDecision</span> <span class="o">=</span> <span class="n">needsExplicitDecision</span> <span class="o">||</span> <span class="n">locationToExitingPageRoute</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">newHistory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">needsExplicitDecision</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行transitionDelegate的_transition方法，因为在实战示例中，没有在Navigator传入，所以默认是DefaultTransitionDelegate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">results</span> <span class="o">=</span> <span class="n">widget</span><span class="p">.</span><span class="n">transitionDelegate</span><span class="p">.</span><span class="n">_transition</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 新路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nl">newPageRouteHistory:</span> <span class="n">newHistory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 即将退出的路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nl">locationToExitingPageRoute:</span> <span class="n">locationToExitingPageRoute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 无页路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nl">pageRouteToPagelessRoutes:</span> <span class="n">pageRouteToPagelessRoutes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">).</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">_history</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">_RouteEntry</span><span class="o">&gt;</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 添加主要的无页面路由（如果有）。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Adds the leading pageless routes if there is any.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">pageRouteToPagelessRoutes</span><span class="p">.</span><span class="n">containsKey</span><span class="p">(</span><span class="kc">null</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_history</span><span class="p">.</span><span class="n">addAll</span><span class="p">(</span><span class="n">pageRouteToPagelessRoutes</span><span class="p">[</span><span class="kc">null</span><span class="p">]</span><span class="o">!</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 添加正常的有Page的路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">_RouteEntry</span> <span class="n">result</span> <span class="k">in</span> <span class="n">results</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_history</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 最后添加依附于当前路由result的无页路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">pageRouteToPagelessRoutes</span><span class="p">.</span><span class="n">containsKey</span><span class="p">(</span><span class="n">result</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">_history</span><span class="p">.</span><span class="n">addAll</span><span class="p">(</span><span class="n">pageRouteToPagelessRoutes</span><span class="p">[</span><span class="n">result</span><span class="p">]</span><span class="o">!</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span><span class="n">_debugUpdatingPage</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;}());</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span> <span class="n">_debugLocked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}());</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 执行_history更新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">_flushHistoryUpdates</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">assert</span><span class="p">(()</span> <span class="p">{</span> <span class="n">_debugLocked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>看下<em>TransitionDelegate</em>的 <em>_transition</em> 方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">RouteTransitionRecord</span><span class="o">&gt;</span> <span class="n">_transition</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="kd">required</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">RouteTransitionRecord</span><span class="o">&gt;</span> <span class="n">newPageRouteHistory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="kd">required</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">RouteTransitionRecord</span><span class="o">?</span><span class="p">,</span> <span class="n">RouteTransitionRecord</span><span class="o">&gt;</span> <span class="n">locationToExitingPageRoute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="kd">required</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">RouteTransitionRecord</span><span class="o">?</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">RouteTransitionRecord</span><span class="o">&gt;&gt;</span> <span class="n">pageRouteToPagelessRoutes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">RouteTransitionRecord</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">resolve</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nl">newPageRouteHistory:</span> <span class="n">newPageRouteHistory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">locationToExitingPageRoute:</span> <span class="n">locationToExitingPageRoute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nl">pageRouteToPagelessRoutes:</span> <span class="n">pageRouteToPagelessRoutes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 做出决定后验证其完整性。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Verifies the integrity after the decisions have been made.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// 规则如下：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Here are the rules:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// - newPageRouteHistory 中的所有进入路由都必须推送或添加。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// - All the entering routes in newPageRouteHistory must either be pushed or
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   added.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// - locationToExitingPageRoute 中的所有现有路由必须弹出、完成或删除。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// - All the exiting routes in locationToExitingPageRoute must either be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   popped, completed or removed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// - 属于现有路由的所有无页路由必须弹出、完成或删除。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// - All the pageless routes that belong to exiting routes must either be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   popped, completed or removed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// - 结果中的所有进入路由必须与 newPageRouteHistory 中的进入路由保持相同的顺序，并且结果必须包含所有退出路由。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// - All the entering routes in the result must preserve the same order as
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   the entering routes in newPageRouteHistory, and the result must contain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//   all exiting routes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//     例如：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//     ex:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//     newPageRouteHistory = [A, B, C]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//     locationToExitingPageRoute = {A -&gt; D, C -&gt; E}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//     results = [A, B ,C ,D ,E] is valid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//     results = [D, A, B ,C ,E] is also valid because exiting route can be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//     inserted in any place
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//     results = [B, A, C ,D ,E] is invalid because B must be after A.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//     results = [A, B, C ,E] is invalid because results must include D.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">results</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<em>TransitionDelegate</em>的 <em>_transition</em> 方法中，执行了<em>resolve</em>方法，该方法由子类<em>DefaultTransitionDelegate</em>实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl"><span class="n">Iterable</span><span class="o">&lt;</span><span class="n">RouteTransitionRecord</span><span class="o">&gt;</span> <span class="n">resolve</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="kd">required</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">RouteTransitionRecord</span><span class="o">&gt;</span> <span class="n">newPageRouteHistory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="kd">required</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">RouteTransitionRecord</span><span class="o">?</span><span class="p">,</span> <span class="n">RouteTransitionRecord</span><span class="o">&gt;</span> <span class="n">locationToExitingPageRoute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="kd">required</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">RouteTransitionRecord</span><span class="o">?</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">RouteTransitionRecord</span><span class="o">&gt;&gt;</span> <span class="n">pageRouteToPagelessRoutes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">RouteTransitionRecord</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">RouteTransitionRecord</span><span class="o">&gt;</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 此方法将处理该位置处的现有路由及其相应的无页路由。它还会递归地检查其上方是否有任何其他退出路由并相应地处理它们。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// This method will handle the exiting route and its corresponding pageless
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// route at this location. It will also recursively check if there is any
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// other exiting routes above it and handle them accordingly.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="n">handleExitingRoute</span><span class="p">(</span><span class="n">RouteTransitionRecord</span><span class="o">?</span> <span class="n">location</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isLast</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">RouteTransitionRecord</span><span class="o">?</span> <span class="n">exitingPageRoute</span> <span class="o">=</span> <span class="n">locationToExitingPageRoute</span><span class="p">[</span><span class="n">location</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">exitingPageRoute</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">exitingPageRoute</span><span class="p">.</span><span class="n">isWaitingForExitingDecision</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="kt">bool</span> <span class="n">hasPagelessRoute</span> <span class="o">=</span> <span class="n">pageRouteToPagelessRoutes</span><span class="p">.</span><span class="n">containsKey</span><span class="p">(</span><span class="n">exitingPageRoute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">final</span> <span class="kt">bool</span> <span class="n">isLastExitingPageRoute</span> <span class="o">=</span> <span class="n">isLast</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">locationToExitingPageRoute</span><span class="p">.</span><span class="n">containsKey</span><span class="p">(</span><span class="n">exitingPageRoute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">isLastExitingPageRoute</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hasPagelessRoute</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 标记路由状态为pop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">exitingPageRoute</span><span class="p">.</span><span class="n">markForPop</span><span class="p">(</span><span class="n">exitingPageRoute</span><span class="p">.</span><span class="n">route</span><span class="p">.</span><span class="n">currentResult</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 标记路由状态为complete
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">exitingPageRoute</span><span class="p">.</span><span class="n">markForComplete</span><span class="p">(</span><span class="n">exitingPageRoute</span><span class="p">.</span><span class="n">route</span><span class="p">.</span><span class="n">currentResult</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">hasPagelessRoute</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">RouteTransitionRecord</span><span class="o">&gt;</span> <span class="n">pagelessRoutes</span> <span class="o">=</span> <span class="n">pageRouteToPagelessRoutes</span><span class="p">[</span><span class="n">exitingPageRoute</span><span class="p">]</span><span class="o">!</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">RouteTransitionRecord</span> <span class="n">pagelessRoute</span> <span class="k">in</span> <span class="n">pagelessRoutes</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// 属于现有基于页面的路由的无页面路由可能不需要退出决策。如果页面列表在 Navigator.pop 之后立即更新，则可能会发生这种情况。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="c1">// It is possible that a pageless route that belongs to an exiting
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="c1">// page-based route does not require exiting decision. This can
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="c1">// happen if the page list is updated right after a Navigator.pop.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">if</span> <span class="p">(</span><span class="n">pagelessRoute</span><span class="p">.</span><span class="n">isWaitingForExitingDecision</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">isLastExitingPageRoute</span> <span class="o">&amp;&amp;</span> <span class="n">pagelessRoute</span> <span class="o">==</span> <span class="n">pagelessRoutes</span><span class="p">.</span><span class="n">last</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">pagelessRoute</span><span class="p">.</span><span class="n">markForPop</span><span class="p">(</span><span class="n">pagelessRoute</span><span class="p">.</span><span class="n">route</span><span class="p">.</span><span class="n">currentResult</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">pagelessRoute</span><span class="p">.</span><span class="n">markForComplete</span><span class="p">(</span><span class="n">pagelessRoute</span><span class="p">.</span><span class="n">route</span><span class="p">.</span><span class="n">currentResult</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">results</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">exitingPageRoute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// It is possible there is another exiting route above this exitingPageRoute.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">handleExitingRoute</span><span class="p">(</span><span class="n">exitingPageRoute</span><span class="p">,</span> <span class="n">isLast</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Handles exiting route in the beginning of list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">handleExitingRoute</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="n">newPageRouteHistory</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kd">final</span> <span class="n">RouteTransitionRecord</span> <span class="n">pageRoute</span> <span class="k">in</span> <span class="n">newPageRouteHistory</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">bool</span> <span class="n">isLastIteration</span> <span class="o">=</span> <span class="n">newPageRouteHistory</span><span class="p">.</span><span class="n">last</span> <span class="o">==</span> <span class="n">pageRoute</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pageRoute</span><span class="p">.</span><span class="n">isWaitingForEnteringDecision</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">locationToExitingPageRoute</span><span class="p">.</span><span class="n">containsKey</span><span class="p">(</span><span class="n">pageRoute</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isLastIteration</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 标记路由状态为push
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">pageRoute</span><span class="p">.</span><span class="n">markForPush</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 标记路由状态为add
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">pageRoute</span><span class="p">.</span><span class="n">markForAdd</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">results</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">pageRoute</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">handleExitingRoute</span><span class="p">(</span><span class="n">pageRoute</span><span class="p">,</span> <span class="n">isLastIteration</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">results</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="55pushnamed执行逻辑">5.5、<em>pushNamed</em>执行逻辑</h2>
<p>在本实战示例中，执行<em>NavigatorHelper</em>的<em>pushNamed</em>方法后，就会触发在<em>CustomRouterDelegate</em>构造方法中注册的<em>registerOnJumpListener</em>回调方法。</p>
<p>在该回调中执行了 <em>_updatePages</em> 方法，那么就会更新<em>pages</em>，同时内部也调用了<em>notifyListeners</em>方法。</p>
<p>前面讲过，<em>routerDelegate</em>添加了监听回调方法 <em>_handleRouterDelegateNotification</em>，此时就会执行该方法。</p>
<p>首先执行<em>setState</em>方法更新UI，最后，又执行了<em>routeInformationParser</em>的<em>restoreRouteInformation</em>方法。</p>
<h2 id="56pop执行逻辑">5.6、<em>pop</em>执行逻辑</h2>
<p>当点击标题栏中返回按钮时，就会触发<em>CustomRouterDelegate</em>的 <em>_onPopPage</em> 方法，那么又会触发 <em>_updatePages</em> 方法，之后的逻辑与前面一致。</p>
<h1 id="六参考文献">六、参考文献</h1>
<blockquote>
<ul>
<li><a href="https://juejin.cn/post/6880388303745449991"><em>Flutter Navigator 2.0 全面解析</em></a></li>
</ul>
</blockquote>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">AndDevMK</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2023-11-26
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/wechat-qr-code.JPG">
        <span>微信打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/alipay-qr-code.JPG">
        <span>支付宝打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8B%E5%B8%83%E5%B1%80layout%E8%BF%87%E7%A8%8B/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">解读Flutter源码之布局Layout过程</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E8%A7%A3%E8%AF%BBflutter%E6%BA%90%E7%A0%81%E4%B9%8Bnavigator%E5%91%BD%E4%BB%A4%E5%BC%8F/">
            <span class="next-text nav-default">解读Flutter源码之Navigator（命令式）</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="AndDevMK/blog-utterances"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    
    <div id="search_mask" class="search_mask">
    <div class="search_modal">
        <div id="close_search" class="close_search">关闭</div>
        <div class="search_divider"></div>
        <input id="input_search_key" class="input_search_key" placeholder="请输入你要搜索的内容" tabindex="0">
        <ul id="search_list">
        </ul>
    </div>
</div>

<script src="/js/fuse.js"></script> 
<script src="/js/fastsearch.js"></script>

    <footer id="footer" class="footer">
      

<div class="copyright">
  <span class="power-by">
    由 <a id="hexo-link" class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    
    <span id="run-time" class="run-time"></span> 
    <span class="heart"><i class="iconfont icon-heart"></i></span>
    &copy; 
    2023&nbsp;
    <span>AndDevMK</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.11a4ba15caf2d921d57eaf6568c4ad21eafd5d2c001cbcb31693586c63f93005.js"></script>

<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?6db179fb88e600cf326b0515a8aa1de3";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>




<script src="/js/codecopy.js"></script>



<link disabled id="dark-mode-theme" rel="stylesheet" href="/css/dark.css"></link>
<script src="/js/dark.js"></script>


<script src="/js/site_runtime.js"></script>




</body>
</html>
