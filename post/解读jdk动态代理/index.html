<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>解读JDK动态代理 - AndDevMK&#39;s android blog site</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="AndDevMK" /><meta name="description" content="注：本文代码基于JDK 17 一、概述 动态代理，一个听起来很高深的名词，其实并非如此，在日常的开发中，你或多或少都有遇到过，比如你调用第三方SDK的方法时，该方法的具体实现或许就是使用了动态代理，这个本文后面会讲到。 不管是在Java开发还是Android开发中，动态代理的应用场景都非常" /><meta name="keywords" content="Android, Java, Kotlin, C&#43;&#43;, C, Flutter, Dart, NDK" />


<meta name="baidu-site-verification" content="codeva-wQ7uOo4V09" />
<meta name="google-site-verification" content="yHzWB9BxTR74LiaUhuL5ncr89fnDYXiplTaPY565zqo" />


<meta name="generator" content="Hugo 0.111.3 with theme even" />


<link rel="canonical" href="https://anddevmk.cn/post/%E8%A7%A3%E8%AF%BBjdk%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.c11aaf02bef1025d6b0813ba5e1a8a8551aee15fa8f2bcea906d41b20bdf5c69.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/codecopy.css">


<meta property="og:title" content="解读JDK动态代理" />
<meta property="og:description" content="注：本文代码基于JDK 17 一、概述 动态代理，一个听起来很高深的名词，其实并非如此，在日常的开发中，你或多或少都有遇到过，比如你调用第三方SDK的方法时，该方法的具体实现或许就是使用了动态代理，这个本文后面会讲到。 不管是在Java开发还是Android开发中，动态代理的应用场景都非常" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://anddevmk.cn/post/%E8%A7%A3%E8%AF%BBjdk%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-08-11T22:39:31+08:00" />
<meta property="article:modified_time" content="2023-08-11T22:39:31+08:00" />
<meta itemprop="name" content="解读JDK动态代理">
<meta itemprop="description" content="注：本文代码基于JDK 17 一、概述 动态代理，一个听起来很高深的名词，其实并非如此，在日常的开发中，你或多或少都有遇到过，比如你调用第三方SDK的方法时，该方法的具体实现或许就是使用了动态代理，这个本文后面会讲到。 不管是在Java开发还是Android开发中，动态代理的应用场景都非常"><meta itemprop="datePublished" content="2023-08-11T22:39:31+08:00" />
<meta itemprop="dateModified" content="2023-08-11T22:39:31+08:00" />
<meta itemprop="wordCount" content="8994">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="解读JDK动态代理"/>
<meta name="twitter:description" content="注：本文代码基于JDK 17 一、概述 动态代理，一个听起来很高深的名词，其实并非如此，在日常的开发中，你或多或少都有遇到过，比如你调用第三方SDK的方法时，该方法的具体实现或许就是使用了动态代理，这个本文后面会讲到。 不管是在Java开发还是Android开发中，动态代理的应用场景都非常"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">AndDevMK</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>

    
    <li class="mobile-menu-item-search">
      <div id="mobile_open_search" class="mobile_open_search">
        搜索
      </div>
    </li>

    
    <li class="mobile-menu-item-dark-mode">
      <div id="mobile_dark_mode_toggle" class="mobile_light_mode">
       
      </div>
    </li>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">AndDevMK</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
    
    <div id="open_search" class="open_search">
      搜索
    </div>

    
    <div id="dark_mode_toggle" class="light_mode">

    </div>
  
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">解读JDK动态代理</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-08-11 </span>
        <div class="post-category">
            <a href="/categories/java/"> Java </a>
            </div>
          <span class="more-meta"> 约 8994 字 </span>
          <span class="more-meta"> 预计阅读 18 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#一概述">一、概述</a></li>
    <li><a href="#二什么是代理">二、什么是代理？</a></li>
    <li><a href="#三静态代理的使用">三、静态代理的使用</a></li>
    <li><a href="#四动态代理的使用">四、动态代理的使用</a></li>
    <li><a href="#五动态代理的原理">五、动态代理的原理</a></li>
    <li><a href="#六动态代理在android上的运用">六、动态代理在Android上的运用</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <blockquote>
<p><em>注：本文代码基于JDK 17</em></p>
</blockquote>
<h1 id="一概述">一、概述</h1>
<p>动态代理，一个听起来很高深的名词，其实并非如此，在日常的开发中，你或多或少都有遇到过，比如你调用第三方<em>SDK</em>的方法时，该方法的具体实现或许就是使用了动态代理，这个本文后面会讲到。</p>
<p>不管是在Java开发还是Android开发中，动态代理的应用场景都非常广泛，因此我们需要学习它，并且了解它的运行原理，这也是本文接下来要做的事情。</p>
<h1 id="二什么是代理">二、什么是代理？</h1>
<p>代理在我们的日常生活中很常见，比如说：</p>
<ul>
<li>
<p>恶略天气出去吃饭麻烦，可以点外卖</p>
</li>
<li>
<p>爷爷不会使用手机充话费，找孙女帮忙充</p>
</li>
</ul>
<p>在这两个例子中，外卖骑手、孙女这两个角色都是帮我们干活的，他们做着我们不能做或不想做的事情。</p>
<p>因此，代理其实就是当前对象不能做或不想做的事情，委托给别的对象做。</p>
<h1 id="三静态代理的使用">三、静态代理的使用</h1>
<p>还是以上面的“<em>孙女帮爷爷充话费</em>”为例进行说明，现有一个行为接口<em>Action</em>，包含了一个充话费的方法<em>recharge</em>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 行为接口
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Action</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 充话费
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">recharge</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为爷爷需要充话费，所以<em>Grandfather</em>类实现了<em>Action</em>接口。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 爷爷
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Grandfather</span> <span class="kd">implements</span> <span class="n">Action</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">recharge</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;recharge&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>但是，爷爷并不会使用手机充话费，于是他找了孙女请求帮忙充话费，那么<em>Granddaughter</em>类也要实现<em>Action</em>接口，然后把两者的充话费行为关联起来。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 孙女
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Granddaughter</span> <span class="kd">implements</span> <span class="n">Action</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Action</span> <span class="n">action</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Granddaughter</span><span class="o">(</span><span class="n">Action</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">action</span> <span class="o">=</span> <span class="n">action</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">recharge</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;before recharge&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">action</span><span class="o">.</span><span class="na">recharge</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;after recharge&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最终的main方法如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Grandfather</span> <span class="n">grandfather</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Grandfather</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Granddaughter</span> <span class="n">granddaughter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Granddaughter</span><span class="o">(</span><span class="n">grandfather</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">granddaughter</span><span class="o">.</span><span class="na">recharge</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>由上面代码可知，<em>Grandfather</em>和<em>Granddaughter</em>两个类都实现了相同的接口<em>Action</em>，实际对象是<em>Grandfather</em>，代理对象是<em>Granddaughter</em>。</p>
<p><em>Granddaughter</em>内部有一个<em>action</em>的成员变量，指向实际对象，在构造方法中被初始化，对于方法<em>recharge</em>方法的调用，它转发给了实际对象，接着在调用前后输出了一些跟踪调试信息，这也是代理对原方法进行增强的一种体现，上面代码输出如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">before recharge
</span></span><span class="line"><span class="cl">recharge
</span></span><span class="line"><span class="cl">after recharge
</span></span></code></pre></td></tr></table>
</div>
</div><p>因此，代理背后一般至少有一个实际对象，代理的外部功能和实际对象一般是一样的，用户与代理打交道，不直接接触实际对象。</p>
<p>在代码中创建了一个代理类<em>Granddaughter</em>，它的代码是在写程序时固定的，所以称为<em>静态代理</em>。</p>
<p>虽然静态代理实现简单，且不侵入原代码，但是当场景复杂一些的时候，静态代理的缺点也会暴露出来。</p>
<p>1、当需要代理多个类的时候，由于代理对象要实现与目标对象一致的接口，有2种方式：</p>
<ul>
<li>只维护一个代理类，由这个代理类实现多个接口，但是这样就导致代理类过于庞大</li>
<li>新建多个代理类，每个目标对象对应一个代理类，但是这样会产生过多的代理类</li>
</ul>
<p>2、当接口增加、删除、修改方法的时候，目标对象与代理类都要同时修改，十分不易维护。</p>
<p><em><strong>那么，这要如何改进呢？</strong></em></p>
<p>当然是让代理类动态的生成，这也是接下来要说的<em>动态代理</em>。</p>
<h1 id="四动态代理的使用">四、动态代理的使用</h1>
<p>在静态代理中，代理类是直接定义在代码中的，而在动态代理中，代理类是动态生成的，那么就有一个疑问了，要如何去实现动态代理呢？</p>
<p>在<em>JDK</em>中，提供了<code>java.lang.reflect.Proxy</code>和<code>java.lang.reflect.InvocationHandler</code>这两个类来实现动态代理。动态代理的使用有2个步骤：</p>
<ul>
<li>
<p>创建一个类去实现<em>InvocationHandler</em>接口，并且实现该接口的<em>invoke</em>方法。</p>
</li>
<li>
<p>使用<em>Proxy</em>类的<em>newProxyInstance</em>方法去创建代理类的实例对象。</p>
</li>
</ul>
<p>接下来，我们按照上面的步骤一一实现动态代理，首先创建一个类<em>ActionInvocationHandler</em>，让它去实现<em>InvocationHandler</em>接口，并且实现该接口的<em>invoke</em>方法，代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Action接口调用处理器
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ActionInvocationHandler</span> <span class="kd">implements</span> <span class="n">InvocationHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Object</span> <span class="n">realObj</span><span class="o">;</span>   <span class="c1">// 实际对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">ActionInvocationHandler</span><span class="o">(</span><span class="n">Object</span> <span class="n">realObj</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">realObj</span> <span class="o">=</span> <span class="n">realObj</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;before recharge&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">realObj</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;after recharge&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>ActionInvocationHandler</em>类实现了<em>InvocationHandler</em>接口，它的构造方法接受一个<em>Object</em>类型的参数<em>realObj</em>，<em>realObj</em>表示被代理的实际对象，接着在<em>invoke</em>方法中处理所有的接口调用，它有3个参数：</p>
<ul>
<li>
<p><em>proxy</em>：表示代理对象本身，<em><strong>注意了，它不是被代理的实际对象，这个参数一般用处不大</strong></em>；</p>
</li>
<li>
<p><em>method</em>：表示代理方法的method对象；</p>
</li>
<li>
<p><em>args</em>：表示代理方法的参数；</p>
</li>
</ul>
<p>上面调用了<em>method</em>的<em>invoke</em>方法，传递了实际对象<em>realObj</em>作为参数，达到了调用实际对象对应方法的目的，在调用任何方法前后，我们输出了跟踪调试语句。需要注意的是，不能将<em>proxy</em>作为参数传递给<em>method</em>的<em>invoke</em>方法，比如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">proxy</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面的语句会造成死循环，因为<em>proxy</em>表示当前代理对象，这又会调用到<em>ActionInvocationHandler</em>的<em>invoke</em>方法。</p>
<p>然后使用<em>Proxy</em>类的<em>newProxyInstance</em>方法去创建代理类的实例对象，调用代理类的实例对象的方法，代码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Grandfather</span> <span class="n">grandfather</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Grandfather</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Action</span> <span class="n">action</span> <span class="o">=</span> <span class="o">(</span><span class="n">Action</span><span class="o">)</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">Action</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="k">new</span> <span class="n">Class</span><span class="o">&lt;?&gt;[]{</span><span class="n">Action</span><span class="o">.</span><span class="na">class</span><span class="o">},</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">ActionInvocationHandler</span><span class="o">(</span><span class="n">grandfather</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">action</span><span class="o">.</span><span class="na">recharge</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>和静态代理相比，代码看起来复杂不少，但是<em>Action</em>接口和<em>Grandfather</em>的定义不变，程序的输出也没变，只是代理对象<em>Granddaughter</em>的创建方式变了，它使用<em>Proxy</em>类的静态方法<em>newProxyInstance</em>来创建代理对象，该方法的声明如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">newProxyInstance</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">interfaces</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">InvocationHandler</span> <span class="n">h</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>newProxyInstance</em>方法有3个参数：</p>
<ul>
<li>
<p><em>loader</em>：代理类的类加载器；</p>
</li>
<li>
<p><em>interfaces</em>：代理类要实现的接口列表，它是一个数组，元素的类型只能是接口，不能是普通的类；</p>
</li>
<li>
<p><em>h</em>：<em>h</em>的类型为<em>InvocationHandler</em>，它是一个接口，只定义了一个方法<em>invoke</em>，对代理接口所有方法的调用都会转给该方法。</p>
</li>
</ul>
<p><em>newProxyInstance</em>方法的返回值类型为<em>Object</em>，可以强制转换为<em>interfaces</em>数组中的某个接口类型。这里我们强制转换为了<em>Action</em>类型，<em><strong>需要注意的是，它不能强制转换为某个类类型</strong></em>。</p>
<p>如果上面动态代理的代码令你感到疑惑，那么接下来让我们一起去深入源码，慢慢解开你心中的疑惑。</p>
<h1 id="五动态代理的原理">五、动态代理的原理</h1>
<p>我们先看下<em>Proxy</em>类的<em>newProxyInstance</em>方法，因为它返回的是代理类的实例对象，那么代理类的实例对象是怎么被构造出来的呢？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">newProxyInstance</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span>                        
</span></span><span class="line"><span class="cl">                                      <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">interfaces</span><span class="o">,</span>                     
</span></span><span class="line"><span class="cl">                                      <span class="n">InvocationHandler</span> <span class="n">h</span><span class="o">)</span> <span class="o">{</span>                     
</span></span><span class="line"><span class="cl">    <span class="n">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">h</span><span class="o">);</span>                                                   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果没有调用setSecurityManager方法设置SecurityManager，那么getSecurityManager方法返回为null，因此，默认情况下caller即为null，否则返回调用此方法的方法的调用者的类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;removal&#34;</span><span class="o">)</span>                                                 
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">caller</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span>                  
</span></span><span class="line"><span class="cl">                                <span class="o">?</span> <span class="kc">null</span>                                           
</span></span><span class="line"><span class="cl">                                <span class="o">:</span> <span class="n">Reflection</span><span class="o">.</span><span class="na">getCallerClass</span><span class="o">();</span>                   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*                                                                           
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Look up or generate the designated proxy class and its constructor.       
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>   
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析1                                                                      
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">cons</span> <span class="o">=</span> <span class="n">getProxyConstructor</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="n">loader</span><span class="o">,</span> <span class="n">interfaces</span><span class="o">);</span>       
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">newProxyInstance</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="n">cons</span><span class="o">,</span> <span class="n">h</span><span class="o">);</span>                                    
</span></span><span class="line"><span class="cl"><span class="o">}</span>                                                                                
</span></span></code></pre></td></tr></table>
</div>
</div><p>分析1：调用<em>getProxyConstructor</em>方法创建代理类的构造方法所对应的构造器对象<em>cons</em>，</p>
<p>其中方法的参数传入了类加载器<em>loader</em>和数组<em>interfaces</em>；</p>
<p>分析2：调用<em>newProxyInstance</em>方法创建代理类的实例对象并返回，其中方法的参数传入了构造器对象<em>cons</em>和<em>InvocationHandler</em>类型的变量<em>h</em>。</p>
<p><em>OK</em>，首先看<em>getProxyConstructor</em>方法的实现，它是怎么创建的构造器对象<em>cons</em>？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">getProxyConstructor</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">caller</span><span class="o">,</span>             
</span></span><span class="line"><span class="cl">                                                  <span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span>          
</span></span><span class="line"><span class="cl">                                                  <span class="n">Class</span><span class="o">&lt;?&gt;...</span> <span class="n">interfaces</span><span class="o">)</span>      
</span></span><span class="line"><span class="cl"><span class="o">{</span>                                                                              
</span></span><span class="line"><span class="cl">    <span class="c1">// optimization for single interface     
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 代理接口数组中只有单个接口                                  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">interfaces</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>                                              
</span></span><span class="line"><span class="cl">        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">intf</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">// 默认情况下，caller为null，不满足此处if                                        
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">caller</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>   
</span></span><span class="line"><span class="cl">            <span class="c1">// 检查创建代理类所需的权限                                               
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">checkProxyAccess</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="n">loader</span><span class="o">,</span> <span class="n">intf</span><span class="o">);</span>                            
</span></span><span class="line"><span class="cl">        <span class="o">}</span>                                                                      
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">proxyCache</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">intf</span><span class="o">).</span><span class="na">computeIfAbsent</span><span class="o">(</span>                           
</span></span><span class="line"><span class="cl">            <span class="n">loader</span><span class="o">,</span>                                                            
</span></span><span class="line"><span class="cl">            <span class="o">(</span><span class="n">ld</span><span class="o">,</span> <span class="n">clv</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">ProxyBuilder</span><span class="o">(</span><span class="n">ld</span><span class="o">,</span> <span class="n">clv</span><span class="o">.</span><span class="na">key</span><span class="o">()).</span><span class="na">build</span><span class="o">()</span>               
</span></span><span class="line"><span class="cl">        <span class="o">);</span>                                                                     
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>    
</span></span><span class="line"><span class="cl">        <span class="c1">// 代理接口数组中存在多个接口                                                                  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// interfaces cloned                                           
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">intfsArray</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">// 默认情况下，caller为null，不满足此处if                         
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">caller</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> 
</span></span><span class="line"><span class="cl">            <span class="c1">// 检查创建代理类所需的权限                                                 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">checkProxyAccess</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="n">loader</span><span class="o">,</span> <span class="n">intfsArray</span><span class="o">);</span>                      
</span></span><span class="line"><span class="cl">        <span class="o">}</span>                                                                      
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">intfs</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">intfsArray</span><span class="o">);</span>                
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">proxyCache</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">intfs</span><span class="o">).</span><span class="na">computeIfAbsent</span><span class="o">(</span>                          
</span></span><span class="line"><span class="cl">            <span class="n">loader</span><span class="o">,</span>                                                            
</span></span><span class="line"><span class="cl">            <span class="o">(</span><span class="n">ld</span><span class="o">,</span> <span class="n">clv</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">ProxyBuilder</span><span class="o">(</span><span class="n">ld</span><span class="o">,</span> <span class="n">clv</span><span class="o">.</span><span class="na">key</span><span class="o">()).</span><span class="na">build</span><span class="o">()</span>               
</span></span><span class="line"><span class="cl">        <span class="o">);</span>                                                                     
</span></span><span class="line"><span class="cl">    <span class="o">}</span>                                                                          
</span></span><span class="line"><span class="cl"><span class="o">}</span>                                                                              
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过上面代码可知，根据数组<em>interfaces</em>的长度来分情况处理，但是不管怎样，最终都是调用了<em>proxyCache</em>变量的复杂调用链进行相关操作，那么<em>proxyCache</em>是什么玩意？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Proxy</span> <span class="kd">implements</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * a cache of proxy constructors with
</span></span></span><span class="line"><span class="cl"><span class="cm">     * {@link Constructor#setAccessible(boolean) accessible} flag already set
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ClassLoaderValue</span><span class="o">&lt;</span><span class="n">Constructor</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">proxyCache</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">ClassLoaderValue</span><span class="o">&lt;&gt;();</span>  
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>由代码注释可知，<em>proxyCache</em>是已设置<em>accessible</em>标志的代理构造函数的缓存，并且它是<em>ClassLoaderValue</em>类型。跟踪<em>ClassLoaderValue</em>类发现它继承自抽象类<em>AbstractClassLoaderValue</em>，当调用<em>ClassLoaderValue</em>的<em>sub</em>方法时，因为<em>ClassLoaderValue</em>没有<em>sub</em>方法，所以实际上是调用了抽象类<em>AbstractClassLoaderValue</em>的<em>sub</em>方法，这个<em>sub</em>方法创建了<em>Sub</em>对象，而<em>Sub</em>类又是<em>AbstractClassLoaderValue</em>的内部类。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractClassLoaderValue</span><span class="o">&lt;</span><span class="n">CLV</span> <span class="kd">extends</span> <span class="n">AbstractClassLoaderValue</span><span class="o">&lt;</span><span class="n">CLV</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">K</span><span class="o">&gt;</span> <span class="n">Sub</span><span class="o">&lt;</span><span class="n">K</span><span class="o">&gt;</span> <span class="nf">sub</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">Sub</span><span class="o">&lt;&gt;(</span><span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Sub</span><span class="o">&lt;</span><span class="n">K</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">AbstractClassLoaderValue</span><span class="o">&lt;</span><span class="n">Sub</span><span class="o">&lt;</span><span class="n">K</span><span class="o">&gt;,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kd">final</span> <span class="n">K</span> <span class="n">key</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Sub</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>  
</span></span><span class="line"><span class="cl"><span class="err">    </span><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据<em>proxyCache</em>变量的复杂调用链，下一步就是调用<em>Sub</em>类的<em>computeIfAbsent</em>方法了，但是<em>Sub</em>类没有<em>computeIfAbsent</em>方法，那么调用的就是父类<em>AbstractClassLoaderValue</em>的<em>computeIfAbsent</em>方法了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractClassLoaderValue</span><span class="o">&lt;</span><span class="n">CLV</span> <span class="kd">extends</span> <span class="n">AbstractClassLoaderValue</span><span class="o">&lt;</span><span class="n">CLV</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">V</span> <span class="nf">computeIfAbsent</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">cl</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">BiFunction</span><span class="o">&lt;</span>
</span></span><span class="line"><span class="cl">                                 <span class="o">?</span> <span class="kd">super</span> <span class="n">ClassLoader</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="o">?</span> <span class="kd">super</span> <span class="n">CLV</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="o">?</span> <span class="kd">extends</span> <span class="n">V</span>
</span></span><span class="line"><span class="cl">                                 <span class="o">&gt;</span> <span class="n">mappingFunction</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IllegalStateException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ConcurrentHashMap</span><span class="o">&lt;</span><span class="n">CLV</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">map</span><span class="o">(</span><span class="n">cl</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">CLV</span> <span class="n">clv</span> <span class="o">=</span> <span class="o">(</span><span class="n">CLV</span><span class="o">)</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Memoizer</span><span class="o">&lt;</span><span class="n">CLV</span><span class="o">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="n">mv</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Object</span> <span class="n">val</span> <span class="o">=</span> <span class="o">(</span><span class="n">mv</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">clv</span><span class="o">)</span> <span class="o">:</span> <span class="n">map</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">clv</span><span class="o">,</span> <span class="n">mv</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">val</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">mv</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// create Memoizer lazily when 1st needed and restart loop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">mv</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Memoizer</span><span class="o">&lt;&gt;(</span><span class="n">cl</span><span class="o">,</span> <span class="n">clv</span><span class="o">,</span> <span class="n">mappingFunction</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// mv != null, therefore sv == null was a result of successful
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// putIfAbsent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// trigger Memoizer to compute the value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">V</span> <span class="n">v</span> <span class="o">=</span> <span class="n">mv</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// attempt to replace our Memoizer with the value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">map</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="n">clv</span><span class="o">,</span> <span class="n">mv</span><span class="o">,</span> <span class="n">v</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// return computed value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">return</span> <span class="n">v</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// our Memoizer has thrown, attempt to remove it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">map</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">clv</span><span class="o">,</span> <span class="n">mv</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// propagate exception because it&#39;s from our Memoizer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">throw</span> <span class="n">t</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">extractValue</span><span class="o">(</span><span class="n">val</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Memoizer</span><span class="o">.</span><span class="na">RecursiveInvocationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// propagate recursive attempts to calculate the same
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// value as being calculated at the moment
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// don&#39;t propagate exceptions thrown from foreign Memoizer -
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// pretend that there was no entry and retry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// (foreign computeIfAbsent invocation will try to remove it anyway)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// TODO:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Thread.onSpinLoop(); // when available
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>computeIfAbsent</em>方法当中用到了<em>ConcurrentHashMap</em>，这里可以知道应该是支持多线程并发的，<em>computeIfAbsent</em>方法的功能可以解读为：返回与此<em>ClassLoaderValue</em>和给定<em>ClassLoader</em>关联的值，如果不存在，则通过调用给定的<em>mappingFunction</em>来计算该值，将其关联并返回它。</p>
<p>很明显，<em>map</em>中没有缓存时，创建构造器的核心逻辑落在了在<em>ProxyBuilder</em>类上，继续跟踪<em>ProxyBuilder</em>类，发现它是<em>Proxy</em>的内部类，先看它的成员变量。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Proxy</span> <span class="kd">implements</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ProxyBuilder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 分析1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">JavaLangAccess</span> <span class="n">JLA</span> <span class="o">=</span> <span class="n">SharedSecrets</span><span class="o">.</span><span class="na">getJavaLangAccess</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 分析2：所有代理类名称的前缀
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// prefix for all proxy class names
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">proxyClassNamePrefix</span> <span class="o">=</span> <span class="s">&#34;$Proxy&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 分析3：用于生成唯一代理类名称的下一个数字
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// next number to use for generation of unique proxy class names
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">AtomicLong</span> <span class="n">nextUniqueNumber</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicLong</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 分析4：已定义代理类的反向缓存，也就是已经生成代理类的纪录为true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// a reverse cache of defined proxy classes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ClassLoaderValue</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">reverseProxyCache</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">ClassLoaderValue</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>分析1：创建了<em>JavaLangAccess</em>实例，它是通过<em>SharedSecrets</em>的<em>getJavaLangAccess</em>方法来获取，我寻思既然有<em>getXXX</em>方法，那么也应该有<em>setXXX</em>方法，经过一番搜索，发现<em>JavaLangAccess</em>的<em>setJavaLangAccess</em>方法是在<em>System</em>类的<em>setJavaLangAccess</em>方法中被调用，而<em>System</em>类的<em>setJavaLangAccess</em>方法将通过虚拟机<em>VM</em>来调用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setJavaLangAccess</span><span class="o">()</span> <span class="o">{</span>                                                                                            
</span></span><span class="line"><span class="cl">    <span class="c1">// Allow privileged classes outside of java.lang                                                                                 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SharedSecrets</span><span class="o">.</span><span class="na">setJavaLangAccess</span><span class="o">(</span><span class="k">new</span> <span class="n">JavaLangAccess</span><span class="o">()</span> <span class="o">{</span>                                                                           
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 埋下伏笔                                                                                                                                                                 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">defineClass</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span><span class="o">,</span> <span class="n">ProtectionDomain</span> <span class="n">pd</span><span class="o">,</span> <span class="n">String</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>                 
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">ClassLoader</span><span class="o">.</span><span class="na">defineClass1</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">b</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">pd</span><span class="o">,</span> <span class="n">source</span><span class="o">);</span>                                               
</span></span><span class="line"><span class="cl">        <span class="o">}</span>                                                                                                                            
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ...                                                                           
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">});</span>                                                                                                                              
</span></span><span class="line"><span class="cl"><span class="o">}</span>                                                                                                                                    
</span></span></code></pre></td></tr></table>
</div>
</div><p>继续跟踪<em>ProxyBuilder</em>类的构造函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ProxyBuilder</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">interfaces</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析2：如果模块系统未初始化，那么代理是不支持的                      
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(!</span><span class="n">VM</span><span class="o">.</span><span class="na">isModuleSystemInited</span><span class="o">())</span> <span class="o">{</span>                                              
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span><span class="s">&#34;Proxy is not supported until &#34;</span>                    
</span></span><span class="line"><span class="cl">                <span class="o">+</span> <span class="s">&#34;module system is fully initialized&#34;</span><span class="o">);</span>                           
</span></span><span class="line"><span class="cl">    <span class="o">}</span>     
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析3：代理接口数量最多只能65535个                                                                         
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">interfaces</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="o">)</span> <span class="o">{</span>                                               
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;interface limit exceeded: &#34;</span>            
</span></span><span class="line"><span class="cl">                <span class="o">+</span> <span class="n">interfaces</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>                                              
</span></span><span class="line"><span class="cl">    <span class="o">}</span>                                                                              
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析4：返回代理接口的所有公共非静态方法签名引用的所有类型(返回值类型、共享参数类型，共享异常类型)                                                                              
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">refTypes</span> <span class="o">=</span> <span class="n">referencedTypes</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">interfaces</span><span class="o">);</span>                  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析5：验证给定的代理接口和给定的引用类型对定义加载器可见             
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// IAE if violates any restrictions specified in newProxyInstance              
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">validateProxyInterfaces</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">interfaces</span><span class="o">,</span> <span class="n">refTypes</span><span class="o">);</span>                         
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">.</span><span class="na">interfaces</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">;</span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析6：返回生成的代理类所属的模块，有如下规则：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 1、如果任何代理接口是包私有的，则代理类位于包私有接口的同一模块中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2、如果所有代理接口都是公共的并且位于导出包中，则代理类位于无条件导出包中的动态模块中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 3、如果所有代理接口都是公共的，并且至少有一个位于非导出包中，则该代理类位于非导出包中的动态模块中                                              
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="o">.</span><span class="na">module</span> <span class="o">=</span> <span class="n">mapToModule</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">interfaces</span><span class="o">,</span> <span class="n">refTypes</span><span class="o">);</span>                       
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="n">getLoader</span><span class="o">(</span><span class="n">module</span><span class="o">)</span> <span class="o">==</span> <span class="n">loader</span><span class="o">;</span>                                            
</span></span><span class="line"><span class="cl"><span class="o">}</span>     
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 分析1：如果是单个代理接口的情况，其实也是把接口转换为List，然后调用另一个构造方法                                                                 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ProxyBuilder</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">intf</span><span class="o">)</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">intf</span><span class="o">));</span> 
</span></span><span class="line"><span class="cl"><span class="o">}</span>                                                  
</span></span></code></pre></td></tr></table>
</div>
</div><p>由上面代码可知，代理类的生成有着许多限制规则，主要是<em>Java 9</em>引入了模块管理的概念，继续跟踪<em>ProxyBuilder</em>类的<em>build</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 生成一个代理类并返回其代理构造函数，并已设置可访问标志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">build</span><span class="o">()</span> <span class="o">{</span>                
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析1：定义代理类的Class对象                                       
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">proxyClass</span> <span class="o">=</span> <span class="n">defineProxyClass</span><span class="o">(</span><span class="n">module</span><span class="o">,</span> <span class="n">interfaces</span><span class="o">);</span>                
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="o">!</span><span class="n">module</span><span class="o">.</span><span class="na">isNamed</span><span class="o">()</span> <span class="o">||</span> <span class="n">module</span><span class="o">.</span><span class="na">isOpen</span><span class="o">(</span><span class="n">proxyClass</span><span class="o">.</span><span class="na">getPackageName</span><span class="o">(),</span> <span class="n">Prox</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">cons</span><span class="o">;</span>                                                 
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>      
</span></span><span class="line"><span class="cl">        <span class="c1">// 分析2：返回代理类的构造器                                                                
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">cons</span> <span class="o">=</span> <span class="n">proxyClass</span><span class="o">.</span><span class="na">getConstructor</span><span class="o">(</span><span class="n">constructorParams</span><span class="o">);</span>                   
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>                                        
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>                              
</span></span><span class="line"><span class="cl">    <span class="o">}</span>                                                                          
</span></span><span class="line"><span class="cl">    <span class="n">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="k">new</span> <span class="n">PrivilegedAction</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;()</span> <span class="o">{</span>               
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>                                                    
</span></span><span class="line"><span class="cl">            <span class="n">cons</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>                                          
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>                                                       
</span></span><span class="line"><span class="cl">        <span class="o">}</span>                                                                      
</span></span><span class="line"><span class="cl">    <span class="o">});</span>                                                                        
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">cons</span><span class="o">;</span>                                                               
</span></span><span class="line"><span class="cl"><span class="o">}</span>                                                                              
</span></span></code></pre></td></tr></table>
</div>
</div><p>很明显，代理类的生成过程都在<em>defineProxyClass</em>方法当中，继续跟踪。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">defineProxyClass</span><span class="o">(</span><span class="n">Module</span> <span class="n">m</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">interfaces</span><span class="o">)</span> <span class="o">{</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析1：定义代理类所在的包路径                                         
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="n">proxyPkg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>     <span class="c1">// package to define proxy class in                                                      
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">accessFlags</span> <span class="o">=</span> <span class="n">Modifier</span><span class="o">.</span><span class="na">PUBLIC</span> <span class="o">|</span> <span class="n">Modifier</span><span class="o">.</span><span class="na">FINAL</span><span class="o">;</span>                                                                  
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">nonExported</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>                                                                                         
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*                                                                                                                   
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Record the package of a non-public proxy interface so that the                                                    
</span></span></span><span class="line"><span class="cl"><span class="cm">     * proxy class will be defined in the same package.  Verify that                                                     
</span></span></span><span class="line"><span class="cl"><span class="cm">     * all non-public proxy interfaces are in the same package.                                                          
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>        
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析2：记录非公共代理接口的包，以便代理类将定义在同一个包中。验证所有非公共代理接口是否位于同一个包中。                                                                                                          
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">intf</span> <span class="o">:</span> <span class="n">interfaces</span><span class="o">)</span> <span class="o">{</span>                                                                                   
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">intf</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">();</span>                                                                                 
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">Modifier</span><span class="o">.</span><span class="na">isPublic</span><span class="o">(</span><span class="n">flags</span><span class="o">))</span> <span class="o">{</span>                                                                                 
</span></span><span class="line"><span class="cl">            <span class="n">accessFlags</span> <span class="o">=</span> <span class="n">Modifier</span><span class="o">.</span><span class="na">FINAL</span><span class="o">;</span>  <span class="c1">// non-public, final                                                          
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">String</span> <span class="n">pkg</span> <span class="o">=</span> <span class="n">intf</span><span class="o">.</span><span class="na">getPackageName</span><span class="o">();</span>                                                                          
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">proxyPkg</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>                                                                                      
</span></span><span class="line"><span class="cl">                <span class="n">proxyPkg</span> <span class="o">=</span> <span class="n">pkg</span><span class="o">;</span>                                                                                          
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">pkg</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">proxyPkg</span><span class="o">))</span> <span class="o">{</span>                                                                          
</span></span><span class="line"><span class="cl">                <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span>                                                                      
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;non-public interfaces from different packages&#34;</span><span class="o">);</span>                                                
</span></span><span class="line"><span class="cl">            <span class="o">}</span>                                                                                                            
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>                                                                                                         
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">intf</span><span class="o">.</span><span class="na">getModule</span><span class="o">().</span><span class="na">isExported</span><span class="o">(</span><span class="n">intf</span><span class="o">.</span><span class="na">getPackageName</span><span class="o">()))</span> <span class="o">{</span>                                                   
</span></span><span class="line"><span class="cl">                <span class="c1">// module-private types                                                                                  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">nonExported</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>                                                                                      
</span></span><span class="line"><span class="cl">            <span class="o">}</span>                                                                                                            
</span></span><span class="line"><span class="cl">        <span class="o">}</span>                                                                                                                
</span></span><span class="line"><span class="cl">    <span class="o">}</span>                                                                                                                    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析3：所有代理接口都是公共和导出的                                                                                                                 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">proxyPkg</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>                                                                                              
</span></span><span class="line"><span class="cl">        <span class="c1">// all proxy interfaces are public and exported                                                                  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">m</span><span class="o">.</span><span class="na">isNamed</span><span class="o">())</span>                                                                                                
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span><span class="s">&#34;ununamed module: &#34;</span> <span class="o">+</span> <span class="n">m</span><span class="o">);</span>     
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果代理接口所在包名在模块中是不可导出的，那么代理接口包名定义为com.sun.proxy.模块名，否则定义为模块名                                                       
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">proxyPkg</span> <span class="o">=</span> <span class="n">nonExported</span> <span class="o">?</span> <span class="n">PROXY_PACKAGE_PREFIX</span> <span class="o">+</span> <span class="s">&#34;.&#34;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>                                                
</span></span><span class="line"><span class="cl">                               <span class="o">:</span> <span class="n">m</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>                                                                            
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">proxyPkg</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">m</span><span class="o">.</span><span class="na">isNamed</span><span class="o">())</span> <span class="o">{</span>                                                                      
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span>                                                                              
</span></span><span class="line"><span class="cl">                <span class="s">&#34;Unnamed package cannot be added to &#34;</span> <span class="o">+</span> <span class="n">m</span><span class="o">);</span>                                                              
</span></span><span class="line"><span class="cl">    <span class="o">}</span>                                                                                                                    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">isNamed</span><span class="o">())</span> <span class="o">{</span>                                                                                                   
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">m</span><span class="o">.</span><span class="na">getDescriptor</span><span class="o">().</span><span class="na">packages</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">proxyPkg</span><span class="o">))</span> <span class="o">{</span>                                                          
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span><span class="n">proxyPkg</span> <span class="o">+</span> <span class="s">&#34; not exist in &#34;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>                                          
</span></span><span class="line"><span class="cl">        <span class="o">}</span>                                                                                                                
</span></span><span class="line"><span class="cl">    <span class="o">}</span>                                                                                                                    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*                                                                                                                   
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Choose a name for the proxy class to generate.                                                                    
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>                
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析4：选择要生成的代理类的名称           
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 计数器+1                                                                                      
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">long</span> <span class="n">num</span> <span class="o">=</span> <span class="n">nextUniqueNumber</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果包名为&#34;&#34;，代理类名字 $Proxy + 计数器数字，否则 包名.$Proxy + 计数器数字                                                                     
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String</span> <span class="n">proxyName</span> <span class="o">=</span> <span class="n">proxyPkg</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span>                                                                                
</span></span><span class="line"><span class="cl">                            <span class="o">?</span> <span class="n">proxyClassNamePrefix</span> <span class="o">+</span> <span class="n">num</span>                                                                 
</span></span><span class="line"><span class="cl">                            <span class="o">:</span> <span class="n">proxyPkg</span> <span class="o">+</span> <span class="s">&#34;.&#34;</span> <span class="o">+</span> <span class="n">proxyClassNamePrefix</span> <span class="o">+</span> <span class="n">num</span><span class="o">;</span>                                               
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ClassLoader</span> <span class="n">loader</span> <span class="o">=</span> <span class="n">getLoader</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>                                                                                   
</span></span><span class="line"><span class="cl">    <span class="n">trace</span><span class="o">(</span><span class="n">proxyName</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="n">loader</span><span class="o">,</span> <span class="n">interfaces</span><span class="o">);</span>                                                                             
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*                                                                                                                   
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Generate the specified proxy class.                                                                               
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>             
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析5：生成指定的代理类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 动态生成代理类字节数组                                                                                                     
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">byte</span><span class="o">[]</span> <span class="n">proxyClassFile</span> <span class="o">=</span> <span class="n">ProxyGenerator</span><span class="o">.</span><span class="na">generateProxyClass</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">proxyName</span><span class="o">,</span> <span class="n">interfaces</span><span class="o">,</span> <span class="n">accessFlags</span><span class="o">);</span>               
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>          
</span></span><span class="line"><span class="cl">        <span class="c1">// 通过代理类字节数组定义代理类Class对象，对于了前面说的System的setJavaLangAccess方法的实现                                                                                                     
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">JLA</span><span class="o">.</span><span class="na">defineClass</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">proxyName</span><span class="o">,</span> <span class="n">proxyClassFile</span><span class="o">,</span>                                                 
</span></span><span class="line"><span class="cl">                                      <span class="kc">null</span><span class="o">,</span> <span class="s">&#34;__dynamic_proxy__&#34;</span><span class="o">);</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">// 缓存代理类已经生成过的标记true                                                      
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">reverseProxyCache</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">pc</span><span class="o">).</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">TRUE</span><span class="o">);</span>                                                     
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pc</span><span class="o">;</span>                                                                                                       
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassFormatError</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>                                                                                       
</span></span><span class="line"><span class="cl">        <span class="cm">/*                                                                                                               
</span></span></span><span class="line"><span class="cl"><span class="cm">         * A ClassFormatError here means that (barring bugs in the                                                       
</span></span></span><span class="line"><span class="cl"><span class="cm">         * proxy class generation code) there was some other                                                             
</span></span></span><span class="line"><span class="cl"><span class="cm">         * invalid aspect of the arguments supplied to the proxy                                                         
</span></span></span><span class="line"><span class="cl"><span class="cm">         * class creation (such as virtual machine limitations                                                           
</span></span></span><span class="line"><span class="cl"><span class="cm">         * exceeded).                                                                                                    
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>                                                                                                              
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>                                                                
</span></span><span class="line"><span class="cl">    <span class="o">}</span>                                                                                                                    
</span></span><span class="line"><span class="cl"><span class="o">}</span>                                                                                                                        
</span></span></code></pre></td></tr></table>
</div>
</div><p>继续跟踪<em>ProxyGenerator</em>的<em>generateProxyClass</em>方法，看看是如何生成代理类字节数组的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 给定名称和代理接口列表生成代理类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">generateProxyClass</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span>                                                                       
</span></span><span class="line"><span class="cl">                                 <span class="kd">final</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span>                                                                        
</span></span><span class="line"><span class="cl">                                 <span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">interfaces</span><span class="o">,</span>                                                                
</span></span><span class="line"><span class="cl">                                 <span class="kt">int</span> <span class="n">accessFlags</span><span class="o">)</span> <span class="o">{</span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析1                                                                    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ProxyGenerator</span> <span class="n">gen</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProxyGenerator</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">interfaces</span><span class="o">,</span> <span class="n">accessFlags</span><span class="o">);</span>                                        
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">classFile</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="na">generateClassFile</span><span class="o">();</span>                                                                      
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析2                                                                                                             
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">saveGeneratedFiles</span><span class="o">)</span> <span class="o">{</span>                                                                                              
</span></span><span class="line"><span class="cl">        <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span>                                                                       
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">PrivilegedAction</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;()</span> <span class="o">{</span>                                                               
</span></span><span class="line"><span class="cl">                    <span class="kd">public</span> <span class="n">Void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>                                                                                    
</span></span><span class="line"><span class="cl">                        <span class="k">try</span> <span class="o">{</span>                                                                                              
</span></span><span class="line"><span class="cl">                            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="sc">&#39;.&#39;</span><span class="o">);</span>                                                                 
</span></span><span class="line"><span class="cl">                            <span class="n">Path</span> <span class="n">path</span><span class="o">;</span>                                                                                     
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>                                                                                   
</span></span><span class="line"><span class="cl">                                <span class="n">Path</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">dotToSlash</span><span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">)));</span>                                      
</span></span><span class="line"><span class="cl">                                <span class="n">Files</span><span class="o">.</span><span class="na">createDirectories</span><span class="o">(</span><span class="n">dir</span><span class="o">);</span>                                                              
</span></span><span class="line"><span class="cl">                                <span class="n">path</span> <span class="o">=</span> <span class="n">dir</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;.class&#34;</span><span class="o">);</span>                                      
</span></span><span class="line"><span class="cl">                            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>                                                                                       
</span></span><span class="line"><span class="cl">                                <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#34;.class&#34;</span><span class="o">);</span>                                                           
</span></span><span class="line"><span class="cl">                            <span class="o">}</span>                                                                                              
</span></span><span class="line"><span class="cl">                            <span class="n">Files</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">classFile</span><span class="o">);</span>                                                                  
</span></span><span class="line"><span class="cl">                            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>                                                                                   
</span></span><span class="line"><span class="cl">                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>                                                                          
</span></span><span class="line"><span class="cl">                            <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span>                                                                       
</span></span><span class="line"><span class="cl">                                    <span class="s">&#34;I/O exception saving generated file: &#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>                                          
</span></span><span class="line"><span class="cl">                        <span class="o">}</span>                                                                                                  
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>                                                                                                      
</span></span><span class="line"><span class="cl">                <span class="o">});</span>                                                                                                        
</span></span><span class="line"><span class="cl">    <span class="o">}</span>                                                                                                                      
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">classFile</span><span class="o">;</span>                                                                                                      
</span></span><span class="line"><span class="cl"><span class="o">}</span>                                                                                                                          
</span></span></code></pre></td></tr></table>
</div>
</div><p>分析1：调用了<em>ProxyGenerator</em>的<em>generateClassFile</em>方法来生成代理类的字节数组，跟踪看看。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 生成代理类的类文件。该方法驱动类文件生成过程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">generateClassFile</span><span class="o">()</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">// 确定代理类的基础信息（类修饰符、类名、父类、实现的接口等等）                                                                    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">visit</span><span class="o">(</span><span class="n">V14</span><span class="o">,</span> <span class="n">accessFlags</span><span class="o">,</span> <span class="n">dotToSlash</span><span class="o">(</span><span class="n">className</span><span class="o">),</span> <span class="kc">null</span><span class="o">,</span>                                                   
</span></span><span class="line"><span class="cl">            <span class="n">JLR_PROXY</span><span class="o">,</span> <span class="n">typeNames</span><span class="o">(</span><span class="n">interfaces</span><span class="o">));</span>                                                             
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*                                                                                                     
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Add proxy methods for the hashCode, equals,                                                         
</span></span></span><span class="line"><span class="cl"><span class="cm">     * and toString methods of java.lang.Object.  This is done before                                      
</span></span></span><span class="line"><span class="cl"><span class="cm">     * the methods from the proxy interfaces so that the methods from                                      
</span></span></span><span class="line"><span class="cl"><span class="cm">     * java.lang.Object take precedence over duplicate methods in the                                      
</span></span></span><span class="line"><span class="cl"><span class="cm">     * proxy interfaces.                                                                                   
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析1：将所有方法封装成ProxyMethod对象       
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 为java.lang.Object的hashCode、equals和toString方法添加代理方法。这是在代理接口中的方法之前完成的，以便 java.lang.Object 中的方法优先于代理接口中的重复方法。                                                                                       
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">addProxyMethod</span><span class="o">(</span><span class="n">hashCodeMethod</span><span class="o">);</span>                                                                        
</span></span><span class="line"><span class="cl">    <span class="n">addProxyMethod</span><span class="o">(</span><span class="n">equalsMethod</span><span class="o">);</span>                                                                          
</span></span><span class="line"><span class="cl">    <span class="n">addProxyMethod</span><span class="o">(</span><span class="n">toStringMethod</span><span class="o">);</span>                                                                        
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*                                                                                                     
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Accumulate all of the methods from the proxy interfaces.                                            
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>        
</span></span><span class="line"><span class="cl">    <span class="c1">// 遍历所有代理接口中的所有方法，并生成ProxyMethod对象                                                                                            
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">intf</span> <span class="o">:</span> <span class="n">interfaces</span><span class="o">)</span> <span class="o">{</span>                                                                     
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Method</span> <span class="n">m</span> <span class="o">:</span> <span class="n">intf</span><span class="o">.</span><span class="na">getMethods</span><span class="o">())</span> <span class="o">{</span>                                                               
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">Modifier</span><span class="o">.</span><span class="na">isStatic</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">()))</span> <span class="o">{</span>                                                    
</span></span><span class="line"><span class="cl">                <span class="n">addProxyMethod</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">intf</span><span class="o">);</span>                                                                   
</span></span><span class="line"><span class="cl">            <span class="o">}</span>                                                                                              
</span></span><span class="line"><span class="cl">        <span class="o">}</span>                                                                                                  
</span></span><span class="line"><span class="cl">    <span class="o">}</span>                                                                                                      
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*                                                                                                     
</span></span></span><span class="line"><span class="cl"><span class="cm">     * For each set of proxy methods with the same signature,                                              
</span></span></span><span class="line"><span class="cl"><span class="cm">     * verify that the methods&#39; return types are compatible.                                               
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>   
</span></span><span class="line"><span class="cl">    <span class="c1">// 对于具有相同签名的每组代理方法，验证方法的返回类型是否兼容                                                                                                 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;</span> <span class="n">sigmethods</span> <span class="o">:</span> <span class="n">proxyMethods</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>                                           
</span></span><span class="line"><span class="cl">        <span class="n">checkReturnTypes</span><span class="o">(</span><span class="n">sigmethods</span><span class="o">);</span>                                                                      
</span></span><span class="line"><span class="cl">    <span class="o">}</span>                                                                                                      
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 分析2：开始生成代理类的构造，方法，成员变量等等     
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 生成代理类的构造方法                                                                              
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">generateConstructor</span><span class="o">();</span>                                                                                 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 遍历ProxyMethod列表                                                                         
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ProxyMethod</span><span class="o">&gt;</span> <span class="n">sigmethods</span> <span class="o">:</span> <span class="n">proxyMethods</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>                                           
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">ProxyMethod</span> <span class="n">pm</span> <span class="o">:</span> <span class="n">sigmethods</span><span class="o">)</span> <span class="o">{</span>                                                                
</span></span><span class="line"><span class="cl">            <span class="c1">// add static field for the Method object    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 为Method对象添加静态字段                                                  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">visitField</span><span class="o">(</span><span class="n">ACC_PRIVATE</span> <span class="o">|</span> <span class="n">ACC_STATIC</span> <span class="o">|</span> <span class="n">ACC_FINAL</span><span class="o">,</span> <span class="n">pm</span><span class="o">.</span><span class="na">methodFieldName</span><span class="o">,</span>                           
</span></span><span class="line"><span class="cl">                    <span class="n">LJLR_METHOD</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>                                                              
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Generate code for proxy method 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 生成代理方法的代码                                                             
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">pm</span><span class="o">.</span><span class="na">generateMethod</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">className</span><span class="o">);</span>                                                            
</span></span><span class="line"><span class="cl">        <span class="o">}</span>                                                                                                  
</span></span><span class="line"><span class="cl">    <span class="o">}</span>                                                                                                      
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 生成代理类的静态代码块                                                                                    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">generateStaticInitializer</span><span class="o">();</span>                                                                           
</span></span><span class="line"><span class="cl">    <span class="n">generateLookupAccessor</span><span class="o">();</span>   
</span></span><span class="line"><span class="cl">    <span class="c1">// 第一步：计算 ClassFile 结构的大小（以字节为单位）。 magic 字段使用 4 个字节，10 个强制字段（minor_version、major_version、constant_pool_count、access_flags、this_class、super_class、interfaces_count、fields_count、methods_count 和 attribute_count）每个使用 2 个字节，每个接口也使用 2 个字节。 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 第二步：分配一个正确大小的 ByteVector并用 ClassFile 内容填充它。   
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 也就是写入魔数、次版本号、主版本号、常量池等等。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 第三步：转换为二进制数组输出                                                                       
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">toByteArray</span><span class="o">();</span>                                                                                  
</span></span><span class="line"><span class="cl"><span class="o">}</span>                                                                                                          
</span></span></code></pre></td></tr></table>
</div>
</div><p>分析2：<em>saveGeneratedFiles</em>是用于保存生成的代理类文件的调试标志，如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">saveGeneratedFiles</span> <span class="o">=</span>                           
</span></span><span class="line"><span class="cl">        <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span>                        
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">GetBooleanAction</span><span class="o">(</span>                                       
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;jdk.proxy.ProxyGenerator.saveGeneratedFiles&#34;</span><span class="o">));</span>    
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>AccessController</em>的<em>doPrivileged</em>方法需要传入<em>PrivilegedAction</em>接口，而<em>PrivilegedAction</em>接口中有一个<em>run</em>方法，<em>run</em>方法的返回值即为<em>saveGeneratedFiles</em>，又因为<em>GetBooleanAction</em>实现了<em>PrivilegedAction</em>接口，所以只需跟踪<em>GetBooleanAction</em>的<em>run</em>方法即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GetBooleanAction</span>
</span></span><span class="line"><span class="cl">        <span class="kd">implements</span> <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">PrivilegedAction</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">theProp</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Constructor that takes the name of the system property whose boolean
</span></span></span><span class="line"><span class="cl"><span class="cm">     * value needs to be determined.
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param theProp the name of the system property.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">GetBooleanAction</span><span class="o">(</span><span class="n">String</span> <span class="n">theProp</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">theProp</span> <span class="o">=</span> <span class="n">theProp</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="n">theProp</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>继续跟踪<em>Boolean</em>的<em>getBoolean</em>方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">getBoolean</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>                   
</span></span><span class="line"><span class="cl">    <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>                                       
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>                                                         
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">parseBoolean</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>          
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalArgumentException</span> <span class="o">|</span> <span class="n">NullPointerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> 
</span></span><span class="line"><span class="cl">    <span class="o">}</span>                                                             
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>                                                
</span></span><span class="line"><span class="cl"><span class="o">}</span>                                                                 
</span></span></code></pre></td></tr></table>
</div>
</div><p>很显然，调用了<em>System</em>类的<em>getProperty</em>方法，然后转换为<em>boolean</em>值返回，<em>name</em>其实就是</p>
<p><code>jdk.proxy.ProxyGenerator.saveGeneratedFiles</code>，那么我们只需要在<em>Proxy</em>类的<em>newProxyInstance</em>方法之前，通过<em>System</em>类的<em>setProperty</em>方法设置该值为<em>true</em>即可保存代理类文件。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&#34;jdk.proxy.ProxyGenerator.saveGeneratedFiles&#34;</span><span class="o">,</span> <span class="s">&#34;true&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Grandfather</span> <span class="n">grandfather</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Grandfather</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Action</span> <span class="n">action</span> <span class="o">=</span> <span class="o">(</span><span class="n">Action</span><span class="o">)</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">Action</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="k">new</span> <span class="n">Class</span><span class="o">&lt;?&gt;[]{</span><span class="n">Action</span><span class="o">.</span><span class="na">class</span><span class="o">},</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">ActionInvocationHandler</span><span class="o">(</span><span class="n">grandfather</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">action</span><span class="o">.</span><span class="na">recharge</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行过后，会在如下位置生成代理类，这也是接口都是<em>public</em>修饰时的情况。</p>
<img title="" src="/img/java/解读JDK动态代理/一般情况下的代理类生成路径.png" alt="" width="335">
<p>本例中生成的代理类如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">$Proxy0</span> <span class="kd">extends</span> <span class="n">Proxy</span> <span class="kd">implements</span> <span class="n">Action</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Method</span> <span class="n">m0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Method</span> <span class="n">m1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Method</span> <span class="n">m2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Method</span> <span class="n">m3</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">$Proxy0</span><span class="o">(</span><span class="n">InvocationHandler</span> <span class="n">var1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">var1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">(</span><span class="n">Integer</span><span class="o">)</span><span class="kd">super</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">m0</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">[])</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="o">|</span> <span class="n">Error</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">var2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">UndeclaredThrowableException</span><span class="o">(</span><span class="n">var3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">var1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">(</span><span class="n">Boolean</span><span class="o">)</span><span class="kd">super</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">m1</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">var1</span><span class="o">});</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="o">|</span> <span class="n">Error</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">var2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">UndeclaredThrowableException</span><span class="o">(</span><span class="n">var3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="kd">super</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">m2</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">[])</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="o">|</span> <span class="n">Error</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">var2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">UndeclaredThrowableException</span><span class="o">(</span><span class="n">var3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">recharge</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">super</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">m3</span><span class="o">,</span> <span class="o">(</span><span class="n">Object</span><span class="o">[])</span><span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="o">|</span> <span class="n">Error</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="n">var2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">UndeclaredThrowableException</span><span class="o">(</span><span class="n">var3</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">m0</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;java.lang.Object&#34;</span><span class="o">).</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;hashCode&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m1</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;java.lang.Object&#34;</span><span class="o">).</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;equals&#34;</span><span class="o">,</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;java.lang.Object&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">m2</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;java.lang.Object&#34;</span><span class="o">).</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;toString&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m3</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;com.pengmj.proxy.Action&#34;</span><span class="o">).</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&#34;recharge&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">NoSuchMethodError</span><span class="o">(</span><span class="n">var2</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">NoClassDefFoundError</span><span class="o">(</span><span class="n">var3</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">MethodHandles</span><span class="o">.</span><span class="na">Lookup</span> <span class="nf">proxyClassLookup</span><span class="o">(</span><span class="n">MethodHandles</span><span class="o">.</span><span class="na">Lookup</span> <span class="n">var0</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IllegalAccessException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">var0</span><span class="o">.</span><span class="na">lookupClass</span><span class="o">()</span> <span class="o">==</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">class</span> <span class="o">&amp;&amp;</span> <span class="n">var0</span><span class="o">.</span><span class="na">hasFullPrivilegeAccess</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">MethodHandles</span><span class="o">.</span><span class="na">lookup</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalAccessException</span><span class="o">(</span><span class="n">var0</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>由上面代码可知：</p>
<p>1、代理类<code>$Proxy0</code>继承自<em>Proxy</em>类，并实现了我们自己定义的<em>Action</em>接口；</p>
<p><em><strong>有一个疑问：问什么JDK动态代理只能基于接口进行代理？</strong></em></p>
<p>因为它已经继承了<em>Proxy</em>类了，而<em>Java</em>不支持多继承。</p>
<p>2、代理类使用了<em>final</em>修饰，说明代理类无法被继承；</p>
<p>3、接口中所有被代理的方法以及<em>Object</em>类的<em>hashCode</em>、<em>equals</em>、<em>toString</em>方法在<em>static</em>静态代码块中通过反射建立了<em>method</em>对象；</p>
<p>4、当调用接口中所有被代理的方法以及<em>Object</em>类的<em>hashCode</em>、<em>equals</em>、<em>toString</em>方法时，都会转交给<em>InvocationHandler</em>的<em>invoke</em>方法；</p>
<p>我们回到之前流程，当创建了代理类的构造器之后，就会调用<em>newProxyInstance</em>方法，继续跟踪看看。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">newProxyInstance</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">caller</span><span class="o">,</span> <span class="c1">// null if no SecurityManager                
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                       <span class="n">Constructor</span><span class="o">&lt;?&gt;</span> <span class="n">cons</span><span class="o">,</span>                                          
</span></span><span class="line"><span class="cl">                                       <span class="n">InvocationHandler</span> <span class="n">h</span><span class="o">)</span> <span class="o">{</span>                                        
</span></span><span class="line"><span class="cl">    <span class="cm">/*                                                                                               
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Invoke its constructor with the designated invocation handler.                                
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>                                                                                              
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="o">{</span>                                                                                            
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">caller</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>                                                                        
</span></span><span class="line"><span class="cl">            <span class="n">checkNewProxyPermission</span><span class="o">(</span><span class="n">caller</span><span class="o">,</span> <span class="n">cons</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">());</span>                               
</span></span><span class="line"><span class="cl">        <span class="o">}</span>                                                                                            
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">cons</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">h</span><span class="o">});</span>                                                    
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="o">|</span> <span class="n">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>                                    
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>                                                    
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>                                                          
</span></span><span class="line"><span class="cl">        <span class="n">Throwable</span> <span class="n">t</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>                                                                  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">t</span> <span class="k">instanceof</span> <span class="n">RuntimeException</span><span class="o">)</span> <span class="o">{</span>                                                         
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="o">(</span><span class="n">RuntimeException</span><span class="o">)</span> <span class="n">t</span><span class="o">;</span>                                                              
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>                                                                                     
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">InternalError</span><span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">t</span><span class="o">);</span>                                                
</span></span><span class="line"><span class="cl">        <span class="o">}</span>                                                                                            
</span></span><span class="line"><span class="cl">    <span class="o">}</span>                                                                                                
</span></span><span class="line"><span class="cl"><span class="o">}</span>                                                                                                    
</span></span></code></pre></td></tr></table>
</div>
</div><p>很明显了，通过构造器直接<em>newInstance</em>创建代理类实例对象，构造方法传入的参数为<em>h</em>。至此，<em>JDK</em>动态代理的原理就讲解完成了。</p>
<h1 id="六动态代理在android上的运用">六、动态代理在Android上的运用</h1>
<p>在<em>Android</em>上，动态代理也隐隐约约地存在着，比如网络请求框架<em>Retrofit</em>，它的<em>create</em>方法就使用了动态代理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">create</span><span class="o">(</span><span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>                                                                         
</span></span><span class="line"><span class="cl">  <span class="n">validateServiceInterface</span><span class="o">(</span><span class="n">service</span><span class="o">);</span>                                                                                  
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span>                                                                                                          
</span></span><span class="line"><span class="cl">      <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span>                                                                                         
</span></span><span class="line"><span class="cl">          <span class="n">service</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span>                                                                                   
</span></span><span class="line"><span class="cl">          <span class="k">new</span> <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="o">{</span><span class="n">service</span><span class="o">},</span>                                                                                   
</span></span><span class="line"><span class="cl">          <span class="k">new</span> <span class="n">InvocationHandler</span><span class="o">()</span> <span class="o">{</span>                                                                                   
</span></span><span class="line"><span class="cl">            <span class="kd">private</span> <span class="kd">final</span> <span class="n">Platform</span> <span class="n">platform</span> <span class="o">=</span> <span class="n">Platform</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>                                                         
</span></span><span class="line"><span class="cl">            <span class="kd">private</span> <span class="kd">final</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">emptyArgs</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>                                                         
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>                                                                                                 
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="nd">@Nullable</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>                      
</span></span><span class="line"><span class="cl">                <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>                                                                                    
</span></span><span class="line"><span class="cl">              <span class="c1">// If the method is a method from Object then defer to normal invocation.                               
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">()</span> <span class="o">==</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>                                                       
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>                                                                     
</span></span><span class="line"><span class="cl">              <span class="o">}</span>                                                                                                       
</span></span><span class="line"><span class="cl">              <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">args</span> <span class="o">:</span> <span class="n">emptyArgs</span><span class="o">;</span>                                                                 
</span></span><span class="line"><span class="cl">              <span class="k">return</span> <span class="n">platform</span><span class="o">.</span><span class="na">isDefaultMethod</span><span class="o">(</span><span class="n">method</span><span class="o">)</span>                                                                 
</span></span><span class="line"><span class="cl">                  <span class="o">?</span> <span class="n">platform</span><span class="o">.</span><span class="na">invokeDefaultMethod</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">service</span><span class="o">,</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span>                                        
</span></span><span class="line"><span class="cl">                  <span class="o">:</span> <span class="n">loadServiceMethod</span><span class="o">(</span><span class="n">method</span><span class="o">).</span><span class="na">invoke</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>                                                           
</span></span><span class="line"><span class="cl">            <span class="o">}</span>                                                                                                         
</span></span><span class="line"><span class="cl">          <span class="o">});</span>                                                                                                         
</span></span><span class="line"><span class="cl"><span class="o">}</span>                                                                                                                     
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">AndDevMK</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2023-08-11
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/wechat-qr-code.JPG">
        <span>微信打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/alipay-qr-code.JPG">
        <span>支付宝打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/flutter%E6%BA%90%E7%A0%81%E4%B9%8B%E4%B8%89%E9%A2%97%E6%A0%91%E5%88%86%E7%B1%BB/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Flutter源码之三颗树分类</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E8%A7%A3%E8%AF%BBkotlin%E5%8D%8F%E7%A8%8B%E5%90%AF%E5%8A%A8%E6%BA%90%E7%A0%81/">
            <span class="next-text nav-default">解读Kotlin协程启动源码</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="AndDevMK/blog-utterances"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    
    <div id="search_mask" class="search_mask">
    <div class="search_modal">
        <div id="close_search" class="close_search">关闭</div>
        <div class="search_divider"></div>
        <input id="input_search_key" class="input_search_key" placeholder="请输入你要搜索的内容" tabindex="0">
        <ul id="search_list">
        </ul>
    </div>
</div>

<script src="/js/fuse.js"></script> 
<script src="/js/fastsearch.js"></script>

    <footer id="footer" class="footer">
      

<div class="copyright">
  <span class="power-by">
    由 <a id="hexo-link" class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    
    <span id="run-time" class="run-time"></span> 
    <span class="heart"><i class="iconfont icon-heart"></i></span>
    &copy; 
    2023&nbsp;
    <span>AndDevMK</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.11a4ba15caf2d921d57eaf6568c4ad21eafd5d2c001cbcb31693586c63f93005.js"></script>

<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?6db179fb88e600cf326b0515a8aa1de3";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>




<script src="/js/codecopy.js"></script>



<link disabled id="dark-mode-theme" rel="stylesheet" href="/css/dark.css"></link>
<script src="/js/dark.js"></script>


<script src="/js/site_runtime.js"></script>




</body>
</html>
